function getbaselineinfo(t,e){var i=document.createElement("div"),r=document.body;if(!i||!r)return{ascent:0,descent:0};i.style.position="absolute",i.style.whiteSpace="nowrap",i.style.fontFamily=t,i.style.fontSize=e+"pt",r.appendChild(i);var o="Hg|Wjgm";i.innerHTML=o;var a=i.offsetHeight,s=document.createElement("span");s.style.display="inline-block",s.style.overflow="hidden",s.style.width="1px",s.style.height="0px",i.appendChild(s);var n=s.offsetTop+s.offsetHeight;return document.body.removeChild(i),{ascent:n,descent:a-n}}function get_key(t){for(var e=1e5,i=0;e>i;i++)if(!t.hasOwnProperty(i))return i;return console.log("!! table overflow !!"),e}!function(){function t(t){return t.call.apply(t.bind,arguments)}function e(t,e){if(!t)throw Error();if(2<arguments.length){var i=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,i),t.apply(e,r)}}return function(){return t.apply(e,arguments)}}function i(){return i=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?t:e,i.apply(null,arguments)}function r(t,e){this.F=t,this.k=e||t,this.H=this.k.document}function o(t,e,i){t=t.H.getElementsByTagName(e)[0],t||(t=document.documentElement),t.insertBefore(i,t.lastChild)}function a(t,e,i){e=e||[],i=i||[];for(var r=t.className.split(/\s+/),o=0;o<e.length;o+=1){for(var a=!1,s=0;s<r.length;s+=1)if(e[o]===r[s]){a=!0;break}a||r.push(e[o])}for(e=[],o=0;o<r.length;o+=1){for(a=!1,s=0;s<i.length;s+=1)if(r[o]===i[s]){a=!0;break}a||e.push(r[o])}t.className=e.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function s(t,e){for(var i=t.className.split(/\s+/),r=0,o=i.length;o>r;r++)if(i[r]==e)return!0;return!1}function n(t){if("string"==typeof t.fa)return t.fa;var e=t.k.location.protocol;return"about:"==e&&(e=t.F.location.protocol),"https:"==e?"https:":"http:"}function h(t,e,i){function r(){h&&a&&s&&(h(n),h=null)}e=t.createElement("link",{rel:"stylesheet",href:e,media:"all"});var a=!1,s=!0,n=null,h=i||null;V?(e.onload=function(){a=!0,r()},e.onerror=function(){a=!0,n=Error("Stylesheet failed to load"),r()}):setTimeout(function(){a=!0,r()},0),o(t,"head",e)}function l(t,e,i,r){var o=t.H.getElementsByTagName("head")[0];if(o){var a=t.createElement("script",{src:e}),s=!1;return a.onload=a.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,i&&i(null),a.onload=a.onreadystatechange=null,"HEAD"==a.parentNode.tagName&&o.removeChild(a))},o.appendChild(a),setTimeout(function(){s||(s=!0,i&&i(Error("Script load timeout")))},r||5e3),a}return null}function p(){this.S=0,this.K=null}function c(t){return t.S++,function(){t.S--,u(t)}}function d(t,e){t.K=e,u(t)}function u(t){0==t.S&&t.K&&(t.K(),t.K=null)}function _(t){this.ea=t||"-"}function g(t,e){this.Q=t,this.M=4,this.L="n";var i=(e||"n4").match(/^([nio])([1-9])$/i);i&&(this.L=i[1],this.M=parseInt(i[2],10))}function f(t){return m(t)+" "+(t.M+"00")+" 300px "+P(t.Q)}function P(t){var e=[];t=t.split(/,\s*/);for(var i=0;i<t.length;i++){var r=t[i].replace(/['"]/g,"");e.push(-1!=r.indexOf(" ")||/^\d/.test(r)?"'"+r+"'":r)}return e.join(",")}function y(t){return t.L+t.M}function m(t){var e="normal";return"o"===t.L?e="oblique":"i"===t.L&&(e="italic"),e}function v(t){var e=4,i="n",r=null;return t&&((r=t.match(/(normal|oblique|italic)/i))&&r[1]&&(i=r[1].substr(0,1).toLowerCase()),(r=t.match(/([1-9]00|normal|bold)/i))&&r[1]&&(/bold/i.test(r[1])?e=7:/[1-9]00/.test(r[1])&&(e=parseInt(r[1].substr(0,1),10)))),i+e}function M(t,e){this.a=t,this.j=t.k.document.documentElement,this.O=e,this.f="wf",this.e=new _("-"),this.da=!1!==e.events,this.u=!1!==e.classes}function C(t){t.u&&a(t.j,[t.e.d(t.f,"loading")]),E(t,"loading")}function w(t){if(t.u){var e=s(t.j,t.e.d(t.f,"active")),i=[],r=[t.e.d(t.f,"loading")];e||i.push(t.e.d(t.f,"inactive")),a(t.j,i,r)}E(t,"inactive")}function E(t,e,i){t.da&&t.O[e]&&(i?t.O[e](i.getName(),y(i)):t.O[e]())}function x(){this.t={}}function k(t,e,i){var r,o=[];for(r in e)if(e.hasOwnProperty(r)){var a=t.t[r];a&&o.push(a(e[r],i))}return o}function R(t,e){this.a=t,this.h=e,this.m=this.a.createElement("span",{"aria-hidden":"true"},this.h)}function I(t,e){var i,r=t.m;i="display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+P(e.Q)+";"+("font-style:"+m(e)+";font-weight:"+(e.M+"00")+";"),r.style.cssText=i}function T(t){o(t.a,"body",t.m)}function O(t,e,i,r,o,a){this.G=t,this.J=e,this.g=r,this.a=i,this.v=o||3e3,this.h=a||void 0}function L(t,e,i,r,o,a,s){this.G=t,this.J=e,this.a=i,this.g=r,this.h=s||"BESbswy",this.s={},this.v=o||3e3,this.Z=a||null,this.D=this.C=this.A=this.w=null,this.w=new R(this.a,this.h),this.A=new R(this.a,this.h),this.C=new R(this.a,this.h),this.D=new R(this.a,this.h),I(this.w,new g(this.g.getName()+",serif",y(this.g))),I(this.A,new g(this.g.getName()+",sans-serif",y(this.g))),I(this.C,new g("serif",y(this.g))),I(this.D,new g("sans-serif",y(this.g))),T(this.w),T(this.A),T(this.C),T(this.D)}function G(){if(null===Q){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Q=!!t&&(536>parseInt(t[1],10)||536===parseInt(t[1],10)&&11>=parseInt(t[2],10))}return Q}function b(t,e,i){for(var r in Z)if(Z.hasOwnProperty(r)&&e===t.s[Z[r]]&&i===t.s[Z[r]])return!0;return!1}function S(t){var e,i=t.w.m.offsetWidth,r=t.A.m.offsetWidth;(e=i===t.s.serif&&r===t.s["sans-serif"])||(e=G()&&b(t,i,r)),e?W()-t.ga>=t.v?G()&&b(t,i,r)&&(null===t.Z||t.Z.hasOwnProperty(t.g.getName()))?A(t,t.G):A(t,t.J):D(t):A(t,t.G)}function D(t){setTimeout(i(function(){S(this)},t),50)}function A(t,e){setTimeout(i(function(){this.w.remove(),this.A.remove(),this.C.remove(),this.D.remove(),e(this.g)},t),0)}function F(t,e,i){this.a=t,this.p=e,this.P=0,this.ba=this.Y=!1,this.v=i}function N(t){0==--t.P&&t.Y&&(t.ba?(t=t.p,t.u&&a(t.j,[t.e.d(t.f,"active")],[t.e.d(t.f,"loading"),t.e.d(t.f,"inactive")]),E(t,"active")):w(t.p))}function U(t){this.F=t,this.q=new x,this.$=0,this.T=this.U=!0}function B(t,e,r,o,s){var n=0==--t.$;(t.T||t.U)&&setTimeout(function(){var t=s||null,h=o||null||{};if(0===r.length&&n)w(e.p);else{e.P+=r.length,n&&(e.Y=n);var l,p=[];for(l=0;l<r.length;l++){var c=r[l],d=h[c.getName()],u=e.p,_=c;u.u&&a(u.j,[u.e.d(u.f,_.getName(),y(_).toString(),"loading")]),E(u,"fontloading",_),u=null,null===te&&(te=window.FontFace?(u=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(u[1],10):!0:!1),u=te?new O(i(e.V,e),i(e.W,e),e.a,c,e.v,d):new L(i(e.V,e),i(e.W,e),e.a,c,e.v,t,d),p.push(u)}for(l=0;l<p.length;l++)p[l].start()}},0)}function H(t,e,i){var r=[],o=i.timeout;C(e);var r=k(t.q,i,t.a),a=new F(t.a,e,o);for(t.$=r.length,e=0,i=r.length;i>e;e++)r[e].load(function(e,i,r){B(t,a,e,i,r)})}function X(t,e,i){this.N=t?t:e+ee,this.o=[],this.R=[],this.ca=i||""}function z(t,e){for(var i=e.length,r=0;i>r;r++){var o=e[r].split(":");3==o.length&&t.R.push(o.pop());var a="";2==o.length&&""!=o[1]&&(a=":"),t.o.push(o.join(a))}}function Y(t){this.o=t,this.aa=[],this.I={}}function q(t,e){this.a=t,this.c=e}function K(t,e){this.a=t,this.c=e,this.X=[]}function $(t,e){this.a=t,this.c=e}function j(t,e){this.a=t,this.c=e}function J(t,e){this.a=t,this.c=e}var W=Date.now||function(){return+new Date},V=!!window.FontFace;r.prototype.createElement=function(t,e,i){if(t=this.H.createElement(t),e)for(var r in e)e.hasOwnProperty(r)&&("style"==r?t.style.cssText=e[r]:t.setAttribute(r,e[r]));return i&&t.appendChild(this.H.createTextNode(i)),t},_.prototype.d=function(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e].replace(/[\W_]+/g,"").toLowerCase());return t.join(this.ea)},g.prototype.getName=function(){return this.Q},R.prototype.remove=function(){var t=this.m;t.parentNode&&t.parentNode.removeChild(t)},O.prototype.start=function(){function t(){W()-r>=i.v?i.J(i.g):e.fonts.load(f(i.g),i.h).then(function(e){1<=e.length?i.G(i.g):setTimeout(t,25)},function(){i.J(i.g)})}var e=this.a.k.document,i=this,r=W();t()};var Z={ia:"serif",ha:"sans-serif"},Q=null;L.prototype.start=function(){this.s.serif=this.C.m.offsetWidth,this.s["sans-serif"]=this.D.m.offsetWidth,this.ga=W(),S(this)};var te=null;F.prototype.V=function(t){var e=this.p;e.u&&a(e.j,[e.e.d(e.f,t.getName(),y(t).toString(),"active")],[e.e.d(e.f,t.getName(),y(t).toString(),"loading"),e.e.d(e.f,t.getName(),y(t).toString(),"inactive")]),E(e,"fontactive",t),this.ba=!0,N(this)},F.prototype.W=function(t){var e=this.p;if(e.u){var i=s(e.j,e.e.d(e.f,t.getName(),y(t).toString(),"active")),r=[],o=[e.e.d(e.f,t.getName(),y(t).toString(),"loading")];i||r.push(e.e.d(e.f,t.getName(),y(t).toString(),"inactive")),a(e.j,r,o)}E(e,"fontinactive",t),N(this)},U.prototype.load=function(t){this.a=new r(this.F,t.context||this.F),this.U=!1!==t.events,this.T=!1!==t.classes,H(this,new M(this.a,t),t)};var ee="//fonts.googleapis.com/css";X.prototype.d=function(){if(0==this.o.length)throw Error("No fonts to load!");if(-1!=this.N.indexOf("kit="))return this.N;for(var t=this.o.length,e=[],i=0;t>i;i++)e.push(this.o[i].replace(/ /g,"+"));return t=this.N+"?family="+e.join("%7C"),0<this.R.length&&(t+="&subset="+this.R.join(",")),0<this.ca.length&&(t+="&text="+encodeURIComponent(this.ca)),t};var ie={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},re={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},oe={i:"i",italic:"i",n:"n",normal:"n"},ae=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;Y.prototype.parse=function(){for(var t=this.o.length,e=0;t>e;e++){var i=this.o[e].split(":"),r=i[0].replace(/\+/g," "),o=["n4"];if(2<=i.length){var a,s=i[1];if(a=[],s)for(var s=s.split(","),n=s.length,h=0;n>h;h++){var l;if(l=s[h],l.match(/^[\w-]+$/))if(l=ae.exec(l.toLowerCase()),null==l)l="";else{var p;if(p=l[1],null==p||""==p)p="4";else{var c=re[p];p=c?c:isNaN(p)?"4":p.substr(0,1)}l=l[2],l=[null==l||""==l?"n":oe[l],p].join("")}else l="";l&&a.push(l)}0<a.length&&(o=a),3==i.length&&(i=i[2],a=[],i=i?i.split(","):a,0<i.length&&(i=ie[i[0]])&&(this.I[r]=i))}for(this.I[r]||(i=ie[r])&&(this.I[r]=i),i=0;i<o.length;i+=1)this.aa.push(new g(r,o[i]))}};var se={Arimo:!0,Cousine:!0,Tinos:!0};q.prototype.load=function(t){var e=new p,i=this.a,r=new X(this.c.api,n(i),this.c.text),o=this.c.families;z(r,o);var a=new Y(o);a.parse(),h(i,r.d(),c(e)),d(e,function(){t(a.aa,a.I,se)})},K.prototype.B=function(t){var e=this.a;return n(this.a)+(this.c.api||"//f.fontdeck.com/s/css/js/")+(e.k.location.hostname||e.F.location.hostname)+"/"+t+".js"},K.prototype.load=function(t){var e=this.c.id,i=this.a.k,r=this;e?(i.__webfontfontdeckmodule__||(i.__webfontfontdeckmodule__={}),i.__webfontfontdeckmodule__[e]=function(e,i){for(var o=0,a=i.fonts.length;a>o;++o){var s=i.fonts[o];r.X.push(new g(s.name,v("font-weight:"+s.weight+";font-style:"+s.style)))}t(r.X)},l(this.a,this.B(e),function(e){e&&t([])})):t([])},$.prototype.B=function(t){return(this.c.api||"https://use.typekit.net")+"/"+t+".js"},$.prototype.load=function(t){var e=this.c.id,i=this.a.k;e?l(this.a,this.B(e),function(e){if(e)t([]);else if(i.Typekit&&i.Typekit.config&&i.Typekit.config.fn){e=i.Typekit.config.fn;for(var r=[],o=0;o<e.length;o+=2)for(var a=e[o],s=e[o+1],n=0;n<s.length;n++)r.push(new g(a,s[n]));try{i.Typekit.load({events:!1,classes:!1,async:!0})}catch(h){}t(r)}},2e3):t([])},j.prototype.B=function(t,e){var i=n(this.a),r=(this.c.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,"");return i+"//"+r+"/"+t+".js"+(e?"?v="+e:"")},j.prototype.load=function(t){function e(){if(o["__mti_fntLst"+i]){var r,a=o["__mti_fntLst"+i](),s=[];if(a)for(var n=0;n<a.length;n++){var h=a[n].fontfamily;void 0!=a[n].fontStyle&&void 0!=a[n].fontWeight?(r=a[n].fontStyle+a[n].fontWeight,s.push(new g(h,r))):s.push(new g(h))}t(s)}else setTimeout(function(){e()},50)}var i=this.c.projectId,r=this.c.version;if(i){var o=this.a.k;l(this.a,this.B(i,r),function(i){i?t([]):e()}).id="__MonotypeAPIScript__"+i}else t([])},J.prototype.load=function(t){var e,i,r=this.c.urls||[],o=this.c.families||[],a=this.c.testStrings||{},s=new p;for(e=0,i=r.length;i>e;e++)h(this.a,r[e],c(s));var n=[];for(e=0,i=o.length;i>e;e++)if(r=o[e].split(":"),r[1])for(var l=r[1].split(","),u=0;u<l.length;u+=1)n.push(new g(r[0],l[u]));else n.push(new g(r[0]));d(s,function(){t(n,a)})};var ne=new U(window);ne.q.t.custom=function(t,e){return new J(e,t)},ne.q.t.fontdeck=function(t,e){return new K(e,t)},ne.q.t.monotype=function(t,e){return new j(e,t)},ne.q.t.typekit=function(t,e){return new $(e,t)},ne.q.t.google=function(t,e){return new q(e,t)};var he={load:i(ne.load,ne)};"function"==typeof define&&define.amd?define(function(){return he}):"undefined"!=typeof module&&module.exports?module.exports=he:(window.WebFont=he,window.WebFontConfig&&ne.load(window.WebFontConfig))}(),PM.Core={},PM.Ctrl={},PM.Editor={},PM.Lib={},PM.URL={},PM.TYPE={},PM.PAGE={},PM.HIT={},PM.CONFIG={},PM.Core.Version="78",PM.Core.MAIN_CANVAS_ID="",PM.TYPE.UNKNOWN=-1,PM.TYPE.ICON=0,PM.TYPE.IMAGE=1,PM.TYPE.TEXT=2,PM.PAGE.ERROR=-3,PM.PAGE.COVER=-2,PM.PAGE.PROLOG=-1,PM.PAGE.COVER_FRONT=-10,PM.PAGE.COVER_MIDDLE=-11,PM.PAGE.COVER_BACK=-12,PM.ADDPAGE_SUCCESS=0,PM.ADDPAGE_FAIL=-1,PM.ADDPAGE_LIMIT_ERROR=-2,PM.DELPAGE_SUCCESS=0,PM.DELPAGE_FAIL=-1,PM.DELPAGE_LIMIT_ERROR=-2,PM.HIT.NONE=-1,PM.HIT.MOVE=0,PM.HIT.RESIZE_T=1,PM.HIT.RESIZE_R=2,PM.HIT.RESIZE_B=3,PM.HIT.RESIZE_L=4,PM.HIT.RESIZE_LT=5,PM.HIT.RESIZE_RT=6,PM.HIT.RESIZE_RB=7,PM.HIT.RESIZE_LB=8,PM.HIT.ROTATE=9,PM.HIT.MOVE_CROP=10,PM.HIT.EDIT_TEXT=11,PM.RECORD_ON=!0,PM.RECORD_OFF=!1,PM.RECORD_UNKNOWN=0,PM.RECORD_PAGE_INSERT=1,PM.RECORD_PAGE_DELETE=2,PM.RECORD_PAGE_REORDER=3,PM.RECORD_PAGE_BKCOLOR=4,PM.RECORD_PAGE_BKIMAGE=5,PM.RECORD_PAGE_LAYOUT=6,PM.RECORD_LAYER_INSERT=7,PM.RECORD_LAYER_DELETE=8,PM.RECORD_LAYER_MOVE=9,PM.RECORD_LAYER_ZORDER=10,PM.RECORD_FRAME_CHANGE=11,PM.RECORD_PHOTO_CHANGE=12,PM.RECORD_PHOTO_CROP=13,PM.RECORD_PHOTO_ADDALL=14,PM.RECORD_PHOTO_DELALL=15,PM.RECORD_ICON_OPACITY=16,PM.RECORD_TEXT_CHANGE=17,PM.SIZE6X6=0,PM.SIZE6X8=1,PM.SIZE8X6=2,PM.SIZE8X8=3,PM.SIZE8X11=4,PM.SIZE11X8=5,PM.SIZE10X10=6,PM.DEBUG=!1,PM.URL.UPLOAD="http://tplx.photomon.com/upload/flex_webimage.asp",PM.URL.ADD_CART="http://www.photomon.com/StoryAlbum/CardEditor/add_cart_ok.asp",PM.URL.THEME_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_stylethumb.xml",PM.URL.LAYOUT_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_layouturl.xml",PM.URL.SKIN_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_backgroundurl.xml",PM.URL.STICKER_LIST="http://tpl.photomon.com/Product/catalog/mainxml/flex_stickdnurl.20130904.xml",PM.URL.FRAME_LIST="http://tpl.photomon.com/Product/catalog/mainxml/flex_frameurl.xml",PM.URL.LAYOUT_THUMB="http://tpl.photomon.com/product/skin/thumb/",PM.URL.LAYOUT_FILE="http://tpl.photomon.com/product/skin/thumb/",PM.URL.SKIN_THUMB="http://tpl.photomon.com/Product/skin/flex_skinthumb/",PM.URL.SKIN_FILE="http://tpl.photomon.com/product/skin/edit/",PM.URL.STICKER_THUMB="http://tpl.photomon.com/Product/clipart20120430/thumb/",PM.URL.STICKER_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.URL.FRAME_THUMB="http://tpl.photomon.com/Product/clipart20120430/thumb/",PM.URL.FRAME_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.URL.EDIT_INFO="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_productbook_div_utf8.asp?",PM.CONFIG.SCALE_MIN=.3,PM.CONFIG.SCALE_MAX=2,PM.CONFIG.CANVAS_MARGIN_W=120,PM.CONFIG.CANVAS_MARGIN_H=120,PM.CONFIG.PHOTO_MIN_DPI=150,PM.CONFIG.GRID_COLOR="#777777",PM.CONFIG.GRID_LINEW=.5,PM.CONFIG.GRID_SPACE=10,PM.CONFIG.CONTROLLER_RADIUS=8,PM.CONFIG.CROP_RADIUS=22,PM.CONFIG.PHOTO_MAX=25,PM.CONFIG.GUIDE_COLOR="#ff0000",PM.CONFIG.GUIDE_LINEW=1,PM.CONFIG.GUIDE_EXTRA=32,PM.CONFIG.GUIDE_FONT="16px Nanum Gothic",PM.CONFIG.GUIDE_FONT_H=16,PM.CONFIG.GUIDE_TEXT_COLOR="#000000",PM.CONFIG.GUIDE_TEXT_MARGIN=10,PM.CONFIG.GUIDE_LEATHERCOVER_TEXT="커버내 사각홈에 보여지는 사진은 실제 제작시 1~3mm 정도 오차가 발생할 수 있습니다.",PM.CONFIG.PROLOG_FONT="16pt Nanum Gothic",PM.CONFIG.PROLOG_COLOR="#bbbbbb",PM.CONFIG.PROLOG_TEXT="인쇄되지 않는 페이지입니다.",PM.CONFIG.BOOT_FONT="14pt Nanum Gothic",PM.CONFIG.BOOT_COLOR="#bbbbbb",PM.CONFIG.BOOT_LOADING_MSG="상품정보를 불러오는 중...",PM.CONFIG.BOOT_FAILURE_MSG="상품정보를 정상적으로 불러오지 못했습니다.",PM.CONFIG.BOOT_LOADING=0,PM.CONFIG.BOOT_SUCCESS=1,PM.CONFIG.BOOT_FAILURE=-1,PM.CONFIG.MESSAGE_ONLINE="인터넷이 연결되었습니다.",PM.CONFIG.MESSAGE_OFFLINE="인터넷이 연결되지 않았습니다.",PM.CONFIG.MESSAGE_CANNOT_ADD="추가를 할 수 없습니다.",PM.CONFIG.MESSAGE_CHECK_IME="macOS에서는 영문모드 상태에서만 입력 가능합니다. (영문모드 상태에서 Shift+Space로 한/영 전환)",PM.CONFIG.MESSAGE_CHECK_TEXT_LEN="글상자의 내용이 범위를 넘어섭니다. 글꼴 크기를 줄이거나 글 내용을 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE="글상자의 크기가 범위를 넘어섭니다. 글상자의 크기를 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA="인쇄되지 않는 페이지를 침범한 레이어 영역은 인쇄되지 않습니다.",PM.CONFIG.MESSAGE_CHECK_SPINE_AREA="커버의 책등(세네카)영역과 겹치지 않게 편집해 주십시오.",PM.CONFIG.MESSAGEBAR_TIMEOUT=3e3,PM.CONFIG.MESSAGEBAR_FONT="10pt Nanum Gothic",PM.CONFIG.MESSAGEBAR_TEXTCOLOR="#111111",PM.CONFIG.MESSAGEBAR_BACKCOLOR="#ffff00",PM.CONFIG.MESSAGEBAR_HEIGHT=30,PM.CONFIG.ROUNDMASK_IMAGE="http://tpl.photomon.com/Product/clipart20120430/edit/frame_diagram_56.png",PM.CONFIG.FRAME_EMPTY_IMAGE="frame_diagram_delete.png",PM.CONFIG.COVER_BARCODE_IMAGE="./images/common/cover_barcode.jpg",PM.CONFIG.PAGE_GRADATION_IMAGE="./images/common/page_gradation.png",PM.CONFIG.PHOTO_EMPTY_IMAGE="./images/common/photo_empty.png",PM.CONFIG.PHOTO_WARNING_IMAGE="./images/common/photo_warning.png",PM.CONFIG.FONT_DEFAULT="Nanum Gothic",PM.CONFIG.FONT_POOL=["BM Dohyeon","BM Hanna","BM Jua","Jeju Gothic","Jeju Myeongjo","Jeju Hallasan","KoPub Batang","Nanum Barun Gothic","Nanum Barun Gothic Light","Nanum Barun Pen","Nanum Gothic","Nanum Myeongjo","Nanum Pen Script","Nanum Brush Script","Nanum Square","Noto Sans KR","Seoul Hangang","Seoul Namsan","TDc Ballerina","TDc Bearnrabbit","TDc Bigeyes","TDc Childheart","TDc Donkiprince","TDc Donkiround","TDc Pororomc","TDc Poundingheart","TDc Todayweather","TDc Valentine"],PM.CONFIG.FONT_PATH={"BM Dohyeon":"./webfont/kor/bmdohyeon.css","BM Hanna":"./webfont/kor/bmhanna.css","BM Jua":"./webfont/kor/bmjua.css","Jeju Gothic":"./webfont/kor/jejugothic.css","Jeju Myeongjo":"./webfont/kor/jejumyeongjo.css","Jeju Hallasan":"./webfont/kor/jejuhallasan.css","KoPub Batang":"./webfont/kor/kopubbatang.css","Nanum Barun Gothic":"./webfont/kor/nanumbarungothic.css","Nanum Barun Gothic Light":"./webfont/kor/nanumbarungothic-light.css","Nanum Barun Pen":"./webfont/kor/nanumbarunpen.css","Nanum Gothic":"./webfont/kor/nanumgothic.css","Nanum Myeongjo":"./webfont/kor/nanummyeongjo.css","Nanum Pen Script":"./webfont/kor/nanumsonpen.css","Nanum Brush Script":"./webfont/kor/nanumsonbrush.css","Nanum Square":"./webfont/kor/nanumsquare.css","Noto Sans KR":"./webfont/kor/notosanskr.css","Seoul Hangang":"./webfont/kor/seoulhangang.css","Seoul Namsan":"./webfont/kor/seoulnamsan.css","TDc Ballerina":"./webfont/kor/tdc_ballerina.css","TDc Bearnrabbit":"./webfont/kor/tdc_bearnrabbit.css","TDc Bigeyes":"./webfont/kor/tdc_bigeyes.css","TDc Childheart":"./webfont/kor/tdc_childheart.css","TDc Donkiprince":"./webfont/kor/tdc_donkiprince.css","TDc Donkiround":"./webfont/kor/tdc_donkiround.css","TDc Pororomc":"./webfont/kor/tdc_pororomc.css","TDc Poundingheart":"./webfont/kor/tdc_poundingheart.css","TDc Todayweather":"./webfont/kor/tdc_todayweather.css","TDc Valentine":"./webfont/kor/tdc_valentine.css"},PM.COLOR_PAGE_BORDER="rgba(0, 255, 0, 0.5)",PM.COLOR_PAGE_FOCUS_STROKE="rgba(0, 255, 255, 0.5)",PM.COLOR_LAYER_STROKE="rgba(0,0,0,0.5)",PM.COLOR_LAYER_FILL="rgba(0,0,0,0.1)",PM.COLOR_TBOX_WARNING_FILL="rgba(255,255,0,0.5)",PM.COLOR_DRAGGER_FOCUS_STROKE="rgba(255,0,0,1.0)",PM.COLOR_DRAGGER_FOCUS_FILL="rgba(255,100,100,0.6)",PM.COLOR_DRAGGER_NORMAL_STROKE="rgba(0,0,0,0.5)",PM.COLOR_DRAGGER_NORMAL_FILL="rgba(80,190,240,0.6)",PM.TBOX_COMMENT_DEFAULT="내용을 입력해 주십시오",PM.Codi=new function(){var t=[[{m:152,s:36},{m:162,s:46},{m:174,s:58},{m:186,s:70},{m:206,s:90},{m:0,s:0}],[{m:121,s:29},{m:130,s:38},{m:140,s:48},{m:148,s:56},{m:164,s:72},{m:0,s:0}],[{m:131,s:31},{m:142,s:42},{m:152,s:52},{m:162,s:62},{m:180,s:80},{m:0,s:0}],[{m:118,s:28},{m:126,s:51},{m:135,s:63},{m:144,s:75},{m:159,s:96},{m:0,s:0}],[{m:92,s:22},{m:98,s:28},{m:106,s:36},{m:112,s:42},{m:124,s:54},{m:0,s:0}],[{m:105,s:30},{m:117,s:43},{m:128,s:53},{m:138,s:64},{m:150,s:76},{m:0,s:0}],[{m:102,s:29},{m:113,s:41},{m:126,s:51},{m:134,s:61},{m:148,s:73},{m:0,s:0}]],e=[[{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:65},{m:90,s:88},{m:0,s:0}],[{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:71,s:69},{m:0,s:0}],[{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:23,s:22},{m:30,s:29},{m:38,s:36},{m:45,s:44},{m:52,s:50},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],i=[[{m:28,s:26},{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:75},{m:0,s:0}],[{m:21,s:19},{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:21,s:20},{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:0,s:0}],[{m:22,s:20},{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:16,s:14},{m:23,s:22},{m:30,s:36},{m:38,s:36},{m:45,s:44},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],r=[[0,0,0],[112,118,0],[121,128,0],[108,114,0],[84,89,0],[88,94,0],[87,92,0]],o=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[11,17,20,26,0],[8,12,16,20,0],[0,0,0,0,0],[0,0,0,0,0]],a=[28,22,24,22,17,17,17],s=[20,15,16,15,12,12,12],n=[0,0,0,5,5,5,5],h=[0,22,24,22,17,17,17],l=[0,0,0,15,12,0,0],p=[{dx:18,dy:9},{dx:14,dy:7},{dx:14,dy:7},{dx:14,dy:7},{dx:10,dy:5},{dx:10,dy:5},{dx:10,dy:5}],c=[{x:489,y:566,w:78,h:40},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],d=[{x:519,y:577,w:84,h:42},{x:381,y:595,w:66,h:33},{x:558,y:443,w:66,h:33},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:547,y:446,w:62,h:26},{x:502,y:582,w:100,h:41}],u=[{x:0,y:0,w:0,h:0},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],_=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}];this.GetProductSizeIndex=function(t){var e=t.toLowerCase(),i=-1;switch(e){case"6x6":i=PM.SIZE6X6;break;case"6x8":case"a5h":i=PM.SIZE6X8;break;case"8x6":case"a5w":i=PM.SIZE8X6;break;case"8x8":i=PM.SIZE8X8;break;case"8x11":case"a4h":i=PM.SIZE8X11;break;case"11x8":case"a4w":i=PM.SIZE11X8;break;case"10x10":i=PM.SIZE10X10}return i},this.GetPageBlockIndex=function(t,e,i){if("layflat"==t){if(21>=i)return 0;if(31>=i)return 1;if(41>=i)return 2;if(51>=i)return 3;if(61>=i)return 4}else if("design"==t)if("soft"==e){if(45>=i)return 0;if(65>=i)return 1;if(83>=i)return 2;if(101>=i)return 3}else{if(61>=i)return 0;if(81>=i)return 1}return-1},this.GetGuideInfo=function(g,f,P,y,m,v){var M=this.GetPageBlockIndex(f,y,v),C=0,w=0,E=PM.Util.ProductSize2SizeId(P),x=p[E].dx,k=p[E].dy,R=null,I=0>=g;if("layflat"==f)if("soft"==y){var T="yes"==m||"y"==m;C=T?e[E][M].m:i[E][M].m,w=T?e[E][M].s:i[E][M].s,I&&(x=s[E],k=x),R=d[E]}else"hard"==y?(C=t[E][M].m,w=t[E][M].s,I&&(x=a[E],k=x),R=c[E]):"acrylic"==y?(C=0,I&&(x=n[E],k=x),R={x:0,y:0,w:0,h:0}):(C=0,I&&(x=k=0),R={x:0,y:0,w:0,h:0});else"soft"==y?(C=o[E][M],I&&(x=l[E],k=x),R=_[E]):"hard"==y||"pad"==y?(C=r[E][M],I&&(x=h[E],k=x),R=u[E]):(C=0,I&&(x=k=0),R={x:0,y:0,w:0,h:0});return{cut_w:x,cut_h:k,middle_w:C,spine_w:w,barcode_rect:R}}},PM.Core.Layer=function(){this.gid="",this.require=!1,this.movelock=!1,this.resizelock=!1,this.zorderlock=!1,this.removelock=!1,this.xpos=0,this.ypos=0,this.width=0,this.height=0,this.radian=0},PM.Core.Layer.prototype.CopyProperty=function(t){return t.gid=this.gid,t.require=this.require,t.movelock=this.movelock,t.resizelock=this.resizelock,t.removelock=this.removelock,t.xpos=this.xpos,t.ypos=this.ypos,t.width=this.width,t.height=this.height,t.radian=this.radian,t},PM.Core.Layer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian}},PM.Core.Layer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian},PM.Core.Layer.prototype.IsEqualMoveInfo=function(t){return this.xpos==t.xpos&&this.ypos==t.ypos&&this.width==t.width&&this.height==t.height&&this.radian==t.radian},PM.Core.Layer.prototype.PrepareDC=function(t,e,i){t.save(),t.translate(e+this.xpos,i+this.ypos),this.radian&&(t.translate(this.width/2,this.height/2),t.rotate(this.radian),t.translate(-this.width/2,-this.height/2))},PM.Core.Layer.prototype.ReleaseDC=function(t){t.restore()},PM.Core.Layer.prototype.GetType=function(){return this.type},PM.Core.Layer.prototype.GetRect=function(){return{l:this.xpos,t:this.ypos,w:this.width,h:this.height}},PM.Core.Layer.prototype.GetCenterPos=function(){return{x:this.xpos+this.width/2,y:this.ypos+this.height/2}},PM.Core.Layer.prototype.NonRotatedPoint=function(t,e,i,r){var o=-this.radian;return this.GetRotatePoint(o,t,e,i,r)},PM.Core.Layer.prototype.GetRotatePoint=function(t,e,i,r,o){var a={x:r,y:o};return t&&(a.x=(r-e)*Math.cos(t)-(o-i)*Math.sin(t)+e,a.y=(r-e)*Math.sin(t)+(o-i)*Math.cos(t)+i),a},PM.Core.Layer.prototype.GetRotateInnerPoints=function(t,e){var i=[];return i.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos)),i.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos)),i.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos+this.height)),i.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos+this.height)),i},PM.Core.Layer.prototype.Points2OutRect=function(t){if(4!=t.length)return{l:0,t:0,w:0,h:0};var e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),i=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),r=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),o=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y));return{l:e,t:i,w:r-e,h:o-i}},PM.Core.Layer.prototype.GetOutRect=function(){var t=this.xpos+this.width/2,e=this.ypos+this.height/2,i=this.GetRotateInnerPoints(t,e),r=this.Points2OutRect(i);return r},PM.Core.Layer.prototype.DrawExtra=function(t,e){PM.DEBUG&&(PM.Editor.Framework.IsPreviewMode()||(t.font="12px Nanum Gothic",t.fillStyle="#ff0000",t.textAlign="center",t.textBaseline="middle",t.fillText(e,10,10,30)))},PM.Core.Layer.prototype.DrawHighlight=function(t,e,i){this.PrepareDC(t,e,i),PM.Util.DrawRect(t,0,0,this.width,this.height,1.5,"yellow",null),this.ReleaseDC(t)},PM.Core.Layer.prototype.DrawController=function(t,e,i,r){this.PrepareDC(t,e,i);var o=PM.Editor.Framework.IsShiftState(),a=1,s=r?PM.COLOR_DRAGGER_FOCUS_STROKE:PM.COLOR_DRAGGER_NORMAL_STROKE;if(PM.Util.DrawDashRect(t,0,0,this.width,this.height,a,s,null),!r){var n=0,h=0,l=PM.CONFIG.CONTROLLER_RADIUS,p=PM.COLOR_DRAGGER_NORMAL_FILL;if(!this.movelock&&!o){var c=this.resizelock?0:-l;PM.Util.DrawDashLine(t,this.width/2,-30+l,this.width/2,c,1,s)}n=this.width/2,h=-30,this.movelock||o||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=this.width/2,h=0,this.resizelock||o||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=this.width,h=this.height/2,this.resizelock||o||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=this.width/2,h=this.height,this.resizelock||o||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=0,h=this.height/2,this.resizelock||o||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=0,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=this.width,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=this.width,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,p),n=0,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,p)}this.ReleaseDC(t)},PM.Core.Layer.prototype.HitTest=function(t,e,i){var r=this.xpos+this.width/2,o=this.ypos+this.height/2,a=this.NonRotatedPoint(r,o,e,i),s=this.GetRect();return PM.Util.PtInRect(s,a.x,a.y)?this:null},PM.Core.Layer.prototype.HitTestController=function(t,e,i){var r=PM.Editor.Framework.IsShiftState(),o=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(o,a,e,i),n=this.GetRect(),h=PM.CONFIG.CONTROLLER_RADIUS;return o=n.l+this.width/2,a=n.t-30,this.movelock||r||!PM.Util.PtInCircle(o,a,h,s.x,s.y)?(o=n.l+this.width/2,a=n.t+0,this.resizelock||r||!PM.Util.PtInCircle(o,a,h,s.x,s.y)?(o=n.l+this.width,a=n.t+this.height/2,this.resizelock||r||!PM.Util.PtInCircle(o,a,h,s.x,s.y)?(o=n.l+this.width/2,a=n.t+this.height,this.resizelock||r||!PM.Util.PtInCircle(o,a,h,s.x,s.y)?(o=n.l+0,a=n.t+this.height/2,this.resizelock||r||!PM.Util.PtInCircle(o,a,h,s.x,s.y)?(o=n.l+0,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(o,a,h,s.x,s.y)?PM.HIT.RESIZE_LT:(o=n.l+this.width,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(o,a,h,s.x,s.y)?PM.HIT.RESIZE_RT:(o=n.l+this.width,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(o,a,h,s.x,s.y)?PM.HIT.RESIZE_RB:(o=n.l+0,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(o,a,h,s.x,s.y)?PM.HIT.RESIZE_LB:PM.Util.PtInRect(n,s.x,s.y)?PM.HIT.MOVE:PM.HIT.NONE)))):PM.HIT.RESIZE_L):PM.HIT.RESIZE_B):PM.HIT.RESIZE_R):PM.HIT.RESIZE_T):PM.HIT.ROTATE},PM.Core.Layer.prototype.Move=function(t,e,i,r){if(!this.movelock){var o=i-t,a=r-e;this.xpos+=o,this.ypos+=a}},PM.Core.Layer.prototype.ResizeToFixedRate=function(t,e,i,r,o){var a=0,s=this.width,n=this.height;Math.abs(e)>Math.abs(i)?(n=s*o/r,a=this.height-n,this.height=n,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_RT)&&(this.ypos+=a)):(s=n*r/o,a=this.width-s,this.width=s,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_LB)&&(this.xpos+=a))},PM.Core.Layer.prototype.Resize=function(t,e,i,r,o){if(!this.resizelock){var a=PM.Editor.Framework.IsShiftState(),s=this.xpos+this.width/2,n=this.ypos+this.height/2,h=this.NonRotatedPoint(s,n,e,i),l=this.NonRotatedPoint(s,n,r,o),p=this.width,c=this.height,d=l.x-h.x,u=l.y-h.y;switch(t){case PM.HIT.RESIZE_T:this.height-u>=30&&(this.ypos+=u,this.height-=u);break;case PM.HIT.RESIZE_B:this.height+u>=30&&(this.height+=u);break;case PM.HIT.RESIZE_L:this.width-d>=30&&(this.xpos+=d,this.width-=d);break;case PM.HIT.RESIZE_R:this.width+d>=30&&(this.width+=d);break;case PM.HIT.RESIZE_LT:this.width-d>=30&&this.height-u>=30&&(this.xpos+=d,this.width-=d,this.ypos+=u,this.height-=u,a&&this.ResizeToFixedRate(t,d,u,p,c));break;case PM.HIT.RESIZE_RT:this.width+d>=30&&this.height-u>=30&&(this.width+=d,this.ypos+=u,this.height-=u,a&&this.ResizeToFixedRate(t,d,u,p,c));break;case PM.HIT.RESIZE_RB:this.width+d>=30&&this.height+u>=30&&(this.width+=d,this.height+=u,a&&this.ResizeToFixedRate(t,d,u,p,c));break;case PM.HIT.RESIZE_LB:this.width-d>=30&&this.height+u>=30&&(this.xpos+=d,this.width-=d,this.height+=u,a&&this.ResizeToFixedRate(t,d,u,p,c))}this.RecalcXY(s,n)}},PM.Core.Layer.prototype.RecalcXY=function(t,e){if(this.radian){var i=this.GetRotateInnerPoints(t,e),r=this.Points2OutRect(i),o=r.l+r.w/2,a=r.t+r.h/2,s=this.NonRotatedPoint(o,a,i[0].x,i[0].y);this.xpos=s.x,this.ypos=s.y}},PM.Core.Layer.prototype.Rotate=function(t,e,i,r){if(!this.movelock){var o=this.xpos+this.width/2,a=this.ypos+this.height/2;t-=o,i-=o,e=a-e,r=a-r;var s=Math.atan2(t,e),n=Math.atan2(i,r);0>s&&(s=2*Math.PI+s),0>n&&(n=2*Math.PI+n),this.radian+=n-s,this.radian<0&&(this.radian+=2*Math.PI),this.radian>2*Math.PI&&(this.radian-=2*Math.PI)}},PM.Core.Layer.prototype.RotateAngle=function(t){if(this.movelock)return!1;if(90!=t&&-90!=t)return!1;var e=PM.Util.ToAngle(this.radian);0>e&&(e+=360),e>=360&&(e-=360),t>0?90>e?e=0:180>e?e=90:270>e?e=180:360>e&&(e=270):e=e>0&&90>=e?90:e>90&&180>=e?180:e>180&&270>=e?270:360;
var i=e+t;return 0>i&&(i+=360),i>=360&&(i-=360),this.radian=PM.Util.ToRadian(i),!0},PM.Core.Layer.prototype.Parse=function(t){var e=this;e.gid=t.attr("gid").toLowerCase(),e.require="true"===t.attr("require"),e.movelock="true"===t.attr("movelock"),e.resizelock="true"===t.attr("resizelock"),e.zorderlock="true"===t.attr("zorderlock"),e.removelock="true"===t.attr("removelock"),$layer_rect=t.find("rect"),e.xpos=parseFloat($layer_rect.attr("x")),e.ypos=parseFloat($layer_rect.attr("y")),e.width=parseFloat($layer_rect.attr("width")),e.height=parseFloat($layer_rect.attr("height"));var i=parseFloat($layer_rect.attr("angle"));if(0>i&&(i+=360),i>360&&(i-=360),"spine"!=e.gid&&0!=i){var r=e.xpos,o=e.ypos,a=PM.Util.ToRadian(i),s=[];s.push(e.GetRotatePoint(a,r,o,e.xpos,e.ypos)),s.push(e.GetRotatePoint(a,r,o,e.xpos+e.width,e.ypos)),s.push(e.GetRotatePoint(a,r,o,e.xpos,e.ypos+e.height)),s.push(e.GetRotatePoint(a,r,o,e.xpos+e.width,e.ypos+e.height));var n=e.Points2OutRect(s),h=n.l+n.w/2,l=n.t+n.h/2;e.xpos=h-e.width/2,e.ypos=l-e.height/2,e.radian=a}else e.radian=PM.Util.ToRadian(i);e.radian<0&&(e.radian+=2*Math.PI),e.radian>2*Math.PI&&(e.radian-=2*Math.PI),e.movelock=e.resizelock=e.zorderlock=e.removelock="spine"==e.gid?!0:!1},PM.Core.Layer.prototype.LoadJson=function(t){return this.gid=t.gid,this.require=t.require,this.movelock=t.movelock,this.resizelock=t.resizelock,this.zorderlock=t.zorderlock,this.removelock=t.removelock,this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,!0},PM.Core.Layer.prototype.SaveJson=function(){var t="\n";t+='        "gid": "'+this.gid+'"',t+=', "require": '+this.require,t+=', "movelock": '+this.movelock,t+=', "resizelock": '+this.resizelock,t+=', "zorderlock": '+this.zorderlock,t+=', "removelock": '+this.removelock,t+=', "xpos": '+this.xpos,t+=', "ypos": '+this.ypos,t+=', "width": '+this.width,t+=', "height": '+this.height,t+=', "radian": '+this.radian;var e=this.GetOutRect();return t+=', "out_x": '+e.l,t+=', "out_y": '+e.t,t+=', "out_w": '+e.w,t+=', "out_h": '+e.h},PM.Core.IconLayer=function(){PM.Core.Layer.call(this),this.alpha=255,this.icon="",this.icon_image=null},PM.Core.IconLayer.prototype=new PM.Core.Layer,PM.Core.IconLayer.prototype.GetType=function(){return PM.TYPE.ICON},PM.Core.IconLayer.prototype.GetDesc=function(){return"스티커"},PM.Core.IconLayer.prototype.Load=function(){var t=$.Deferred(),e=this,i=e.icon,r=PM.Util.LoadImage(i);return r.done(function(i){e.icon_image=i,(e.width<=0||e.height<=0)&&(e.width=e.icon_image.width,e.height=e.icon_image.height),t.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.IconLayer.Load: "+i),t.reject()}),t.promise()},PM.Core.IconLayer.prototype.Draw=function(t,e,i,r){this.PrepareDC(t,e,i),null!=this.icon_image&&(t.globalAlpha=this.alpha/255,t.drawImage(this.icon_image,0,0,this.width,this.height),t.globalAlpha=1),this.DrawExtra(t,r),this.ReleaseDC(t)},PM.Core.IconLayer.prototype.GetDrawItemList=function(){return"\n[icon] "+this.icon},PM.Core.IconLayer.prototype.HitTest=function(t,e,i){return PM.Core.Layer.prototype.HitTest.call(this,t,e,i)?this:null},PM.Core.IconLayer.prototype.SetAlpha=function(t,e,i){if(this.alpha=e,i){var r=PM.Editor.Framework.GetPairNumber(),o=PM.Editor.Framework.GetSelectedPageIndex(),a=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(PM.RECORD_ICON_OPACITY,r,{page_pos:o,layer_pos:a,data:t},{page_pos:o,layer_pos:a,data:e},"스티커 투명도")}},PM.Core.IconLayer.prototype.GetAlpha=function(){return this.alpha},PM.Core.IconLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.alpha=parseInt(t.attr("alpha")),$layer_file=t.find("file");var e=$layer_file.text();e&&e.length>0&&(this.icon=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e))},PM.Core.IconLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.alpha=t.alpha,this.icon=t.icon;var i=this,r=this.Load();return r.done(function(){e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.IconLayer.LoadJson: "+i.icon),e.reject()}),e.promise()},PM.Core.IconLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.ICON,t+='\n        , "alpha": '+this.alpha,t+='\n        , "icon": "'+this.icon+'"',t+="\n        }"},PM.Core.ImageLayer=function(){PM.Core.Layer.call(this),this.diagram="",this.diagram_image=null,this.special="",this.special_image=null,this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,this.is_low=!1},PM.Core.ImageLayer.prototype=new PM.Core.Layer,PM.Core.ImageLayer.prototype.GetType=function(){return PM.TYPE.IMAGE},PM.Core.ImageLayer.prototype.GetDesc=function(){return"사진틀"},PM.Core.ImageLayer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian,extra:this.GetCropInfo()}},PM.Core.ImageLayer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,this.SetCropInfo(t.extra)},PM.Core.ImageLayer.prototype.GetCropInfo=function(){return{crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetCropInfo=function(t){this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h},PM.Core.ImageLayer.prototype.IsEqualCropInfo=function(t){return this.crop_x==t.crop_x&&this.crop_y==t.crop_y&&this.crop_w==t.crop_w&&this.crop_h==t.crop_h},PM.Core.ImageLayer.prototype.RecordState=function(t,e,i,r){var o=PM.Editor.Framework.GetPairNumber(),a=PM.Editor.Framework.GetSelectedPageIndex(),s=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(t,o,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:i},r)},PM.Core.ImageLayer.prototype.GetPhotoState=function(){return{photo:this.photo,photo_org:this.photo_org,original_w:this.original_w,original_h:this.original_h,photo_angle:this.photo_angle,flip_x:this.flip_x,flip_y:this.flip_y,crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetPhotoState=function(t){this.photo=t.photo,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var e=$.Deferred(),i=this.Load();return i.done(function(){e.resolve()}),i.fail(function(){console.log("* Fail:PM.Core.ImageLayer.SetPhotoState: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SetSharedImageInfo=function(t){"leather"==this.gid&&"leather"==t.gid&&(this.width=t.width,this.height=t.height,this.radian=t.radian,this.photo=t.photo,this.photo_image=t.photo_image,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h,this.is_low=t.is_low)},PM.Core.ImageLayer.prototype.GetSpecialFromDiagram=function(t){if(t.indexOf("_special_")>=0){var e=t.replace(".png","_cut.png");return e}return""},PM.Core.ImageLayer.prototype.Load=function(){var t=$.Deferred(),e=this,i=PM.Util.LoadImage(e.diagram);i.done(function(t){e.diagram_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),i.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(diagram): "+e.diagram)}),e.special=this.GetSpecialFromDiagram(e.diagram);var r=PM.Util.LoadImage(e.special);r.done(function(t){e.special_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(special): "+e.special)});var o=PM.Util.LoadImage(e.photo);return o.done(function(t){if(e.flip_x||e.flip_y){var i=0;e.Flip(t,e.flip_x,e.flip_y,i,function(t){e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):e.photo_image=t})}else e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):(e.photo_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0))}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(photo): "+e.photo)}),$.when(i,o).then(function(){(e.crop_w<=0||e.crop_h<=0)&&e.FitPhoto(!1),t.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.Load Failure "),t.reject()}),t.promise()},PM.Core.ImageLayer.prototype.AddDiagram=function(t){var e=$.Deferred(),i=this,r=PM.Util.LoadImage(t);r.done(function(e){i.diagram=t,i.diagram_image=e}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(diagram): "+i.diagram)});var o=this.GetSpecialFromDiagram(t),a=PM.Util.LoadImage(o);return a.done(function(t){i.special=o,i.special_image=t}),a.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(special): "+i.special)}),$.when(r,a).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.AddDiagram Failure "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.DeleteDiagram=function(){this.diagram="",this.diagram_image=null,this.special="",this.special_image=null},PM.Core.ImageLayer.prototype.AddPhoto=function(t,e,i,r,o){if(!o&&this.photo.length>0)return{added:!1,promise:null};var a=$.Deferred(),s=this,n=PM.Util.LoadImage(t);return s.photo=t,n.done(function(t){s.photo_image=t,s.photo_org=e,s.original_w=parseInt(i),s.original_h=parseInt(r),s.photo_angle=0,s.flip_x=!1,s.flip_y=!1,s.FitPhoto(!1),a.resolve(),"leather"==s.gid&&PM.Editor.Framework.SetSharedImageInfo(s)}),n.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddPhoto(photo): "+s.photo),a.reject()}),{added:!0,promise:a.promise()}},PM.Core.ImageLayer.prototype.DeletePhoto=function(){if(!(this.photo.length<=0)){var t=[],e=[],i={type:this.GetType(),value:this.GetPhotoState()};t.push(i),this.DeletePhotoProp();var r={type:this.GetType(),value:this.GetPhotoState()};e.push(r),this.RecordState(PM.RECORD_PHOTO_CHANGE,t,e,"사진 삭제")}},PM.Core.ImageLayer.prototype.DeletePhotoProp=function(){if(this.photo.length<=0)return!1;var t=this.photo;return this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,t.length>0&&"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),!0},PM.Core.ImageLayer.prototype.ValidatePhotoBoundary=function(){this.photo_image&&(this.crop_x<0&&(this.crop_x=0),this.crop_y<0&&(this.crop_y=0),this.crop_x+this.crop_w>this.photo_image.width&&(this.crop_x=this.photo_image.width-this.crop_w),this.crop_y+this.crop_h>this.photo_image.height&&(this.crop_y=this.photo_image.height-this.crop_h))},PM.Core.ImageLayer.prototype.MoveCrop=function(t,e,i,r){if(this.photo_image){var o=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(o,a,t,e),n=this.NonRotatedPoint(o,a,i,r),h=n.x-s.x,l=n.y-s.y;this.crop_x-=h,this.crop_y-=l,this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this)}},PM.Core.ImageLayer.prototype.FitPhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),i=PM.Util.GetScaledRect(this.width,this.height,this.photo_image.width,this.photo_image.height,!1);this.crop_x=i.l,this.crop_y=i.t,this.crop_w=i.w,this.crop_h=i.h,"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var r=this.GetCropInfo();t&&this.RecordState(PM.RECORD_PHOTO_CROP,e,r,"사진 화면맞춤")}},PM.Core.ImageLayer.prototype.ScalePhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),i=this.crop_w*t,r=this.crop_h*t;if(this.crop_w-i>this.photo_image.width||this.crop_h-r>this.photo_image.height){var o=this.crop_x,a=this.crop_y;this.FitPhoto(!1),this.crop_x=o,this.crop_y=a}else this.crop_x+=i/2,this.crop_y+=r/2,this.crop_w-=i,this.crop_h-=r;this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var s=this.GetCropInfo();this.RecordState(PM.RECORD_PHOTO_CROP,e,s,t>0?"사진 확대":"사진 축소")}},PM.Core.ImageLayer.prototype.Resize=function(t,e,i,r,o){var a=this.width,s=this.height;if(PM.Core.Layer.prototype.Resize.call(this,t,e,i,r,o),this.photo_image){var n=this.width-a,h=this.height-s,l=n/a,p=h/s;if(this.crop_w+=this.crop_w*l,this.crop_h+=this.crop_h*p,this.crop_w>this.photo_image.width||this.crop_h>this.photo_image.height){var c=this.crop_x,d=this.crop_y;this.FitPhoto(!1),this.crop_x=c,this.crop_y=d}this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution()}},PM.Core.ImageLayer.prototype.RotatePhoto=function(t){if(this.photo_image&&(90==t||-90==t)){var e=this;this.RotatePhotoRightAngle(this.photo_image,t,function(i){var r=[],o=[],a={type:e.GetType(),value:e.GetPhotoState()};r.push(a),e.photo_image=i,e.photo_angle+=t,e.photo_angle<0&&(e.photo_angle+=360),e.photo_angle>=360&&(e.photo_angle-=360),e.FitPhoto(!1),"leather"==e.gid&&PM.Editor.Framework.SetSharedImageInfo(e);var s={type:e.GetType(),value:e.GetPhotoState()};o.push(s),e.RecordState(PM.RECORD_PHOTO_CHANGE,r,o,"사진 회전")})}},PM.Core.ImageLayer.prototype.RotatePhotoRightAngle=function(t,e,i){var r=$.Deferred();if(!t)return r.resolve();var o=document.createElement("canvas"),a=o.getContext("2d");90==e||-90==e||270==e?(o.width=t.height,o.height=t.width):(o.width=t.width,o.height=t.height),a.translate(o.width/2,o.height/2),a.rotate(e*Math.PI/180),a.translate(-o.width/2,-o.height/2);var s=o.width/2-t.width/2,n=o.height/2-t.height/2;a.drawImage(t,s,n);var h=this,l=PM.Util.CanvasToImage(o),p=PM.Util.LoadImage(l);return p.done(function(t){i(t),r.resolve(),"leather"==h.gid&&PM.Editor.Framework.SetSharedImageInfo(h)}),p.fail(function(){console.log("* Fail:PM.Core.ImageLayer.RotatePhoto: "+e),r.reject()}),r.promise()},PM.Core.ImageLayer.prototype.FlipPhoto=function(t,e){if(this.photo_image){var i=this;this.Flip(this.photo_image,t,e,this.photo_angle,function(r){var o=[],a=[],s={type:i.GetType(),value:i.GetPhotoState()};o.push(s),i.photo_image=r,t&&(i.flip_x=!i.flip_x),e&&(i.flip_y=!i.flip_y),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this);var n={type:i.GetType(),value:i.GetPhotoState()};a.push(n),i.RecordState(PM.RECORD_PHOTO_CHANGE,o,a,"사진 플립")})}},PM.Core.ImageLayer.prototype.Flip=function(t,e,i,r,o){var a=$.Deferred();if(!t)return a.resolve();var s=document.createElement("canvas"),n=s.getContext("2d");if(s.width=t.width,s.height=t.height,90==r||-90==r||270==r){var h=e;e=i,i=h}var l=0,p=0,c=1,d=1;e&&(l=s.width,c=-1),i&&(p=s.height,d=-1),n.translate(l,p),n.scale(c,d),n.drawImage(t,0,0);var u=this,_=PM.Util.CanvasToImage(s),g=PM.Util.LoadImage(_);return g.done(function(t){o(t),a.resolve(),"leather"==u.gid&&PM.Editor.Framework.SetSharedImageInfo(u)}),g.fail(function(){console.log("* Fail:PM.Core.ImageLayer.FlipPhoto"),a.reject()}),a.promise()},PM.Core.ImageLayer.prototype.DrawController=function(t,e,i,r){if(PM.Core.Layer.prototype.DrawController.call(this,t,e,i,r),this.photo_image&&!PM.Editor.Framework.IsShiftState()){this.PrepareDC(t,e,i);var o=1,a=PM.COLOR_DRAGGER_NORMAL_STROKE,s=PM.COLOR_DRAGGER_NORMAL_FILL,n=PM.CONFIG.CROP_RADIUS,h=this.width/2,l=this.height/2;PM.Util.DrawCircle(t,h,l,n,o,a,s),this.ReleaseDC(t)}},PM.Core.ImageLayer.prototype.Draw=function(t,e,i,r){if(this.PrepareDC(t,e,i),t.beginPath(),t.rect(0,0,this.width,this.height),t.clip(),this.diagram_image){var o=document.createElement("canvas"),a=o.getContext("2d");if(o.width=this.width,o.height=this.height,a.drawImage(this.diagram_image,0,0,this.width,this.height),this.photo_image)a.globalCompositeOperation="source-atop",a.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height),this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(o,0,0,this.width,this.height);else if(PM.Editor.Framework.IsPreviewMode())this.special_image&&t.drawImage(this.special_image,0,0,this.width,this.height);else{var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);a.globalCompositeOperation="source-atop",a.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(o,0,0,this.width,this.height)}}else if(this.photo_image)t.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height);else if(!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);t.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}else PM.Util.DrawRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,PM.COLOR_LAYER_FILL)}if(this.is_low&&this.photo_image&&!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_warning_image;s&&t.drawImage(s,this.width-s.width,0,s.width,s.height)}if(this.DrawExtra(t,r),PM.DEBUG&&!PM.Editor.Framework.IsPreviewMode()){t.font="20px Nanum Gothic",t.fillStyle="#5555ff",t.strokeStyle="#ff0000",t.textAlign="center",t.textBaseline="middle";var h="("+this.original_w+"x"+this.original_h+")";t.fillText(h,this.width/2,20,this.width),t.strokeText(h,this.width/2,20,this.width)}this.ReleaseDC(t)},PM.Core.ImageLayer.prototype.GetDrawItemList=function(){return"\n[mask] "+this.diagram+", [photo] "+this.photo},PM.Core.ImageLayer.prototype.HitTestController=function(t,e,i){var r=PM.Core.Layer.prototype.HitTestController.call(this,t,e,i);if(r==PM.HIT.MOVE&&this.photo_image&&!PM.Editor.Framework.IsShiftState()){var o=PM.CONFIG.CROP_RADIUS,a=this.xpos+this.width/2,s=this.ypos+this.height/2,n=this.NonRotatedPoint(a,s,e,i);if(PM.Util.PtInCircle(a,s,o,n.x,n.y))return PM.HIT.MOVE_CROP}return r},PM.Core.ImageLayer.prototype.HitTest=function(t,e,i){return PM.Core.Layer.prototype.HitTest.call(this,t,e,i)?this:null},PM.Core.ImageLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),$layer_effect=t.find("effect");var e=$layer_effect.attr("diagramfilename");e&&e.length>0?this.diagram=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e):(e=$layer_effect.attr("rotateflip"),e&&"roundmask"==e&&(this.diagram=PM.CONFIG.ROUNDMASK_IMAGE))},PM.Core.ImageLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.diagram=t.diagram,this.diagram_image=null,this.photo=t.photo,this.photo_image=null,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var i=this.Load();return i.done(function(){e.resolve()}),i.fail(function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.IMAGE,t+='\n        , "diagram": "'+this.diagram+'"',t+='\n        , "photo_org": "'+this.photo_org+'"',t+='\n        , "original_w": '+this.original_w,t+='\n        , "original_h": '+this.original_h,t+='\n        , "photo": "'+this.photo+'"',t+='\n        , "photo_angle": '+this.photo_angle,t+='\n        , "photo_width": '+(this.photo_image?this.photo_image.width:0),t+='\n        , "photo_height": '+(this.photo_image?this.photo_image.height:0),t+='\n        , "flip_x": '+this.flip_x,t+='\n        , "flip_y": '+this.flip_y,t+='\n        , "crop_x": '+this.crop_x,t+='\n        , "crop_y": '+this.crop_y,t+='\n        , "crop_w": '+this.crop_w,t+='\n        , "crop_h": '+this.crop_h,t+="\n        }"},PM.Core.ImageLayer.prototype.IsLowResolution=function(){var t=PM.Editor.Framework.GetProduct().product_size,e=PM.Editor.Framework.GetCurrentPairSize(),i=PM.Util.ProductSize2InchSize(t),r=i.w*PM.CONFIG.PHOTO_MIN_DPI*2*i.h*PM.CONFIG.PHOTO_MIN_DPI,o=this.width*this.height/(e.w*e.h),a=r*o,s=this.photo_image.width*this.photo_image.height,n=this.original_w*this.original_h,h=n/s,l=this.crop_w*this.crop_h*h;return a>l},PM.Core.ImageLayer.prototype.Test=function(t,e,i,r){if(null!=t&&(0!=e||0!=i||0!=r)){var o=this,a=new PM.Lib.SeqManager;(i||r)&&a.Add(function(e){o.Flip(t,i,r,0,function(i){t=i,console.log("flip"),e.deferred.resolve()})}),e&&a.Add(function(i){o.RotatePhotoRightAngle(t,e,function(e){t=e,console.log("rotate"),i.deferred.resolve()})}),a.Run(function(){o.photo_image=t,o.photo_angle=e,o.flip_x=i,o.flip_y=r,o.FitPhoto(!1),console.log("end...")},function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: ")})}},PM.Core.TextLayer=function(){PM.Core.Layer.call(this),this.halign="center",this.valign="middle",this.caption="",this.textdata="",this.fontname="",this.fontsize=14,this.italic=!1,this.bold=!1,this.color="",this.bkcolor="",this.chargap=0,this.linegap=0,this.tbox=new PM.Ctrl.TextBox},PM.Core.TextLayer.prototype=new PM.Core.Layer,PM.Core.TextLayer.prototype.GetType=function(){return PM.TYPE.TEXT},PM.Core.TextLayer.prototype.GetDesc=function(){return"글상자"},PM.Core.TextLayer.prototype.InitTBox=function(t){t.tbox.setfontdefault(t.fontname,t.fontsize,t.color,t.bold,t.italic),t.tbox.setparadefault(t.halign,0,t.linegap),t.tbox.setimemode(!0),t.tbox.setvalign(t.valign,PM.RECORD_OFF),"spine"==t.gid&&(t.tbox.setsingleline(!0),t.tbox.setvalign("middle",PM.RECORD_OFF),t.tbox.setspine(!0)),t.tbox.SetSize(t.width,t.height),t.tbox.SetMinHeight(t.height),t.textdata.length>0&&t.tbox.IsEmptyDoc()&&t.tbox.fromString(t.textdata)},PM.Core.TextLayer.prototype.Load=function(){var t=$.Deferred();return(this.width<=0||this.height<=0)&&(this.width=200,this.height=40),this.InitTBox(this),t.resolve(),t.promise()},PM.Core.TextLayer.prototype.ResizeFromTBoxCallback=function(t,e){if(!this.resizelock&&this.tbox){var i=this.xpos+this.width/2,r=this.ypos+this.height/2;this.height=e>=30?e:30,this.RecalcXY(i,r),this.tbox.SetSize(this.width,this.height)}},PM.Core.TextLayer.prototype.Resize=function(t,e,i,r,o){PM.Core.Layer.prototype.Resize.call(this,t,e,i,r,o),this.tbox.SetSize(this.width,this.height),this.tbox.SetMinHeight(this.height)},PM.Core.TextLayer.prototype.RecalcTBoxSize=function(t){this.tbox&&(this.tbox.edit_w=this.width,this.tbox.updateall(t))},PM.Core.TextLayer.prototype.AdjustSize=function(){this.height<this.tbox.getheight()&&(this.height=this.tbox.getheight(),this.tbox.SetSize(this.width,this.height))},PM.Core.TextLayer.prototype.SelectAll=function(){this.tbox&&this.tbox.selectAll()},PM.Core.TextLayer.prototype.GetEditableTextBox=function(){return this.tbox?this.tbox:null},PM.Core.TextLayer.prototype.ResetFocus=function(){this.tbox&&(this.textdata=this.tbox.toString(),this.tbox.killfocus())},PM.Core.TextLayer.prototype.Undo=function(t){return this.tbox?this.tbox.undo_action(t):!1},PM.Core.TextLayer.prototype.Redo=function(t){return this.tbox?this.tbox.redo_action(t):!1},PM.Core.TextLayer.prototype.KeyDown=function(t){return this.tbox.KeyDown(t)},PM.Core.TextLayer.prototype.KeyPress=function(t){return this.tbox.KeyPress(t)},PM.Core.TextLayer.prototype.NormalizePoint=function(t,e){t-=this.xpos,e-=this.ypos;var i=this.width/2,r=this.height/2;return this.NonRotatedPoint(i,r,t,e)},PM.Core.TextLayer.prototype.MouseDown=function(t,e,i,r){var o=this.NormalizePoint(i,r);this.tbox.MouseDown(t,e,o.x,o.y)},PM.Core.TextLayer.prototype.MouseMove=function(t,e,i){var r=this.NormalizePoint(e,i);this.tbox.MouseMove(t,r.x,r.y)},PM.Core.TextLayer.prototype.MouseUp=function(t,e,i){var r=this.NormalizePoint(e,i);this.tbox.MouseUp(t,r.x,r.y)},PM.Core.TextLayer.prototype.Draw=function(t,e,i,r){if(!PM.Editor.Framework.IsPreviewMode()||!this.tbox.IsEmptyDoc()){if(this.PrepareDC(t,e,i),t.canvas.id==PM.Core.MAIN_CANVAS_ID)if(this.textdata.length<=0&&!this.tbox.isfocus()){PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null);var o="";o=this.bold?"bold ":"",o+=this.italic?"italic ":"",o+=this.fontsize+"pt ",o+=PM.Util.GetWebFont(this.fontname),t.font=o,t.fillStyle=this.color,t.textAlign="center",t.textBaseline="middle",t.fillText(this.caption,this.width/2,this.height/2,this.width)}else PM.Editor.Framework.IsPreviewMode()||PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null),this.tbox.Draw(t);else this.tbox.Draw(t);this.DrawExtra(t,r),this.ReleaseDC(t)}},PM.Core.TextLayer.prototype.GetDrawItemList=function(){return""},PM.Core.TextLayer.prototype.HitTestController=function(t,e,i){var r=PM.Core.Layer.prototype.HitTestController.call(this,t,e,i);return this.tbox.isfocus()&&(r=r==PM.HIT.MOVE?PM.HIT.EDIT_TEXT:PM.HIT.NONE),r},PM.Core.TextLayer.prototype.HitTest=function(t,e,i){return PM.Core.Layer.prototype.HitTest.call(this,t,e,i)?this:null},PM.Core.TextLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.halign=t.attr("halign"),this.valign=t.attr("valign"),this.caption=t.find("caption").text(),this.textdata=t.find("text").text(),this.textdata.length>0?this.textdata.indexOf(PM.TBOX_COMMENT_DEFAULT)>=0?(this.caption=this.textdata,this.textdata=""):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata=""),$layer_font=t.find("fontinfo");var e=$layer_font.attr("fontname");e=PM.Util.GetWebFont(e),PM.Util.LoadWebFont(e,function(){}),this.fontname=e,this.fontsize=parseInt($layer_font.attr("fontsize")),this.italic="true"===$layer_font.attr("italic"),this.bold="true"===$layer_font.attr("bold"),this.color=PM.Util.String2HexColor($layer_font.attr("color")),this.bkcolor=PM.Util.String2HexColor($layer_font.attr("bkcolor")),this.chargap=parseFloat($layer_font.attr("chargap")),this.linegap=parseFloat($layer_font.attr("linegap")),this.fontsize=Math.floor(6*this.fontsize/8),this.bkcolor="",this.chargap=0,this.linegap=0},PM.Core.TextLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.halign=t.halign,this.valign=t.valign,this.caption=t.caption,this.textdata=t.textdata;var i=PM.Util.GetWebFont(t.fontname);return PM.Util.LoadWebFont(i,function(){console.log("[load-json] webfont loaded... "+i+" "+Date.now())}),this.fontname=i,this.fontsize=t.fontsize,this.italic=t.italic,this.bold=t.bold,this.color=t.color,this.bkcolor=t.bkcolor,this.chargap=t.chargap,this.linegap=t.linegap,this.tbox=new PM.Ctrl.TextBox,this.InitTBox(this),this.tbox.LoadJson(t.tbox_info),e.resolve(),e.promise()},PM.Core.TextLayer.prototype.LoadJsonAtPos=function(t,e,i){var r=JSON.parse(i);this.LoadJson(r),this.xpos=t,this.ypos=e},PM.Core.TextLayer.prototype.SaveJson=function(){this.textdata=this.tbox.toString();var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.TEXT,t+='\n        , "halign": "'+this.halign+'"',t+='\n        , "valign": "'+this.valign+'"',t+='\n        , "caption": "'+this.caption+'"',t+='\n        , "textdata": "'+this.textdata+'"',t+='\n        , "fontname": "'+this.fontname+'"',t+='\n        , "fontsize": '+this.fontsize,t+='\n        , "italic": '+this.italic,t+='\n        , "bold": '+this.bold,t+='\n        , "color": "'+this.color+'"',t+='\n        , "bkcolor": "'+this.bkcolor+'"',t+='\n        , "chargap": '+this.chargap,t+='\n        , "linegap": '+this.linegap,t+='\n        , "tbox_info": \n',t+=this.tbox.SaveJsonEx(),t+="\n        }"},PM.Core.Layout=function(){this.style="normal",this.kind="",this.type="",this.imgcnt=0,this.link="",this.thumb=""},PM.Core.Layout.prototype.copy=function(){var t=new PM.Core.Layout;return t.style=this.style,t.kind=this.kind,t.type=this.type,t.imgcnt=this.imgcnt,t.link=this.link,t.thumb=this.thumb,t},PM.Core.Skin=function(){this.kind="",this.type="",this.link="",this.thumb="",this.storecode=""},PM.Core.Skin.prototype.copy=function(){var t=new PM.Core.Skin;return t.kind=this.kind,t.type=this.type,t.link=this.link,t.thumb=this.thumb,t.storecode=this.storecode,t},PM.Core.Cover=function(){this.back_page=new PM.Core.Page,this.middle_page=new PM.Core.Page,this.front_page=new PM.Core.Page},PM.Core.Cover.prototype.Load=function(){var t=$.Deferred(),e=this.back_page?this.back_page.Load():$.Deferred().resolve(),i=this.middle_page?this.middle_page.Load():$.Deferred().resolve(),r=this.front_page?this.front_page.Load():$.Deferred().resolve();return $.when(e,i,r).then(function(){t.resolve()},function(){t.reject()}),t.promise()},PM.Core.Cover.prototype.GetSpineWidth=function(){if(this.middle_page)for(var t=0;t<this.middle_page.layer_array.length;t++){var e=this.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.height}return 0},PM.Core.Cover.prototype.SetSpineWidth=function(t){if(this.middle_page)for(var e=0;e<this.middle_page.layer_array.length;e++){var i=this.middle_page.layer_array[e];i.GetType()==PM.TYPE.TEXT&&(t>0&&(i.height=t,i.tbox.SetSize(i.width,i.height)),i.xpos=this.middle_page.width/2-i.width/2,i.ypos=this.middle_page.height/2-i.height/2)}},PM.Core.Cover.prototype.LoadJson=function(t){return t.back_page&&void 0!=t.back_page&&this.back_page.LoadJson(t.back_page),t.middle_page&&void 0!=t.middle_page?this.middle_page.LoadJson(t.middle_page):this.middle_page=null,t.front_page&&void 0!=t.front_page?this.front_page.LoadJson(t.front_page):this.front_page=null,!0},PM.Core.Cover.prototype.SaveJson=function(){var t="\n   { ";return this.back_page&&(t+='\n   "back_page": ',t+=this.back_page.SaveJson(),this.middle_page&&(t+='\n,  "middle_page": ',t+=this.middle_page.SaveJson()),this.front_page&&(t+='\n,  "front_page": ',t+=this.front_page.SaveJson())),t+="\n   }"},PM.Core.Cover.prototype.CheckComplete=function(){if(this.back_page){if(!this.back_page.CheckComplete())return!1;if(this.middle_page&&!this.middle_page.CheckComplete())return!1;if(this.front_page&&!this.front_page.CheckComplete())return!1}return!0},PM.Core.Page=function(){this.layout_kind="",this.layout_type="",this.layout_link="",this.layout_style="normal",this.skin_kind="",this.skin_type="",this.skin_link="",this.skin_storecode="",this.is_layer_lock=!1,this.width=0,this.height=0,this.color="",this.layer_array=[],this.skin_image=null,this.work_pos={}},PM.Core.Page.prototype.SetLayoutInfo=function(t){t&&(this.layout_kind=t.kind,this.layout_type=t.type,this.layout_link=t.link,this.layout_style=t.style)},PM.Core.Page.prototype.SetSkinInfo=function(t){t&&(this.skin_kind=t.kind,this.skin_type=t.type,this.skin_link=t.link,this.skin_storecode=t.storecode)},PM.Core.Page.prototype.CopyProperty=function(){var t=new PM.Core.Page;return t.layout_kind=this.layout_kind,t.layout_type=this.layout_type,t.layout_link=this.layout_link,t.layout_style=this.layout_style,t.skin_kind=this.skin_kind,t.skin_type=this.skin_type,t.skin_link=this.skin_link,t.skin_storecode=this.skin_storecode,t.width=this.width,t.height=this.height,t.color=this.color,t.layer_array=[],t.skin_image=this.skin_image,t.work_pos.x=this.work_pos.x,t.work_pos.y=this.work_pos.y,t},PM.Core.Page.prototype.GetDefaultDummyLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h_bg.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"w_bg.xml":PM.URL.LAYOUT_FILE+"s_bg.xml"},PM.Core.Page.prototype.GetDefaultPageLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h01f001.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"W01f001.xml":PM.URL.LAYOUT_FILE+"s_01f097.xml"},PM.Core.Page.prototype.CreateDefaultPage=function(){var t=this.CopyProperty();t.layout_link=this.GetDefaultPageLink(t);var e=new PM.Core.ImageLayer;return t.layer_array.push(e),e.xpos=0,e.ypos=0,e.width=t.width,e.height=t.height,t},PM.Core.Page.prototype.Load=function(){var t=this,e=$.Deferred(),i=PM.Util.LoadXml(t.layout_link),r=PM.Util.LoadImage(t.skin_link);return i.done(function(e){t.Parse(e)}),i.fail(function(){console.log("* Fail:PM.Core.Page.Load(layout_xml): "+t.layout_link)
}),r.done(function(e){t.skin_image=e}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(skin_image): "+t.skin_link)}),$.when(i,r).then(function(){var i=t.LoadLayers(t);i.done(function(){e.resolve()}),i.fail(function(){console.log("* Fail:PM.Core.Page.Load(LoadLayers) ")})},function(){console.log("-----------> PM.Core.Page.Load Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.LoadLayers=function(t){for(var e=$.Deferred(),i=[],r=0;r<t.layer_array.length;r++){var o=t.layer_array[r];i.push(o.Load())}return $.when.apply($,i).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadLayers Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.IsLayerLock=function(){return this.is_layer_lock},PM.Core.Page.prototype.SetLayersLockInfo=function(t){this.is_layer_lock=t;for(var e=0;e<this.layer_array.length;e++){var i=this.layer_array[e];i.movelock=t,i.resizelock=t,i.zorderlock=t,i.removelock=t,i.GetType()==PM.TYPE.TEXT&&i.tbox&&(i.resizelock?(i.tbox.setautoresize(!1),i.tbox.SetSize(i.width,i.height),i.tbox.SetMinHeight(i.height)):i.tbox.setautoresize(!0))}},PM.Core.Page.prototype.SetSharedImageInfo=function(t){for(var e=0;e<this.layer_array.length;e++){var i=this.layer_array[e];if(i&&i!=t&&i.GetType()==PM.TYPE.IMAGE&&"leather"==i.gid){i.SetSharedImageInfo(t);break}}},PM.Core.Page.prototype.ChangeColor=function(t){this.color=t,this.skin_link="",this.skin_storecode="",this.skin_image=null;var e=$.Deferred();return e.resolve()},PM.Core.Page.prototype.ChangeSkin=function(t){var e=this,i=$.Deferred(),r=PM.Util.LoadImage(t);return r.done(function(r){e.skin_link=t,e.skin_image=r,i.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.Page.ChangeSkin(skin_image): "+t),i.reject()}),i.promise()},PM.Core.Page.prototype.ChangeLayout=function(t,e,i){var r=this,o=$.Deferred(),a=PM.Util.LoadXml(t);return a.done(function(a){r.layout_link=t;var s=$(a).find("foreground").find("rect");if(null!=s){var n=r.width/r.height,h=parseInt(s.attr("width"))/parseInt(s.attr("height"));if(n-h==0){var l=null==e?r.GetUserImageList():e,p=null==i?r.color:i;r.Parse(a);var c=r.LoadLayers(r);c.done(function(){r.color=p;var t=r.AddPhotos(l,0).promise;t.done(function(){o.resolve()}),t.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers>AddPhotos) ")})}),c.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers) "),o.reject()})}else o.reject()}}),a.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(layout_xml): "+t),o.reject()}),o.promise()},PM.Core.Page.prototype.GetLayerIndex=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e])return e;return-1},PM.Core.Page.prototype.AddLayerOrderly=function(t){var e=0,i=this.layer_array.length;if(t.GetType()==PM.TYPE.IMAGE){for(;i>e&&this.layer_array[e].GetType()==PM.TYPE.IMAGE;)e++;this.layer_array.splice(e,0,t)}else if(t.GetType()==PM.TYPE.ICON){for(;i>e&&(this.layer_array[e].GetType()==PM.TYPE.IMAGE||this.layer_array[e].GetType()==PM.TYPE.ICON);)e++;this.layer_array.splice(e,0,t)}else this.layer_array.push(t)},PM.Core.Page.prototype.AddNewLayer=function(t,e,i,r){var o=this,a=$.Deferred(),s=i.Load();return s.done(function(){o.AddLayerOrderly(i);var s=i.width,n=i.height;!r&&s>o.width/4&&(s=o.width/4,n=s*i.height/i.width),i.width=s,i.height=n,i.xpos=t-o.work_pos.x-i.width/2,i.ypos=e-o.work_pos.y-i.height/2,a.resolve()}),s.fail(function(){console.log("* Fail:PM.Core.Page.AddNewLayer "),a.reject()}),a.promise()},PM.Core.Page.prototype.AddLayerAndLoad=function(t){this.AddLayerOrderly(t),t.Load()},PM.Core.Page.prototype.AddLayer=function(t){this.AddLayerOrderly(t)},PM.Core.Page.prototype.RemoveLayer=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e]){this.layer_array.splice(e,1);break}},PM.Core.Page.prototype.SwapLayer=function(t,e,i){if(0>e||e>=t.length)return-1;if(0>i||i>=t.length)return-1;if(t[e].GetType()!=t[i].GetType())return-1;var r=t[e];return t[e]=t[i],t[i]=r,i},PM.Core.Page.prototype.RotateLayer=function(t,e){return t?t.RotateAngle(e):!1},PM.Core.Page.prototype.UpLayer=function(t){for(var e=-1,i=0;i<this.layer_array.length;i++)if(t==this.layer_array[i]){e=this.SwapLayer(this.layer_array,i,i+1);break}return e},PM.Core.Page.prototype.DownLayer=function(t){for(var e=-1,i=0;i<this.layer_array.length;i++)if(t==this.layer_array[i]){e=this.SwapLayer(this.layer_array,i,i-1);break}return e},PM.Core.Page.prototype.ResetFocus=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];e.GetType()==PM.TYPE.TEXT&&e.ResetFocus()}},PM.Core.Page.prototype.AddPhotos=function(t,e){var i=e,r=[],o=[],a=$.Deferred();if(i>=0&&i<t.length)for(var s=0;s<this.layer_array.length;s++)try{var n=t[i],h=JSON.parse(n),l=this.layer_array[s];if(l&&l.GetType()==PM.TYPE.IMAGE){var p="",c="",d=0,u=0;void 0==h.url_domain?(p=h.edit_link,c=h.org_link,d=h.original_width,u=h.original_height):(p=h.url_domain+h.url_path+h.url_edit,c=h.url_domain+h.url_path+h.url_file,d=h.img_width,u=h.img_height);var _=!1,g=l.AddPhoto(p,c,d,u,_);g.added&&(i++,r.push({page_pos:-1,layer_pos:s,json:n}),o.push(g.promise))}}catch(f){i++,console.error(f)}finally{if(i>=t.length){i=-1;break}}else i=-1;return o.length>0?$.when.apply($,o).then(function(){a.resolve()},function(){a.reject()}):a.resolve(),{next_idx:i,result_photos:r,promise:a.promise()}},PM.Core.Page.prototype.DeletePhotos=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var i=this.layer_array[e];if(i&&i.GetType()==PM.TYPE.IMAGE){var r={page_pos:-1,layer_pos:e,info:i.GetPhotoState()};i.DeletePhotoProp()&&t.push(r)}}return t},PM.Core.Page.prototype.GetUserImageList=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var i=this.layer_array[e];if(i&&i.GetType()==PM.TYPE.IMAGE&&i.photo.length>0&&i.photo_org.length>0){var r="{";r+='"edit_link": "'+i.photo+'"',r+=', "org_link": "'+i.photo_org+'"',r+=', "original_width": '+i.original_w,r+=', "original_height": '+i.original_h,r+="}",t.push(r)}}return t},PM.Core.Page.prototype.GetImageLayerCount=function(){for(var t=0,e=0;e<this.layer_array.length;e++){var i=this.layer_array[e];i&&i.GetType()==PM.TYPE.IMAGE&&t++}return t},PM.Core.Page.prototype.GetWorkRect=function(){var t="layflat"==this.layout_style?2*this.width:this.width;return{l:this.work_pos.x,t:this.work_pos.y,w:t,h:this.height}},PM.Core.Page.prototype.HitTestLayers=function(t,e,i){e-=this.work_pos.x,i-=this.work_pos.y;for(var r=this.layer_array.length-1;r>=0;r--){var o=this.layer_array[r].HitTest(t,e,i);if(o)return o}return null},PM.Core.Page.prototype.DrawBackground=function(t,e,i){if(t.save(),this.color&&this.color.length>0&&(t.fillStyle=this.color,t.fillRect(e,i,this.width,this.height)),null!=this.skin_image){var r=this.width/this.height,o=this.skin_image.width/this.skin_image.height;if(r-o==0)t.drawImage(this.skin_image,e,i,this.width,this.height);else{var a=PM.Util.GetScaledRect(this.width,this.height,this.skin_image.width,this.skin_image.height,!1);t.drawImage(this.skin_image,a.l,a.t,a.w,a.h,e,i,this.width,this.height)}}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.work_pos.x=e,this.work_pos.y=i),t.restore()},PM.Core.Page.prototype.DrawLayers=function(t,e,i,r){t.save();for(var o=0;o<this.layer_array.length;o++){var a=this.layer_array[o];(r==PM.TYPE.UNKNOWN||r==a.GetType())&&a.Draw(t,e,i,o)}t.restore()},PM.Core.Page.prototype.DrawBorder=function(t,e,i){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.strokeStyle=PM.COLOR_PAGE_BORDER,t.strokeRect(e,i,this.width,this.height),t.restore())},PM.Core.Page.prototype.DrawProlog=function(t,e,i){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.font=PM.CONFIG.PROLOG_FONT,t.fillStyle=PM.CONFIG.PROLOG_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(PM.CONFIG.PROLOG_TEXT,e,i),t.restore())},PM.Core.Page.prototype.GetDrawItemList=function(){var t="\n[skin] "+this.skin_link,e=[];e.push(t);for(var i=0;i<this.layer_array.length;i++)e.push(this.layer_array[i].GetDrawItemList());return e},PM.Core.Page.prototype.Parse=function(t){var e=this;e.layer_array=[];var i=$(t).find("foreground").find("rect");if(null==i)return!1;e.width=parseInt(i.attr("width")),e.height=parseInt(i.attr("height"));var r=$(t).find("pagefileargb");if(null==r)return!1;e.color=PM.Util.ToHexColor(r.attr("r"),r.attr("g"),r.attr("b"));var o=$(t).find("layer").find("maskimage");o.find("maskrect").each(function(){var t=new PM.Core.ImageLayer;e.AddLayerOrderly(t),t.type=0,t.Parse($(this))}),$(t).find("iconinfo").each(function(){var t=new PM.Core.IconLayer;e.AddLayerOrderly(t),t.type=1,t.Parse($(this))}),$(t).find("textinfo").each(function(){var t=new PM.Core.TextLayer;e.AddLayerOrderly(t),t.type=2,t.Parse($(this))})},PM.Core.Page.prototype.LoadJson=function(t){var e=$.Deferred(),i=[];this.layout_kind=t.layout_kind,this.layout_type=t.layout_type,this.layout_link=t.layout_link,this.layout_style=t.layout_style,this.skin_kind=t.skin_kind,this.skin_type=t.skin_type,this.skin_link=t.skin_link,this.skin_storecode=t.skin_storecode,this.width=t.width,this.height=t.height,this.color=t.color,this.layer_array=[];for(var r in t.layer_array){var o=null;switch(t.layer_array[r].type){case PM.TYPE.ICON:o=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:o=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:o=new PM.Core.TextLayer}o&&(this.layer_array.push(o),i.push(o.LoadJson(t.layer_array[r])))}var a=this,s=PM.Util.LoadImage(a.skin_link);return s.done(function(t){a.skin_image=t}),s.fail(function(){console.log("* Fail:PM.Core.Page.LoadJson(skin_image): "+a.skin_link)}),i.push(s),$.when.apply($,i).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadJson Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.SaveJson=function(){var t="\n    {";t+='\n    "layout_kind": "'+this.layout_kind+'"',t+='\n    , "layout_type": "'+this.layout_type+'"',t+='\n    , "layout_link": "'+this.layout_link+'"',t+='\n    , "layout_style": "'+this.layout_style+'"',t+='\n    , "skin_kind": "'+this.skin_kind+'"',t+='\n    , "skin_type": "'+this.skin_type+'"',t+='\n    , "skin_link": "'+this.skin_link+'"',t+='\n    , "skin_storecode": "'+this.skin_storecode+'"',t+='\n    , "width": '+this.width,t+='\n    , "height": '+this.height,t+='\n    , "color": "'+this.color+'"',t+='\n    , "layer_array": [';for(var e=0;e<this.layer_array.length;e++)t+=this.layer_array[e].SaveJson(),e<this.layer_array.length-1&&(t+="\n    ,");return t+="\n    ]",t+="\n    }"},PM.Core.Page.prototype.CheckComplete=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];if(e&&e.GetType()==PM.TYPE.IMAGE&&e.photo.length<=0)return!1}return!0},PM.Core.Product=function(){this.user_id="",this.session_id="",this.add_param="",this.product_code="",this.product_key="",this.product_name="",this.product_size="",this.product_type="",this.cover_type="",this.surface_type="",this.price=0,this.price_page=0,this.min_page=0,this.max_page=0,this.theme_depth1="",this.theme_depth2="",this.theme_name="",this.style_id="",this.cover_layout_id="",this.cover_skin_id="",this.page_layout_id="",this.page_skin_id="",this.cover=null,this.prolog=null,this.page_array=[],this.basket_name="",this.order_code="",this.is_complete=!1,this.work_pos={x:0,y:0},this.clipboard_memory="",this.keep_photos=null,this.dragger=new PM.Ctrl.Dragger,this.move_state=null},PM.Core.Product.prototype.PreProcess=function(t){var e=t.cover?t.cover.back_page:null,i=t.page_array[0];"leather"==t.cover_type?"design"==t.product_type?(e.SetLayersLockInfo(!0),i.SetLayersLockInfo(!0)):"layflat"==t.product_type&&e.SetLayersLockInfo(!0):"napura"==t.cover_type&&e.SetLayersLockInfo(!0)},PM.Core.Product.prototype.IsHoleLeatherCoverProduct=function(){return"design"==this.product_type&&"leather"==this.cover_type},PM.Core.Product.prototype.SetSharedImageInfo=function(t){this.IsHoleLeatherCoverProduct()&&(this.cover&&this.cover.back_page&&this.cover.back_page.SetSharedImageInfo(t),this.page_array[0]&&this.page_array[0].SetSharedImageInfo(t))},PM.Core.Product.prototype.Load=function(t){PM.Editor.Framework.Ready(PM.CONFIG.BOOT_LOADING);var e=PM.URL.EDIT_INFO+"depth1="+this.theme_depth1+"&depth2="+this.theme_depth2+"&productOption1="+this.product_key+"&addParam="+this.add_param;this.product_size=this.product_size.toLowerCase(),this.product_type=this.product_type.toLowerCase(),this.cover_type=this.cover_type.toLowerCase(),this.surface_type=this.surface_type.toLowerCase(),this.keep_photos=t;var i=this,r=PM.Util.LoadXml(e);r.done(function(t){i.Parse(t),i.LoadPages(i)}),r.fail(function(t,i){alert("* Fail PM.Core.Product.Load: "+i+":"+e)})},PM.Core.Product.prototype.LoadPages=function(t){var e=[];t.cover&&e.push(t.cover.Load()),t.prolog&&e.push(t.prolog.Load());for(var i=0;i<t.page_array.length;i++)e.push(t.page_array[i].Load());$.when.apply($,e).then(function(){t.PreProcess(t),t.LoadComplete(),null!=t.keep_photos&&t.AddPhotosPerPage(t.keep_photos),"layflat"!=t.product_type||"no"!=t.surface_type&&"n"!=t.surface_type||t.ResetSpine();for(var e="#ffffff",i=0;i<t.page_array.length;i++){var r=t.page_array[i];r.skin_link.length<=0&&r.color.length<=0&&(r.color=e),e=r.color}},function(){t.LoadFailure()})},PM.Core.Product.prototype.LoadComplete=function(){console.log("Load Complete................................................."),console.log(navigator.userAgent),this.cover&&(this.dragger.middle_page=this.cover.middle_page),this.page_array.length>=this.min_page?(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_SUCCESS),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(0,"success")):(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-2,"insufficient pages"))},PM.Core.Product.prototype.LoadFailure=function(){console.log("Load Failure.................................................."),PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"load failed")},PM.Core.Product.prototype.SwapPages=function(t,e){var i=this.PairCount();if(t>=i||e>=i)return!1;var r=this.Pair2PageIndex(t),o=this.Pair2PageIndex(e);if(0>r||0>o)return!1;var a=this.page_array[r],s=this.page_array[r+1];return this.page_array[r]=this.page_array[o],this.page_array[r+1]=this.page_array[o+1],this.page_array[o]=a,this.page_array[o+1]=s,!0},PM.Core.Product.prototype.ReorderPages=function(t,e){if(!e||e.length<=0)return!1;if(this.PairCount()!=e.length)return!1;var i=[],r=[],o=0;null!=this.cover&&o++,null!=this.prolog&&(o++,i.push(this.page_array[0]),r.push(0));for(var a=o;a<e.length;a++){var s=this.Pair2PageIndex(e[a]);i.push(this.page_array[s]),i.push(this.page_array[s+1]),r.push(s),r.push(s+1)}return this.page_array=i,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success"),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_REORDER,t,null,{page_pos:-1,layer_pos:-1,data:r},"페이지 순서 변경"),!0},PM.Core.Product.prototype.AddPages=function(t,e){var i=this.GetInnerPageCount();if(i>=this.max_page)return PM.ADDPAGE_LIMIT_ERROR;i+2*e>this.max_page&&(e=(this.max_page-i)/2);var r=!1;0>t&&(r=!0,t=this.PairCount()-1);for(var o=this.Pair2PageIndex(t);0>o;){if(t++,t>=this.PairCount())return PM.ADDPAGE_FAIL;o=this.Pair2PageIndex(t)}for(var a=this.page_array[o].CreateDefaultPage(),s=this.page_array[o+1].CreateDefaultPage(),n=r?o+2:o,h=[],l=0;e>l;l++)h.splice(0,0,a,s),a=a.CreateDefaultPage(),s=s.CreateDefaultPage();if(h.length>0){for(var l=0;l<h.length;l++)this.page_array.splice(n,0,h[l]);this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_INSERT,t,null,{page_pos:n,layer_pos:-1,data:h},"페이지 추가")}return t},PM.Core.Product.prototype.DeletePages=function(t,e){var i=this.GetInnerPageCount();if(i<=this.min_page)return PM.DELPAGE_LIMIT_ERROR;i-2*e<this.min_page&&(e=(i-this.min_page)/2);var r=!1;0>t&&(r=!0,t=this.PairCount()-e);var o=this.Pair2PageIndex(t);if(0>o)return PM.DELPAGE_FAIL;var a=this.page_array.slice(o,o+2*e);return this.page_array.splice(o,2*e),this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_DELETE,t,{page_pos:o,layer_pos:-1,data:a},null,"페이지 삭제"),PM.DELPAGE_SUCCESS},PM.Core.Product.prototype.IsAvailableSpine=function(){return this.cover&&this.cover.middle_page},PM.Core.Product.prototype.IsEmptySpine=function(){if(this.cover&&this.cover.middle_page)for(var t=0;t<this.cover.middle_page.layer_array.length;t++){var e=this.cover.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.tbox.IsEmptyDoc()}return!1},PM.Core.Product.prototype.ResetSpine=function(){if(this.cover&&this.cover.middle_page){var t=PM.Codi.GetGuideInfo(0,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount());if(void 0!=t.middle_w&&t.middle_w>0){var e=this.cover.middle_page.width,i=t.middle_w;e!=i&&(PM.Editor.Framework.ShowMessageBar("커버의 책등(세네카) 크기가 변경되었습니다. 커버의 편집 내용을 다시 확인해 주십시오."),this.cover.middle_page.width=i,this.SetSpineWidth(t.spine_w))}}},PM.Core.Product.prototype.GetSpineWidth=function(){return this.cover?this.cover.GetSpineWidth():0},PM.Core.Product.prototype.SetSpineWidth=function(t){this.cover&&this.cover.SetSpineWidth(t)},PM.Core.Product.prototype.DeleteLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),i=this.GetPageIndex(t),r=t.GetLayerIndex(e),o=[],a=[],s=PM.RECORD_LAYER_DELETE,n={type:e.GetType(),value:$.extend(!0,{},e)};if(o.push(n),this.dragger.DeleteLayer()){var h=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(s,h,{page_pos:i,layer_pos:r,data:o},{page_pos:i,layer_pos:r,data:a},e.GetDesc()+" 삭제")}},PM.Core.Product.prototype.RotateLayer=function(t){var e=this.dragger.GetSelectedPage(),i=this.dragger.GetSelectedLayer(),r=this.GetPageIndex(e),o=e.GetLayerIndex(i),a=i.GetMoveInfo();if(this.dragger.RotateLayer(t)){var s=PM.Editor.Framework.GetPairNumber();return this.CheckBoundary(s),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,s,{page_pos:r,layer_pos:o,data:a},{page_pos:r,layer_pos:o,data:i.GetMoveInfo()},"레이어 90도 단위 회전"),!0}return!1},PM.Core.Product.prototype.UpLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),i=this.GetPageIndex(t),r=t.GetLayerIndex(e),o=this.dragger.UpLayer();if(o>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:i,layer_pos:r,data:null},{page_pos:i,layer_pos:o,data:null},"레이어 앞으로 이동"),!0}return!1},PM.Core.Product.prototype.DownLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),i=this.GetPageIndex(t),r=t.GetLayerIndex(e),o=this.dragger.DownLayer();if(o>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:i,layer_pos:r,data:null},{page_pos:i,layer_pos:o,data:null},"레이어 뒤로 이동"),!0}return!1},PM.Core.Product.prototype.AddPhotosPerPage=function(t){var e=[];if(this.cover&&this.cover.back_page&&!this.IsHoleLeatherCoverProduct()){var i=0,r=this.cover.back_page.AddPhotos(t[0],i);if(e.push(r.promise),this.cover.middle_page){var i=0,r=this.cover.middle_page.AddPhotos(t[1],i);e.push(r.promise)}if(this.cover.front_page){var i=0,r=this.cover.front_page.AddPhotos(t[2],i);e.push(r.promise)}}if(this.prolog,this.page_array.length>0)for(var o=3,a=0;a<this.page_array.length;a++){var i=0,r=this.page_array[a].AddPhotos(t[o++],i);if(e.push(r.promise),o>=t.length)break}var s=this;$.when.apply($,e).then(function(){s.AddPhotosComplete(),s.keep_photos=null},function(){s.AddPhotosFailure()})},PM.Core.Product.prototype.AppendResultPhotos=function(t,e,i){if(e.length<=0)return t;for(var r=0;r<e.length;r++)e[r].page_pos=i;return t.concat(e)},PM.Core.Product.prototype.AddPhotos=function(t){var e=0,i=[],r=[];if(this.cover&&this.cover.back_page&&!this.IsHoleLeatherCoverProduct()){var o=this.cover.back_page.AddPhotos(t,e);if(e=o.next_idx,r.push(o.promise),i=this.AppendResultPhotos(i,o.result_photos,PM.PAGE.COVER_BACK),e>=0&&this.cover.middle_page){var o=this.cover.middle_page.AddPhotos(t,e);e=o.next_idx,r.push(o.promise),i=this.AppendResultPhotos(i,o.result_photos,PM.PAGE.COVER_MIDDLE)}if(e>=0&&this.cover.front_page){var o=this.cover.front_page.AddPhotos(t,e);e=o.next_idx,r.push(o.promise),i=this.AppendResultPhotos(i,o.result_photos,PM.PAGE.COVER_FRONT)}}if(e>=0&&this.prolog){var o=this.prolog.AddPhotos(t,e);e=o.next_idx,r.push(o.promise),i=this.AppendResultPhotos(i,o.result_photos,PM.PAGE.PROLOG)}if(e>=0&&this.page_array.length>0)for(var a=0;a<this.page_array.length;a++){var o=this.page_array[a].AddPhotos(t,e);if(e=o.next_idx,r.push(o.promise),i=this.AppendResultPhotos(i,o.result_photos,a),0>e)break}if(i.length>0){var s=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_ADDALL,s,null,{page_pos:-1,layer_pos:-1,data:i},"일괄사진넣기")}var n=this;$.when.apply($,r).then(function(){n.AddPhotosComplete(),n.keep_photos=null},function(){n.AddPhotosFailure()})},PM.Core.Product.prototype.AddPhotosComplete=function(){console.log("AddPhotos Complete................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},PM.Core.Product.prototype.AddPhotosFailure=function(){console.log("AddPhotos Failure.................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(-1,"failure")},PM.Core.Product.prototype.DeletePhotos=function(){var t=[];if(this.cover&&this.cover.back_page){var e=this.cover.back_page.DeletePhotos();if(t=this.AppendResultPhotos(t,e,PM.PAGE.COVER_BACK),this.cover.middle_page){var e=this.cover.middle_page.DeletePhotos();t=this.AppendResultPhotos(t,e,PM.PAGE.COVER_MIDDLE)}if(this.cover.front_page){var e=this.cover.front_page.DeletePhotos();t=this.AppendResultPhotos(t,e,PM.PAGE.COVER_FRONT)}}if(this.prolog){var e=this.prolog.DeletePhotos();t=this.AppendResultPhotos(t,e,PM.PAGE.PROLOG)}if(this.page_array.length>0)for(var i=0;i<this.page_array.length;i++){var e=this.page_array[i].DeletePhotos();t=this.AppendResultPhotos(t,e,i)}if(t.length>0){var r=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_DELALL,r,{page_pos:-1,layer_pos:-1,data:t},null,"일괄사진제거")}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Core.Product.prototype.GetSelectedLayer=function(){return this.dragger.GetSelectedLayer()},PM.Core.Product.prototype.GetSelectedPage=function(){return this.dragger.GetSelectedPage()},PM.Core.Product.prototype.GetSelectedPageIndex=function(){var t=this.dragger.GetSelectedPage();return t?this.GetPageIndex(t):PM.PAGE.ERROR},PM.Core.Product.prototype.SetSelectLayer=function(t,e){if(e){var i=PM.Editor.Framework.GetPairNumber();this.ResetFocus(i),this.dragger.SetSelect(t,e,-1,-1),this.dragger.drag_mode=PM.HIT.NONE,this.CheckBoundary(i)}else this.ClearSelect()},PM.Core.Product.prototype.ExtraCount=function(){var t=0;return null!=this.cover&&(t+=2),null!=this.prolog&&(t+=1),t},PM.Core.Product.prototype.GetTotalPageCount=function(){return this.ExtraCount()+this.page_array.length},PM.Core.Product.prototype.GetInnerPageCount=function(){return this.page_array.length},PM.Core.Product.prototype.PairCount=function(){var t=this.GetTotalPageCount();return Math.ceil(t/2)},PM.Core.Product.prototype.GetFitScaleFactor=function(t,e){var i=this.GetPairSize(1);return i.w=Math.max(i.w,this.GetPairSize(0).w),PM.Util.GetScale(t,e,i.w,i.h,!0)},PM.Core.Product.prototype.GetWorkRect=function(t){var e=this.GetPairSize(t);return{l:this.work_pos.x,t:this.work_pos.y,w:e.w,h:e.h}},PM.Core.Product.prototype.DrawCover=function(t,e,i){var r=this.GetCoverSize(),o=PM.Util.GetCenterPos(e,i,r.w,r.h);this.cover.back_page&&this.cover.back_page.DrawBackground(t,o.x,o.y),this.cover.middle_page&&this.cover.middle_page.DrawBackground(t,o.x+this.cover.back_page.width,o.y),this.cover.front_page&&this.cover.front_page.DrawBackground(t,o.x+this.cover.back_page.width+this.cover.middle_page.width,o.y),this.cover.back_page&&this.cover.back_page.DrawLayers(t,o.x,o.y,PM.TYPE.IMAGE),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,o.x+this.cover.back_page.width,o.y,PM.TYPE.IMAGE),this.cover.front_page&&this.cover.front_page.DrawLayers(t,o.x+this.cover.back_page.width+this.cover.middle_page.width,o.y,PM.TYPE.IMAGE),this.cover.back_page&&this.cover.back_page.DrawLayers(t,o.x,o.y,PM.TYPE.ICON),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,o.x+this.cover.back_page.width,o.y,PM.TYPE.ICON),this.cover.front_page&&this.cover.front_page.DrawLayers(t,o.x+this.cover.back_page.width+this.cover.middle_page.width,o.y,PM.TYPE.ICON),this.cover.back_page&&this.cover.back_page.DrawLayers(t,o.x,o.y,PM.TYPE.TEXT),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,o.x+this.cover.back_page.width,o.y,PM.TYPE.TEXT),this.cover.front_page&&this.cover.front_page.DrawLayers(t,o.x+this.cover.back_page.width+this.cover.middle_page.width,o.y,PM.TYPE.TEXT),this.cover.back_page&&this.cover.back_page.DrawBorder(t,o.x,o.y),this.cover.middle_page&&this.cover.middle_page.DrawBorder(t,o.x+this.cover.back_page.width,o.y),this.cover.front_page&&this.cover.front_page.DrawBorder(t,o.x+this.cover.back_page.width+this.cover.middle_page.width,o.y),PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=o)},PM.Core.Product.prototype.DrawPages=function(t,e,i,r,o){var a=this.GetPagesSize(r,o),s=PM.Util.GetCenterPos(e,i,a.w,a.h),n=this.GetPages(r,o);if(n.rpage.DrawBackground(t,s.x+n.lpage.width,s.y),n.lpage.DrawBackground(t,s.x,s.y),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.IMAGE),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.IMAGE),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.ICON),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.ICON),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.TEXT),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.TEXT),n.lpage.DrawBorder(t,s.x,s.y),n.rpage.DrawBorder(t,s.x+n.lpage.width,s.y),-1==r&&this.prolog&&this.prolog==n.lpage&&this.prolog.DrawProlog(t,s.x+n.lpage.width/2,s.y+n.lpage.height/2),"layflat"!=this.product_type&&PM.Editor.Framework.page_gradation_image&&!PM.Editor.Framework.IsPreviewMode()){var h=s.x+n.lpage.width-PM.Editor.Framework.page_gradation_image.width/2,l=s.y,p=PM.Editor.Framework.page_gradation_image.width,c=a.h;t.drawImage(PM.Editor.Framework.page_gradation_image,h,l,p,c)}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=s)},PM.Core.Product.prototype.DrawPair=function(t,e,i,r){var o=this.Pair2PageIndex(e);if(!(o<=PM.PAGE.ERROR))switch(o){case PM.PAGE.COVER:this.DrawCover(t,i,r);break;case PM.PAGE.PROLOG:this.DrawPages(t,i,r,-1,0);break;default:this.DrawPages(t,i,r,o,o+1)}},PM.Core.Product.prototype.MakePreviewImages=function(t){for(var e=document.createElement("canvas"),i=e.getContext("2d"),r=0,o=[],a=0;a<this.PairCount();a++){var s=this.GetPairSize(a),n=0==a&&(null==this.cover.middle_page||null==this.cover.front_page);t||n?(e.width=s.w,e.height=s.h,this.DrawPair(i,a,s.w,s.h),o[r++]=PM.Util.CanvasToImage(e)):(e.width=s.w/2,e.height=s.h,PM.PAGE.PROLOG!=this.Pair2PageIndex(a)&&(this.DrawPair(i,a,s.w,s.h),o[r++]=PM.Util.CanvasToImage(e)),i.translate(-e.width,0),this.DrawPair(i,a,s.w,s.h),o[r++]=PM.Util.CanvasToImage(e),i.translate(e.width,0))}return o},PM.Core.Product.prototype.GetUserImageList=function(){var t=[];if(this.cover){var e=this.cover.back_page?this.cover.back_page.GetUserImageList():[],i=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],r=this.cover.front_page?this.cover.front_page.GetUserImageList():[];t=t.concat(e,i,r)}this.prolog;for(var o=0;o<this.page_array.length;o++)t=t.concat(this.page_array[o].GetUserImageList());return t},PM.Core.Product.prototype.GetUserImageListPerPage=function(){var t=[];this.cover&&(t[0]=this.cover.back_page?this.cover.back_page.GetUserImageList():[],t[1]=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],t[2]=this.cover.front_page?this.cover.front_page.GetUserImageList():[]),this.prolog;for(var e=3,i=0;i<this.page_array.length;i++)t[e++]=this.page_array[i].GetUserImageList();return t},PM.Core.Product.prototype.ResetFocus=function(t){var e=this.Pair2PageIndex(t);if(!(e<=PM.PAGE.ERROR))switch(e){case PM.PAGE.COVER:this.cover.back_page&&this.cover.back_page.ResetFocus(),this.cover.middle_page&&this.cover.middle_page.ResetFocus(),this.cover.front_page&&this.cover.front_page.ResetFocus();break;case PM.PAGE.PROLOG:this.prolog.ResetFocus(),this.page_array[0].ResetFocus();break;default:this.page_array[e].ResetFocus(),this.page_array[e+1].ResetFocus()}},PM.Core.Product.prototype.GetPoolInfo=function(){return{cover_layout_id:this.cover_layout_id,cover_skin_id:this.cover_skin_id,page_layout_id:this.page_layout_id,page_skin_id:this.page_skin_id}},PM.Core.Product.prototype.GetCoverSize=function(){var t=0;return this.cover.back_page&&(t+=this.cover.back_page.width),this.cover.middle_page&&(t+=this.cover.middle_page.width),this.cover.front_page&&(t+=this.cover.front_page.width),{w:t,h:this.cover.back_page.height}},PM.Core.Product.prototype.GetPages=function(t,e){return{lpage:0>t?this.prolog:this.page_array[t],rpage:this.page_array[e]}},PM.Core.Product.prototype.GetPagesSize=function(t,e){var i=this.GetPages(t,e);return{w:i.lpage.width+i.rpage.width,h:i.lpage.height}},PM.Core.Product.prototype.GetPairSize=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return{w:0,h:0};switch(e){case PM.PAGE.COVER:return this.GetCoverSize();case PM.PAGE.PROLOG:return this.GetPagesSize(-1,0);default:return this.GetPagesSize(e,e+1)}return{w:0,h:0}},PM.Core.Product.prototype.GetCurrentPageEditableSize=function(t){var e=this.dragger.GetSelectedPage();if(!e)return{w:500,h:500};var i=PM.Codi.GetGuideInfo(t,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount()),r=i.cut_w+5,o=i.cut_h+5;return{w:e.width-2*r,h:e.height-2*o}},PM.Core.Product.prototype.GetPairText=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return"";switch(e){case PM.PAGE.COVER:return"cover";case PM.PAGE.PROLOG:return"1p";default:return""+(e+1)+"-"+(e+2)+"p"}return""},PM.Core.Product.prototype.ClearSelect=function(){this.dragger.SetSelect(null,null,-1,-1)},PM.Core.Product.prototype.KeyDown=function(t){return this.dragger.KeyDown(t)},PM.Core.Product.prototype.KeyPress=function(t){return this.dragger.KeyPress(t)},PM.Core.Product.prototype.DblClick=function(t,e,i,r,o){this.Select(t,e,i,r,o),this.dragger.DblClick(t,e,r,o),this.Up(t,e,i,r,o)},PM.Core.Product.prototype.ContextMenu=function(t,e,i,r,o,a){var s=PM.Util.L2PPoint({x:r,y:o},a);PM.Editor.Framework.contextMenuCallback&&PM.Editor.Framework.contextMenuCallback(s.x,s.y)},PM.Core.Product.prototype.Point2Page=function(t,e,i){var r=this.Pair2PageIndex(t);if(r<=PM.PAGE.ERROR)return null;var o=null;switch(r){case PM.PAGE.COVER:this.cover&&(this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),e,i)?o=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),e,i)?o=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),e,i)&&(o=this.cover.front_page));break;case PM.PAGE.PROLOG:this.prolog&&this.page_array[0]&&(PM.Util.PtInRect(this.prolog.GetWorkRect(),e,i)?o=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),e,i)&&(o=this.page_array[0]));break;default:this.page_array[r]&&this.page_array[r+1]&&(PM.Util.PtInRect(this.page_array[r].GetWorkRect(),e,i)?o=this.page_array[r]:PM.Util.PtInRect(this.page_array[r+1].GetWorkRect(),e,i)&&(o=this.page_array[r+1]))}return o},PM.Core.Product.prototype.Select=function(t,e,i,r,o,a){this.move_state=null;var s=this.dragger.HitTest(e,r,o);if(s==PM.HIT.NONE){var n=this.HitTest(e,i,r,o);this.dragger.SetSelect(n.page,n.layer,r,o),n.page||n.layer||this.ClearSelect()}else this.dragger.Down(t,e,r,o);var h=this.dragger.GetSelectedPage(),l=this.dragger.GetSelectedLayer(),p=this.dragger.GetSelectedLayerRect();
if(null!=l){if(l.GetType()==PM.TYPE.TEXT){var c=l.GetEditableTextBox();c&&c.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)}this.dragger.IsMove()||this.dragger.IsRotate()||this.dragger.IsResize()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetMoveInfo()}:this.dragger.IsMoveCrop()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetCropInfo()}:this.dragger.IsEditText()}null!=p&&(p=PM.Util.L2PRect(p,a)),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(l,p)},PM.Core.Product.prototype.Move=function(t,e,i,r,o,a){var s=PM.HIT.NONE,n=!0;if(this.dragger.IsMove()){var h=this.HitTest(e,i,r,o),l=h.page?h.page:this.dragger.GetSelectedPage(),p=h.layer?h.layer:this.dragger.GetSelectedLayer();if(l&&p){var c=l.GetWorkRect(),d=p.GetCenterPos(),u=this.Point2Page(i,c.l+d.x,c.t+d.y);u==this.prolog&&(u=null),this.dragger.Move(t,u,r,o),s=PM.HIT.MOVE}}else if(this.dragger.IsResize()){var l=this.dragger.GetSelectedPage(),p=this.dragger.GetSelectedLayer();if(l&&p){var c=l.GetWorkRect(),d=p.GetCenterPos(),u=this.Point2Page(i,c.l+d.x,c.t+d.y);u==this.prolog&&(u=null),u&&(l=u)}s=this.dragger.Resize(l,r,o)}else if(this.dragger.IsRotate())s=this.dragger.Rotate(r,o);else if(this.dragger.IsMoveCrop())s=this.dragger.MoveCrop(r,o);else if(this.dragger.IsEditText())s=this.dragger.EditText(t,r,o);else{if(this.dragger.IsSelect()&&(s=this.dragger.HitTest(e,r,o)),s==PM.HIT.NONE){var h=this.HitTest(e,i,r,o);s=h.layer?PM.HIT.MOVE:PM.HIT.NONE}n=!1}return this.MovedCallbackProcess(a),{hit_type:s,modified:n}},PM.Core.Product.prototype.Up=function(t,e,i,r,o,a){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){if(this.CheckBoundary(i),null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);if(n.GetType()==PM.TYPE.TEXT&&this.dragger.IsResize()&&(n.ResizeFromTBoxCallback(n.width,n.tbox.edit_h),this.CheckBoundary(i)),this.move_state.page_pos!=h||this.move_state.layer_pos!=l||!n.IsEqualMoveInfo(this.move_state.move_info)){var p="?";this.dragger.IsMove()?p=" 위치 변경":this.dragger.IsResize()?p=" 크기 변경":this.dragger.IsRotate()&&(p=" 회전"),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,i,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetMoveInfo()},n.GetDesc()+p)}}}else if(this.dragger.IsMoveCrop()){if(null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);this.move_state.page_pos==h&&this.move_state.layer_pos==l&&n.IsEqualCropInfo(this.move_state.move_info)||PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_CROP,i,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetCropInfo()},"사진 크롭")}}else this.dragger.IsEditText();this.MovedCallbackProcess(a),this.dragger.Up(t,r,o),this.move_state=null},PM.Core.Product.prototype.CheckBoundary=function(t){var e=this.dragger.GetSelectedPage(),i=this.dragger.GetSelectedLayer();if(e&&i&&"spine"!=i.gid){var r=PM.Codi.GetGuideInfo(t,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount()),o=r.cut_w+5,a=r.cut_h+5,s=e.GetWorkRect(),n=i.GetCenterPos(),h=i.GetOutRect();PM.Editor.Framework.GetGridMode()&&(h.l=Math.floor(h.l/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,h.t=Math.floor(h.t/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,n.x=h.l+h.w/2,n.y=h.t+h.h/2,i.xpos=n.x-i.width/2,i.ypos=n.y-i.height/2);var l=this.Point2Page(t,s.l+n.x,s.t+n.y);if(l==this.prolog&&(l=null),l||(n.x<o?n.x=o:n.x>s.w-o&&(n.x=s.w-o),n.y<a?n.y=a:n.y>s.h-a&&(n.y=s.h-a),i.xpos=n.x-i.width/2,i.ypos=n.y-i.height/2),i.GetType()==PM.TYPE.TEXT){h.l<o?h.l=o:h.l+h.w>s.w-o&&(h.l=h.w>s.w-2*o?o:s.w-h.w-o),h.t<a?h.t=a:h.t+h.h>s.h-a&&(h.t=h.h>s.h-2*a?a:s.h-h.h-a);var p=h.l+h.w/2,c=h.t+h.h/2;i.xpos=p-i.width/2,i.ypos=c-i.height/2}i.GetType()==PM.TYPE.TEXT&&(h.w>s.w-2*o||h.h>s.h-2*a)&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE),this.cover&&0==t?this.cover.middle_page&&i.GetType()==PM.TYPE.IMAGE&&(l==this.cover.back_page?h.l+h.w>s.w&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA):l==this.cover.front_page&&h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA)):!this.prolog||null!=l&&l!=this.page_array[0]||h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA)}},PM.Core.Product.prototype.MakeMoveLayerCallback=function(t){var e=this.dragger.GetSelectedLayer(),i=this.dragger.GetSelectedLayerRect();return null!=i&&(i=PM.Util.L2PRect(i,t)),{layer:e,rect:i}},PM.Core.Product.prototype.ResizeFromTBoxCallbackProcess=function(t){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)},PM.Core.Product.prototype.MovedCallbackProcess=function(t){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)}},PM.Core.Product.prototype.GetDropData=function(t){var e="";return 0==t.indexOf("color")?e="color":0==t.indexOf("skin")?e="skin":0==t.indexOf("layout")?e="layout":0==t.indexOf("icon")?e="icon":0==t.indexOf("frame")?e="frame":0==t.indexOf("text")?e="text":0==t.indexOf("photo")&&(e="photo"),{id:e,value:t.substring(e.length)}},PM.Core.Product.prototype.GetPageIndex=function(t){for(var e=0;e<this.page_array.length;e++){var i=this.page_array[e];if(i==t)return e}return t==this.cover.back_page?PM.PAGE.COVER_BACK:t==this.cover.middle_page?PM.PAGE.COVER_MIDDLE:t==this.cover.front_page?PM.PAGE.COVER_FRONT:PM.PAGE.ERROR},PM.Core.Product.prototype.DragOver=function(t,e,i,r,o){var a=this.HitTest(e,i,r,o),s=this.GetDropData(t.dataTransfer.getData("text"));return this.CheckDrop(a.page,a.layer,s.id,s.value)},PM.Core.Product.prototype.Drop=function(t,e,i,r,o){t.preventDefault();var a=this.HitTest(e,i,r,o);if(a.page){var s=a.page,n=a.layer,h=this.GetDropData(t.dataTransfer.getData("text"));if(("skin"==h.id||"color"==h.id)&&"layflat"==s.layout_style){var l=s.GetWorkRect();if(l.l+=l.w/2,PM.Util.PtInRect(l,r,o)){var p=this.Pair2PageIndex(i);if(p<=PM.PAGE.ERROR)return;s=this.page_array[p+1]}}this.DropItem(i,s,n,r,o,h.id,h.value)}},PM.Core.Product.prototype.DropDefault=function(t,e,i){var r=this.Pair2PageIndex(t);if(!(r<=PM.PAGE.ERROR)){var o=this.dragger.GetSelectedPage(),a=this.dragger.GetSelectedLayer();if(!o)switch(r){case PM.PAGE.COVER:o=this.cover.back_page;break;case PM.PAGE.PROLOG:o=this.page_array[0];break;default:o=this.page_array[r]}if(o&&this.CheckDrop(o,a,e,i)){var s=o.work_pos.x+o.width/2,n=o.work_pos.y+o.height/2;this.DropItem(t,o,a,s,n,e,i)}}},PM.Core.Product.prototype.CheckDrop=function(t,e,i,r){if("skin"==i){if(t&&!t.IsLayerLock()){var o=JSON.parse(r);return o.kind==t.skin_kind&&o.type==t.skin_type}}else if("layout"==i&&t&&!t.IsLayerLock()){if(this.IsAvailableSpine()&&t==this.cover.middle_page)return!1;var o=JSON.parse(r),a=!1;return"cover"==o.type&&"cover"==t.layout_type?a=!0:"page"==o.type&&"page"==t.layout_type?a=!0:"layflat"==this.product_type&&"page_spread"==o.type&&"page"==t.layout_type&&(a=!0),o.kind==t.layout_kind&&a}return null!=t&&t!=this.prolog},PM.Core.Product.prototype.DropItem=function(t,e,i,r,o,a,s){var n="",h=null,l=null,p=[],c=[],d=PM.RECORD_UNKNOWN;switch(a){case"color":if(n="배경색 변경",e&&!e.IsLayerLock()){d=PM.RECORD_PAGE_BKCOLOR;var u={skin_link:e.skin_link,color:e.color};p.push(u),h=e.ChangeColor(s)}break;case"skin":if(n="배경스킨 변경",e&&!e.IsLayerLock()){var _=JSON.parse(s);if(_.kind==e.skin_kind&&_.type==e.skin_type){d=PM.RECORD_PAGE_BKIMAGE;var u={skin_link:e.skin_link,color:e.color};p.push(u),h=e.ChangeSkin(PM.URL.SKIN_FILE+_.link)}}break;case"layout":if(n="레이아웃 변경",e&&!e.IsLayerLock()){if(this.IsAvailableSpine()&&e==this.cover.middle_page)break;var _=JSON.parse(s);if(_.kind==e.layout_kind){d=PM.RECORD_PAGE_LAYOUT;var u=e.SaveJson();if("cover"==_.type&&"cover"==e.layout_type)p.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else if("page"==_.type&&"page"==e.layout_type)if("layflat"==e.layout_style){var g=this.GetPageIndex(e);if(g>0&&g<this.page_array.length-1){p.push(u);var f=this.page_array[g+1].SaveJson();p.push(f),this.page_array[g+1]=null,this.page_array[g+1]=e.CreateDefaultPage(),this.page_array[g+1].layout_style=e.layout_style="normal",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null)}}else p.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else if("layflat"==this.product_type&&"page_spread"==_.type&&"page"==e.layout_type)if("layflat"==e.layout_style)p.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else{var g=this.GetPageIndex(e);if(g>0&&(this.page_array[g-1].work_pos.x<e.work_pos.x&&(g--,e=this.page_array[g]),g<this.page_array.length-1)){var u=e.SaveJson();p.push(old_info1);var f=this.page_array[g+1].SaveJson();p.push(f);var P=e.GetDefaultDummyLink(e);this.page_array[g+1].layout_link=P,this.page_array[g+1].layout_style="dummy",this.page_array[g+1].layer_array=[],e.layout_style="layflat",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null)}}}}break;case"text":n="글상자 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.TextLayer,h=e.AddNewLayer(r,o,l,!1),l.LoadJsonAtPos(l.xpos,l.ypos,s));break;case"icon":n="스티커 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.IconLayer,l.icon=s,h=e.AddNewLayer(r,o,l,!1));break;case"frame":if(n="사진틀 추가",e&&!e.IsLayerLock())if(i&&i.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_FRAME_CHANGE;var u={type:i.GetType(),value:i.diagram};p.push(u),s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0?(h=i.AddDiagram(s),n="사진틀 변경"):(i.DeleteDiagram(),h=$.Deferred().resolve(),n="사진틀 제거")}else e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX&&s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.diagram=s,h=e.AddNewLayer(r,o,l,!1));break;case"photo":if(n="사진 추가",e)if(i&&i.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_PHOTO_CHANGE;var u={type:i.GetType(),value:i.GetPhotoState()};p.push(u);var _=JSON.parse(s),y=_.url_domain+_.url_path+_.url_edit,m=_.url_domain+_.url_path+_.url_file,v=i.AddPhoto(y,m,_.img_width,_.img_height,!0);v.added&&(h=v.promise),n="사진 변경"}else if(e.IsLayerLock());else if(e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX){var _=JSON.parse(s),y=_.url_domain+_.url_path+_.url_edit,m=_.url_domain+_.url_path+_.url_file;d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.photo=y,l.photo_org=m,l.original_w=_.img_width,l.original_h=_.img_height,h=e.AddNewLayer(r,o,l,!1)}}if(this.SetSelectLayer(e,l),h){var M=this;h.done(function(){var r=M.GetPageIndex(e),o=-1;switch(a){case"color":c.push({skin_link:e.skin_link,color:s});break;case"skin":c.push({skin_link:PM.URL.SKIN_FILE+_.link,color:e.color});break;case"layout":var h=e.SaveJson();if(c.push(h),p.length>1){var u=M.page_array[r+1].SaveJson();c.push(u)}break;case"text":case"icon":case"frame":case"photo":if(d==PM.RECORD_LAYER_INSERT){o=e.GetLayerIndex(l);var g={type:l.GetType(),value:$.extend(!0,{},l)};c.push(g)}else if(d==PM.RECORD_FRAME_CHANGE){o=e.GetLayerIndex(i);var g={type:i.GetType(),value:i.diagram};c.push(g)}else if(d==PM.RECORD_PHOTO_CHANGE){o=e.GetLayerIndex(i);var g={type:i.GetType(),value:i.GetPhotoState()};c.push(g)}}d>PM.RECORD_UNKNOWN&&PM.Editor.Framework.RecordOperation(d,t,{page_pos:r,layer_pos:o,data:p},{page_pos:r,layer_pos:o,data:c},n),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback(a,s)}),h.fail(function(){PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")})}else PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")},PM.Core.Product.prototype.ChangeAll=function(t,e,i){var r=[],o=[],a=[];switch(e){case"color":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];n&&(r.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeColor(i)))}break;case"skin":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n){var h=JSON.parse(i);h.kind==n.skin_kind&&h.type==n.skin_type&&(r.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeSkin(PM.URL.SKIN_FILE+h.link)))}}break;case"layout":var h=JSON.parse(i);if("page"==h.type)for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n&&!n.IsLayerLock()&&h.kind==n.layout_kind&&h.type==n.layout_type){var l=n.SaveJson();r.push(l),a.push(n.ChangeLayout(PM.URL.LAYOUT_FILE+h.link,null,null))}}}if(r.length<=0)return void PM.Editor.Framework.ShowMessageBar("실행할 수 없습니다.");this.ClearSelect();var p=this;return $.when.apply($,a).then(function(){var i=PM.RECORD_UNKNOWN,a="";switch(e){case"color":i=PM.RECORD_PAGE_BKCOLOR,a="배경색 전체일괄적용";for(var s=0;s<p.page_array.length;s++){var n=p.page_array[s];n&&o.push({skin_link:n.skin_link,color:n.color})}break;case"skin":i=PM.RECORD_PAGE_BKIMAGE,a="배경스킨 전체일괄적용";for(var s=0;s<p.page_array.length;s++){var n=p.page_array[s];n&&o.push({skin_link:n.skin_link,color:n.color})}break;case"layout":i=PM.RECORD_PAGE_LAYOUT,a="레이아웃 전체일괄적용";for(var s=0;s<p.page_array.length;s++){var n=p.page_array[s];if(n){n.layout_style="normal";var h=n.SaveJson();o.push(h)}}}PM.Editor.Framework.RecordOperation(i,t,{page_pos:0,layer_pos:-1,data:r},{page_pos:0,layer_pos:-1,data:o},a),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all",e)},function(){PM.Editor.Framework.ShowMessageBar(desc+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")}),a.length>0},PM.Core.Product.prototype.Copy=function(){var t=this.dragger.GetSelectedLayer();return t?"spine"==t.gid?(PM.Editor.Framework.ShowMessageBar("복사할 수 없습니다."),!1):(this.clipboard_memory=t.SaveJson(),this.clipboard_memory.length>0):!1},PM.Core.Product.prototype.Cut=function(){var t=this.dragger.GetSelectedLayer();return t?(this.clipboard_memory=t.SaveJson(),this.DeleteLayer(),this.clipboard_memory.length>0):!1},PM.Core.Product.prototype.Paste=function(t){if(this.clipboard_memory.length<=0)return!1;var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return!1;var i=this.dragger.GetSelectedPage();if(!i||i==this.prolog||this.IsAvailableSpine()&&i==this.cover.middle_page)switch(e){case PM.PAGE.COVER:i=this.cover.back_page;break;case PM.PAGE.PROLOG:i=this.page_array[0];break;default:i=this.page_array[e]}if(i&&!i.IsLayerLock()){var r=null,o=JSON.parse(this.clipboard_memory);switch(o.type){case PM.TYPE.ICON:r=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:r=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:r=new PM.Core.TextLayer}if(r){r.LoadJson(o),r.movelock=r.resizelock=r.zorderlock=r.removelock=!1;var a=i.work_pos.x+r.xpos+r.width/2+20,s=i.work_pos.y+r.ypos+r.height/2+20,n=this,h=i.AddNewLayer(a,s,r,!0);return h.done(function(){n.SetSelectLayer(i,r);var e=[],o=[],a=n.GetPageIndex(i),s=i.GetLayerIndex(r),h={type:r.GetType(),value:$.extend(!0,{},r)};o.push(h),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_INSERT,t,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:o},r.GetDesc()+" 붙여넣기")}),!0}}return!1},PM.Core.Product.prototype.HitTest=function(t,e,i,r){var o=this.Pair2PageIndex(e);if(o<=PM.PAGE.ERROR)return{page:null,layer:null};var a=null,s=null;switch(o){case PM.PAGE.COVER:if(this.cover){if(this.cover.back_page&&(s=this.cover.back_page.HitTestLayers(t,i,r),a=s?this.cover.back_page:null,s))break;if(this.cover.middle_page&&(s=this.cover.middle_page.HitTestLayers(t,i,r),a=s?this.cover.middle_page:null,s))break;if(this.cover.front_page&&(s=this.cover.front_page.HitTestLayers(t,i,r),a=s?this.cover.front_page:null,s))break;this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),i,r)?a=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),i,r)?a=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),i,r)&&(a=this.cover.front_page)}break;case PM.PAGE.PROLOG:if(this.prolog&&this.page_array[0]){if(s=this.prolog.HitTestLayers(t,i,r),a=s?this.prolog:null,s)break;if(s=this.page_array[0].HitTestLayers(t,i,r),a=s?this.page_array[0]:null,s)break;PM.Util.PtInRect(this.prolog.GetWorkRect(),i,r)?a=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),i,r)&&(a=this.page_array[0])}break;default:if(this.page_array[o]&&this.page_array[o+1]){if(s=this.page_array[o].HitTestLayers(t,i,r),a=s?this.page_array[o]:null,s)break;if(s=this.page_array[o+1].HitTestLayers(t,i,r),a=s?this.page_array[o+1]:null,s)break;PM.Util.PtInRect(this.page_array[o].GetWorkRect(),i,r)?a=this.page_array[o]:PM.Util.PtInRect(this.page_array[o+1].GetWorkRect(),i,r)&&(a=this.page_array[o+1])}}return{page:a,layer:s}},PM.Core.Product.prototype.Pair2PageIndex=function(t){if(0>t||t>=this.PairCount())return PM.PAGE.ERROR;var e=this.ExtraCount();switch(e){case 3:return 0==t?PM.PAGE.COVER:1==t?PM.PAGE.PROLOG:2*t-3;case 2:return 0==t?PM.PAGE.COVER:2*t-2;case 1:return 0==t?PM.PAGE.PROLOG:2*t-1}return 2*t},PM.Core.Product.prototype.Parse=function(t){var e=this,i=$(t).find("photo").find("theme").find("theme");return i.attr("id")!=e.product_key?!1:i.find("theme").attr("themename")!=e.theme_depth1?!1:i.find("theme").find("theme").attr("id")!=e.theme_depth2?!1:(i=i.find("theme").find("theme"),void i.find("theme").each(function(){if("styles"==$(this).attr("type")&&(e.style_id=$(this).attr("id")),"pages"==$(this).attr("type")){var t=null,i=null,r=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.page_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.page_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")?i=e.ParseItems($(this)):"prolog"==$(this).attr("type")&&(r=e.ParseItems($(this)))}),r&&r.length>0){var o=r[0];o.type="prolog";var a=new PM.Core.Page;a.SetLayoutInfo(o),a.SetSkinInfo(new PM.Core.Skin),e.prolog=a}if(t.length>0&&i.length>0)for(var s=0,n=0,h=0;h<e.min_page;h++){s>=t.length&&(s=0),n>=i.length&&(n=0);var o=t[s++],l=i[n++],p=new PM.Core.Page;p.SetLayoutInfo(o),p.SetSkinInfo(l),e.page_array.push(p)}}if("cover"==$(this).attr("type")){var t=null,i=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.cover_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.cover_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")&&(i=e.ParseItems($(this)))}),1==t.length&&1==i.length){var c=t[0],d=i[0],u=new PM.Core.Cover;u.back_page.SetLayoutInfo(c),u.back_page.SetSkinInfo(d),u.middle_page=null,u.front_page=null,e.cover=u}else if(t.length>=3&&i.length>=3){var c=t[0],_=t[1],g=t[2],d=i[0],f=i[1],P=i[2],u=new PM.Core.Cover;u.back_page.SetLayoutInfo(c),u.back_page.SetSkinInfo(d),u.middle_page.SetLayoutInfo(_),u.middle_page.SetSkinInfo(f),u.front_page.SetLayoutInfo(g),u.front_page.SetSkinInfo(P),e.cover=u}}}))},PM.Core.Product.prototype.ParseItems=function(t){var e=this,i=t.attr("type"),r=[];return t.find("skinthumb").each(function(){var t="normal",o=$(this).attr("type"),a=$(this).attr("kind"),s=$(this).attr("imgcnt"),n=$(this).attr("link"),h=$(this).text(),l=$(this).attr("storecode");if("layflat"==e.product_type){var p=$(this).attr("spreadimgcnt");p&&p.length>0&&(s=$(this).attr("spreadimgcnt"));var c=$(this).attr("spreadlink");c&&c.length>0&&(n=$(this).attr("spreadlink"),t="s_bg.xml"==c||"w_bg.xml"==c||"h_bg.xml"==c?"dummy":"layflat")}if("layout"==i||"prolog"==i){var d=new PM.Core.Layout;d.style=t,d.type=o,d.kind=a,d.imgcnt=s,d.link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n),d.thumb=PM.Util.GetFullPathName(PM.URL.LAYOUT_THUMB,h),r.push(d)}else if("skin"==i){var d=new PM.Core.Skin;d.type=o,d.kind=a,d.link=PM.Util.GetFullPathName(PM.URL.SKIN_FILE,n),d.thumb=PM.Util.GetFullPathName(PM.URL.SKIN_THUMB,h),d.storecode=l,r.push(d)}}),r},PM.Core.Product.prototype.LoadJson=function(t){this.user_id=t.user_id,this.session_id=t.session_id,this.add_param=t.add_param,this.product_code=t.product_code,this.product_key=t.product_key,this.product_name=t.product_name,this.product_size=t.product_size,this.product_type=t.product_type,this.cover_type=t.cover_type,this.surface_type=t.surface_type,this.price=t.price,this.price_page=t.price_page,this.min_page=t.min_page,this.max_page=t.max_page,this.theme_depth1=t.theme_depth1,this.theme_depth2=t.theme_depth2,this.theme_name=t.theme_name,this.style_id=t.style_id,this.cover_layout_id=t.cover_layout_id,this.cover_skin_id=t.cover_skin_id,this.page_layout_id=t.page_layout_id,this.page_skin_id=t.page_skin_id,this.basket_name=t.basket_name,this.order_code=t.order_code,this.is_complete=t.is_complete;var e=[];this.cover=null,t.cover&&(this.cover=new PM.Core.Cover,e.push(this.cover.LoadJson(t.cover))),this.prolog=null,t.prolog&&(this.prolog=new PM.Core.Page,e.push(this.prolog.LoadJson(t.prolog)));for(var i in t.page_array){var r=new PM.Core.Page;this.page_array.push(r),e.push(r.LoadJson(t.page_array[i]))}var o=this;$.when.apply($,e).then(function(){o.PreProcess(o),o.LoadComplete()},function(){o.LoadFailure()})},PM.Core.Product.prototype.SaveJson=function(){var t="{";navigator&&navigator.userAgent&&(t+='\n  "user_agent": "'+navigator.userAgent+'"'),t+='\n, "user_id": "'+this.user_id+'"',t+='\n, "session_id": "'+this.session_id+'"',t+='\n, "add_param": "'+this.add_param+'"',t+='\n, "product_code": "'+this.product_code+'"',t+='\n, "product_key": "'+this.product_key+'"',t+='\n, "product_name": "'+this.product_name+'"',t+='\n, "product_size": "'+this.product_size+'"',t+='\n, "product_type": "'+this.product_type+'"',t+='\n, "cover_type": "'+this.cover_type+'"',t+='\n, "surface_type": "'+this.surface_type+'"',t+='\n, "price": '+this.price,t+='\n, "price_page": '+this.price_page,t+='\n, "min_page": '+this.min_page,t+='\n, "max_page": '+this.max_page,t+='\n, "inner_page_count": '+this.page_array.length,t+='\n, "theme_depth1": "'+this.theme_depth1+'"',t+='\n, "theme_depth2": "'+this.theme_depth2+'"',t+='\n, "theme_name": "'+this.theme_name+'"',t+='\n, "style_id": "'+this.style_id+'"',t+='\n, "cover_layout_id": "'+this.cover_layout_id+'"',t+='\n, "cover_skin_id": "'+this.cover_skin_id+'"',t+='\n, "page_layout_id": "'+this.page_layout_id+'"',t+='\n, "page_skin_id": "'+this.page_skin_id+'"',t+='\n, "basket_name": "'+this.basket_name+'"',t+='\n, "order_code": "'+this.order_code+'"',t+='\n, "is_complete": '+this.is_complete,this.cover?(t+='\n, "cover": ',t+=this.cover.SaveJson()):t+='\n, "cover": null',this.prolog?(t+='\n, "prolog": ',t+=this.prolog.SaveJson()):t+='\n, "prolog": null',t+='\n, "page_array": [';for(var e=0;e<this.page_array.length;e++)t+=this.page_array[e].SaveJson(),e<this.page_array.length-1&&(t+="\n,");return t+="\n]",t+="\n}"},PM.Core.Product.prototype.CheckComplete=function(){if(this.is_complete=!1,this.cover&&!this.cover.CheckComplete())return!1;if(this.prolog&&!this.prolog.CheckComplete())return!1;for(var t=0;t<this.page_array.length;t++)if(!this.page_array[t].CheckComplete())return!1;return this.is_complete=!0,!0},PM.Ctrl.Dragger=function(){this.drag_mode=PM.HIT.NONE,this.move={x:-1,y:-1},this.sel_page=null,this.sel_layer=null,this.is_editmode=!1,this.middle_page=null},PM.Ctrl.Dragger.prototype.IsMove=function(){return this.drag_mode==PM.HIT.MOVE},PM.Ctrl.Dragger.prototype.IsMoveCrop=function(){return this.drag_mode==PM.HIT.MOVE_CROP},PM.Ctrl.Dragger.prototype.IsEditText=function(){return this.drag_mode==PM.HIT.EDIT_TEXT},PM.Ctrl.Dragger.prototype.IsResize=function(){return this.drag_mode>=PM.HIT.RESIZE_T&&this.drag_mode<=PM.HIT.RESIZE_LB},PM.Ctrl.Dragger.prototype.IsRotate=function(){return this.drag_mode==PM.HIT.ROTATE},PM.Ctrl.Dragger.prototype.IsSelect=function(){return null!=this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedPage=function(){return this.sel_page},PM.Ctrl.Dragger.prototype.GetSelectedLayer=function(){return this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedLayerRect=function(){if(!this.sel_layer)return null;if(!this.sel_page)return null;var t=this.sel_page.GetWorkRect(),e=this.sel_layer.GetRect(),i=e.l+e.w/2,r=e.t+e.h/2,o=this.sel_layer.GetRotateInnerPoints(i,r),a=this.sel_layer.Points2OutRect(o);return{l:t.l+a.l,t:t.t+a.t,w:a.w,h:a.h}},PM.Ctrl.Dragger.prototype.DeleteLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.removelock?!1:(this.sel_page.RemoveLayer(this.sel_layer),this.sel_layer=null,!0):!1},PM.Ctrl.Dragger.prototype.RotateLayer=function(t){return this.sel_layer&&this.sel_page?this.sel_layer.movelock?!1:this.sel_page.RotateLayer(this.sel_layer,t):!1},PM.Ctrl.Dragger.prototype.UpLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.UpLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.DownLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.DownLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.KeyDown=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyDown(t):!1},PM.Ctrl.Dragger.prototype.KeyPress=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyPress(t):!1},PM.Ctrl.Dragger.prototype.SetSelect=function(t,e,i,r){this.is_editmode=e&&e==this.sel_layer&&this.is_editmode,this.sel_page=t,this.sel_layer=e,this.drag_mode=e?PM.HIT.MOVE:PM.HIT.NONE,this.move.x=i,this.move.y=r},PM.Ctrl.Dragger.prototype.ResetSelectedPage=function(t,e,i){if(this.sel_layer&&this.sel_page&&(this.sel_layer.GetType()!=PM.TYPE.TEXT||t!=this.middle_page)&&t){var r=this.sel_layer,o=this.sel_page,a=t;a.AddLayer(r),o.RemoveLayer(r);var s=o.GetWorkRect(),n=e-s.l-r.xpos,h=i-s.t-r.ypos,l=a.GetWorkRect();r.xpos=e-l.l-n,r.ypos=i-l.t-h,this.sel_page=a,this.sel_layer=r}},PM.Ctrl.Dragger.prototype.DblClick=function(t,e,i,r){this.sel_layer&&(this.is_editmode=this.drag_mode==PM.HIT.MOVE||this.drag_mode==PM.HIT.EDIT_TEXT,this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,i,r),this.drag_mode=PM.HIT.EDIT_TEXT))},PM.Ctrl.Dragger.prototype.Down=function(t,e,i,r){if(this.sel_layer&&this.sel_page){this.move.x=i,this.move.y=r;var o=this.sel_page.GetWorkRect();this.drag_mode=this.sel_layer.HitTestController(e,i-o.l,r-o.t),this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,i-o.l,r-o.t),this.drag_mode=PM.HIT.EDIT_TEXT)}},PM.Ctrl.Dragger.prototype.Move=function(t,e,i,r){if(this.sel_layer&&this.sel_page&&this.IsMove()&&!this.sel_layer.movelock){e&&e!=this.sel_page&&this.ResetSelectedPage(e,i,r);var o=this.move.x,a=this.move.y;this.move.x=i,this.move.y=r,this.sel_layer.Move(o,a,this.move.x,this.move.y)}},PM.Ctrl.Dragger.prototype.Up=function(t,e,i){if(this.sel_layer&&this.sel_page){if(this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT){var r=this.sel_page.GetWorkRect();this.sel_layer.MouseUp(t,e-r.l,i-r.t)}this.is_editmode||this.sel_layer.GetType()!=PM.TYPE.TEXT||(this.sel_layer.SelectAll(),this.IsResize()&&this.sel_layer.AdjustSize()),this.drag_mode=PM.HIT.NONE}},PM.Ctrl.Dragger.prototype.EditText=function(t,e,i){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsEditText())return PM.HIT.NONE;if(!this.is_editmode)return PM.HIT.NONE;var r=this.sel_page.GetWorkRect();return this.sel_layer.MouseMove(t,e-r.l,i-r.t),this.drag_mode},PM.Ctrl.Dragger.prototype.MoveCrop=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsMoveCrop())return PM.HIT.NONE;var i=this.move.x,r=this.move.y;return this.move.x=t,this.move.y=e,this.sel_layer.MoveCrop(i,r,this.move.x,this.move.y),this.drag_mode},PM.Ctrl.Dragger.prototype.Resize=function(t,e,i){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsResize())return PM.HIT.NONE;t&&t!=this.sel_page&&this.ResetSelectedPage(t,e,i);var r=this.move.x,o=this.move.y;this.move.x=e,this.move.y=i;var a=this.sel_page.GetWorkRect();return this.sel_layer.Resize(this.drag_mode,r-a.l,o-a.t,this.move.x-a.l,this.move.y-a.t),this.drag_mode},PM.Ctrl.Dragger.prototype.Rotate=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsRotate())return PM.HIT.NONE;var i=this.move.x,r=this.move.y;this.move.x=t,this.move.y=e;var o=this.sel_page.GetWorkRect();return this.sel_layer.Rotate(i-o.l,r-o.t,this.move.x-o.l,this.move.y-o.t),this.drag_mode},PM.Ctrl.Dragger.prototype.HitTest=function(t,e,i){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;var r=this.sel_page.GetWorkRect(),o=this.sel_layer.HitTestController(t,e-r.l,i-r.t);return o},PM.Ctrl.Dragger.prototype.Draw=function(t){if(this.sel_page&&!PM.Editor.Framework.IsPreviewMode()){var e=this.sel_page.GetWorkRect();if(PM.Util.DrawRect(t,e.l,e.t,e.w,e.h,5,PM.COLOR_PAGE_FOCUS_STROKE,null),this.sel_layer){var i=this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT;this.sel_layer.DrawController(t,e.l,e.t,i)}}},PM.Ctrl.Message=function(){this.is_show=!1,this.text="^^",this.timer_id=-1},PM.Ctrl.Message.prototype.Show=function(t){this.Hide(),this.is_show=!0,this.text=t;var e=PM.CONFIG.MESSAGEBAR_TIMEOUT;t.length>parseInt(e/100)&&(e=100*t.length);var i=this;this.timer_id=setTimeout(function(){i.is_show=!1,i.text=""},e)},PM.Ctrl.Message.prototype.Hide=function(){this.is_show=!1,this.text="",-1!=this.timer_id&&clearTimeout(this.timer_id)},PM.Ctrl.Message.prototype.Draw=function(t,e,i,r,o){this.is_show&&(t.save(),t.fillStyle=PM.CONFIG.MESSAGEBAR_BACKCOLOR,t.fillRect(e,i,r,o),t.font=PM.CONFIG.MESSAGEBAR_FONT,t.fillStyle=PM.CONFIG.MESSAGEBAR_TEXTCOLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,e+r/2,i+o/2),t.restore())},PM.Ctrl.TextBox=function(){this.doc_pos=new xpos(0,0),this.caret=new xcaret,this.dox=new xdoc,this.ime=new xime,this.valign=0,this.edit_w=0,this.edit_h=0,this.min_h=0,this.ctx=null,this.is_singleline=!1,this.is_autoresize=!0,this.is_editable=!0,this.is_spine=!1,this.is_drag=!1,this.undo_stack=[],this.redo_stack=[],this.clipboard_memory=""},PM.Ctrl.TextBox.prototype.callback_update_state=function(){PM.Editor.Framework.updateTextStateCallback&&PM.Editor.Framework.updateTextStateCallback()},PM.Ctrl.TextBox.prototype.callback_update_size=function(t,e){PM.Editor.Framework.updateTextBoundsCallback&&PM.Editor.Framework.updateTextBoundsCallback(t,e)},PM.Ctrl.TextBox.prototype.LoadJson=function(t){this.undo_stack=[],this.redo_stack=[];var e=t;null!=e&&(this.dox.loaddata(e),this.doc_pos.init(),this.movecaretpos(this.doc_pos.getmove()))},PM.Ctrl.TextBox.prototype.SaveJson=function(){return this.dox.toJSON()},PM.Ctrl.TextBox.prototype.SaveJsonEx=function(){var t=0,e=this.getdocy();return this.dox.toJSONEx(t,e)},PM.Ctrl.TextBox.prototype.IsEmptyDoc=function(){return this.dox.getlength()<=0},PM.Ctrl.TextBox.prototype.SetSize=function(t,e){this.edit_w=t,this.edit_h=e,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.SetMinHeight=function(t){this.min_h=t,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.adjustsize=function(t){if(!this.is_singleline&&this.is_autoresize){var e=Math.floor(this.dox.getdocheight()),i=Math.floor(this.edit_h);if(e>this.edit_h)i=e;else if(e<this.edit_h){var r=this.min_h;i=r>e?r:e}i>0&&i!=this.edit_h&&(this.edit_h=i,t&&this.callback_update_size(this.edit_w,this.edit_h))}},PM.Ctrl.TextBox.prototype.Draw=function(t){t&&(t.save(),this.align(t,!0),this.draw(t),this.ctx=t,t.restore())},PM.Ctrl.TextBox.prototype.align=function(t,e){this.dox.aligndoc(t,this.edit_w,e),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.draw=function(t){t.beginPath(),t.rect(0,-4,this.edit_w,this.edit_h+4),t.clip(),this.isOverflowText()&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(t.fillStyle=PM.COLOR_TBOX_WARNING_FILL,t.fillRect(0,0,this.edit_w,this.edit_h));
var e=0,i=this.getdocy(),r=this.doc_pos.getblock();this.dox.display(t,e,i,this.edit_h,r.left,r.right,this.isfocus()),this.is_editable&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&!PM.Editor.Framework.IsPreviewMode()&&this.caret.display(t,e,i)},PM.Ctrl.TextBox.prototype.getdocy=function(){var t=0;switch(this.valign){case 0:t=0;break;case 1:t=this.edit_h/2-this.getdocheight()/2;break;case 2:t=this.edit_h-this.getdocheight()}return t},PM.Ctrl.TextBox.prototype.MouseDown=function(t,e,i,r){var t=window.event||t;this.setfocus(),r-=this.getdocy();var o=new xpoint(i,r),a=this.movecaretpoint(o,!0);a>=0&&(t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.is_drag=!0)},PM.Ctrl.TextBox.prototype.MouseMove=function(t,e,i){if(this.is_drag){var t=window.event||t;i-=this.getdocy();var r=new xpoint(e,i),o=this.movecaretpoint(r,!0);o>=0&&this.doc_pos.setmove(o)}},PM.Ctrl.TextBox.prototype.MouseUp=function(t){this.is_drag=!1,t.target.id==PM.Core.MAIN_CANVAS_ID&&this.callback_update_state()},PM.Ctrl.TextBox.prototype.KeyDown=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;switch(e){case 112:t.preventDefault(),this.dox.dump();break;case 113:check_bbox=!check_bbox;break;case 114:this.dump_undoredo();break;case 21:case 229:t.preventDefault(),this.setimemode(!this.ime.is_activate());break;case 32:t.preventDefault(),t.shiftKey?this.setimemode(!this.ime.is_activate()):this.keyprocess(e);break;case 10:case 13:this.is_singleline||(t.preventDefault(),this.completecompose(),this.insertchars(X.ENTERKEY,1,X.RECORD_INS));break;case 220:break;case 90:t.ctrlKey&&(t.preventDefault(),this.completecompose(),t.shiftKey?PM.Editor.Framework.Redo():PM.Editor.Framework.Undo());break;case 89:t.ctrlKey&&(t.preventDefault(),this.completecompose(),PM.Editor.Framework.Redo());break;case 67:case 88:case 86:t.ctrlKey&&(t.preventDefault(),this.completecompose(),67==e?this.copy():88==e?(this.copy(),this.deletechars(0,X.RECORD_DEL)):86==e&&this.paste(""));break;case 48:case 107:case 109:case 187:case 189:t.ctrlKey&&this.completecompose();break;case 8:if(t.preventDefault(),this.ime.is_composite()){var i=this.ime.composite(-1);if(i.comp_update>=0){this.deletechars(-1,X.RECORD_OFF);var r=String.fromCharCode(i.comp_update);this.insertchars(r,1,X.RECORD_REPL)}else this.deletechars(-1,X.RECORD_DEL)}else this.deletechars(-1,X.RECORD_DEL);break;case 46:t.preventDefault(),this.ime.is_composite()?this.completecompose():this.deletechars(1,X.RECORD_DEL);break;case 65:t.ctrlKey&&(t.preventDefault(),this.completecompose(),this.select(0,this.dox.getlength()),this.callback_update_state());break;case 33:case 36:t.preventDefault(),this.completecompose(),this.movehome(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 34:case 35:t.preventDefault(),this.completecompose(),this.moveend(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 37:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveleft(0):this.doc_pos.moveleft(0),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();break;case 39:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveright(this.dox.getlength()):this.doc_pos.moveright(this.dox.getlength()),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();break;case 38:t.preventDefault(),this.completecompose();var o=new xpoint(0,0);o.x=this.caret.getbase_x(),o.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(o,!1,-1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state();break;case 40:t.preventDefault(),this.completecompose();var o=new xpoint(0,0);o.x=this.caret.getbase_x(),o.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(o,!1,1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state()}return!0},PM.Ctrl.TextBox.prototype.KeyPress=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;return this.keyprocess(e),!0},PM.Ctrl.TextBox.prototype.keyprocess=function(t){if((!this.is_singleline||13!=t)&&92!=t){if(PM.Editor.Framework.IsMacintosh()&&t>255)return PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_IME),void PM.Editor.Framework.SetIMEState();if(this.ime.is_activate()){var e=this.ime.is_composite(),i=this.ime.composite(t);if(i.comp_update>=0){if(e&&this.deletechars(-1,X.RECORD_OFF),i.comp_end>=0){var r=String.fromCharCode(i.comp_end);this.insertchars(r,1,X.RECORD_REPL)}if(i.comp_update>=0){var r=String.fromCharCode(i.comp_update);X.RECORD_type=X.RECORD_REPL,(!e||i.comp_end>=0)&&(X.RECORD_type=X.RECORD_INS),this.insertchars(r,1,X.RECORD_type)}}else{this.completecompose();var r=String.fromCharCode(t);this.insertchars(r,1,X.RECORD_INS)}}else{var r=String.fromCharCode(t);this.insertchars(r,1,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.completecompose=function(){this.ime.is_composite()&&(this.ime.flush(),this.movecaretpos(this.doc_pos.getmove()+1))},PM.Ctrl.TextBox.prototype.record_op=function(t,e,i,r){this.redo_stack=[];var o=null,a="";switch(t){case X.RECORD_INS:o=new xop(t,e,null,r),a="문자 입력";break;case X.RECORD_DEL:o=new xop(t,e,i,null),a="문자 삭제";break;case X.RECORD_REPL:this.undo_stack.pop(),PM.Editor.Framework.GetUndoStack().pop(),o=new xop(t,e,null,r),a="문자 입력.";break;case X.RECORD_ATTR:o=new xop(t,e,i,r),a="글꼴 속성 변경";break;case X.RECORD_PARA:o=new xop(t,e,i,r),a="단락 속성 변경";break;case X.RECORD_VALIGN:o=new xop(t,e,i,r),a="세로 정렬"}if(null!=o){var s=PM.Editor.Framework.GetSelectedLayer();if(s&&s.GetType()==PM.TYPE.TEXT){var n=PM.Editor.Framework.GetPairNumber(),h=PM.Editor.Framework.GetSelectedPageIndex(),l=PM.Editor.Framework.GetSelectedLayerIndex(),p={text_data:o,layer_data:s.GetMoveInfo()};this.ctx&&(this.align(this.ctx,!0),PM.Editor.Framework.ResizeFromTBox(s,this.edit_w,this.edit_h));var c={text_data:o,layer_data:s.GetMoveInfo()};PM.Editor.Framework.RecordOperation(PM.RECORD_TEXT_CHANGE,n,{page_pos:h,layer_pos:l,data:p},{page_pos:h,layer_pos:l,data:c},a)}}this.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)},PM.Ctrl.TextBox.prototype.isOverflowText=function(){if(this.is_singleline&&this.dox.getlength()>0){var t=this.dox.getalignedwidth();if(t>0&&t>this.edit_w)return!0;if(this.getdocheight()>this.edit_h)return!0}return!1},PM.Ctrl.TextBox.prototype.insertdoc=function(t,e){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var i=this.doc_pos.getmove(),r=i+t.strings.length;if(this.dox.insertdoc(i,t),this.doc_pos.setpos(r),e!=X.RECORD_OFF){var o=new xpos(i,i),a=t;this.record_op(e,o,null,a)}}},PM.Ctrl.TextBox.prototype.insertchars=function(t,e,i){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var r=this.doc_pos.getmove(),o=r+e;if(this.dox.insertchars(r,t,e),this.doc_pos.setpos(o),i!=X.RECORD_OFF){var a=new xpos(r,r),s=this.dox.getblockdoc(r,o-1);this.record_op(i,a,null,s)}}},PM.Ctrl.TextBox.prototype.deletechars=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var i=this.doc_pos.getblock();if(i.left>=0&&i.right>=0){if(e!=X.RECORD_OFF){var r=new xpos(i.left,i.left),o=this.dox.getblockdoc(i.left,i.right);this.record_op(e,r,o,null)}this.doc_pos.setpos(i.left),this.dox.deletechars(i.left,i.right-i.left+1)}}else{if(0>t){if(!this.doc_pos.moveleft(0))return;t=1}var a=this.doc_pos.getmove();if(e!=X.RECORD_OFF){var r=new xpos(a,a),o=this.dox.getblockdoc(a,a+t-1);this.record_op(e,r,o,null)}this.dox.deletechars(a,t),this.doc_pos.setpos(a)}},PM.Ctrl.TextBox.prototype.select=function(t,e){if(!(0>t||t>=e)){this.doc_pos.setpos(t),this.doc_pos.setmove(e);var i=this.dox.pos2caretrect(e,!1);this.caret.setrect(i),this.caret.setbase_x(i.l)}},PM.Ctrl.TextBox.prototype.movehome=function(t,e){var i=this.dox.pos2linepos(t,0);e?this.doc_pos.setmove(i):this.doc_pos.setpos(i);var r=this.dox.pos2caretrect(i,!1);this.caret.setrect(r),this.caret.setbase_x(r.l)},PM.Ctrl.TextBox.prototype.moveend=function(t,e){var i=this.dox.pos2linepos(t,1);e?this.doc_pos.setmove(i):this.doc_pos.setpos(i);var r=this.dox.pos2caretrect(i,!1);this.caret.setrect(r),this.caret.setbase_x(r.l)},PM.Ctrl.TextBox.prototype.movecaretpos=function(t){this.ime.is_composite()&&--t,0>t&&(t=0),t>this.dox.getlength()&&(t=this.dox.getlength());var e=this.dox.pos2caretrect(t,this.ime.is_composite());this.caret.setrect(e),this.caret.setbase_x(e.l)},PM.Ctrl.TextBox.prototype.movecaretpoint=function(t,e){var i=this.dox.point2caretrect(t,0);return this.caret.setrect(i.rect),e&&this.caret.setbase_x(i.rect.l),i.pos},PM.Ctrl.TextBox.prototype.movelinecaretpoint=function(t,e,i){var r=this.dox.point2caretrect(t,i);return this.caret.setrect(r.rect),e&&this.caret.setbase_x(r.rect.l),r.pos},PM.Ctrl.TextBox.prototype.copydox=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock(),e=this.dox.getblockdoc(t.left,t.right);return null!=e?e.toJSON():""},PM.Ctrl.TextBox.prototype.pastedox=function(t){if(this.is_editable){var e=JSON.parse(t);if(null!=e){var i=new xdoc;i.loaddata(e),this.insertdoc(i,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.setfontprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var i=this.doc_pos.getblock(),r=this.dox.getblockdoc(i.left,i.right);this.dox.setblockattrstate(i.left,i.right,t,e);var o=new xpos(i.left,i.right),a=this.dox.getblockdoc(i.left,i.right);this.record_op(X.RECORD_ATTR,o,r,a)}else{var o=this.doc_pos.getmove();this.dox.setattrstate(o,t,e)}},PM.Ctrl.TextBox.prototype.setparaprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var i=this.doc_pos.getblock(),r=this.dox.getselparas(i.left,i.right);this.dox.setblockparastate(i.left,i.right,t,e);var o=new xpos(i.left,i.right),a=this.dox.getselparas(i.left,i.right);this.record_op(X.RECORD_PARA,o,r,a)}else{var s=this.doc_pos.getmove(),r=this.dox.getselparas(s,-1);this.dox.setparastate(s,t,e);var o=new xpos(s,-1),a=this.dox.getselparas(s,-1);this.record_op(X.RECORD_PARA,o,r,a)}},PM.Ctrl.TextBox.prototype.dump_undoredo=function(){console.log(".>> tbox stack log");for(var t=null,e=0;2>e;e++){0==e?(console.log("undo_stack"),t=this.undo_stack):(console.log("redo_stack"),t=this.redo_stack);for(var i=0;i<t.length;i++){var r="";switch(t[i].type){case X.RECORD_INS:r="insert ";break;case X.RECORD_DEL:r="delete ";break;case X.RECORD_REPL:r="replace";break;case X.RECORD_ATTR:r="attr   ";break;case X.RECORD_PARA:r="para   "}r+="["+t[i].pos.getpivot()+","+t[i].pos.getmove()+"]",t[i].ins&&(r+=" (ins)",r+=t[i].ins.strings),t[i].del&&(r+=" (del)",r+=t[i].del.strings),console.log(r)}}},PM.Ctrl.TextBox.prototype.setfontdefault=function(t,e,i,r,o){var a=new xattr;a.facename=t,a.point=parseInt(e),a.textcolor=i,a.bold=r,a.italic=o,this.dox.setdefault(a,null)},PM.Ctrl.TextBox.prototype.setparadefault=function(t,e,i){var r=new xpara;switch(t){case"left":r.align=0;break;case"right":r.align=1;break;case"center":r.align=2;break;case"scattering":r.align=3;break;case"justify":r.align=4}r.paragap=e,r.linegap=i,this.dox.setdefault(null,r)},PM.Ctrl.TextBox.prototype.getfontstate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockattrstate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getattrstate(e)}return null==t.attr||null==t.filter?null:{fontface:t.filter.facename?t.attr.facename:"",fontpoint:t.filter.point?t.attr.point:0,fillcolor:t.filter.textcolor?t.attr.textcolor:"",isstroke:t.filter.strokecolor&&""!=t.attr.strokecolor?!0:!1,isbold:t.filter.bold?t.attr.bold:!1,isitalic:t.filter.italic?t.attr.italic:!1,isunderline:t.filter.underline?t.attr.underline:!1,charw:t.filter.charw?t.attr.charw:0}},PM.Ctrl.TextBox.prototype.getparastate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockparastate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getparastate(e)}if(null==t.para||null==t.filter)return null;var i=t.filter.linegap?t.para.linegap:"",r=t.filter.paragap?t.para.paragap:"",o="";if(t.filter.align)switch(t.para.align){case 0:o="left";break;case 1:o="right";break;case 2:o="center";break;case 3:o="scattering";break;case 4:o="justify"}return{lineh:i,parah:r,align:o}},PM.Ctrl.TextBox.prototype.setfontname=function(t){var e=this;PM.Util.LoadWebFont(t,function(){var i=new xattr,r=new xattr_filter(!1);i.facename=t,r.facename=!0,e.setfontprop(i,r)})},PM.Ctrl.TextBox.prototype.setfontsize=function(t){var e=new xattr,i=new xattr_filter(!1);e.point=t,i.point=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontcolor=function(t){var e=new xattr,i=new xattr_filter(!1);e.textcolor=t,i.textcolor=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontstroke=function(t){var e=new xattr,i=new xattr_filter(!1);e.strokecolor=t?"#ff7f00":"",i.strokecolor=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontbold=function(t){var e=new xattr,i=new xattr_filter(!1);e.bold=t,i.bold=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontitalic=function(t){var e=new xattr,i=new xattr_filter(!1);e.italic=t,i.italic=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontunderline=function(t){var e=new xattr,i=new xattr_filter(!1);e.underline=t,i.underline=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setfontwidth=function(t){var e=new xattr,i=new xattr_filter(!1);e.charw=t,i.charw=!0,this.setfontprop(e,i)},PM.Ctrl.TextBox.prototype.setalign=function(t){var e=new xpara,i=new xpara_filter(!1);switch(t){case"left":e.align=0;break;case"right":e.align=1;break;case"center":e.align=2;break;case"scattering":e.align=3;break;case"justify":e.align=4}i.align=!0,this.setparaprop(e,i)},PM.Ctrl.TextBox.prototype.setvalign=function(t,e){var i=PM.Editor.Framework.GetSelectedLayer();if(i&&i.gid&&"spine"==i.gid)return PM.Editor.Framework.ShowMessageBar("책등은 가운데 정렬만 지원합니다."),!1;var r=this.valign;switch(t){case"top":this.valign=0;break;case"middle":this.valign=1;break;case"bottom":this.valign=2}var o=this.valign;return e&&this.record_op(X.RECORD_VALIGN,0,r,o),!0},PM.Ctrl.TextBox.prototype.getvalign=function(){var t="";switch(this.valign){case 0:t="top";break;case 1:t="middle";break;case 2:t="bottom"}return t},PM.Ctrl.TextBox.prototype.setlineh=function(t){var e=new xpara,i=new xpara_filter(!1);e.linegap=t,i.linegap=!0,this.setparaprop(e,i)},PM.Ctrl.TextBox.prototype.setparah=function(t){var e=new xpara,i=new xpara_filter(!1);e.paragap=t,i.paragap=!0,this.setparaprop(e,i)},PM.Ctrl.TextBox.prototype.fromString=function(t){this.undo_stack=[],this.redo_stack=[];var t=t.replace(/\r\n/gi,X.ENTERKEY);t=t.replace(/\n/gi,X.ENTERKEY),t=t.replace(/\r/gi,X.ENTERKEY),this.select(0,this.dox.getlength()),this.insertchars(t,t.length,X.RECORD_OFF)},PM.Ctrl.TextBox.prototype.toString=function(){return this.dox.toString()},PM.Ctrl.TextBox.prototype.toSVG=function(){return this.dox.toSVG()},PM.Ctrl.TextBox.prototype.setimemode=function(t){this.completecompose(),this.ime.activate(t),this.movecaretpos(this.doc_pos.getmove())},PM.Ctrl.TextBox.prototype.copytext=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock();return this.dox.getblocktext(t.left,t.right)},PM.Ctrl.TextBox.prototype.pastetext=function(t){this.insertchars(t,t.length,X.RECORD_INS)},PM.Ctrl.TextBox.prototype.copy=function(){return this.clipboard_memory=this.copydox(),this.clipboard_memory},PM.Ctrl.TextBox.prototype.paste=function(t){""==t&&(t=this.clipboard_memory),this.clipboard_memory.length>0&&this.pastedox(this.clipboard_memory)},PM.Ctrl.TextBox.prototype.undo=function(){if(!this.is_editable)return!1;if(this.undo_stack.length<=0)return!1;var t=this.undo_stack.pop();return null!=t&&(this.undo_action(t),this.redo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.redo=function(){if(!this.is_editable)return!1;if(this.redo_stack.length<=0)return!1;var t=this.redo_stack.pop();return null!=t&&(this.redo_action(t),this.undo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.undo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.del);break;case X.RECORD_VALIGN:this.valign=t.del}return!0},PM.Ctrl.TextBox.prototype.redo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.ins);break;case X.RECORD_VALIGN:this.valign=t.ins}return!0},PM.Ctrl.TextBox.prototype.setsingleline=function(t){this.is_singleline=t,this.dox.is_singleline=t},PM.Ctrl.TextBox.prototype.isspine=function(){return this.is_spine},PM.Ctrl.TextBox.prototype.setspine=function(t){this.is_spine=t},PM.Ctrl.TextBox.prototype.getautoresize=function(){return this.is_autoresize},PM.Ctrl.TextBox.prototype.setautoresize=function(t){this.is_autoresize=t},PM.Ctrl.TextBox.prototype.seteditable=function(t){this.is_editable=t},PM.Ctrl.TextBox.prototype.getwidth=function(){return this.edit_w},PM.Ctrl.TextBox.prototype.getheight=function(){return this.edit_h},PM.Ctrl.TextBox.prototype.getdocwidth=function(){return this.dox.getdocwidth()},PM.Ctrl.TextBox.prototype.getdocheight=function(){return this.dox.getdocheight()},PM.Ctrl.TextBox.prototype.isfocus=function(){return this.caret.is_show()},PM.Ctrl.TextBox.prototype.setfocus=function(){this.caret.show(!0)},PM.Ctrl.TextBox.prototype.killfocus=function(){this.completecompose(),this.caret.show(!1)},PM.Ctrl.TextBox.prototype.selectAll=function(){this.select(0,this.dox.getlength()),this.callback_update_state()},PM.Ctrl.TextBox.prototype.updateall=function(t){if(null!=this.ctx){var e=this.ctx;this.dox.aligndoc(e,this.edit_w,!0),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(t),this.draw(e)}},PM.Editor.Framework=new function(){var t=this,e=!1,i=!1,r=PM.CONFIG.BOOT_LOADING,o="",a=new PM.Ctrl.Message,s=null,n=null,h=null,l=null,p=0,c=1,d=!1,u=!1,_=PM.CONFIG.GRID_SPACE,g=PM.CONFIG.GRID_COLOR,f=[],P=[],y=[];this.Init=function(e){PM.Util.LoadWebFont(PM.CONFIG.FONT_DEFAULT,function(){}),o=document.title,document.title=o+"."+PM.Core.Version,PM.Core.MAIN_CANVAS_ID=e.canvasTarget.id,n=e.canvasTarget,h=n.getContext("2d"),n.width=2e3,n.height=2e3,n.ondragover=this.OnDragOver,n.ondrop=this.OnDrop,n.addEventListener("contextmenu",this.OnContextMenu,!1),n.addEventListener("dblclick",this.OnDoubleClick,!1),n.addEventListener("mousedown",this.OnMouseDown,!1),n.addEventListener("mousemove",this.OnMouseMove,!1),document.addEventListener("mouseup",this.OnMouseUp,!1),document.addEventListener("keydown",this.OnKeyDown,!1),document.addEventListener("keypress",this.OnKeyPress,!1),document.addEventListener("keyup",this.OnKeyUp,!1),window.addEventListener("resize",this.OnResize,!0),document.body.addEventListener("online",this.OnUpdateConnection,!1),document.body.addEventListener("offline",this.OnUpdateConnection,!1),$(window).on("beforeunload",function(){}),window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3)}}(),window.requestAnimationFrame(this.OnMainLoop),l=e.productInfo,l.Load(null),this.SetModified(!1),P=[],y=[],this.loadCompleteCallback=e.loadCompleteCallback,this.addPhotosCompleteCallback=e.addPhotosCompleteCallback,this.deletePhotosCompleteCallback=e.deletePhotosCompleteCallback,this.updateTextStateCallback=e.updateTextStateCallback,this.selectLayerCallback=e.selectLayerCallback,this.moveLayerCallback=e.moveLayerCallback,this.contextMenuCallback=e.contextMenuCallback,this.movePageCallback=e.movePageCallback,this.dropTargetCallback=e.dropTargetCallback,this.updateTextBoundsCallback=function(e,i){var r=t.GetSelectedLayer();r&&r.GetType()==PM.TYPE.TEXT&&t.ResizeFromTBox(r,e,i)},s=e.infoTarget;var i=PM.Util.LoadImage(PM.CONFIG.COVER_BARCODE_IMAGE);i.done(function(e){t.cover_barcode_image=e}),i.fail(function(){t.cover_barcode_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.COVER_BARCODE_IMAGE)});var r=PM.Util.LoadImage(PM.CONFIG.PAGE_GRADATION_IMAGE);r.done(function(e){t.page_gradation_image=e}),r.fail(function(){t.page_gradation_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PAGE_GRADATION_IMAGE)});var a=PM.Util.LoadImage(PM.CONFIG.PHOTO_EMPTY_IMAGE);a.done(function(e){t.photo_empty_image=e}),a.fail(function(){t.photo_empty_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_EMPTY_IMAGE)});var p=PM.Util.LoadImage(PM.CONFIG.PHOTO_WARNING_IMAGE);p.done(function(e){t.photo_warning_image=e}),p.fail(function(){t.photo_warning_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_WARNING_IMAGE)})},this.Ready=function(t){r=t,r==PM.CONFIG.BOOT_SUCCESS&&(this.RecalcCanvasSize(),e=PM.Util.IsMacintosh())},this.IsShiftState=function(){return i},this.IsMacintosh=function(){return e},this.SetIMEState=function(){n.style.imeMode="disable"},this.IsModified=function(){return this.is_modified},this.SetModified=function(t){this.is_modified=t,document.title=o+"."+PM.Core.Version+(this.is_modified?"*":"")},this.IsEmptySpine=function(){return l?l.IsEmptySpine():!1},this.IsComplete=function(){return l?l.CheckComplete():!1},this.ResizeFromTBox=function(t,e,i){l&&(l.dragger.IsResize()||t.ResizeFromTBoxCallback(e,i),l.ResizeFromTBoxCallbackProcess(c),l.CheckBoundary(p))},this.LoadProduct=function(t){var e=null;try{e=JSON.parse(t)}catch(i){e=null,console.error(i)}if(e){var r=new PM.Core.Product;r.LoadJson(e),l=null,l=r,this.SetModified(!1),P=[],y=[]}else PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"Parse failed")},this.SaveProduct=function(){return l?(this.SetModified(!1),l.SaveJson()):""},this.ClearProduct=function(){l=null,p=0,c=1,this.SetModified(!1)},this.ShowMessageBar=function(t){a.Show(t)},this.HideMessageBar=function(){a.Hide()},this.LoadTheme=function(t,e,i){var r=new PM.Core.Product;r.user_id=l.user_id,r.session_id=l.session_id,r.add_param=l.add_param,r.product_code=l.product_code,r.product_key=l.product_key,r.product_name=l.product_name,r.product_size=l.product_size,r.product_type=l.product_type,r.cover_type=l.cover_type,r.surface_type=l.surface_type,r.theme_depth1=t,r.theme_depth2=e,r.theme_name=i,r.price=l.price,r.price_page=l.price_page,r.min_page=l.min_page,r.max_page=l.max_page;var o=l.GetUserImageListPerPage();this.ClearProduct(),l=r,l.Load(o),this.SetModified(!1),P=[],y=[]},this.IsHoleLeatherCoverProduct=function(){return l?l.IsHoleLeatherCoverProduct():!1},this.SetSharedImageInfo=function(t){l&&l.IsHoleLeatherCoverProduct()&&l.SetSharedImageInfo(t)},this.SetCurrentThumbnail=function(){l&&this.ModifyCurrentThumbnail(p)},this.ModifyCurrentThumbnail=function(t){this.DrawThumbnail(t),this.IsHoleLeatherCoverProduct()&&(0==t?this.DrawThumbnail(1):1==t&&this.DrawThumbnail(0))},this.DrawThumbnail=function(t){if(!(0>t||t>=f.length)&&null!=f[t]&&void 0!=f[t]){var e=f[t],i=e.getContext("2d"),r=l.GetFitScaleFactor(e.width-5,e.height-5);this.Draw(i,e,r,t)}},this.ConnectPageThumbnail=function(t,e){if(l&&t){f[e]=t;var i=t,r=t.getContext("2d"),o=l.GetFitScaleFactor(i.width-5,i.height-5);i&&r&&this.Draw(r,i,o,e)}},this.MakePreviewImages=function(t){if(!l)return null;var e=null,i=d;d=!0;try{e=l.MakePreviewImages(t)}catch(r){e=null,console.error(r)}finally{d=!1,d=i}return e},this.SetPreviewMode=function(t){d=t},this.IsPreviewMode=function(){return d},this.GetUserImageList=function(){return l?l.GetUserImageList():""},this.GetUserImageListText=function(){if(!l)return"";for(var t="",e=l.GetUserImageList(),i=0;i<e.length;i++){var r=JSON.parse(e[i]);t+=r.org_link,t+="\n"}return t},this.GetPoolInfo=function(){return l?l.GetPoolInfo():null},this.GetParentElementSize=function(){var t={w:1e3,h:600};if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var e=n.parentElement.getBoundingClientRect();t.w=e.width,t.h=e.height}return t},this.RecalcCanvasSize=function(){if(l){var t=PM.Util.P2LSize(this.GetParentElementSize(),c),e=this.GetPairSize(p),i={w:e.w+PM.CONFIG.CANVAS_MARGIN_W,h:e.h+PM.CONFIG.CANVAS_MARGIN_H},r=Math.max(i.w,t.w),o=Math.max(i.h,t.h);n.width=r*c-20,n.height=o*c-20}},this.FitScale=function(){if(!l)return 1;var t=this.GetParentElementSize();return n.width=t.w,n.height=t.h,c=l.GetFitScaleFactor(n.width-PM.CONFIG.CANVAS_MARGIN_W,n.height-PM.CONFIG.CANVAS_MARGIN_H),this.Draw(h,n,c,p),c},this.SetScale=function(t){return l?(t<PM.CONFIG.SCALE_MIN?t=PM.CONFIG.SCALE_MIN:t>PM.CONFIG.SCALE_MAX&&(t=PM.CONFIG.SCALE_MAX),c=t,this.RecalcCanvasSize(),this.Draw(h,n,c,p),t):1},this.GetScale=function(){return c},this.MovePair=function(t){return l?(pair_count=l.PairCount(),0>t?t=0:t>=pair_count&&(t=pair_count-1),p=t,this.RecalcCanvasSize(),l.ClearSelect(),this.Draw(h,n,c,p),this.movePageCallback&&this.movePageCallback(p),p):0},this.GetPairText=function(t){return l?l.GetPairText(t):""},this.GetPairNumber=function(){return p},this.GetPairCount=function(){return l?l.PairCount():0},this.GetPairSize=function(t){return l?l.GetPairSize(t):{w:0,h:0}},this.GetCurrentPairSize=function(){return l?l.GetPairSize(p):{w:0,h:0}},this.GetCurrentPageEditableSize=function(){return l?l.GetCurrentPageEditableSize(p):{w:0,h:0}},this.GetPageNumber=function(t){return l?l.Pair2PageIndex(t):PM.PAGE.ERROR},this.GetInnerPageCount=function(){return l?l.GetInnerPageCount():0},this.SwapPair=function(t,e){return!1},this.ReorderPair=function(t){return l?d?!1:(this.SetModified(!0),l.ReorderPages(p,t)):!1},this.AddPair=function(t,e){return l?d?PM.ADDPAGE_FAIL:(this.SetModified(!0),"current"==t?l.AddPages(p,parseInt(e)):"last"==t?l.AddPages(-1,parseInt(e)):PM.ADDPAGE_FAIL):PM.ADDPAGE_FAIL},this.DeletePair=function(t,e){if(!l)return PM.DELPAGE_FAIL;if(d)return PM.DELPAGE_FAIL;this.SetModified(!0);var i=PM.DELPAGE_FAIL;return"current"==t?i=l.DeletePages(p,parseInt(e)):"last"==t&&(i=l.DeletePages(-1,parseInt(e))),this.MovePair(p),i},this.DeleteLayer=function(){l&&(d||(this.SetModified(!0),l.DeleteLayer()))},this.RotateLayer=function(t){return l?d?!1:(this.SetModified(!0),l.RotateLayer(t)):!1},this.UpLayer=function(){return l?d?!1:(this.SetModified(!0),l.UpLayer()):!1},this.DownLayer=function(){return l?d?!1:(this.SetModified(!0),l.DownLayer()):!1},this.AddPhotos=function(t){l&&(d||(this.SetModified(!0),l.AddPhotos(t)))},this.DeletePhotos=function(){l&&(d||(this.SetModified(!0),l.DeletePhotos()))},this.GetProduct=function(){return l},this.GetSelectedLayer=function(){return l?d?null:l.GetSelectedLayer():null},this.GetSelectedLayerIndex=function(){if(!l)return null;if(d)return null;var t=this.GetSelectedPage();if(t){var e=l.GetSelectedLayer();return t.GetLayerIndex(e)}return-1},this.GetSelectedPage=function(){return l?d?null:l.GetSelectedPage():null},this.GetSelectedPageIndex=function(){return l?d?null:l.GetSelectedPageIndex():null},this.GetEditableTextBox=function(){if(!l)return null;if(d)return null;var t=l.GetSelectedLayer();return t&&t.GetType()==PM.TYPE.TEXT?t.GetEditableTextBox():null},this.GetGridMode=function(){return u},this.SetGridMode=function(t){d||(u=t)},this.GetGridOption=function(){return{space:_,color:g}},this.SetGridOption=function(t){_=t.space,g=t.color},this.Draw=function(t,e,i,o){t.clearRect(0,0,e.width,e.height),t.save(),t.scale(i,i);var s={w:e.width,h:e.height};if(s=PM.Util.P2LSize(s,i),l&&r==PM.CONFIG.BOOT_SUCCESS&&(l.DrawPair(t,o,s.w,s.h),e==n&&(this.DrawBarcode(t,o),d||(this.DrawGuideline(t,o),u&&this.DrawGrid(t,o),this.DebugInfo(t)))),t.restore(),e==n&&!d){if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var h=n.parentElement.scrollLeft,p=n.parentElement.scrollTop,c=n.parentElement.getBoundingClientRect().width,_=PM.CONFIG.MESSAGEBAR_HEIGHT;a.Draw(t,h,p,c,_)}if(r!=PM.CONFIG.BOOT_SUCCESS){var g=r==PM.CONFIG.BOOT_FAILURE?PM.CONFIG.BOOT_FAILURE_MSG:PM.CONFIG.BOOT_LOADING_MSG,h=n.parentElement.scrollLeft,p=n.parentElement.scrollTop,f=n.parentElement.getBoundingClientRect();this.DrawBootMessage(t,h,p,f.width,f.height,g)}}},this.DrawBarcode=function(t,e){t.save();var i=0>=e;if(i&&this.cover_barcode_image){var r=l.GetWorkRect(e),o=r.l,a=r.t,s=PM.Codi.GetGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());t.drawImage(this.cover_barcode_image,o+s.barcode_rect.x,a+s.barcode_rect.y,s.barcode_rect.w,s.barcode_rect.h)}t.restore()},this.DrawGuideline=function(t,e){t.save();var i=l.GetWorkRect(e),r=i.l,o=i.l+i.w,a=i.t,s=i.t+i.h,n=0>=e,h=l.GetSpineWidth(),p=PM.Codi.GetGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount()),c=PM.CONFIG.GUIDE_EXTRA;if(t.strokeStyle=PM.CONFIG.GUIDE_COLOR,t.fillStyle=PM.CONFIG.GUIDE_TEXT_COLOR,t.lineWidth=PM.CONFIG.GUIDE_LINEW,t.beginPath(),t.moveTo(r-c,a+p.cut_h),t.lineTo(o+c,a+p.cut_h),t.moveTo(r-c,s-p.cut_h),t.lineTo(o+c,s-p.cut_h),t.moveTo(r+p.cut_w,a-c),t.lineTo(r+p.cut_w,s+c),t.moveTo(o-p.cut_w,a-c),t.lineTo(o-p.cut_w,s+c),t.font=PM.CONFIG.GUIDE_FONT,n)if(l.IsAvailableSpine()){var d=r+i.w/2-p.middle_w/2,u=d+p.middle_w,_=r+i.w/2-h/2,g=_+h,f="";PM.DEBUG&&l.cover.middle_page&&(f=":"+p.middle_w+"=="+l.cover.middle_page.width+"("+h+")"),t.moveTo(d,a-c),t.lineTo(d,s+c),t.moveTo(u,a-c),t.lineTo(u,s+c),t.moveTo(_,a-c),t.lineTo(_,s+c),t.moveTo(g,a-c),t.lineTo(g,s+c),t.textAlign="center",t.textBaseline="bottom",t.fillText("책등"+f,r+i.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("뒷면->",_,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-앞면",g,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-인쇄영역",r,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("인쇄영역->",o,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.fillText("(인쇄영역까지 사진을 넣어주셔야 여백없이 제작됩니다)",o,s+PM.CONFIG.GUIDE_FONT_H+2*PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-접히는면",r+p.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->",o-p.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}else l.IsHoleLeatherCoverProduct()&&(t.textAlign="center",t.textBaseline="bottom",t.fillText(PM.CONFIG.GUIDE_LEATHERCOVER_TEXT,r+i.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN));else{var P=r+i.w/2;t.moveTo(P,a-c),t.lineTo(P,s+c),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->   ",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("   <-접히는면",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-잘리는면",r+p.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("잘리는면->",o-p.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}t.stroke(),t.restore()},this.DrawGrid=function(t,e){t.save();var i=l.GetWorkRect(e),r=i.l,o=i.l+i.w,a=i.t,s=i.t+i.h,n=_;t.strokeStyle=g,t.lineWidth=PM.CONFIG.GRID_LINEW,t.beginPath();for(var h=r;o>=h;h+=n)t.moveTo(h,a),t.lineTo(h,s);for(var h=a;s>=h;h+=n)t.moveTo(r,h),t.lineTo(o,h);t.stroke(),t.restore()},this.DrawBootMessage=function(t,e,i,r,o,a){t.save(),t.font=PM.CONFIG.BOOT_FONT,t.fillStyle=PM.CONFIG.BOOT_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+r/2,i+o/2),t.restore()},this.DebugInfo=function(){s&&s.html(this.DebugString())},this.DebugString=function(){if(!PM.DEBUG)return"";var t="";t+=" [total:"+l.GetInnerPageCount()+"p",t+=" "+l.GetPairText(p),t+=" ] ";
var e=PM.Codi.GetGuideInfo(p,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());return t+="[",t+=" 책등폭:"+e.middle_w,t+=" 재단선:"+e.cut_w+" "+e.cut_h,t+=" 바코드:"+e.barcode_rect.x+" "+e.barcode_rect.y+" "+e.barcode_rect.w+" "+e.barcode_rect.h,t+=" ] ",t+="["+l.product_code,t+=" "+l.product_size,t+=" "+l.product_type,t+=" "+l.cover_type,t+=" "+l.surface_type,t+=" "+l.theme_depth1,t+=" "+l.theme_depth2,t+="]"},this.Information=function(){var t="";return t=" product_key: "+l.product_key,t+="\n product_name: "+l.product_name,t+="\n product_code: "+l.product_code,t+="\n theme_depth1: "+l.theme_depth1,t+="\n theme_depth2: "+l.theme_depth2,t+="\n",t+="\n product_size: "+l.product_size,t+="\n product_type: "+l.product_type,t+="\n cover_type: "+l.cover_type,t+="\n surface_type: "+l.surface_type,t+="\n",t+="\n price:"+l.price,t+="\n price_page:"+l.price_page,t+="\n min_page:"+l.min_page,t+="\n max_page:"+l.max_page,t+="\n"},this.WindowToCanvas=function(t){var t=window.event||t,e=n.getBoundingClientRect();return{x:t.clientX-e.left*(n.width/e.width),y:t.clientY-e.top*(n.height/e.height)}},this.OnMainLoop=function(){t.OnIdle(),window.requestAnimationFrame(t.OnMainLoop)};var m=0;this.OnIdle=function(){t.Draw(h,n,c,p);var e=+new Date;e-m>1e3&&(t.ModifyCurrentThumbnail(p),m=e)},this.OnUpdateConnection=function(){var e=navigator.onLine?PM.CONFIG.MESSAGE_ONLINE:PM.CONFIG.MESSAGE_OFFLINE;t.ShowMessageBar(e)},this.OnKeyDown=function(e){if(l&&!d)if(l.KeyDown(e))t.SetModified(!0);else{i=e.shiftKey;var r=e.which||e.keyCode;switch(r){case 90:e.ctrlKey&&(e.shiftKey?t.Redo():t.Undo());break;case 89:e.ctrlKey&&t.Redo()}}},this.OnKeyPress=function(e){l&&(d||l.KeyPress(e)&&t.SetModified(!0))},this.OnKeyUp=function(){i=!1},this.OnDoubleClick=function(e){if(l&&!d){l.ResetFocus(p);var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);if(l.DblClick(e,h,p,i.x,i.y),2==c&&u&&e.shiftKey){var r=l.GetWorkRect(p);i.x<r.l&&i.x>r.l-20&&(PM.DEBUG=!PM.DEBUG)}}},this.OnMouseDown=function(e){if(l&&!d&&3!=e.which){l.ResetFocus(p);var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);l.Select(e,h,p,i.x,i.y,c)}},this.OnMouseMove=function(e){if(l&&!d){var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c),r=l.Move(e,h,p,i.x,i.y,c);switch(r.hit_type){case PM.HIT.MOVE:e.target.style.cursor="move";break;case PM.HIT.RESIZE_T:e.target.style.cursor="n-resize";break;case PM.HIT.RESIZE_R:e.target.style.cursor="e-resize";break;case PM.HIT.RESIZE_B:e.target.style.cursor="s-resize";break;case PM.HIT.RESIZE_L:e.target.style.cursor="w-resize";break;case PM.HIT.RESIZE_LT:e.target.style.cursor="nw-resize";break;case PM.HIT.RESIZE_RT:e.target.style.cursor="ne-resize";break;case PM.HIT.RESIZE_RB:e.target.style.cursor="se-resize";break;case PM.HIT.RESIZE_LB:e.target.style.cursor="sw-resize";break;case PM.HIT.ROTATE:e.target.style.cursor="pointer";break;case PM.HIT.MOVE_CROP:e.target.style.cursor="pointer";break;case PM.HIT.EDIT_TEXT:e.target.style.cursor="text";break;default:e.target.style.cursor="default"}r.modified&&t.SetModified(!0)}},this.OnMouseUp=function(e){if(l&&!d){var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);l.Up(e,h,p,i.x,i.y,c),e.target.style.cursor="default"}},this.OnContextMenu=function(e){if(!d){e.preventDefault();var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);l.ContextMenu(e,h,p,i.x,i.y,c)}},this.OnResize=function(){t.RecalcCanvasSize()},this.OnDragOver=function(e){if(l&&!d){var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);l.DragOver(e,h,p,i.x,i.y)&&e.preventDefault()}},this.OnDrop=function(e){if(l&&!d){l.ResetFocus(p);var i=PM.Util.P2LPoint(t.WindowToCanvas(e),c);l.Drop(e,h,p,i.x,i.y),t.SetModified(!0)}},this.DropDefault=function(t,e){l&&(d||(l.ResetFocus(p),l.DropDefault(p,t,e),this.SetModified(!0)))},this.ChangeAll=function(t,e){if(!l)return!1;if(d)return!1;l.ResetFocus(p);var i=l.ChangeAll(p,t,e);return i?(this.SetModified(!0),!0):!1},this.Copy=function(){return l?d?!1:this.IsCopyAvailable()?l.Copy(p):(console.log("Copy is not available."),!1):!1},this.Cut=function(){return l?d?!1:this.IsCutAvailable()?(this.SetModified(!0),l.Cut(p)):(console.log("Cut is not available."),!1):!1},this.Paste=function(){return l?d?!1:this.IsPasteAvailable()?(this.SetModified(!0),l.Paste(p)):(console.log("Paste is not available."),!1):!1},this.RecordOperation=function(t,e,i,r,o){var a=new PM.Record(t,e,i,r,o);null!=a&&(y=[],P.push(a))},this.DumpRecord=function(){if(PM.DEBUG){console.log("\n[undo stack...................]");for(var t=0;t<P.length;t++)console.log(t+". "+P[t].desc);console.log("\n[redo stack...................]");for(var t=0;t<y.length;t++)console.log(t+". "+y[t].desc);console.log("\n")}},this.Undo=function(){this.IsUndoAvailable()||console.log("Undo is not available.");var t=P.pop();t&&(l.ResetFocus(p),t.UndoAction(),y.push(t),l.ResetFocus(p),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.Redo=function(){this.IsRedoAvailable()||console.log("Redo is not available.");var t=y.pop();t&&(l.ResetFocus(p),t.RedoAction(),P.push(t),l.ResetFocus(p),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.GetUndoStack=function(){return P},this.GetUndoDesc=function(){if(P.length>0){var t=P[P.length-1];if(t&&t.desc)return t.desc}return""},this.GetRedoDesc=function(){if(P.length>0){var t=y[y.length-1];if(t&&t.desc)return t.desc}return""},this.IsCopyAvailable=function(){if(!l)return!1;if(d)return!1;var t=l.GetSelectedLayer();return t&&"spine"!=t.gid},this.IsCutAvailable=function(){return this.IsCopyAvailable()},this.IsPasteAvailable=function(){return l.clipboard_memory.length>0},this.IsUndoAvailable=function(){return P.length>0},this.IsRedoAvailable=function(){return y.length>0}},PM.Lib.AjaxItem=function(){this.status="ready",this.params=null,this.xhr=null,this.result={},this.success=null,this.error=null,this.abort=null},PM.Lib.AjaxItem.prototype.Init=function(t,e,i,r){this.params=t,this.success=e,this.error=i,this.abort=r},PM.Lib.AjaxItem.prototype.Send=function(){if(null!=this.params){this.params.timeout=3e4;var t=this;this.status="waiting",this.xhr=$.ajax(this.params),this.xhr.done(function(e,i,r){t.status="success",t.result={data:e,textStatus:i,jqXHR:r}}),this.xhr.fail(function(e,i,r){t.status="fail",t.result={jqXHR:e,textStatus:i,errorThrown:r}})}},PM.Lib.AjaxItem.CommitSuccess=function(){null!=this.success&&this.success(this.result.data,this.result.textStatus,this.result.jqXHR)},PM.Lib.AjaxItem.CommitError=function(){null!=this.error&&this.error(this.result.jqXHR,this.result.textStatus,this.result.errorThrown)},PM.Lib.AjaxItem.CommitAbort=function(){null!=this.xhr&&this.xhr.abort(),null!=this.abort&&this.abort()},PM.Lib.AjaxManager=new function(){this.request_array=[],this.Add=function(t,e,i,r){var o=new PM.Lib.AjaxItem;o.Init(t,e,i,r),this.request_array.push(o)},this.Download=function(){for(var t in this.request_array)this.request_array[t].Send()}},PM.Lib.SeqItem=function(){this.deferred=$.Deferred(),this.func=null},PM.Lib.SeqManager=function(){this.seq_array=[],this.result={}},PM.Lib.SeqManager.prototype.Add=function(t){var e=new PM.Lib.SeqItem;e.func=t,this.seq_array.push(e)},PM.Lib.SeqManager.prototype.Connect=function(t,e){$.when(e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.ConnectArray=function(t,e){$.when.apply($,e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.Run=function(t,e){for(var i=this,r=0;r<i.seq_array.length;r++){var o=function(r,o){$.when(r.deferred).then(function(){void 0==o?t(i.result):(i.result.deferred=o.deferred,o.func(i.result))},function(){e(i.result)})};o(i.seq_array[r],i.seq_array[r+1])}i.seq_array.length>0?(i.result.deferred=i.seq_array[0].deferred,i.seq_array[0].func(i.result)):t(i.result)},PM.Record=function(t,e,i,r,o){this.type=t,this.pair_pos=e,this.old_info=i,this.new_info=r,this.desc=o},PM.Record.prototype.GetPageFromIndex=function(t){var e=null;if(t>=0)e=PM.Editor.Framework.GetProduct().page_array[t];else switch(t){case PM.PAGE.COVER_FRONT:e=PM.Editor.Framework.GetProduct().cover.front_page;break;case PM.PAGE.COVER_MIDDLE:e=PM.Editor.Framework.GetProduct().cover.middle_page;break;case PM.PAGE.COVER_BACK:e=PM.Editor.Framework.GetProduct().cover.back_page}return e},PM.Record.prototype.ChangeBackground=function(t,e){for(var i=[],r=0;r<e.length;r++){var o=e[r],a=this.GetPageFromIndex(t+r);a&&i.push(o.skin_link.length>0?a.ChangeSkin(o.skin_link):a.ChangeColor(o.color))}$.when.apply($,i).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.ChangeLayout=function(t,e){for(var i=[],r=0;r<e.length;r++){var o=e[r],a=this.GetPageFromIndex(t+r);if(a){var s=JSON.parse(o);i.push(a.LoadJson(s))}}$.when.apply($,i).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.InsertLayer=function(t,e,i){var r=this.GetPageFromIndex(t);r&&r.layer_array.splice(e,0,i)},PM.Record.prototype.DeleteLayer=function(t,e){var i=null,r=this.GetPageFromIndex(t);return r&&(i=r.layer_array[e],r.layer_array.splice(e,1)),i},PM.Record.prototype.MoveLayer=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var i=e.layer_array[t.layer_pos];i&&(i.SetMoveInfo(t.data),i.GetType()==PM.TYPE.TEXT&&i.RecalcTBoxSize(!0))}},PM.Record.prototype.SwapLayer=function(t,e,i){var r=this.GetPageFromIndex(t);if(r){var o=r.layer_array[e];r.layer_array[e]=r.layer_array[i],r.layer_array[i]=o}},PM.Record.prototype.ReorderLayer=function(t,e,i){var r=this.GetPageFromIndex(t);if(r){var o=r.layer_array[i];r.layer_array.splice(i,1),r.layer_array.splice(e,0,o)}},PM.Record.prototype.ChangeFrame=function(t){var e=t.data;if(e.length>0){var i=this.GetPageFromIndex(t.page_pos);if(i){var r=i.layer_array[t.layer_pos];if(r.GetType()==PM.TYPE.IMAGE){var o=e[0];o.value.length>0?r.AddDiagram(o.value):r.DeleteDiagram()}}}},PM.Record.prototype.ChangePhoto=function(t){var e=t.data;if(e.length>0){var i=this.GetPageFromIndex(t.page_pos);if(i){var r=i.layer_array[t.layer_pos];if(r.GetType()==PM.TYPE.IMAGE){var o=e[0];r.SetPhotoState(o.value)}}}},PM.Record.prototype.CropPhoto=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var i=e.layer_array[t.layer_pos];i&&i.SetCropInfo(t.data)}},PM.Record.prototype.AddAllPhotos=function(t,e){for(var i=[],r=t.data,o=0;o<r.length;o++){var a=this.GetPageFromIndex(r[o].page_pos);if(a){var s=a.layer_array[r[o].layer_pos];if(s&&s.GetType()==PM.TYPE.IMAGE)if(e){var n=JSON.parse(r[o].json),h=n.url_domain+n.url_path+n.url_edit,l=n.url_domain+n.url_path+n.url_file,p=n.img_width,c=n.img_height,d=!1,u=s.AddPhoto(h,l,p,c,d);u.added&&i.push(u.promise)}else{var _=s.SetPhotoState(r[o].info);i.push(_)}}}$.when.apply($,i).then(function(){PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},function(){})},PM.Record.prototype.DeleteAllPhotos=function(t){for(var e=t.data,i=0;i<e.length;i++){var r=this.GetPageFromIndex(e[i].page_pos);if(r){var o=r.layer_array[e[i].layer_pos];o&&o.GetType()==PM.TYPE.IMAGE&&o.DeletePhotoProp()}}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Record.prototype.UndoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:var e=PM.Editor.Framework.GetProduct(),i=this.new_info.data;e.page_array.splice(this.new_info.page_pos,i.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:for(var e=PM.Editor.Framework.GetProduct(),i=this.old_info.data,r=i.length-1;r>=0;r--)e.page_array.splice(this.old_info.page_pos,0,i[r]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),i=this.new_info.data,o=[],r=0;r<i.length;r++){var a=i[r];o[a]=e.page_array[r]}e.page_array=o,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_LAYER_INSERT:this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);break;case PM.RECORD_LAYER_DELETE:var i=this.old_info.data;if(i.length>0){var s=i[0];this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,s.value)}break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);n&&this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);this.MoveLayer(this.old_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.old_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.old_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.old_info);break;case PM.RECORD_PHOTO_ADDALL:this.DeleteAllPhotos(this.new_info);break;case PM.RECORD_PHOTO_DELALL:this.AddAllPhotos(this.old_info,!1);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.old_info.data,this.old_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Undo(this.old_info.data.text_data),l.SetMoveInfo(this.old_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Record.prototype.RedoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:for(var e=PM.Editor.Framework.GetProduct(),i=this.new_info.data,r=i.length-1;r>=0;r--)e.page_array.splice(this.new_info.page_pos,0,i[r]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:var e=PM.Editor.Framework.GetProduct(),i=this.old_info.data;e.page_array.splice(this.old_info.page_pos,i.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),i=this.new_info.data,o=[],r=0;r<i.length;r++){var a=i[r];o.push(e.page_array[a])}e.page_array=o,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_LAYER_INSERT:var i=this.new_info.data;if(i.length>0){var s=i[0];this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,s.value)}break;case PM.RECORD_LAYER_DELETE:this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);n&&this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.new_info.page_pos,this.new_info.layer_pos,this.old_info.layer_pos);this.MoveLayer(this.new_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.new_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.new_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.new_info);break;case PM.RECORD_PHOTO_ADDALL:this.AddAllPhotos(this.new_info,!0);break;case PM.RECORD_PHOTO_DELALL:this.DeleteAllPhotos(this.old_info);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.new_info.data,this.new_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Redo(this.new_info.data.text_data),l.SetMoveInfo(this.new_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Util=new function(){this.P2LPoint=function(t,e){return t.x/=e,t.y/=e,t},this.P2LSize=function(t,e){return t.w/=e,t.h/=e,t},this.P2LRect=function(t,e){return t.l/=e,t.t/=e,t.w/=e,t.h/=e,t},this.L2PPoint=function(t,e){return t.x*=e,t.y*=e,t},this.L2PSize=function(t,e){return t.w*=e,t.h*=e,t},this.L2PRect=function(t,e){return t.l*=e,t.t*=e,t.w*=e,t.h*=e,t},this.PtInRect=function(t,e,i){return e>=t.l&&e<=t.l+t.w&&i>=t.t&&i<=t.t+t.h?!0:!1},this.PtInCircle=function(t,e,i,r,o){var a={l:t-i,t:e-i,w:2*i,h:2*i};return this.PtInRect(a,r,o)},this.ToRadian=function(t){return t*Math.PI/180},this.ToAngle=function(t){return 180*t/Math.PI},this.DrawLine=function(t,e,i,r,o,a,s){t.beginPath(),t.lineWidth=a,t.strokeStyle=s,t.moveTo(e,i),t.lineTo(r,o),t.stroke(),t.closePath()},this.DrawRect=function(t,e,i,r,o,a,s,n){t.lineWidth=a,t.strokeStyle=s,t.strokeRect(e,i,r,o),n&&(t.fillStyle=n,t.fillRect(e,i,r,o))},this.DrawCircle=function(t,e,i,r,o,a,s){t.beginPath(),t.lineWidth=o,t.strokeStyle=a,s&&(t.fillStyle=s),t.arc(e,i,r,0,2*Math.PI,!1),t.stroke(),s&&t.fill(),t.closePath()},this.DrawDashLine=function(t,e,i,r,o,a,s){var n=t.getLineDash();t.setLineDash([4,4]),this.DrawLine(t,e,i,r,o,a,s),t.setLineDash(n)},this.DrawDashRect=function(t,e,i,r,o,a,s,n){var h=t.getLineDash();t.setLineDash([4,4]),this.DrawRect(t,e,i,r,o,a,s,n),t.setLineDash(h)},this.GetFullPathName=function(t,e){return e.indexOf("colorempty.png")>=0?"":t+e},this.ToHexColor=function(t,e,i){if(!t||!e||!i)return"";var r=parseInt(t,10).toString(16),o=parseInt(e,10).toString(16),a=parseInt(i,10).toString(16);return r=1==r.length?"0"+r:r,o=1==o.length?"0"+o:o,a=1==a.length?"0"+a:a,"#"+r+o+a},this.String2HexColor=function(t){var e=t.split(",");return e.length<4?"#000000":this.ToHexColor(e[1],e[2],e[3])},this.GetWebFont=function(t){for(var e in PM.CONFIG.FONT_POOL)if(t==PM.CONFIG.FONT_POOL[e])return t;return PM.CONFIG.FONT_DEFAULT},this.LoadWebFont=function(t,e){t=this.GetWebFont(t);var i=PM.CONFIG.FONT_PATH[t];i.length<=0||WebFont.load({timeout:6e3,custom:{families:[t],urls:[i]},loading:function(){},inactive:function(){console.error("webfont inactive!!!! "+t+" "+Date.now()),PM.Editor.Framework.ShowMessageBar("웹폰트를 로드할 수 없습니다.")},active:e})},this.LoadXml=function(t){var e=$.Deferred();return $.ajax({type:"get",dataType:"xml",timeout:2e4,url:t,success:function(t,i,r){e.resolve(t,i,r)},error:function(t,i,r){e.reject(t,i,r)}}),e.promise()},this.LoadImage=function(t){var e=$.Deferred(function(e){if(null==t||t.length<=0)e.resolve(null);else{var i=new Image;i.crossOrigin="Anonymous",i.onload=function(){e.resolve(i)},i.onerror=function(){e.reject()},i.src=t,(i.complete||void 0===i.complete)&&(i.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",i.src=t)}});return e.promise()},this.CanvasToImage=function(t){var e=null;try{e=t.toDataURL("image/jpeg",1)}catch(i){e=null,console.error(i)}return e},this.GetCenterPos=function(t,e,i,r){var o=0,a=0;return t>=i&&(o=t/2-i/2),e>=r&&(a=e/2-r/2),{x:o,y:a}},this.GetScale=function(t,e,i,r,o){var a=t/i,s=e/r,n=o?Math.min(a,s):Math.max(a,s);return n},this.GetScaledRect=function(t,e,i,r,o){var a=this.GetScale(t,e,i,r,o),s=i*a,n=r*a,h=(t-s)/2,l=(e-n)/2,p={l:-h/a,t:-l/a,w:t/a,h:e/a};return p.l<0&&(p.l=0),p.t<0&&(p.t=0),p.l+p.w>i&&(p.w=i-p.l),p.t+p.h>r&&(p.h=r-p.t),p},this.IsMacintosh=function(){var t=navigator.userAgent;return t.indexOf("Macintosh")>=0||t.indexOf("Mac OS")>=0?!0:!1},this.ProductSize2SizeId=function(t){var e=t,i=-1;switch(e){case"6x6":i=PM.SIZE6X6;break;case"6x8":case"a5h":i=PM.SIZE6X8;break;case"8x6":case"a5w":i=PM.SIZE8X6;break;case"8x8":i=PM.SIZE8X8;break;case"8x11":case"a4h":i=PM.SIZE8X11;break;case"11x8":case"a4w":i=PM.SIZE11X8;break;case"10x10":i=PM.SIZE10X10}return i},this.ProductSize2InchSize=function(t){var e={w:0,h:0},i=this.ProductSize2SizeId(t);switch(i){case PM.SIZE6X6:e.w=6,e.h=6;break;case PM.SIZE6X8:e.w=6,e.h=8;break;case PM.SIZE8X6:e.w=8,e.h=6;break;case PM.SIZE8X8:e.w=8,e.h=8;break;case PM.SIZE8X11:e.w=8,e.h=11;break;case PM.SIZE11X8:e.w=11,e.h=8;break;case PM.SIZE10X10:e.w=10,e.h=10}return e};var t=0;this.CalcFps=function(){var e=new Date,i=1e3/(e-t);return t=e,i},this.IsValidURL=function(t){return t&&t.length>0&&(t=t.toLowerCase(),t.indexOf("http://")>=0||t.indexOf("https://")>=0)?!0:!1},this.replaceEscapeChar=function(t){var e=t;return e=e.replace(/"/gi,'\\"')}},X={},X.ENTERKEY="¶",X.COLOR_CARET="rgba(255, 0, 0, 0.5)",X.COLOR_ULINE="rgba(0, 0, 0, 1)",X.COLOR_BLOCK="rgba(0, 0, 255, 0.5)",X.COLOR_BLOCK_KILLFOCUS="rgba(0, 0, 255, 0.0)",X.RECORD_OFF=0,X.RECORD_INS=1,X.RECORD_DEL=2,X.RECORD_REPL=3,X.RECORD_ATTR=4,X.RECORD_PARA=5,X.RECORD_VALIGN=6,X.MARGIN_H=5;var check_bbox=!1,xpoint=function(t,e){this.x=t,this.y=e};xpoint.prototype={clone:function(){var t=new xpoint;return t.x=this.x,t.y=this.y,t}};var xrect=function(t,e,i,r){this.l=t,this.t=e,this.r=i,this.b=r};xrect.prototype={clone:function(){var t=new xrect;return t.l=this.l,t.t=this.t,t.r=this.r,t.b=this.b,t},width:function(){return this.r-this.l},height:function(){return this.b-this.t}};var xattr_filter=function(t){this.bold=t,this.italic=t,this.underline=t,this.point=t,this.facename=t,this.charw=t,this.textcolor=t,this.strokecolor=t,this.shadowcolor=t},xattr=function(){this.bold=!1,this.italic=!1,this.underline=!1,this.point=12,this.facename="",this.charw=100,this.textcolor="#000000",this.strokecolor="",this.shadowcolor="",this.ascent=0,this.descent=0};xattr.prototype={clone:function(){var t=new xattr;return t.bold=this.bold,t.italic=this.italic,t.underline=this.underline,t.point=this.point,t.facename=this.facename,t.charw=this.charw,t.textcolor=this.textcolor,t.strokecolor=this.strokecolor,t.shadowcolor=this.shadowcolor,t.ascent=this.ascent,t.descent=this.descent,t},loaddata:function(t){this.bold=t.bold,this.italic=t.italic,this.underline=t.underline,this.point=t.point,this.facename=t.facename,this.charw=t.charw,this.textcolor=t.textcolor,this.strokecolor=t.strokecolor,this.shadowcolor=t.shadowcolor;var e=this.facename;PM.Util.LoadWebFont(e,function(){console.log("[xdoc-load] webfont loaded... "+e+" "+Date.now())});var i=getbaselineinfo(this.facename,this.point);this.ascent=i.ascent,this.descent=i.descent},toJSON:function(){var t="  {";return t+='"bold":'+this.bold,t+=', "italic":'+this.italic,t+=', "underline":'+this.underline,t+=', "point":'+this.point,t+=', "facename":"'+this.facename+'"',t+=', "charw":"'+this.charw+'"',t+=', "textcolor":"'+this.textcolor+'"',t+=', "strokecolor":"'+this.strokecolor+'"',t+=', "shadowcolor":"'+this.shadowcolor+'"',t+="}"},set_prop:function(t,e){if(e.bold&&(this.bold=t.bold),e.italic&&(this.italic=t.italic),e.underline&&(this.underline=t.underline),e.point&&(this.point=t.point),e.facename&&(this.facename=t.facename),e.charw&&(this.charw=t.charw),e.textcolor&&(this.textcolor=t.textcolor),e.strokecolor&&(this.strokecolor=t.strokecolor),e.shadowcolor&&(this.shadowcolor=t.shadowcolor),e.point||e.facename){var i=getbaselineinfo(this.facename,this.point);this.ascent=i.ascent,this.descent=i.descent}},is_equal:function(t){return this.bold!=t.bold?!1:this.italic!=t.italic?!1:this.underline!=t.underline?!1:this.point!=t.point?!1:this.facename!=t.facename?!1:this.charw!=t.charw?!1:this.textcolor!=t.textcolor?!1:this.strokecolor!=t.strokecolor?!1:this.shadowcolor!=t.shadowcolor?!1:!0}};var xattr_pool=function(){this.array={}};xattr_pool.prototype.clone=function(){var t=new xattr_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xattr_pool.prototype.add_nodup=function(t){var e=-1;for(var i in this.array)if(this.array[i].is_equal(t)){e=i,t=null;break}if(0>e){var r=getbaselineinfo(t.facename,t.point);t.ascent=r.ascent,t.descent=r.descent,e=get_key(this.array),this.array[e]=t}return e},xattr_pool.prototype.toJSON=function(){var t=0,e=0;for(var i in this.array)e++;var r='"attr_pool": {\n';for(var o in this.array)r+='"'+o+'":',r+=this.array[o].toJSON(),e-1>t&&(r+=","),r+="\n",t++;return r+="}"},xattr_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var i=parseInt(e);this.array[i]=new xattr,this.array[i].loaddata(t[e])}};var xpara_filter=function(t){this.align=t,this.linegap=t,this.paragap=t},xpara=function(){this.align=4,this.linegap=5,this.paragap=0};xpara.prototype={clone:function(){var t=new xpara;return t.align=this.align,t.linegap=this.linegap,t.paragap=this.paragap,t},loaddata:function(t){this.align=t.align,this.linegap=t.linegap,this.paragap=t.paragap},toJSON:function(){var t="  {";return t+='"align":'+this.align,t+=', "linegap":'+this.linegap,t+=', "paragap":'+this.paragap,t+=" }"},set_prop:function(t,e){e.align&&(this.align=t.align),e.linegap&&(this.linegap=t.linegap),e.paragap&&(this.paragap=t.paragap)},is_equal:function(t){return this.align!=t.align?!1:this.linegap!=t.linegap?!1:this.paragap!=t.paragap?!1:!0}};var xpara_pool=function(){this.array={}};xpara_pool.prototype.clone=function(){var t=new xpara_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xpara_pool.prototype.add_nodup=function(t){var e=-1;for(var i in this.array)if(this.array[i].is_equal(t)){e=i,t=null;break}return 0>e&&(e=get_key(this.array),this.array[e]=t),e},xpara_pool.prototype.toJSON=function(){var t=0,e=0;for(var i in this.array)e++;var r='"para_pool": {\n';for(var o in this.array)r+='"'+o+'":',r+=this.array[o].toJSON(),e-1>t&&(r+=","),r+="\n",t++;return r+="}"},xpara_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var i=parseInt(e);this.array[i]=new xpara,this.array[i].loaddata(t[e])}};var xcodeinfo=function(){this.code="",this.width=0,this.ascent=0,this.descent=0,this.x=0,this.y=0,this.step_w=0};xcodeinfo.prototype={clone:function(){var t=new xcodeinfo;return t.code=this.code,t.width=this.width,t.ascent=this.ascent,t.descent=this.descent,t.x=this.x,t.y=this.y,t.step_w=this.step_w,t}};var xline=function(){this.begin=0,this.end=0,this.total_w=0,this.remain_w=0,this.max_ascent=0,this.max_descent=0,this.gap=0,this.is_lastline,this.ci_array=null},xlines=function(){this.array=new Array};xlines.prototype={pos2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0;e<this.array.length;e++){var i=this.array[e];if(t>=i.begin&&t<=i.end)return e}return-1},point2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0,i=0;i<this.array.length;i++){var r=this.array[i],o=r.max_ascent+r.max_descent+r.gap;if(e+o>t)return i;e+=o}return this.array.length-1},gettotalheight:function(){for(var t=0,e=0;e<this.array.length;e++){var i=this.array[e],r=i.max_ascent+i.max_descent+i.gap;t+=r}return t},getlinerect:function(t,e){if(this.array.length<=0)return new xrect(0,0,0,0);if(0>t)return new xrect(0,0,0,0);if(t>=this.array.length)return new xrect(0,0,0,0);for(var i=0,r=new xrect(0,0,0,0),o=0;o<this.array.length;o++){var a=this.array[o];if(r.r=r.l+(a.total_w-a.remain_w),r.b=r.t+(a.max_ascent+a.max_descent+a.gap),i=a.gap,o==t)break;r.t=r.b}return e||(r.b-=i),r}};var xsel_state=function(){this.inspos=-1,this.attrid=-1};xsel_state.prototype={reset:function(){this.inspos=-1,this.attrid=-1},clone:function(){var t=new xsel_state;return t.inspos=this.inspos,t.attrid=this.attrid,t},setstate:function(t,e){this.inspos=t,this.attrid=e},getinspos:function(){return this.inspos},getattrid:function(){return this.attrid}};var xpos=function(t,e){this.pivot=t,this.move=e};xpos.prototype={init:function(){this.pivot=0,this.move=0},clone:function(){var t=new xpos(0,0);return t.pivot=this.pivot,t.move=this.move,t},isblock:function(){return this.pivot<0||this.move<0?!1:this.pivot!=this.move},setpos:function(t){this.pivot=t,this.move=t},getpivot:function(){return this.pivot},getmove:function(){return this.move},setpivot:function(t){this.pivot=t},setmove:function(t){this.move=t},setleft:function(){var t=this.pivot<=this.move?this.pivot:this.move;this.pivot=this.move=t},setright:function(){var t=this.pivot>this.move?this.pivot:this.move;this.pivot=this.move=t},moveleft:function(t){if(this.isblock())this.setleft();else{if(this.pivot<=t)return!1;this.pivot--,this.move=this.pivot}return!0},moveright:function(t){if(this.isblock())this.setright();else{if(this.pivot>=t)return!1;this.pivot++,this.move=this.pivot}return!0},blockmoveleft:function(t){return this.move<=t?!1:(this.move--,!0)},blockmoveright:function(t){return this.move>=t?!1:(this.move++,!0)},getblock:function(){if(this.isblock()){var t=this.pivot<=this.move?this.pivot:this.move,e=this.pivot>this.move?this.pivot:this.move;return{left:t,right:e-1}}return{left:-1,right:-1}},setblock:function(t,e){return 0>t||0>e?!1:(this.pivot=t,this.move=e,this.pivot<this.move)}};var xcaret=function(){this.visible=!1,this.base_x=0,this.rect=new xrect(0,0,0,0)};xcaret.prototype={is_show:function(){return this.visible},show:function(t){this.visible=t},getbase_x:function(){return this.base_x},setbase_x:function(t){this.base_x=t},getrect:function(){return this.rect.clone()},setrect:function(t){this.rect=null,this.rect=t.clone()},display:function(t,e,i){0!=this.visible&&(t.save(),t.fillStyle=X.COLOR_CARET,t.fillRect(this.rect.l+e,this.rect.t+i,this.rect.width(),this.rect.height()),t.restore())}};var xop=function(t,e,i,r){this.type=t,this.pos=e,this.del=i,this.ins=r},xdoc=function(){this.is_singleline=!1,this.strings=[],this.offsets=[],this.attr_pool=new xattr_pool,this.para_pool=new xpara_pool,this.lines=new xlines,this.sel_state=new xsel_state,this.strings.push(X.ENTERKEY),this.offsets.push(0),this.attr_pool.array[0]=new xattr,this.para_pool.array[0]=new xpara};xdoc.prototype={clone:function(){var t=new xdoc;return t.strings=this.strings.slice(0),t.offsets=this.offsets.slice(0),t.attr_pool=this.attr_pool.clone(),t.para_pool=this.para_pool.clone(),t},setdefault:function(t,e){null!=t&&(this.attr_pool.array[0]=t),null!=e&&(this.para_pool.array[0]=e)},delete_unused:function(){var t={},e={};for(var i in this.attr_pool.array)t[i]=0;for(var i in this.para_pool.array)e[i]=0;for(var i=0;i<this.offsets.length;i++){var r=this.offsets[i];this.strings[i]==X.ENTERKEY?e[r]=1:t[r]=1}t[0]=e[0]=1;for(var i in this.attr_pool.array)0==t[i]&&delete this.attr_pool.array[i];for(var i in this.para_pool.array)0==e[i]&&delete this.para_pool.array[i]},loaddata:function(t){this.strings=t.strings,this.offsets=t.offsets,this.attr_pool.loaddata(t.attr_pool),this.para_pool.loaddata(t.para_pool)},toString:function(){for(var t="",e=0;e<this.strings.length-1;e++)t+=this.strings[e];return t=PM.Util.replaceEscapeChar(t)},toJSON:function(){var t="{\n";t+='"strings": [\n';for(var e=0;e<this.strings.length;e++){var i=PM.Util.replaceEscapeChar(this.strings[e]);t+='"'+i+'"',e<this.strings.length-1&&(t+=",")}t+="],\n",t+='"offsets": [\n';for(var e=0;e<this.offsets.length;e++)t+=this.offsets[e],e<this.offsets.length-1&&(t+=",");return t+="],\n",t+=this.attr_pool.toJSON()+",\n",t+=this.para_pool.toJSON()+"\n",t+="}\n"},toJSONEx:function(t,e){var i="{\n";i+='"strings": [\n';for(var r=0;r<this.strings.length;r++){var o=PM.Util.replaceEscapeChar(this.strings[r]);i+='"'+o+'"',r<this.strings.length-1&&(i+=",")}i+="],\n",i+='"offsets": [\n';for(var r=0;r<this.offsets.length;r++)i+=this.offsets[r],r<this.offsets.length-1&&(i+=",");return i+="],\n",i+=this.attr_pool.toJSON()+",\n",i+=this.para_pool.toJSON()+"\n",i+=",\n"+this.toCoordinatesJSON(t,e)+"\n",i+="}\n"
},toCoordinatesJSON:function(t,e){for(var i='"coordinates": [\n',r=e+X.MARGIN_H,o=0;o<this.lines.array.length;){for(var a=this.lines.array[o++],s=a.begin;s<=a.end;){var n=a.ci_array[s-a.begin],h=n.x,l=r+n.y,p=n.width,c=n.ascent+n.descent,d=n.ascent;i+="{ ",i+='"x": '+h.toFixed(2)+", ",i+='"y": '+l.toFixed(2)+", ",i+='"w": '+p.toFixed(2)+", ",i+='"h": '+c.toFixed(2)+", ",i+='"ascent": '+d.toFixed(2),i+="}",s++,s<this.strings.length&&(i+=","),i+="\n"}var u=a.max_ascent+a.max_descent+a.gap;r+=u}return i+="]"},toSVG:function(){this.delete_unused();var t='<?xml version="1.0" encoding="utf-8"?>\n';t+='<svg xmlns="http://www.w3.org/2000/svg" ',t+='width="'+canvas.width+'px" height="'+canvas.height+'px">\n';for(var e=0;e<this.lines.array.length;)for(var i=this.lines.array[e++],r=i.begin;r<=i.end;){var o=i.ci_array[r-i.begin],a=this.strings[r];if(a!=X.ENTERKEY){t+="<text ";var s=this.getattr(r);t+='x="'+o.x+'" ',t+='y="'+(o.y+o.ascent+o.descent)+'" ',t+='style="',t+="font-family:"+s.facename+";",t+="font-size:"+s.point+"pt;",t+="fill:"+s.textcolor+";",t+=""!=s.strokecolor?"stroke:"+s.strokecolor+";":"",t+=s.bold?"font-weight:bold;":"",t+=s.italic?"font-style:italic;":"",t+='"',t+=">",t+=a,t+="</text>\n"}r++}return t+="</svg>\n"},getlength:function(){return this.strings.length-1},getdocheight:function(){return this.lines.gettotalheight()+2*X.MARGIN_H},getdocwidth:function(){if(0<this.lines.array.length){var t=this.lines.array[0];return t.total_w}return 0},getalignedwidth:function(){if(this.lines.array.length>0){var t=this.lines.array[0];return t.total_w-t.remain_w}return 0},insertchars:function(t,e,i){if(0>t||t>=this.strings.length)return!1;if(e[0]==X.ENTERKEY&&1==i){var r=this.getpara(t-1),o=null!=r?r.clone():new xpara,a=get_key(this.para_pool.array);this.para_pool.array[a]=o,this.strings.splice(t,0,X.ENTERKEY),this.offsets.splice(t,0,a)}else{var s=0;s=t==this.sel_state.getinspos()?this.sel_state.getattrid():this.getattrid(t-1);for(var n=t,h=0;i>h;h++)this.strings.splice(n,0,e[h]),this.offsets.splice(n,0,s),n++}return t!=this.sel_state.getinspos()&&this.sel_state.reset(),!0},insertdoc:function(t,e){if(0>t||t>=this.strings.length)return!1;var i=e.clone(),r={};for(var o in i.attr_pool.array)r[o]=this.attr_pool.add_nodup(i.attr_pool.array[o]);var a={};for(var o in i.para_pool.array){var s=get_key(this.para_pool.array);this.para_pool.array[s]=i.para_pool.array[o],a[o]=s}for(var o=0;o<i.offsets.length;o++){var n=i.offsets[o];i.offsets[o]=i.strings[o]==X.ENTERKEY?a[n]:r[n]}for(var h=t,o=0;o<i.strings.length;o++)this.strings.splice(h,0,i.strings[o]),this.offsets.splice(h,0,i.offsets[o]),h++;this.delete_unused()},deletechars:function(t,e){return 0>t||t+e>this.getlength()?!1:(this.strings.splice(t,e),this.offsets.splice(t,e),t!=this.sel_state.getinspos()&&this.sel_state.reset(),e>2&&this.delete_unused(),!0)},getblockdoc:function(t,e){if(t>=0&&e>=t&&e<this.strings.length-1){var i=new xdoc;i.strings=this.strings.slice(t,e+1),i.offsets=this.offsets.slice(t,e+1);for(var r=t;e+1>r;r++){var o=this.offsets[r];this.strings[r]==X.ENTERKEY?i.para_pool.array[o]=this.para_pool.array[o].clone():i.attr_pool.array[o]=this.attr_pool.array[o].clone()}return i}return null},getblocktext:function(t,e){return t>=0&&e>t&&e<this.strings.length?this.strings.slice(t,e+1).join(""):""},getattrid:function(t){for(;t>=0;){var e=this.strings[t];if(e!=X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getparaid:function(t){for(;t>=0;){var e=this.strings[t];if(e==X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getattr:function(t){var e=this.getattrid(t);return this.attr_pool.array.hasOwnProperty(e)?this.attr_pool.array[e]:null},getpara:function(t){var e=this.getparaid(t);return this.para_pool.array.hasOwnProperty(e)?this.para_pool.array[e]:null},getattrstate:function(t){if(t>=0&&t<this.strings.length){var e=this.getattr(t-1);if(e){var i=e.clone(),r=new xattr_filter(!0);return{attr:i,filter:r}}}return{attr:null,filter:null}},getparastate:function(t){if(t>=0&&t<this.strings.length){var e=this.getpara(t-1);if(e){var i=e.clone(),r=new xpara_filter(!0);return{para:i,filter:r}}}return{para:null,filter:null}},getblockattrstate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var i=this.getattr(t);if(i){for(var r=i.clone(),o=new xattr_filter(!0),a=t+1;e>=a;a++){var s=this.getattr(a);i.bold!=s.bold&&(o.bold=!1),i.italic!=s.italic&&(o.italic=!1),i.point!=s.point&&(o.point=!1),i.facename!=s.facename&&(o.facename=!1),i.charw!=s.charw&&(o.charw=!1),i.textcolor!=s.textcolor&&(o.textcolor=!1),i.strokecolor!=s.strokecolor&&(o.strokecolor=!1),i.shadowcolor!=s.shadowcolor&&(o.shadowcolor=!1)}return{attr:r,filter:o}}}return{attr:null,filter:null}},getblockparastate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var i=this.getpara(t);if(i){for(var r=i.clone(),o=new xpara_filter(!0),a=t+1;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.getpara(a);i.align!=n.align&&(o.align=!1),i.linegap!=n.linegap&&(o.linegap=!1),i.paragap!=n.paragap&&(o.paragap=!1)}}return{para:r,filter:o}}}return{para:null,filter:null}},setattrstate:function(t,e,i){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var r=null;if(i){var o=this.getattr(t-1);o&&(r=o.clone(),r.set_prop(e,i))}else r=e.clone();var a=this.attr_pool.add_nodup(r);return this.sel_state.setstate(t,a),!0},setparastate:function(t,e,i){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var r=this.getpara(t-1);return r?(r.set_prop(e,i),!0):!1},setblockattrstate:function(t,e,i,r){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==i)return!1;if(r)for(var o=new Array,a=new Array,s=t;e>=s;s++){var n=this.strings[s];if(n!=X.ENTERKEY){for(var h=this.offsets[s],l=!1,p=0;p<o.length;p++)if(h==a[p]){var c=a[p];this.offsets[s]=c,l=!0;break}if(!l){var d=this.attr_pool.array[h],u=d.clone();u.set_prop(i,r);var c=this.attr_pool.add_nodup(u);this.offsets[s]=c,o.push(h),a.push(c)}}}else for(var u=i.clone(),_=this.attr_pool.add_nodup(u),s=t;e>=s;s++){var n=this.strings[s];n!=X.ENTERKEY&&(this.offsets[s]=_)}return!0},setblockparastate:function(t,e,i,r){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==i)return!1;if(this.setparastate(t,i,r)){for(var o=t;e>=o;o++){var a=this.strings[o];if(a==X.ENTERKEY){var s=this.offsets[o];if(this.para_pool.array.hasOwnProperty(s)){var n=this.para_pool.array[s];n.set_prop(i,r)}}}return!0}return!1},getselparas:function(t,e){if(!(0>t)){var i=[],r=this.getpara(t-1);if(r){i.push(r.clone());for(var o=t;e>=o;o++)if(this.strings[o]==X.ENTERKEY){var a=this.offsets[o];this.para_pool.array.hasOwnProperty(a)&&(r=this.para_pool.array[a],r&&i.push(r.clone()))}return i}return null}},setselparas:function(t,e,i){if(!(0>t)){var r=new xpara_filter(!0);if(this.setparastate(t,i[0],r))for(var o=1,a=t;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.offsets[a];if(this.para_pool.array.hasOwnProperty(n)){var h=this.para_pool.array[n];h.set_prop(i[o],r)}o++}}}},is_dbcs:function(t){var e=t.charCodeAt();return e>=4352&&4607>=e?!0:e>=12592&&12687>=e?!0:e>=44032&&55203>=e?!0:!1},preparedc:function(t,e){if(this.attr_pool.array.hasOwnProperty(e)){var i=this.attr_pool.array[e];if(i){var r=i.bold?"bold ":"";r+=i.italic?"italic ":"",t.font=r+i.point+"pt '"+i.facename+"'",t.fillStyle=i.textcolor,t.strokeStyle=i.strokecolor,""!=i.strokecolor&&(t.lineWidth=1),t.shadowColor=i.shadowcolor,""!=i.shadowcolor&&(t.shadowOffsetX=3,t.shadowOffsetY=2),t.textAlign="left",t.textBaseline="alphabetic"}}},getcodeinfo:function(t,e,i,r,o){var a=this.getattrid(e);this.prev_attr_id!=a&&(this.preparedc(t,a,this.is_dbcs(i)),this.prev_attr_id=a);var s=this.getattr(e);if(s){var n=t.measureText(i);if(r.code=i,r.width=n.width*s.charw/100,!o||s.ascent<=0||s.descent<=0){var h=getbaselineinfo(s.facename,s.point);s.ascent=h.ascent,s.descent=h.descent}r.ascent=s.ascent,r.descent=s.descent,r.x=0,r.y=0,i==X.ENTERKEY&&(r.width=0)}},aligndoc:function(t,e,i){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0,this.lines=null,this.lines=new xlines;for(var r=0;;){var o=this.alignline(t,e,r,i);if(o>=this.strings.length)break;r=o}for(var a=0,s=0,n=0;n<this.lines.array.length;){{var h=this.lines.array[n++];h.max_ascent+h.max_descent+h.gap}this.alignlinexy(a,s,h)}return n+1}},alignline:function(t,e,i,r){var o=new xline;o.begin=i,o.end=i,o.total_w=e,o.remain_w=e,o.max_ascent=0,o.max_descent=0,o.gap=0,o.is_lastline=!1,o.ci_array=new Array;var a=this.getpara(i);a&&(o.gap=a.linegap);for(var s=i,n=i,h=0,l=0,p=!1;s<this.strings.length;){var c=this.strings[s],d=new xcodeinfo;if(this.getcodeinfo(t,s,c,d,r),o.ci_array.push(d),o.max_ascent<d.ascent&&(o.max_ascent=d.ascent),o.max_descent<d.descent&&(o.max_descent=d.descent),h+=d.width," "==c?(n=s,l+=h,h=0):1==p&&(n=s-1,l+=h-d.width,h=d.width),c==X.ENTERKEY||s>=this.strings.length-1){n=s,o.is_lastline=!0,a&&(o.gap+=a.paragap);break}if(!this.is_singleline&&l+h>e){if(s==i){l=e,n=s;break}n==i&&(l=h-d.width,n=s-1);for(var u=s;u>n;)o.ci_array.pop(),u--;break}s++,p=!1;var _=this.strings[s];this.is_dbcs(c)&&this.is_dbcs(_)&&(p=!0),this.is_dbcs(c)!=this.is_dbcs(_)&&(p=!0)}for(var u=n+1;u<this.strings.length&&" "==this.strings[u];){var g=d.clone();o.ci_array.push(g),u++}return n=u-1,o.end=n,this.lines.array.push(o),n+1},alignlinexy:function(t,e,i){if(!(i.begin>i.end)){var r=this.getpara(i.begin);if(null!=r){for(var o=i.ci_array.length-1;" "==i.ci_array[o].code;)o--;for(var a=0,s=0,n=0;o>=n;n++)" "==i.ci_array[n].code&&a++,s+=i.ci_array[n].width;i.remain_w=i.total_w-s;var h=0,l=0,p=t,c=e,d=c+i.max_ascent;switch(r.align){case 0:break;case 1:p=t+i.remain_w;break;case 2:p=t+i.remain_w/2;break;case 3:if(i.ci_array.length<=1)p=t+i.remain_w/2;else{var u=i.ci_array.length-1;1==i.is_lastline&&u--,h=i.remain_w/u}case 4:a>0&&(l=i.remain_w/a)}for(var n=0;o>=n;n++){var _=i.ci_array[n];switch(_.x=p,_.y=d-_.ascent,r.align){case 0:case 1:case 2:_.step_w=_.width,p+=_.step_w;break;case 3:_.step_w=_.width+h,p+=_.step_w;break;case 4:_.step_w=_.width," "!=_.code||i.is_lastline||(_.step_w+=l),p+=_.step_w}}for(var n=o+1;n<i.ci_array.length;n++){var _=i.ci_array[n];_.x=p,_.y=d-_.ascent}}}},display:function(t,e,i,r,o,a,s){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0;for(var n=i,h=n+r,l=e,p=X.MARGIN_H+i,c=0;c<this.lines.array.length;){var d=this.lines.array[c++],u=d.max_ascent+d.max_descent+d.gap;if(p+u>0&&this.displayline(t,l,p,d,o,a,s),p+=u,p>h)break}}},displayline:function(t,e,i,r,o,a,s){if(!(r.begin>r.end)){for(var n=-1,h=-1,l=-1,p=r.begin;p<=r.end;){var c=r.ci_array[p-r.begin];p==o&&(h=c.x),p==a&&(l=c.x+c.step_w);var d=this.strings[p];if(d!=X.ENTERKEY){var u=this.getattrid(p);if(this.prev_attr_id!=u&&(this.preparedc(t,u,this.is_dbcs(d)),this.prev_attr_id=u),t.fillText(d,c.x,i+c.y+c.ascent,c.width),""!=this.attr_pool.array[u].strokecolor&&t.strokeText(d,c.x,i+c.y+c.ascent,c.width),this.attr_pool.array[u].underline&&0>n&&(n=c.x),n>=0){var _=-1;this.attr_pool.array[u].underline?(p>=r.end||r.is_lastline&&this.strings[p+1]==X.ENTERKEY)&&(_=c.x+c.width):_=c.x,_>=0&&(t.save(),t.strokeStyle=X.COLOR_ULINE,t.beginPath(),t.moveTo(n,i+r.max_ascent+r.max_descent),t.lineTo(_,i+r.max_ascent+r.max_descent),t.stroke(),n=-1,t.restore())}1==check_bbox&&(t.beginPath(),t.rect(c.x,i+c.y,c.width,c.ascent+c.descent),t.moveTo(c.x,i+c.y+c.ascent),t.lineTo(c.x+c.width,i+c.y+c.ascent),t.stroke())}p++}t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(r.begin>=o&&r.begin<=a||r.end>=o&&r.begin<=a)&&(0>h&&(h=e),0>l&&(l=r.total_w),t.save(),t.fillStyle=s?X.COLOR_BLOCK:X.COLOR_BLOCK_KILLFOCUS,t.fillRect(h,i,l-h,r.max_ascent+r.max_descent+r.gap),t.restore())}},pos2linepos:function(t,e){var i=this.lines.pos2lineindex(t);if(i>=0){var r=this.lines.array[i];if(t>=r.begin&&t<=r.end)return 0==e?r.begin:r.end}return 0},pos2caretrect:function(t,e){var i=this.lines.pos2lineindex(t);if(0>i)return new xrect(0,0,0,0);var r=this.lines.array[i];t<r.begin&&(t=r.begin),t>r.end&&(t=r.end);var o=r.ci_array[t-r.begin].x,a=r.ci_array[t-r.begin].width,s=this.lines.getlinerect(i,!1);return s.l=o,s.r=e?o+a:s.l+1,s.t+=X.MARGIN_H,s.b+=X.MARGIN_H,s},point2caretrect:function(t,e){var i=-1,r=(new xrect(0,0,0,0),this.lines.point2lineindex(t.y));r+=e,0>r&&(r=0),r>=this.lines.array.length&&(r=this.lines.array.length-1);for(var o=this.lines.array[r],a=null,s=o.begin;s<=o.end&&(i=s,a=o.ci_array[s-o.begin],!(t.x<=a.x+a.width/2));s++);var n=this.lines.getlinerect(r,!1);return n.l=a.x,n.r=a.x+1,n.t+=X.MARGIN_H,n.b+=X.MARGIN_H,{rect:n,pos:i}},dump:function(){for(var t="",e=0;e<this.strings.length;e++)t+=this.strings[e]+",";for(var i="",e=0;e<this.offsets.length;e++)i+=this.offsets[e]+",";console.log("strings:\n"+t),console.log("offsets:\n"+i);for(var e in this.attr_pool.array){var r=this.attr_pool.array[e];console.log("attr_pool key:"+e+" value:"+r.facename+","+r.point+","+r.bold+","+r.italic)}for(var e in this.para_pool.array){var o=this.para_pool.array[e];console.log("para_pool key:"+e+" value:"+o.align+","+o.linegap+","+o.paragap)}console.log("<-- end of dump.\n")}};var xime=function(){this.cho_han=[12593,12594,12596,12599,12600,12601,12609,12610,12611,12613,12614,12615,12616,12617,12618,12619,12620,12621,12622],this.cho_eng=[114,82,115,101,69,102,97,113,81,116,84,100,119,87,99,122,120,118,103],this.jung_han=[12623,12624,12625,12626,12627,12628,12629,12630,12631,12632,12633,12634,12635,12636,12637,12638,12639,12640,12641,12642,12643],this.jung_eng=[107,111,105,79,106,112,117,80,104,0,0,0,121,110,0,0,0,98,109,0,108],this.jong_han=[0,12593,12594,12595,12596,12597,12598,12599,12601,12602,12603,12604,12605,12606,12607,12608,12609,12610,12612,12613,12614,12615,12616,12618,12619,12620,12621,12622],this.jong_eng=[0,114,82,0,115,0,0,101,102,0,0,0,0,0,0,0,97,113,0,116,84,100,119,99,122,120,118,103],this.cho_jong=[1,2,4,7,0,8,16,17,0,19,20,21,22,0,23,24,25,26,27],this.state=0,this.queue=[],this.last_comp=0,this.is_act=!1};xime.prototype={activate:function(t){this.is_act=t,this.state=0,this.queue=[],this.last_comp=-1},flush:function(){var t=this.last_comp;return this.state=0,this.queue=[],this.last_comp=-1,t},is_activate:function(){return this.is_act},is_composite:function(){return this.is_act&&this.last_comp>=0?!0:!1},composite:function(t){var e=this.cho_eng.indexOf(t),i=this.jung_eng.indexOf(t);if(t>=0&&0>e&&0>i)return this.state=0,{comp_end:this.last_comp,comp_update:-1};var r=-1,o=-1;switch(this.state){case 0:e>=0?(this.state=1,r=this.cho_han[e],this.queue.push(e)):(this.state=2,r=this.jung_han[i],this.queue.push(i));break;case 1:if(0>t)this.flush();else if(e>=0){var a=this.comp_conx(this.queue[this.queue.length-1],e);a>=0?(this.state=3,r=this.jong_han[a],this.queue.pop(),this.queue.push(a)):(this.state=1,o=this.cho_han[this.queue.shift()],r=this.cho_han[e],this.queue.push(e))}else this.state=4,r=44032+588*this.queue[0]+28*i+0,this.queue.push(i);break;case 2:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),r=this.jung_han[this.queue[0]],this.state=2}else this.flush()}else if(e>=0)this.state=1,o=this.jung_han[this.queue.shift()],r=this.cho_han[e],this.queue.push(e);else{var a=this.comp_vowx(this.queue[this.queue.length-1],i);a>=0?(this.state=2,r=this.jung_han[a],this.queue.pop(),this.queue.push(a)):(this.state=2,o=this.jung_han[this.queue.shift()],r=this.jung_han[i],this.queue.push(i))}break;case 3:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(a.prev),r=this.cho_han[this.queue[0]],this.state=1}else if(e>=0)this.state=1,r=this.jong_han[this.queue.shift()],this.queue.push(e);else{this.state=4;var a=this.div_conx(this.queue.pop());o=this.cho_han[a.prev],r=44032+588*a.next+28*i+0,this.queue.push(a.next),this.queue.push(i)}break;case 4:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),r=44032+588*this.queue[0]+28*this.queue[1],this.state=4}else r=this.cho_han[this.queue[0]],this.state=1}else if(e>=0){var n=this.jong_eng.indexOf(t);if(0>n){this.state=1;var h=this.queue.shift(),l=this.queue.shift();o=44032+588*h+28*l+0,r=this.cho_han[e],this.queue.push(e)}else this.state=5,r=44032+588*this.queue[0]+28*this.queue[1]+n,this.queue.push(n)}else{var a=this.comp_vowx(this.queue[this.queue.length-1],i);if(a>=0)this.state=4,r=44032+588*this.queue[0]+28*a+0,this.queue.pop(),this.queue.push(a);else{this.state=2;var h=this.queue.shift(),l=this.queue.shift();o=44032+588*h+28*l+0,r=this.jung_han[i],this.queue.push(i)}}break;case 5:if(0>t)this.queue.pop(),r=44032+588*this.queue[0]+28*this.queue[1],this.state=4;else if(e>=0){var a=this.comp_conx(this.jong2cho(this.queue[this.queue.length-1]),e);if(a>=0)this.state=6,r=44032+588*this.queue[0]+28*this.queue[1]+a,this.queue.pop(),this.queue.push(a);else{this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();o=44032+588*h+28*l+n,r=this.cho_han[e],this.queue.push(e)}}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift();o=44032+588*h+28*l+0;var n=this.queue.shift(),a=this.jong2cho(n);r=44032+588*a+28*i+0,this.queue.push(a),this.queue.push(i)}break;case 6:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(this.cho2jong(a.prev)),r=44032+588*this.queue[0]+28*this.queue[1]+this.queue[2],this.state=5}else if(e>=0){this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();o=44032+588*h+28*l+n,r=this.cho_han[e],this.queue.push(e)}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift(),a=this.div_conx(n);o=44032+588*h+28*l+this.cho2jong(a.prev),r=44032+588*a.next+28*i+0,this.queue.push(a.next),this.queue.push(i)}}return this.last_comp=r,{comp_end:o,comp_update:r}},cho2jong:function(t){return this.cho_jong[t]},jong2cho:function(t){return this.cho_jong.indexOf(t)},comp_conx:function(t,e){switch(t){case 0:if(9==e)return 3;break;case 2:if(12==e)return 5;if(18==e)return 6;break;case 5:if(0==e)return 9;if(6==e)return 10;if(7==e)return 11;if(9==e)return 12;if(16==e)return 13;if(17==e)return 14;if(18==e)return 15;break;case 7:if(9==e)return 18}return-1},comp_vowx:function(t,e){switch(t){case 8:if(0==e)return 9;if(1==e)return 10;if(20==e)return 11;break;case 13:if(4==e)return 14;if(5==e)return 15;if(20==e)return 16;break;case 18:if(20==e)return 19}return-1},is_vowx:function(t){return 9==t||10==t||11==t||14==t||15==t||16==t||19==t?!0:!1},div_conx:function(t){switch(t){case 3:return{prev:0,next:9};case 5:return{prev:2,next:12};case 6:return{prev:2,next:18};case 9:return{prev:5,next:0};case 10:return{prev:5,next:6};case 11:return{prev:5,next:7};case 12:return{prev:5,next:9};case 13:return{prev:5,next:16};case 14:return{prev:5,next:17};case 15:return{prev:5,next:18};case 18:return{prev:7,next:9}}return{prev:-1,next:-1}},div_vowx:function(t){switch(t){case 9:return{prev:8,next:0};case 10:return{prev:8,next:1};case 11:return{prev:8,next:20};case 14:return{prev:13,next:4};case 15:return{prev:13,next:5};case 16:return{prev:13,next:20};case 19:return{prev:18,next:20}}return{prev:-1,next:-1}}};