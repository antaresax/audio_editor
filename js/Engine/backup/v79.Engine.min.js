function getbaselineinfo(t,e){var r=document.createElement("div"),o=document.body;if(!r||!o)return{ascent:0,descent:0};r.style.position="absolute",r.style.whiteSpace="nowrap",r.style.fontFamily=t,r.style.fontSize=e+"pt",o.appendChild(r);var i="Hg|Wjgm";r.innerHTML=i;var a=r.offsetHeight,s=document.createElement("span");s.style.display="inline-block",s.style.overflow="hidden",s.style.width="1px",s.style.height="0px",r.appendChild(s);var n=s.offsetTop+s.offsetHeight;return document.body.removeChild(r),{ascent:n,descent:a-n}}function get_key(t){for(var e=1e5,r=0;e>r;r++)if(!t.hasOwnProperty(r))return r;return console.log("!! table overflow !!"),e}!function(){function t(t){return t.call.apply(t.bind,arguments)}function e(t,e){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var o=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(o,r),t.apply(e,o)}}return function(){return t.apply(e,arguments)}}function r(){return r=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?t:e,r.apply(null,arguments)}function o(t,e){this.F=t,this.k=e||t,this.H=this.k.document}function i(t,e,r){t=t.H.getElementsByTagName(e)[0],t||(t=document.documentElement),t.insertBefore(r,t.lastChild)}function a(t,e,r){e=e||[],r=r||[];for(var o=t.className.split(/\s+/),i=0;i<e.length;i+=1){for(var a=!1,s=0;s<o.length;s+=1)if(e[i]===o[s]){a=!0;break}a||o.push(e[i])}for(e=[],i=0;i<o.length;i+=1){for(a=!1,s=0;s<r.length;s+=1)if(o[i]===r[s]){a=!0;break}a||e.push(o[i])}t.className=e.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function s(t,e){for(var r=t.className.split(/\s+/),o=0,i=r.length;i>o;o++)if(r[o]==e)return!0;return!1}function n(t){if("string"==typeof t.fa)return t.fa;var e=t.k.location.protocol;return"about:"==e&&(e=t.F.location.protocol),"https:"==e?"https:":"http:"}function h(t,e,r){function o(){h&&a&&s&&(h(n),h=null)}e=t.createElement("link",{rel:"stylesheet",href:e,media:"all"});var a=!1,s=!0,n=null,h=r||null;V?(e.onload=function(){a=!0,o()},e.onerror=function(){a=!0,n=Error("Stylesheet failed to load"),o()}):setTimeout(function(){a=!0,o()},0),i(t,"head",e)}function l(t,e,r,o){var i=t.H.getElementsByTagName("head")[0];if(i){var a=t.createElement("script",{src:e}),s=!1;return a.onload=a.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,r&&r(null),a.onload=a.onreadystatechange=null,"HEAD"==a.parentNode.tagName&&i.removeChild(a))},i.appendChild(a),setTimeout(function(){s||(s=!0,r&&r(Error("Script load timeout")))},o||5e3),a}return null}function c(){this.S=0,this.K=null}function p(t){return t.S++,function(){t.S--,u(t)}}function d(t,e){t.K=e,u(t)}function u(t){0==t.S&&t.K&&(t.K(),t.K=null)}function _(t){this.ea=t||"-"}function g(t,e){this.Q=t,this.M=4,this.L="n";var r=(e||"n4").match(/^([nio])([1-9])$/i);r&&(this.L=r[1],this.M=parseInt(r[2],10))}function f(t){return m(t)+" "+(t.M+"00")+" 300px "+P(t.Q)}function P(t){var e=[];t=t.split(/,\s*/);for(var r=0;r<t.length;r++){var o=t[r].replace(/['"]/g,"");e.push(-1!=o.indexOf(" ")||/^\d/.test(o)?"'"+o+"'":o)}return e.join(",")}function y(t){return t.L+t.M}function m(t){var e="normal";return"o"===t.L?e="oblique":"i"===t.L&&(e="italic"),e}function M(t){var e=4,r="n",o=null;return t&&((o=t.match(/(normal|oblique|italic)/i))&&o[1]&&(r=o[1].substr(0,1).toLowerCase()),(o=t.match(/([1-9]00|normal|bold)/i))&&o[1]&&(/bold/i.test(o[1])?e=7:/[1-9]00/.test(o[1])&&(e=parseInt(o[1].substr(0,1),10)))),r+e}function v(t,e){this.a=t,this.j=t.k.document.documentElement,this.O=e,this.f="wf",this.e=new _("-"),this.da=!1!==e.events,this.u=!1!==e.classes}function C(t){t.u&&a(t.j,[t.e.d(t.f,"loading")]),w(t,"loading")}function E(t){if(t.u){var e=s(t.j,t.e.d(t.f,"active")),r=[],o=[t.e.d(t.f,"loading")];e||r.push(t.e.d(t.f,"inactive")),a(t.j,r,o)}w(t,"inactive")}function w(t,e,r){t.da&&t.O[e]&&(r?t.O[e](r.getName(),y(r)):t.O[e]())}function k(){this.t={}}function x(t,e,r){var o,i=[];for(o in e)if(e.hasOwnProperty(o)){var a=t.t[o];a&&i.push(a(e[o],r))}return i}function R(t,e){this.a=t,this.h=e,this.m=this.a.createElement("span",{"aria-hidden":"true"},this.h)}function I(t,e){var r,o=t.m;r="display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+P(e.Q)+";"+("font-style:"+m(e)+";font-weight:"+(e.M+"00")+";"),o.style.cssText=r}function O(t){i(t.a,"body",t.m)}function T(t,e,r,o,i,a){this.G=t,this.J=e,this.g=o,this.a=r,this.v=i||3e3,this.h=a||void 0}function L(t,e,r,o,i,a,s){this.G=t,this.J=e,this.a=r,this.g=o,this.h=s||"BESbswy",this.s={},this.v=i||3e3,this.Z=a||null,this.D=this.C=this.A=this.w=null,this.w=new R(this.a,this.h),this.A=new R(this.a,this.h),this.C=new R(this.a,this.h),this.D=new R(this.a,this.h),I(this.w,new g(this.g.getName()+",serif",y(this.g))),I(this.A,new g(this.g.getName()+",sans-serif",y(this.g))),I(this.C,new g("serif",y(this.g))),I(this.D,new g("sans-serif",y(this.g))),O(this.w),O(this.A),O(this.C),O(this.D)}function b(){if(null===Q){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Q=!!t&&(536>parseInt(t[1],10)||536===parseInt(t[1],10)&&11>=parseInt(t[2],10))}return Q}function G(t,e,r){for(var o in Z)if(Z.hasOwnProperty(o)&&e===t.s[Z[o]]&&r===t.s[Z[o]])return!0;return!1}function S(t){var e,r=t.w.m.offsetWidth,o=t.A.m.offsetWidth;(e=r===t.s.serif&&o===t.s["sans-serif"])||(e=b()&&G(t,r,o)),e?W()-t.ga>=t.v?b()&&G(t,r,o)&&(null===t.Z||t.Z.hasOwnProperty(t.g.getName()))?D(t,t.G):D(t,t.J):A(t):D(t,t.G)}function A(t){setTimeout(r(function(){S(this)},t),50)}function D(t,e){setTimeout(r(function(){this.w.remove(),this.A.remove(),this.C.remove(),this.D.remove(),e(this.g)},t),0)}function F(t,e,r){this.a=t,this.p=e,this.P=0,this.ba=this.Y=!1,this.v=r}function N(t){0==--t.P&&t.Y&&(t.ba?(t=t.p,t.u&&a(t.j,[t.e.d(t.f,"active")],[t.e.d(t.f,"loading"),t.e.d(t.f,"inactive")]),w(t,"active")):E(t.p))}function B(t){this.F=t,this.q=new k,this.$=0,this.T=this.U=!0}function U(t,e,o,i,s){var n=0==--t.$;(t.T||t.U)&&setTimeout(function(){var t=s||null,h=i||null||{};if(0===o.length&&n)E(e.p);else{e.P+=o.length,n&&(e.Y=n);var l,c=[];for(l=0;l<o.length;l++){var p=o[l],d=h[p.getName()],u=e.p,_=p;u.u&&a(u.j,[u.e.d(u.f,_.getName(),y(_).toString(),"loading")]),w(u,"fontloading",_),u=null,null===te&&(te=window.FontFace?(u=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(u[1],10):!0:!1),u=te?new T(r(e.V,e),r(e.W,e),e.a,p,e.v,d):new L(r(e.V,e),r(e.W,e),e.a,p,e.v,t,d),c.push(u)}for(l=0;l<c.length;l++)c[l].start()}},0)}function H(t,e,r){var o=[],i=r.timeout;C(e);var o=x(t.q,r,t.a),a=new F(t.a,e,i);for(t.$=o.length,e=0,r=o.length;r>e;e++)o[e].load(function(e,r,o){U(t,a,e,r,o)})}function X(t,e,r){this.N=t?t:e+ee,this.o=[],this.R=[],this.ca=r||""}function z(t,e){for(var r=e.length,o=0;r>o;o++){var i=e[o].split(":");3==i.length&&t.R.push(i.pop());var a="";2==i.length&&""!=i[1]&&(a=":"),t.o.push(i.join(a))}}function Y(t){this.o=t,this.aa=[],this.I={}}function K(t,e){this.a=t,this.c=e}function q(t,e){this.a=t,this.c=e,this.X=[]}function $(t,e){this.a=t,this.c=e}function j(t,e){this.a=t,this.c=e}function J(t,e){this.a=t,this.c=e}var W=Date.now||function(){return+new Date},V=!!window.FontFace;o.prototype.createElement=function(t,e,r){if(t=this.H.createElement(t),e)for(var o in e)e.hasOwnProperty(o)&&("style"==o?t.style.cssText=e[o]:t.setAttribute(o,e[o]));return r&&t.appendChild(this.H.createTextNode(r)),t},_.prototype.d=function(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e].replace(/[\W_]+/g,"").toLowerCase());return t.join(this.ea)},g.prototype.getName=function(){return this.Q},R.prototype.remove=function(){var t=this.m;t.parentNode&&t.parentNode.removeChild(t)},T.prototype.start=function(){function t(){W()-o>=r.v?r.J(r.g):e.fonts.load(f(r.g),r.h).then(function(e){1<=e.length?r.G(r.g):setTimeout(t,25)},function(){r.J(r.g)})}var e=this.a.k.document,r=this,o=W();t()};var Z={ia:"serif",ha:"sans-serif"},Q=null;L.prototype.start=function(){this.s.serif=this.C.m.offsetWidth,this.s["sans-serif"]=this.D.m.offsetWidth,this.ga=W(),S(this)};var te=null;F.prototype.V=function(t){var e=this.p;e.u&&a(e.j,[e.e.d(e.f,t.getName(),y(t).toString(),"active")],[e.e.d(e.f,t.getName(),y(t).toString(),"loading"),e.e.d(e.f,t.getName(),y(t).toString(),"inactive")]),w(e,"fontactive",t),this.ba=!0,N(this)},F.prototype.W=function(t){var e=this.p;if(e.u){var r=s(e.j,e.e.d(e.f,t.getName(),y(t).toString(),"active")),o=[],i=[e.e.d(e.f,t.getName(),y(t).toString(),"loading")];r||o.push(e.e.d(e.f,t.getName(),y(t).toString(),"inactive")),a(e.j,o,i)}w(e,"fontinactive",t),N(this)},B.prototype.load=function(t){this.a=new o(this.F,t.context||this.F),this.U=!1!==t.events,this.T=!1!==t.classes,H(this,new v(this.a,t),t)};var ee="//fonts.googleapis.com/css";X.prototype.d=function(){if(0==this.o.length)throw Error("No fonts to load!");if(-1!=this.N.indexOf("kit="))return this.N;for(var t=this.o.length,e=[],r=0;t>r;r++)e.push(this.o[r].replace(/ /g,"+"));return t=this.N+"?family="+e.join("%7C"),0<this.R.length&&(t+="&subset="+this.R.join(",")),0<this.ca.length&&(t+="&text="+encodeURIComponent(this.ca)),t};var re={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},oe={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},ie={i:"i",italic:"i",n:"n",normal:"n"},ae=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;Y.prototype.parse=function(){for(var t=this.o.length,e=0;t>e;e++){var r=this.o[e].split(":"),o=r[0].replace(/\+/g," "),i=["n4"];if(2<=r.length){var a,s=r[1];if(a=[],s)for(var s=s.split(","),n=s.length,h=0;n>h;h++){var l;if(l=s[h],l.match(/^[\w-]+$/))if(l=ae.exec(l.toLowerCase()),null==l)l="";else{var c;if(c=l[1],null==c||""==c)c="4";else{var p=oe[c];c=p?p:isNaN(c)?"4":c.substr(0,1)}l=l[2],l=[null==l||""==l?"n":ie[l],c].join("")}else l="";l&&a.push(l)}0<a.length&&(i=a),3==r.length&&(r=r[2],a=[],r=r?r.split(","):a,0<r.length&&(r=re[r[0]])&&(this.I[o]=r))}for(this.I[o]||(r=re[o])&&(this.I[o]=r),r=0;r<i.length;r+=1)this.aa.push(new g(o,i[r]))}};var se={Arimo:!0,Cousine:!0,Tinos:!0};K.prototype.load=function(t){var e=new c,r=this.a,o=new X(this.c.api,n(r),this.c.text),i=this.c.families;z(o,i);var a=new Y(i);a.parse(),h(r,o.d(),p(e)),d(e,function(){t(a.aa,a.I,se)})},q.prototype.B=function(t){var e=this.a;return n(this.a)+(this.c.api||"//f.fontdeck.com/s/css/js/")+(e.k.location.hostname||e.F.location.hostname)+"/"+t+".js"},q.prototype.load=function(t){var e=this.c.id,r=this.a.k,o=this;e?(r.__webfontfontdeckmodule__||(r.__webfontfontdeckmodule__={}),r.__webfontfontdeckmodule__[e]=function(e,r){for(var i=0,a=r.fonts.length;a>i;++i){var s=r.fonts[i];o.X.push(new g(s.name,M("font-weight:"+s.weight+";font-style:"+s.style)))}t(o.X)},l(this.a,this.B(e),function(e){e&&t([])})):t([])},$.prototype.B=function(t){return(this.c.api||"https://use.typekit.net")+"/"+t+".js"},$.prototype.load=function(t){var e=this.c.id,r=this.a.k;e?l(this.a,this.B(e),function(e){if(e)t([]);else if(r.Typekit&&r.Typekit.config&&r.Typekit.config.fn){e=r.Typekit.config.fn;for(var o=[],i=0;i<e.length;i+=2)for(var a=e[i],s=e[i+1],n=0;n<s.length;n++)o.push(new g(a,s[n]));try{r.Typekit.load({events:!1,classes:!1,async:!0})}catch(h){}t(o)}},2e3):t([])},j.prototype.B=function(t,e){var r=n(this.a),o=(this.c.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,"");return r+"//"+o+"/"+t+".js"+(e?"?v="+e:"")},j.prototype.load=function(t){function e(){if(i["__mti_fntLst"+r]){var o,a=i["__mti_fntLst"+r](),s=[];if(a)for(var n=0;n<a.length;n++){var h=a[n].fontfamily;void 0!=a[n].fontStyle&&void 0!=a[n].fontWeight?(o=a[n].fontStyle+a[n].fontWeight,s.push(new g(h,o))):s.push(new g(h))}t(s)}else setTimeout(function(){e()},50)}var r=this.c.projectId,o=this.c.version;if(r){var i=this.a.k;l(this.a,this.B(r,o),function(r){r?t([]):e()}).id="__MonotypeAPIScript__"+r}else t([])},J.prototype.load=function(t){var e,r,o=this.c.urls||[],i=this.c.families||[],a=this.c.testStrings||{},s=new c;for(e=0,r=o.length;r>e;e++)h(this.a,o[e],p(s));var n=[];for(e=0,r=i.length;r>e;e++)if(o=i[e].split(":"),o[1])for(var l=o[1].split(","),u=0;u<l.length;u+=1)n.push(new g(o[0],l[u]));else n.push(new g(o[0]));d(s,function(){t(n,a)})};var ne=new B(window);ne.q.t.custom=function(t,e){return new J(e,t)},ne.q.t.fontdeck=function(t,e){return new q(e,t)},ne.q.t.monotype=function(t,e){return new j(e,t)},ne.q.t.typekit=function(t,e){return new $(e,t)},ne.q.t.google=function(t,e){return new K(e,t)};var he={load:r(ne.load,ne)};"function"==typeof define&&define.amd?define(function(){return he}):"undefined"!=typeof module&&module.exports?module.exports=he:(window.WebFont=he,window.WebFontConfig&&ne.load(window.WebFontConfig))}(),PM.Core={},PM.Ctrl={},PM.Editor={},PM.Lib={},PM.URL={},PM.TYPE={},PM.PAGE={},PM.HIT={},PM.CONFIG={},PM.PRODUCT={},PM.Core.Version="79",PM.Core.MAIN_CANVAS_ID="",PM.PRODUCT.UNKNOWN=-1,PM.PRODUCT.PHOTOBOOK=0,PM.PRODUCT.CALENDAR=1,PM.TYPE.UNKNOWN=-1,PM.TYPE.ICON=0,PM.TYPE.IMAGE=1,PM.TYPE.TEXT=2,PM.PAGE.ERROR=-3,PM.PAGE.COVER=-2,PM.PAGE.PROLOG=-1,PM.PAGE.EPILOG=9999,PM.PAGE.COVER_FRONT=-10,PM.PAGE.COVER_MIDDLE=-11,PM.PAGE.COVER_BACK=-12,PM.ADDPAGE_SUCCESS=0,PM.ADDPAGE_FAIL=-1,PM.ADDPAGE_LIMIT_ERROR=-2,PM.DELPAGE_SUCCESS=0,PM.DELPAGE_FAIL=-1,PM.DELPAGE_LIMIT_ERROR=-2,PM.HIT.NONE=-1,PM.HIT.MOVE=0,PM.HIT.RESIZE_T=1,PM.HIT.RESIZE_R=2,PM.HIT.RESIZE_B=3,PM.HIT.RESIZE_L=4,PM.HIT.RESIZE_LT=5,PM.HIT.RESIZE_RT=6,PM.HIT.RESIZE_RB=7,PM.HIT.RESIZE_LB=8,PM.HIT.ROTATE=9,PM.HIT.MOVE_CROP=10,PM.HIT.EDIT_TEXT=11,PM.RECORD_ON=!0,PM.RECORD_OFF=!1,PM.RECORD_UNKNOWN=0,PM.RECORD_PAGE_INSERT=1,PM.RECORD_PAGE_DELETE=2,PM.RECORD_PAGE_REORDER=3,PM.RECORD_PAGE_BKCOLOR=4,PM.RECORD_PAGE_BKIMAGE=5,PM.RECORD_PAGE_LAYOUT=6,PM.RECORD_LAYER_INSERT=7,PM.RECORD_LAYER_DELETE=8,PM.RECORD_LAYER_MOVE=9,PM.RECORD_LAYER_ZORDER=10,PM.RECORD_FRAME_CHANGE=11,PM.RECORD_PHOTO_CHANGE=12,PM.RECORD_PHOTO_CROP=13,PM.RECORD_PHOTO_ADDALL=14,PM.RECORD_PHOTO_DELALL=15,PM.RECORD_ICON_OPACITY=16,PM.RECORD_TEXT_CHANGE=17,PM.RECORD_EMPTYLAYERS_DELETE=18,PM.SIZE6X6=0,PM.SIZE6X8=1,PM.SIZE8X6=2,PM.SIZE8X8=3,PM.SIZE8X11=4,PM.SIZE11X8=5,PM.SIZE10X10=6,PM.DEBUG=!1,PM.URL.UPLOAD="http://tplx.photomon.com/upload/flex_webimage.asp",PM.URL.ADD_CART="http://www.photomon.com/StoryAlbum/CardEditor/add_cart_ok.asp",PM.URL.THEME_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_stylethumb.xml",PM.URL.LAYOUT_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_layouturl.xml",PM.URL.SKIN_LIST="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_backgroundurl.xml",PM.URL.STICKER_LIST="http://tpl.photomon.com/Product/catalog/mainxml/flex_stickdnurl.20130904.xml",PM.URL.FRAME_LIST="http://tpl.photomon.com/Product/catalog/mainxml/flex_frameurl.xml",PM.URL.LAYOUT_THUMB="http://tpl.photomon.com/product/skin/thumb/",PM.URL.LAYOUT_FILE="http://tpl.photomon.com/product/skin/thumb/",PM.URL.SKIN_THUMB="http://tpl.photomon.com/Product/skin/flex_skinthumb/",PM.URL.SKIN_FILE="http://tpl.photomon.com/product/skin/edit/",PM.URL.STICKER_THUMB="http://tpl.photomon.com/Product/clipart20120430/thumb/",PM.URL.STICKER_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.URL.FRAME_THUMB="http://tpl.photomon.com/Product/clipart20120430/thumb/",PM.URL.FRAME_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.URL.EDIT_INFO="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_productbook_div_utf8.asp?",PM.CONFIG.SCALE_MIN=.3,PM.CONFIG.SCALE_MAX=2,PM.CONFIG.CANVAS_MARGIN_W=120,PM.CONFIG.CANVAS_MARGIN_H=120,PM.CONFIG.PHOTO_MIN_DPI=150,PM.CONFIG.GRID_COLOR="#777777",PM.CONFIG.GRID_LINEW=.5,PM.CONFIG.GRID_SPACE=10,PM.CONFIG.CONTROLLER_RADIUS=8,PM.CONFIG.CROP_RADIUS=22,PM.CONFIG.PHOTO_MAX=25,PM.CONFIG.GUIDE_COLOR="#ff0000",PM.CONFIG.GUIDE_LINEW=1,PM.CONFIG.GUIDE_EXTRA=32,PM.CONFIG.GUIDE_FONT="16px Nanum Gothic",PM.CONFIG.GUIDE_FONT_H=16,PM.CONFIG.GUIDE_TEXT_COLOR="#000000",PM.CONFIG.GUIDE_TEXT_MARGIN=10,PM.CONFIG.GUIDE_LEATHERCOVER_TEXT="커버내 사각홈에 보여지는 사진은 실제 제작시 1~3mm 정도 오차가 발생할 수 있습니다.",PM.CONFIG.PROLOG_FONT="16pt Nanum Gothic",PM.CONFIG.PROLOG_COLOR="#bbbbbb",PM.CONFIG.PROLOG_TEXT="인쇄되지 않는 페이지입니다.",PM.CONFIG.BOOT_FONT="14pt Nanum Gothic",PM.CONFIG.BOOT_COLOR="#bbbbbb",PM.CONFIG.BOOT_LOADING_MSG="상품정보를 불러오는 중...",PM.CONFIG.BOOT_FAILURE_MSG="상품정보를 정상적으로 불러오지 못했습니다.",PM.CONFIG.BOOT_LOADING=0,PM.CONFIG.BOOT_SUCCESS=1,PM.CONFIG.BOOT_FAILURE=-1,PM.CONFIG.MESSAGE_ONLINE="인터넷이 연결되었습니다.",PM.CONFIG.MESSAGE_OFFLINE="인터넷이 연결되지 않았습니다.",PM.CONFIG.MESSAGE_CANNOT_ADD="추가를 할 수 없습니다.",PM.CONFIG.MESSAGE_CHECK_IME="macOS에서는 영문모드 상태에서만 입력 가능합니다. (영문모드 상태에서 Shift+Space로 한/영 전환)",PM.CONFIG.MESSAGE_CHECK_TEXT_LEN="글상자의 내용이 범위를 넘어섭니다. 글꼴 크기를 줄이거나 글 내용을 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE="글상자의 크기가 범위를 넘어섭니다. 글상자의 크기를 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA="인쇄되지 않는 페이지를 침범한 레이어 영역은 인쇄되지 않습니다.",PM.CONFIG.MESSAGE_CHECK_SPINE_AREA="커버의 책등(세네카)영역과 겹치지 않게 편집해 주십시오.",PM.CONFIG.MESSAGEBAR_TIMEOUT=3e3,PM.CONFIG.MESSAGEBAR_FONT="10pt Nanum Gothic",PM.CONFIG.MESSAGEBAR_TEXTCOLOR="#111111",PM.CONFIG.MESSAGEBAR_BACKCOLOR="#ffff00",PM.CONFIG.MESSAGEBAR_HEIGHT=30,PM.CONFIG.ROUNDMASK_IMAGE="http://tpl.photomon.com/Product/clipart20120430/edit/frame_diagram_56.png",PM.CONFIG.FRAME_EMPTY_IMAGE="frame_diagram_delete.png",PM.CONFIG.COVER_BARCODE_IMAGE="./images/common/cover_barcode.jpg",PM.CONFIG.PAGE_GRADATION_IMAGE="./images/common/page_gradation.png",PM.CONFIG.PHOTO_EMPTY_IMAGE="./images/common/photo_empty.png",PM.CONFIG.PHOTO_WARNING_IMAGE="./images/common/photo_warning.png",PM.CONFIG.FONT_DEFAULT="Nanum Gothic",PM.CONFIG.FONT_POOL=["BM Dohyeon","BM Hanna","BM Jua","Jeju Gothic","Jeju Myeongjo","Jeju Hallasan","KoPub Batang","Nanum Barun Gothic","Nanum Barun Gothic Light","Nanum Barun Pen","Nanum Gothic","Nanum Myeongjo","Nanum Pen Script","Nanum Brush Script","Nanum Square","Noto Sans KR","Seoul Hangang","Seoul Namsan","TDc Ballerina","TDc Bearnrabbit","TDc Bigeyes","TDc Childheart","TDc Donkiprince","TDc Donkiround","TDc Pororomc","TDc Poundingheart","TDc Todayweather","TDc Valentine"],PM.CONFIG.FONT_PATH={"BM Dohyeon":"./webfont/kor/bmdohyeon.css","BM Hanna":"./webfont/kor/bmhanna.css","BM Jua":"./webfont/kor/bmjua.css","Jeju Gothic":"./webfont/kor/jejugothic.css","Jeju Myeongjo":"./webfont/kor/jejumyeongjo.css","Jeju Hallasan":"./webfont/kor/jejuhallasan.css","KoPub Batang":"./webfont/kor/kopubbatang.css","Nanum Barun Gothic":"./webfont/kor/nanumbarungothic.css","Nanum Barun Gothic Light":"./webfont/kor/nanumbarungothic-light.css","Nanum Barun Pen":"./webfont/kor/nanumbarunpen.css","Nanum Gothic":"./webfont/kor/nanumgothic.css","Nanum Myeongjo":"./webfont/kor/nanummyeongjo.css","Nanum Pen Script":"./webfont/kor/nanumsonpen.css","Nanum Brush Script":"./webfont/kor/nanumsonbrush.css","Nanum Square":"./webfont/kor/nanumsquare.css","Noto Sans KR":"./webfont/kor/notosanskr.css","Seoul Hangang":"./webfont/kor/seoulhangang.css","Seoul Namsan":"./webfont/kor/seoulnamsan.css","TDc Ballerina":"./webfont/kor/tdc_ballerina.css","TDc Bearnrabbit":"./webfont/kor/tdc_bearnrabbit.css","TDc Bigeyes":"./webfont/kor/tdc_bigeyes.css","TDc Childheart":"./webfont/kor/tdc_childheart.css","TDc Donkiprince":"./webfont/kor/tdc_donkiprince.css","TDc Donkiround":"./webfont/kor/tdc_donkiround.css","TDc Pororomc":"./webfont/kor/tdc_pororomc.css","TDc Poundingheart":"./webfont/kor/tdc_poundingheart.css","TDc Todayweather":"./webfont/kor/tdc_todayweather.css","TDc Valentine":"./webfont/kor/tdc_valentine.css"},PM.COLOR_PAGE_BORDER="rgba(0, 255, 0, 0.5)",PM.COLOR_PAGE_FOCUS_STROKE="rgba(0, 255, 255, 0.5)",PM.COLOR_LAYER_STROKE="rgba(0,0,0,0.5)",PM.COLOR_LAYER_FILL="rgba(0,0,0,0.1)",PM.COLOR_TBOX_WARNING_FILL="rgba(255,255,0,0.5)",PM.COLOR_DRAGGER_FOCUS_STROKE="rgba(255,0,0,1.0)",PM.COLOR_DRAGGER_FOCUS_FILL="rgba(255,100,100,0.6)",PM.COLOR_DRAGGER_NORMAL_STROKE="rgba(0,0,0,0.5)",PM.COLOR_DRAGGER_NORMAL_FILL="rgba(80,190,240,0.6)",PM.TBOX_COMMENT_DEFAULT="내용을 입력해 주십시오",PM.Codi=new function(){var t=[[{m:152,s:36},{m:162,s:46},{m:174,s:58},{m:186,s:70},{m:206,s:90},{m:0,s:0}],[{m:121,s:29},{m:130,s:38},{m:140,s:48},{m:148,s:56},{m:164,s:72},{m:0,s:0}],[{m:131,s:31},{m:142,s:42},{m:152,s:52},{m:162,s:62},{m:180,s:80},{m:0,s:0}],[{m:118,s:28},{m:126,s:51},{m:135,s:63},{m:144,s:75},{m:159,s:96},{m:0,s:0}],[{m:92,s:22},{m:98,s:28},{m:106,s:36},{m:112,s:42},{m:124,s:54},{m:0,s:0}],[{m:105,s:30},{m:117,s:43},{m:128,s:53},{m:138,s:64},{m:150,s:76},{m:0,s:0}],[{m:102,s:29},{m:113,s:41},{m:126,s:51},{m:134,s:61},{m:148,s:73},{m:0,s:0}]],e=[[{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:65},{m:90,s:88},{m:0,s:0}],[{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:71,s:69},{m:0,s:0}],[{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:23,s:22},{m:30,s:29},{m:38,s:36},{m:45,s:44},{m:52,s:50},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],r=[[{m:28,s:26},{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:75},{m:0,s:0}],[{m:21,s:19},{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:21,s:20},{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:0,s:0}],[{m:22,s:20},{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:16,s:14},{m:23,s:22},{m:30,s:36},{m:38,s:36},{m:45,s:44},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],o=[[0,0,0],[112,118,0],[121,128,0],[108,114,0],[84,89,0],[88,94,0],[87,92,0]],i=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[11,17,20,26,0],[8,12,16,20,0],[0,0,0,0,0],[0,0,0,0,0]],a=[28,22,24,22,17,17,17],s=[20,15,16,15,12,12,12],n=[0,0,0,5,5,5,5],h=[0,22,24,22,17,17,17],l=[0,0,0,15,12,0,0],c=[{dx:18,dy:9},{dx:14,dy:7},{dx:14,dy:7},{dx:14,dy:7},{dx:10,dy:5},{dx:10,dy:5},{dx:10,dy:5}],p=[{x:489,y:566,w:78,h:40},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],d=[{x:519,y:577,w:84,h:42},{x:381,y:595,w:66,h:33},{x:558,y:443,w:66,h:33},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:547,y:446,w:62,h:26},{x:502,y:582,w:100,h:41}],u=[{x:0,y:0,w:0,h:0},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],_=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}];this.GetProductSizeIndex=function(t){var e=t.toLowerCase(),r=-1;switch(e){case"6x6":r=PM.SIZE6X6;break;case"6x8":case"a5h":r=PM.SIZE6X8;break;case"8x6":case"a5w":r=PM.SIZE8X6;break;case"8x8":r=PM.SIZE8X8;break;case"8x11":case"a4h":r=PM.SIZE8X11;break;case"11x8":case"a4w":r=PM.SIZE11X8;break;case"10x10":r=PM.SIZE10X10}return r},this.GetPageBlockIndex=function(t,e,r){if("layflat"==t){if(21>=r)return 0;if(31>=r)return 1;if(41>=r)return 2;if(51>=r)return 3;if(61>=r)return 4}else if("design"==t)if("soft"==e){if(45>=r)return 0;if(65>=r)return 1;if(83>=r)return 2;if(101>=r)return 3}else{if(61>=r)return 0;if(81>=r)return 1}return-1},this.GetGuideInfo=function(g,f,P,y,m,M){var v=this.GetPageBlockIndex(f,y,M),C=0,E=0,w=PM.Util.ProductSize2SizeId(P),k=c[w].dx,x=c[w].dy,R=null,I=0>=g;if("layflat"==f)if("soft"==y){var O="yes"==m||"y"==m;C=O?e[w][v].m:r[w][v].m,E=O?e[w][v].s:r[w][v].s,I&&(k=s[w],x=k),R=d[w]}else"hard"==y?(C=t[w][v].m,E=t[w][v].s,I&&(k=a[w],x=k),R=p[w]):"acrylic"==y?(C=0,I&&(k=n[w],x=k),R={x:0,y:0,w:0,h:0}):(C=0,I&&(k=x=0),R={x:0,y:0,w:0,h:0});else"soft"==y?(C=i[w][v],I&&(k=l[w],x=k),R=_[w]):"hard"==y||"pad"==y?(C=o[w][v],I&&(k=h[w],x=k),R=u[w]):(C=0,I&&(k=x=0),R={x:0,y:0,w:0,h:0});return{cut_w:k,cut_h:x,middle_w:C,spine_w:E,barcode_rect:R}}},PM.Core.Layer=function(){this.gid="",this.require=!1,this.movelock=!1,this.resizelock=!1,this.zorderlock=!1,this.removelock=!1,this.xpos=0,this.ypos=0,this.width=0,this.height=0,this.radian=0},PM.Core.Layer.prototype.CopyProperty=function(t){return t.gid=this.gid,t.require=this.require,t.movelock=this.movelock,t.resizelock=this.resizelock,t.removelock=this.removelock,t.xpos=this.xpos,t.ypos=this.ypos,t.width=this.width,t.height=this.height,t.radian=this.radian,t},PM.Core.Layer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian}},PM.Core.Layer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian},PM.Core.Layer.prototype.IsEqualMoveInfo=function(t){return this.xpos==t.xpos&&this.ypos==t.ypos&&this.width==t.width&&this.height==t.height&&this.radian==t.radian},PM.Core.Layer.prototype.PrepareDC=function(t,e,r){t.save(),t.translate(e+this.xpos,r+this.ypos),this.radian&&(t.translate(this.width/2,this.height/2),t.rotate(this.radian),t.translate(-this.width/2,-this.height/2))},PM.Core.Layer.prototype.ReleaseDC=function(t){t.restore()},PM.Core.Layer.prototype.GetType=function(){return this.type},PM.Core.Layer.prototype.GetRect=function(){return{l:this.xpos,t:this.ypos,w:this.width,h:this.height}},PM.Core.Layer.prototype.GetCenterPos=function(){return{x:this.xpos+this.width/2,y:this.ypos+this.height/2}},PM.Core.Layer.prototype.NonRotatedPoint=function(t,e,r,o){var i=-this.radian;return this.GetRotatePoint(i,t,e,r,o)},PM.Core.Layer.prototype.GetRotatePoint=function(t,e,r,o,i){var a={x:o,y:i};return t&&(a.x=(o-e)*Math.cos(t)-(i-r)*Math.sin(t)+e,a.y=(o-e)*Math.sin(t)+(i-r)*Math.cos(t)+r),a},PM.Core.Layer.prototype.GetRotateInnerPoints=function(t,e){var r=[];return r.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos)),r.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos)),r.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos+this.height)),r.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos+this.height)),r},PM.Core.Layer.prototype.Points2OutRect=function(t){if(4!=t.length)return{l:0,t:0,w:0,h:0};var e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),r=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),o=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),i=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y));return{l:e,t:r,w:o-e,h:i-r}},PM.Core.Layer.prototype.GetOutRect=function(){var t=this.xpos+this.width/2,e=this.ypos+this.height/2,r=this.GetRotateInnerPoints(t,e),o=this.Points2OutRect(r);return o},PM.Core.Layer.prototype.DrawExtra=function(t,e){PM.DEBUG&&(PM.Editor.Framework.IsPreviewMode()||(t.font="12px Nanum Gothic",t.fillStyle="#ff0000",t.textAlign="center",t.textBaseline="middle",t.fillText(e,10,10,30)))},PM.Core.Layer.prototype.DrawHighlight=function(t,e,r){this.PrepareDC(t,e,r),PM.Util.DrawRect(t,0,0,this.width,this.height,1.5,"yellow",null),this.ReleaseDC(t)},PM.Core.Layer.prototype.DrawController=function(t,e,r,o){this.PrepareDC(t,e,r);var i=PM.Editor.Framework.IsShiftState(),a=1,s=o?PM.COLOR_DRAGGER_FOCUS_STROKE:PM.COLOR_DRAGGER_NORMAL_STROKE;if(PM.Util.DrawDashRect(t,0,0,this.width,this.height,a,s,null),!o){var n=0,h=0,l=PM.CONFIG.CONTROLLER_RADIUS,c=PM.COLOR_DRAGGER_NORMAL_FILL;if(!this.movelock&&!i){var p=this.resizelock?0:-l;PM.Util.DrawDashLine(t,this.width/2,-30+l,this.width/2,p,1,s)}n=this.width/2,h=-30,this.movelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width/2,h=0,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=this.height/2,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width/2,h=this.height,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=this.height/2,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c)}this.ReleaseDC(t)},PM.Core.Layer.prototype.HitTest=function(t,e,r){var o=this.xpos+this.width/2,i=this.ypos+this.height/2,a=this.NonRotatedPoint(o,i,e,r),s=this.GetRect();return PM.Util.PtInRect(s,a.x,a.y)?this:null},PM.Core.Layer.prototype.HitTestController=function(t,e,r){var o=PM.Editor.Framework.IsShiftState(),i=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(i,a,e,r),n=this.GetRect(),h=PM.CONFIG.CONTROLLER_RADIUS;return i=n.l+this.width/2,a=n.t-30,this.movelock||o||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width/2,a=n.t+0,this.resizelock||o||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width,a=n.t+this.height/2,this.resizelock||o||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width/2,a=n.t+this.height,this.resizelock||o||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+0,a=n.t+this.height/2,this.resizelock||o||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+0,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_LT:(i=n.l+this.width,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_RT:(i=n.l+this.width,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_RB:(i=n.l+0,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_LB:PM.Util.PtInRect(n,s.x,s.y)?PM.HIT.MOVE:PM.HIT.NONE)))):PM.HIT.RESIZE_L):PM.HIT.RESIZE_B):PM.HIT.RESIZE_R):PM.HIT.RESIZE_T):PM.HIT.ROTATE},PM.Core.Layer.prototype.Move=function(t,e,r,o){if(!this.movelock){var i=r-t,a=o-e;this.xpos+=i,this.ypos+=a}},PM.Core.Layer.prototype.ResizeToFixedRate=function(t,e,r,o,i){var a=0,s=this.width,n=this.height;Math.abs(e)>Math.abs(r)?(n=s*i/o,a=this.height-n,this.height=n,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_RT)&&(this.ypos+=a)):(s=n*o/i,a=this.width-s,this.width=s,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_LB)&&(this.xpos+=a))},PM.Core.Layer.prototype.Resize=function(t,e,r,o,i){if(!this.resizelock){var a=PM.Editor.Framework.IsShiftState(),s=this.xpos+this.width/2,n=this.ypos+this.height/2,h=this.NonRotatedPoint(s,n,e,r),l=this.NonRotatedPoint(s,n,o,i),c=this.width,p=this.height,d=l.x-h.x,u=l.y-h.y;switch(t){case PM.HIT.RESIZE_T:this.height-u>=30&&(this.ypos+=u,this.height-=u);break;case PM.HIT.RESIZE_B:this.height+u>=30&&(this.height+=u);break;case PM.HIT.RESIZE_L:this.width-d>=30&&(this.xpos+=d,this.width-=d);break;case PM.HIT.RESIZE_R:this.width+d>=30&&(this.width+=d);break;case PM.HIT.RESIZE_LT:this.width-d>=30&&this.height-u>=30&&(this.xpos+=d,this.width-=d,this.ypos+=u,this.height-=u,a&&this.ResizeToFixedRate(t,d,u,c,p));break;case PM.HIT.RESIZE_RT:this.width+d>=30&&this.height-u>=30&&(this.width+=d,this.ypos+=u,this.height-=u,a&&this.ResizeToFixedRate(t,d,u,c,p));break;case PM.HIT.RESIZE_RB:this.width+d>=30&&this.height+u>=30&&(this.width+=d,this.height+=u,a&&this.ResizeToFixedRate(t,d,u,c,p));break;case PM.HIT.RESIZE_LB:this.width-d>=30&&this.height+u>=30&&(this.xpos+=d,this.width-=d,this.height+=u,a&&this.ResizeToFixedRate(t,d,u,c,p))}this.RecalcXY(s,n)}},PM.Core.Layer.prototype.RecalcXY=function(t,e){if(this.radian){var r=this.GetRotateInnerPoints(t,e),o=this.Points2OutRect(r),i=o.l+o.w/2,a=o.t+o.h/2,s=this.NonRotatedPoint(i,a,r[0].x,r[0].y);this.xpos=s.x,this.ypos=s.y}},PM.Core.Layer.prototype.Rotate=function(t,e,r,o){if(!this.movelock){var i=this.xpos+this.width/2,a=this.ypos+this.height/2;t-=i,r-=i,e=a-e,o=a-o;var s=Math.atan2(t,e),n=Math.atan2(r,o);0>s&&(s=2*Math.PI+s),0>n&&(n=2*Math.PI+n),this.radian+=n-s,this.radian<0&&(this.radian+=2*Math.PI),this.radian>2*Math.PI&&(this.radian-=2*Math.PI)}},PM.Core.Layer.prototype.RotateAngle=function(t){if(this.movelock)return!1;
if(90!=t&&-90!=t)return!1;var e=PM.Util.ToAngle(this.radian);0>e&&(e+=360),e>=360&&(e-=360),t>0?90>e?e=0:180>e?e=90:270>e?e=180:360>e&&(e=270):e=e>0&&90>=e?90:e>90&&180>=e?180:e>180&&270>=e?270:360;var r=e+t;return 0>r&&(r+=360),r>=360&&(r-=360),this.radian=PM.Util.ToRadian(r),!0},PM.Core.Layer.prototype.Parse=function(t){var e=this;e.gid=t.attr("gid").toLowerCase(),e.require="true"===t.attr("require"),e.movelock="true"===t.attr("movelock"),e.resizelock="true"===t.attr("resizelock"),e.zorderlock="true"===t.attr("zorderlock"),e.removelock="true"===t.attr("removelock"),$layer_rect=t.find("rect"),e.xpos=parseFloat($layer_rect.attr("x")),e.ypos=parseFloat($layer_rect.attr("y")),e.width=parseFloat($layer_rect.attr("width")),e.height=parseFloat($layer_rect.attr("height"));var r=parseFloat($layer_rect.attr("angle"));if(0>r&&(r+=360),r>360&&(r-=360),"spine"!=e.gid&&0!=r){var o=e.xpos,i=e.ypos,a=PM.Util.ToRadian(r),s=[];s.push(e.GetRotatePoint(a,o,i,e.xpos,e.ypos)),s.push(e.GetRotatePoint(a,o,i,e.xpos+e.width,e.ypos)),s.push(e.GetRotatePoint(a,o,i,e.xpos,e.ypos+e.height)),s.push(e.GetRotatePoint(a,o,i,e.xpos+e.width,e.ypos+e.height));var n=e.Points2OutRect(s),h=n.l+n.w/2,l=n.t+n.h/2;e.xpos=h-e.width/2,e.ypos=l-e.height/2,e.radian=a}else e.radian=PM.Util.ToRadian(r);e.radian<0&&(e.radian+=2*Math.PI),e.radian>2*Math.PI&&(e.radian-=2*Math.PI),e.movelock=e.resizelock=e.zorderlock=e.removelock="spine"==e.gid?!0:!1},PM.Core.Layer.prototype.LoadJson=function(t){return this.gid=t.gid,this.require=t.require,this.movelock=t.movelock,this.resizelock=t.resizelock,this.zorderlock=t.zorderlock,this.removelock=t.removelock,this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,!0},PM.Core.Layer.prototype.SaveJson=function(){var t="\n";t+='        "gid": "'+this.gid+'"',t+=', "require": '+this.require,t+=', "movelock": '+this.movelock,t+=', "resizelock": '+this.resizelock,t+=', "zorderlock": '+this.zorderlock,t+=', "removelock": '+this.removelock,t+=', "xpos": '+this.xpos,t+=', "ypos": '+this.ypos,t+=', "width": '+this.width,t+=', "height": '+this.height,t+=', "radian": '+this.radian;var e=this.GetOutRect();return t+=', "out_x": '+e.l,t+=', "out_y": '+e.t,t+=', "out_w": '+e.w,t+=', "out_h": '+e.h},PM.Core.IconLayer=function(){PM.Core.Layer.call(this),this.alpha=255,this.icon="",this.icon_image=null},PM.Core.IconLayer.prototype=new PM.Core.Layer,PM.Core.IconLayer.prototype.GetType=function(){return PM.TYPE.ICON},PM.Core.IconLayer.prototype.GetDesc=function(){return"스티커"},PM.Core.IconLayer.prototype.Load=function(){var t=$.Deferred(),e=this,r=e.icon,o=PM.Util.LoadImage(r);return o.done(function(r){e.icon_image=r,(e.width<=0||e.height<=0)&&(e.width=e.icon_image.width,e.height=e.icon_image.height),t.resolve()}),o.fail(function(){console.log("* Fail:PM.Core.IconLayer.Load: "+r),t.reject()}),t.promise()},PM.Core.IconLayer.prototype.Draw=function(t,e,r,o){this.PrepareDC(t,e,r),null!=this.icon_image&&(t.globalAlpha=this.alpha/255,t.drawImage(this.icon_image,0,0,this.width,this.height),t.globalAlpha=1),this.DrawExtra(t,o),this.ReleaseDC(t)},PM.Core.IconLayer.prototype.GetDrawItemList=function(){return"\n[icon] "+this.icon},PM.Core.IconLayer.prototype.HitTest=function(t,e,r){return PM.Core.Layer.prototype.HitTest.call(this,t,e,r)?this:null},PM.Core.IconLayer.prototype.SetAlpha=function(t,e,r){if(this.alpha=e,r){var o=PM.Editor.Framework.GetPairNumber(),i=PM.Editor.Framework.GetSelectedPageIndex(),a=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(PM.RECORD_ICON_OPACITY,o,{page_pos:i,layer_pos:a,data:t},{page_pos:i,layer_pos:a,data:e},"스티커 투명도")}},PM.Core.IconLayer.prototype.GetAlpha=function(){return this.alpha},PM.Core.IconLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.alpha=parseInt(t.attr("alpha")),$layer_file=t.find("file");var e=$layer_file.text();e&&e.length>0&&(this.icon=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e))},PM.Core.IconLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.alpha=t.alpha,this.icon=t.icon;var r=this,o=this.Load();return o.done(function(){e.resolve()}),o.fail(function(){console.log("* Fail:PM.Core.IconLayer.LoadJson: "+r.icon),e.reject()}),e.promise()},PM.Core.IconLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.ICON,t+='\n        , "alpha": '+this.alpha,t+='\n        , "icon": "'+this.icon+'"',t+="\n        }"},PM.Core.ImageLayer=function(){PM.Core.Layer.call(this),this.diagram="",this.diagram_image=null,this.special="",this.special_image=null,this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,this.is_low=!1},PM.Core.ImageLayer.prototype=new PM.Core.Layer,PM.Core.ImageLayer.prototype.GetType=function(){return PM.TYPE.IMAGE},PM.Core.ImageLayer.prototype.GetDesc=function(){return"사진틀"},PM.Core.ImageLayer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian,extra:this.GetCropInfo()}},PM.Core.ImageLayer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,this.SetCropInfo(t.extra)},PM.Core.ImageLayer.prototype.GetCropInfo=function(){return{crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetCropInfo=function(t){this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h},PM.Core.ImageLayer.prototype.IsEqualCropInfo=function(t){return this.crop_x==t.crop_x&&this.crop_y==t.crop_y&&this.crop_w==t.crop_w&&this.crop_h==t.crop_h},PM.Core.ImageLayer.prototype.RecordState=function(t,e,r,o){var i=PM.Editor.Framework.GetPairNumber(),a=PM.Editor.Framework.GetSelectedPageIndex(),s=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(t,i,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:r},o)},PM.Core.ImageLayer.prototype.GetPhotoState=function(){return{photo:this.photo,photo_org:this.photo_org,original_w:this.original_w,original_h:this.original_h,photo_angle:this.photo_angle,flip_x:this.flip_x,flip_y:this.flip_y,crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetPhotoState=function(t){this.photo=t.photo,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var e=$.Deferred(),r=this.Load();return r.done(function(){e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.SetPhotoState: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SetSharedImageInfo=function(t){"leather"==this.gid&&"leather"==t.gid&&(this.width=t.width,this.height=t.height,this.radian=t.radian,this.photo=t.photo,this.photo_image=t.photo_image,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h,this.is_low=t.is_low)},PM.Core.ImageLayer.prototype.GetSpecialFromDiagram=function(t){if(t.indexOf("_special_")>=0){var e=t.replace(".png","_cut.png");return e}return""},PM.Core.ImageLayer.prototype.Load=function(){var t=$.Deferred(),e=this,r=PM.Util.LoadImage(e.diagram);r.done(function(t){e.diagram_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(diagram): "+e.diagram)}),e.special=this.GetSpecialFromDiagram(e.diagram);var o=PM.Util.LoadImage(e.special);o.done(function(t){e.special_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(special): "+e.special)});var i=PM.Util.LoadImage(e.photo);return i.done(function(t){if(e.flip_x||e.flip_y){var r=0;e.Flip(t,e.flip_x,e.flip_y,r,function(t){e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):e.photo_image=t})}else e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):(e.photo_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0))}),i.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(photo): "+e.photo)}),$.when(r,i).then(function(){(e.crop_w<=0||e.crop_h<=0)&&e.FitPhoto(!1),t.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.Load Failure "),t.reject()}),t.promise()},PM.Core.ImageLayer.prototype.AddDiagram=function(t){var e=$.Deferred(),r=this,o=PM.Util.LoadImage(t);o.done(function(e){r.diagram=t,r.diagram_image=e}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(diagram): "+r.diagram)});var i=this.GetSpecialFromDiagram(t),a=PM.Util.LoadImage(i);return a.done(function(t){r.special=i,r.special_image=t}),a.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(special): "+r.special)}),$.when(o,a).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.AddDiagram Failure "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.DeleteDiagram=function(){this.diagram="",this.diagram_image=null,this.special="",this.special_image=null},PM.Core.ImageLayer.prototype.AddPhoto=function(t,e,r,o,i){if(!i&&this.photo.length>0)return{added:!1,promise:null};var a=$.Deferred(),s=this,n=PM.Util.LoadImage(t);return s.photo=t,n.done(function(t){s.photo_image=t,s.photo_org=e,s.original_w=parseInt(r),s.original_h=parseInt(o),s.photo_angle=0,s.flip_x=!1,s.flip_y=!1,s.FitPhoto(!1),a.resolve(),"leather"==s.gid&&PM.Editor.Framework.SetSharedImageInfo(s)}),n.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddPhoto(photo): "+s.photo),a.reject()}),{added:!0,promise:a.promise()}},PM.Core.ImageLayer.prototype.DeletePhoto=function(){if(!(this.photo.length<=0)){var t=[],e=[],r={type:this.GetType(),value:this.GetPhotoState()};t.push(r),this.DeletePhotoProp();var o={type:this.GetType(),value:this.GetPhotoState()};e.push(o),this.RecordState(PM.RECORD_PHOTO_CHANGE,t,e,"사진 삭제")}},PM.Core.ImageLayer.prototype.DeletePhotoProp=function(){if(this.photo.length<=0)return!1;var t=this.photo;return this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,t.length>0&&"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),!0},PM.Core.ImageLayer.prototype.ValidatePhotoBoundary=function(){this.photo_image&&(this.crop_x<0&&(this.crop_x=0),this.crop_y<0&&(this.crop_y=0),this.crop_x+this.crop_w>this.photo_image.width&&(this.crop_x=this.photo_image.width-this.crop_w),this.crop_y+this.crop_h>this.photo_image.height&&(this.crop_y=this.photo_image.height-this.crop_h))},PM.Core.ImageLayer.prototype.MoveCrop=function(t,e,r,o){if(this.photo_image){var i=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(i,a,t,e),n=this.NonRotatedPoint(i,a,r,o),h=n.x-s.x,l=n.y-s.y;this.crop_x-=h,this.crop_y-=l,this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this)}},PM.Core.ImageLayer.prototype.FitPhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),r=PM.Util.GetScaledRect(this.width,this.height,this.photo_image.width,this.photo_image.height,!1);this.crop_x=r.l,this.crop_y=r.t,this.crop_w=r.w,this.crop_h=r.h,"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var o=this.GetCropInfo();t&&this.RecordState(PM.RECORD_PHOTO_CROP,e,o,"사진 화면맞춤")}},PM.Core.ImageLayer.prototype.ScalePhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),r=this.crop_w*t,o=this.crop_h*t;if(this.crop_w-r>this.photo_image.width||this.crop_h-o>this.photo_image.height){var i=this.crop_x,a=this.crop_y;this.FitPhoto(!1),this.crop_x=i,this.crop_y=a}else this.crop_x+=r/2,this.crop_y+=o/2,this.crop_w-=r,this.crop_h-=o;this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var s=this.GetCropInfo();this.RecordState(PM.RECORD_PHOTO_CROP,e,s,t>0?"사진 확대":"사진 축소")}},PM.Core.ImageLayer.prototype.Resize=function(t,e,r,o,i){var a=this.width,s=this.height;if(PM.Core.Layer.prototype.Resize.call(this,t,e,r,o,i),this.photo_image){var n=this.width-a,h=this.height-s,l=n/a,c=h/s;if(this.crop_w+=this.crop_w*l,this.crop_h+=this.crop_h*c,this.crop_w>this.photo_image.width||this.crop_h>this.photo_image.height){var p=this.crop_x,d=this.crop_y;this.FitPhoto(!1),this.crop_x=p,this.crop_y=d}this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution()}},PM.Core.ImageLayer.prototype.RotatePhoto=function(t){if(this.photo_image&&(90==t||-90==t)){var e=this;this.RotatePhotoRightAngle(this.photo_image,t,function(r){var o=[],i=[],a={type:e.GetType(),value:e.GetPhotoState()};o.push(a),e.photo_image=r,e.photo_angle+=t,e.photo_angle<0&&(e.photo_angle+=360),e.photo_angle>=360&&(e.photo_angle-=360),e.FitPhoto(!1),"leather"==e.gid&&PM.Editor.Framework.SetSharedImageInfo(e);var s={type:e.GetType(),value:e.GetPhotoState()};i.push(s),e.RecordState(PM.RECORD_PHOTO_CHANGE,o,i,"사진 회전")})}},PM.Core.ImageLayer.prototype.RotatePhotoRightAngle=function(t,e,r){var o=$.Deferred();if(!t)return o.resolve();var i=document.createElement("canvas"),a=i.getContext("2d");90==e||-90==e||270==e?(i.width=t.height,i.height=t.width):(i.width=t.width,i.height=t.height),a.translate(i.width/2,i.height/2),a.rotate(e*Math.PI/180),a.translate(-i.width/2,-i.height/2);var s=i.width/2-t.width/2,n=i.height/2-t.height/2;a.drawImage(t,s,n);var h=this,l=PM.Util.CanvasToImage(i),c=PM.Util.LoadImage(l);return c.done(function(t){r(t),o.resolve(),"leather"==h.gid&&PM.Editor.Framework.SetSharedImageInfo(h)}),c.fail(function(){console.log("* Fail:PM.Core.ImageLayer.RotatePhoto: "+e),o.reject()}),o.promise()},PM.Core.ImageLayer.prototype.FlipPhoto=function(t,e){if(this.photo_image){var r=this;this.Flip(this.photo_image,t,e,this.photo_angle,function(o){var i=[],a=[],s={type:r.GetType(),value:r.GetPhotoState()};i.push(s),r.photo_image=o,t&&(r.flip_x=!r.flip_x),e&&(r.flip_y=!r.flip_y),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this);var n={type:r.GetType(),value:r.GetPhotoState()};a.push(n),r.RecordState(PM.RECORD_PHOTO_CHANGE,i,a,"사진 플립")})}},PM.Core.ImageLayer.prototype.Flip=function(t,e,r,o,i){var a=$.Deferred();if(!t)return a.resolve();var s=document.createElement("canvas"),n=s.getContext("2d");if(s.width=t.width,s.height=t.height,90==o||-90==o||270==o){var h=e;e=r,r=h}var l=0,c=0,p=1,d=1;e&&(l=s.width,p=-1),r&&(c=s.height,d=-1),n.translate(l,c),n.scale(p,d),n.drawImage(t,0,0);var u=this,_=PM.Util.CanvasToImage(s),g=PM.Util.LoadImage(_);return g.done(function(t){i(t),a.resolve(),"leather"==u.gid&&PM.Editor.Framework.SetSharedImageInfo(u)}),g.fail(function(){console.log("* Fail:PM.Core.ImageLayer.FlipPhoto"),a.reject()}),a.promise()},PM.Core.ImageLayer.prototype.DrawController=function(t,e,r,o){if(PM.Core.Layer.prototype.DrawController.call(this,t,e,r,o),this.photo_image&&!PM.Editor.Framework.IsShiftState()){this.PrepareDC(t,e,r);var i=1,a=PM.COLOR_DRAGGER_NORMAL_STROKE,s=PM.COLOR_DRAGGER_NORMAL_FILL,n=PM.CONFIG.CROP_RADIUS,h=this.width/2,l=this.height/2;PM.Util.DrawCircle(t,h,l,n,i,a,s),this.ReleaseDC(t)}},PM.Core.ImageLayer.prototype.Draw=function(t,e,r,o){if(this.PrepareDC(t,e,r),t.beginPath(),t.rect(0,0,this.width,this.height),t.clip(),this.diagram_image){var i=document.createElement("canvas"),a=i.getContext("2d");if(i.width=this.width,i.height=this.height,a.drawImage(this.diagram_image,0,0,this.width,this.height),this.photo_image)a.globalCompositeOperation="source-atop",a.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height),this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(i,0,0,this.width,this.height);else if(PM.Editor.Framework.IsPreviewMode())this.special_image&&t.drawImage(this.special_image,0,0,this.width,this.height);else{var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);a.globalCompositeOperation="source-atop",a.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(i,0,0,this.width,this.height)}}else if(this.photo_image)t.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height);else if(!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);t.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}else PM.Util.DrawRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,PM.COLOR_LAYER_FILL)}if(this.is_low&&this.photo_image&&!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_warning_image;s&&t.drawImage(s,this.width-s.width,0,s.width,s.height)}if(this.DrawExtra(t,o),PM.DEBUG&&!PM.Editor.Framework.IsPreviewMode()){t.font="20px Nanum Gothic",t.fillStyle="#5555ff",t.strokeStyle="#ff0000",t.textAlign="center",t.textBaseline="middle";var h="("+this.original_w+"x"+this.original_h+")";t.fillText(h,this.width/2,20,this.width),t.strokeText(h,this.width/2,20,this.width)}this.ReleaseDC(t)},PM.Core.ImageLayer.prototype.GetDrawItemList=function(){return"\n[mask] "+this.diagram+", [photo] "+this.photo},PM.Core.ImageLayer.prototype.HitTestController=function(t,e,r){var o=PM.Core.Layer.prototype.HitTestController.call(this,t,e,r);if(o==PM.HIT.MOVE&&this.photo_image&&!PM.Editor.Framework.IsShiftState()){var i=PM.CONFIG.CROP_RADIUS,a=this.xpos+this.width/2,s=this.ypos+this.height/2,n=this.NonRotatedPoint(a,s,e,r);if(PM.Util.PtInCircle(a,s,i,n.x,n.y))return PM.HIT.MOVE_CROP}return o},PM.Core.ImageLayer.prototype.HitTest=function(t,e,r){return PM.Core.Layer.prototype.HitTest.call(this,t,e,r)?this:null},PM.Core.ImageLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),$layer_effect=t.find("effect");var e=$layer_effect.attr("diagramfilename");e&&e.length>0?this.diagram=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e):(e=$layer_effect.attr("rotateflip"),e&&"roundmask"==e&&(this.diagram=PM.CONFIG.ROUNDMASK_IMAGE))},PM.Core.ImageLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.diagram=t.diagram,this.diagram_image=null,this.photo=t.photo,this.photo_image=null,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var r=this.Load();return r.done(function(){e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.IMAGE,t+='\n        , "diagram": "'+this.diagram+'"',t+='\n        , "photo_org": "'+this.photo_org+'"',t+='\n        , "original_w": '+this.original_w,t+='\n        , "original_h": '+this.original_h,t+='\n        , "photo": "'+this.photo+'"',t+='\n        , "photo_angle": '+this.photo_angle,t+='\n        , "photo_width": '+(this.photo_image?this.photo_image.width:0),t+='\n        , "photo_height": '+(this.photo_image?this.photo_image.height:0),t+='\n        , "flip_x": '+this.flip_x,t+='\n        , "flip_y": '+this.flip_y,t+='\n        , "crop_x": '+this.crop_x,t+='\n        , "crop_y": '+this.crop_y,t+='\n        , "crop_w": '+this.crop_w,t+='\n        , "crop_h": '+this.crop_h,t+="\n        }"},PM.Core.ImageLayer.prototype.IsLowResolution=function(){var t=PM.Editor.Framework.GetProduct().product_size,e=PM.Editor.Framework.GetCurrentPairSize(),r=PM.Util.ProductSize2InchSize(t),o=r.w*PM.CONFIG.PHOTO_MIN_DPI*2*r.h*PM.CONFIG.PHOTO_MIN_DPI,i=this.width*this.height/(e.w*e.h),a=o*i,s=this.photo_image.width*this.photo_image.height,n=this.original_w*this.original_h,h=n/s,l=this.crop_w*this.crop_h*h;return a>l},PM.Core.ImageLayer.prototype.Test=function(t,e,r,o){if(null!=t&&(0!=e||0!=r||0!=o)){var i=this,a=new PM.Lib.SeqManager;(r||o)&&a.Add(function(e){i.Flip(t,r,o,0,function(r){t=r,console.log("flip"),e.deferred.resolve()})}),e&&a.Add(function(r){i.RotatePhotoRightAngle(t,e,function(e){t=e,console.log("rotate"),r.deferred.resolve()})}),a.Run(function(){i.photo_image=t,i.photo_angle=e,i.flip_x=r,i.flip_y=o,i.FitPhoto(!1),console.log("end...")},function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: ")})}},PM.Core.TextLayer=function(){PM.Core.Layer.call(this),this.halign="center",this.valign="middle",this.caption="",this.textdata="",this.fontname="",this.fontsize=14,this.italic=!1,this.bold=!1,this.color="",this.bkcolor="",this.chargap=0,this.linegap=0,this.tbox=new PM.Ctrl.TextBox},PM.Core.TextLayer.prototype=new PM.Core.Layer,PM.Core.TextLayer.prototype.GetType=function(){return PM.TYPE.TEXT},PM.Core.TextLayer.prototype.GetDesc=function(){return"글상자"},PM.Core.TextLayer.prototype.InitTBox=function(t){t.tbox.setfontdefault(t.fontname,t.fontsize,t.color,t.bold,t.italic),t.tbox.setparadefault(t.halign,0,t.linegap),t.tbox.setimemode(!0),t.tbox.setvalign(t.valign,PM.RECORD_OFF),"spine"==t.gid&&(t.tbox.setsingleline(!0),t.tbox.setvalign("middle",PM.RECORD_OFF),t.tbox.setspine(!0)),t.tbox.SetSize(t.width,t.height),t.tbox.SetMinHeight(t.height),t.textdata.length>0&&t.tbox.IsEmptyDoc()&&t.tbox.fromString(t.textdata)},PM.Core.TextLayer.prototype.Load=function(){var t=$.Deferred();return(this.width<=0||this.height<=0)&&(this.width=200,this.height=40),this.InitTBox(this),t.resolve(),t.promise()},PM.Core.TextLayer.prototype.ResizeFromTBoxCallback=function(t,e){if(!this.resizelock&&this.tbox){var r=this.xpos+this.width/2,o=this.ypos+this.height/2;this.height=e>=30?e:30,this.RecalcXY(r,o),this.tbox.SetSize(this.width,this.height)}},PM.Core.TextLayer.prototype.Resize=function(t,e,r,o,i){PM.Core.Layer.prototype.Resize.call(this,t,e,r,o,i),this.tbox.SetSize(this.width,this.height),this.tbox.SetMinHeight(this.height)},PM.Core.TextLayer.prototype.RecalcTBoxSize=function(t){this.tbox&&(this.tbox.edit_w=this.width,this.tbox.updateall(t))},PM.Core.TextLayer.prototype.AdjustSize=function(){this.height<this.tbox.getheight()&&(this.height=this.tbox.getheight(),this.tbox.SetSize(this.width,this.height))},PM.Core.TextLayer.prototype.SelectAll=function(){this.tbox&&this.tbox.selectAll()},PM.Core.TextLayer.prototype.GetEditableTextBox=function(){return this.tbox?this.tbox:null},PM.Core.TextLayer.prototype.IsFocusTextBox=function(){return this.tbox&&this.tbox.isfocus()?!0:!1},PM.Core.TextLayer.prototype.ResetFocus=function(){this.tbox&&(this.textdata=this.tbox.toString(),this.tbox.killfocus())},PM.Core.TextLayer.prototype.Undo=function(t){return this.tbox?this.tbox.undo_action(t):!1},PM.Core.TextLayer.prototype.Redo=function(t){return this.tbox?this.tbox.redo_action(t):!1},PM.Core.TextLayer.prototype.KeyDown=function(t){return this.tbox.KeyDown(t)},PM.Core.TextLayer.prototype.KeyPress=function(t){return this.tbox.KeyPress(t)},PM.Core.TextLayer.prototype.NormalizePoint=function(t,e){t-=this.xpos,e-=this.ypos;var r=this.width/2,o=this.height/2;return this.NonRotatedPoint(r,o,t,e)},PM.Core.TextLayer.prototype.MouseDown=function(t,e,r,o){var i=this.NormalizePoint(r,o);this.tbox.MouseDown(t,e,i.x,i.y)},PM.Core.TextLayer.prototype.MouseMove=function(t,e,r){var o=this.NormalizePoint(e,r);this.tbox.MouseMove(t,o.x,o.y)},PM.Core.TextLayer.prototype.MouseUp=function(t,e,r){var o=this.NormalizePoint(e,r);this.tbox.MouseUp(t,o.x,o.y)},PM.Core.TextLayer.prototype.Draw=function(t,e,r,o){if(!PM.Editor.Framework.IsPreviewMode()||!this.tbox.IsEmptyDoc()){if(this.PrepareDC(t,e,r),t.canvas.id==PM.Core.MAIN_CANVAS_ID)if(this.textdata.length<=0&&!this.tbox.isfocus()){PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null);var i="";i=this.bold?"bold ":"",i+=this.italic?"italic ":"",i+=this.fontsize+"pt ",i+=PM.Util.GetWebFont(this.fontname),t.font=i,t.fillStyle=this.color,t.textAlign="center",t.textBaseline="middle",t.fillText(this.caption,this.width/2,this.height/2,this.width)}else PM.Editor.Framework.IsPreviewMode()||PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null),this.tbox.Draw(t);else this.tbox.Draw(t);this.DrawExtra(t,o),this.ReleaseDC(t)}},PM.Core.TextLayer.prototype.GetDrawItemList=function(){return""},PM.Core.TextLayer.prototype.HitTestController=function(t,e,r){var o=PM.Core.Layer.prototype.HitTestController.call(this,t,e,r);return this.tbox.isfocus()&&(o=o==PM.HIT.MOVE?PM.HIT.EDIT_TEXT:PM.HIT.NONE),o},PM.Core.TextLayer.prototype.HitTest=function(t,e,r){return PM.Core.Layer.prototype.HitTest.call(this,t,e,r)?this:null},PM.Core.TextLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.halign=t.attr("halign"),this.valign=t.attr("valign"),this.caption=t.find("caption").text(),this.textdata=t.find("text").text(),this.textdata.length>0?this.textdata.indexOf(PM.TBOX_COMMENT_DEFAULT)>=0?(this.caption=this.textdata,this.textdata=""):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata=""),$layer_font=t.find("fontinfo");var e=$layer_font.attr("fontname");e=PM.Util.GetWebFont(e),PM.Util.LoadWebFont(e,function(){}),this.fontname=e,this.fontsize=parseInt($layer_font.attr("fontsize")),this.italic="true"===$layer_font.attr("italic"),this.bold="true"===$layer_font.attr("bold"),this.color=PM.Util.String2HexColor($layer_font.attr("color")),this.bkcolor=PM.Util.String2HexColor($layer_font.attr("bkcolor")),this.chargap=parseFloat($layer_font.attr("chargap")),this.linegap=parseFloat($layer_font.attr("linegap")),this.fontsize=Math.floor(6*this.fontsize/8),this.bkcolor="",this.chargap=0,this.linegap=0},PM.Core.TextLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.halign=t.halign,this.valign=t.valign,this.caption=t.caption,this.textdata=t.textdata;var r=PM.Util.GetWebFont(t.fontname);return PM.Util.LoadWebFont(r,function(){console.log("[load-json] webfont loaded... "+r+" "+Date.now())}),this.fontname=r,this.fontsize=t.fontsize,this.italic=t.italic,this.bold=t.bold,this.color=t.color,this.bkcolor=t.bkcolor,this.chargap=t.chargap,this.linegap=t.linegap,this.tbox=new PM.Ctrl.TextBox,this.InitTBox(this),this.tbox.LoadJson(t.tbox_info),e.resolve(),e.promise()},PM.Core.TextLayer.prototype.LoadJsonAtPos=function(t,e,r){var o=JSON.parse(r);this.LoadJson(o),this.xpos=t,this.ypos=e},PM.Core.TextLayer.prototype.SaveJson=function(){this.textdata=this.tbox.toString();var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.TEXT,t+='\n        , "halign": "'+this.halign+'"',t+='\n        , "valign": "'+this.valign+'"',t+='\n        , "caption": "'+this.caption+'"',t+='\n        , "textdata": "'+this.textdata+'"',t+='\n        , "fontname": "'+this.fontname+'"',t+='\n        , "fontsize": '+this.fontsize,t+='\n        , "italic": '+this.italic,t+='\n        , "bold": '+this.bold,t+='\n        , "color": "'+this.color+'"',t+='\n        , "bkcolor": "'+this.bkcolor+'"',t+='\n        , "chargap": '+this.chargap,t+='\n        , "linegap": '+this.linegap,t+='\n        , "tbox_info": \n',t+=this.tbox.SaveJsonEx(),t+="\n        }"},PM.Core.Layout=function(){this.style="normal",this.kind="",this.type="",this.imgcnt=0,this.link="",this.thumb=""},PM.Core.Layout.prototype.copy=function(){var t=new PM.Core.Layout;return t.style=this.style,t.kind=this.kind,t.type=this.type,t.imgcnt=this.imgcnt,t.link=this.link,t.thumb=this.thumb,t},PM.Core.Skin=function(){this.kind="",this.type="",this.link="",this.thumb="",this.storecode=""},PM.Core.Skin.prototype.copy=function(){var t=new PM.Core.Skin;return t.kind=this.kind,t.type=this.type,t.link=this.link,t.thumb=this.thumb,t.storecode=this.storecode,t},PM.Core.Cover=function(){this.back_page=new PM.Core.Page,this.middle_page=new PM.Core.Page,this.front_page=new PM.Core.Page},PM.Core.Cover.prototype.Load=function(){var t=$.Deferred(),e=this.back_page?this.back_page.Load():$.Deferred().resolve(),r=this.middle_page?this.middle_page.Load():$.Deferred().resolve(),o=this.front_page?this.front_page.Load():$.Deferred().resolve();return $.when(e,r,o).then(function(){t.resolve()},function(){t.reject()}),t.promise()},PM.Core.Cover.prototype.GetSpineWidth=function(){if(this.middle_page)for(var t=0;t<this.middle_page.layer_array.length;t++){var e=this.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.height}return 0},PM.Core.Cover.prototype.SetSpineWidth=function(t){if(this.middle_page)for(var e=0;e<this.middle_page.layer_array.length;e++){var r=this.middle_page.layer_array[e];r.GetType()==PM.TYPE.TEXT&&(t>0&&(r.height=t,r.tbox.SetSize(r.width,r.height)),r.xpos=this.middle_page.width/2-r.width/2,r.ypos=this.middle_page.height/2-r.height/2)}},PM.Core.Cover.prototype.LoadJson=function(t){return t.back_page&&void 0!=t.back_page&&this.back_page.LoadJson(t.back_page),t.middle_page&&void 0!=t.middle_page?this.middle_page.LoadJson(t.middle_page):this.middle_page=null,t.front_page&&void 0!=t.front_page?this.front_page.LoadJson(t.front_page):this.front_page=null,!0},PM.Core.Cover.prototype.SaveJson=function(){var t="\n   { ";return this.back_page&&(t+='\n   "back_page": ',t+=this.back_page.SaveJson(),this.middle_page&&(t+='\n,  "middle_page": ',t+=this.middle_page.SaveJson()),this.front_page&&(t+='\n,  "front_page": ',t+=this.front_page.SaveJson())),t+="\n   }"},PM.Core.Cover.prototype.CheckComplete=function(){if(this.back_page){if(!this.back_page.CheckComplete())return!1;if(this.middle_page&&!this.middle_page.CheckComplete())return!1;if(this.front_page&&!this.front_page.CheckComplete())return!1}return!0},PM.Core.Page=function(){this.layout_kind="",this.layout_type="",this.layout_link="",this.layout_style="normal",this.skin_kind="",this.skin_type="",this.skin_link="",this.skin_storecode="",this.is_layer_lock=!1,this.width=0,this.height=0,this.color="",this.layer_array=[],this.skin_image=null,this.work_pos={}},PM.Core.Page.prototype.SetLayoutInfo=function(t){t&&(this.layout_kind=t.kind,this.layout_type=t.type,this.layout_link=t.link,this.layout_style=t.style)},PM.Core.Page.prototype.SetSkinInfo=function(t){t&&(this.skin_kind=t.kind,this.skin_type=t.type,this.skin_link=t.link,this.skin_storecode=t.storecode)},PM.Core.Page.prototype.CopyProperty=function(){var t=new PM.Core.Page;return t.layout_kind=this.layout_kind,t.layout_type=this.layout_type,t.layout_link=this.layout_link,t.layout_style=this.layout_style,t.skin_kind=this.skin_kind,t.skin_type=this.skin_type,t.skin_link=this.skin_link,t.skin_storecode=this.skin_storecode,t.width=this.width,t.height=this.height,t.color=this.color,t.layer_array=[],t.skin_image=this.skin_image,t.work_pos.x=this.work_pos.x,t.work_pos.y=this.work_pos.y,t},PM.Core.Page.prototype.GetDefaultDummyLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h_bg.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"w_bg.xml":PM.URL.LAYOUT_FILE+"s_bg.xml"},PM.Core.Page.prototype.GetDefaultPageLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h01f001.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"W01f001.xml":PM.URL.LAYOUT_FILE+"s_01f097.xml"},PM.Core.Page.prototype.CreateDefaultPage=function(){var t=this.CopyProperty();t.layout_link=this.GetDefaultPageLink(t);
var e=new PM.Core.ImageLayer;return t.layer_array.push(e),e.xpos=0,e.ypos=0,e.width=t.width,e.height=t.height,t},PM.Core.Page.prototype.Load=function(){var t=this,e=$.Deferred(),r=PM.Util.LoadXml(t.layout_link),o=PM.Util.LoadImage(t.skin_link);return r.done(function(e){t.Parse(e)}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(layout_xml): "+t.layout_link)}),o.done(function(e){t.skin_image=e}),o.fail(function(){console.log("* Fail:PM.Core.Page.Load(skin_image): "+t.skin_link)}),$.when(r,o).then(function(){var r=t.LoadLayers(t);r.done(function(){e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(LoadLayers) ")})},function(){console.log("-----------> PM.Core.Page.Load Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.LoadLayers=function(t){for(var e=$.Deferred(),r=[],o=0;o<t.layer_array.length;o++){var i=t.layer_array[o];r.push(i.Load())}return $.when.apply($,r).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadLayers Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.IsLayerLock=function(){return this.is_layer_lock},PM.Core.Page.prototype.SetLayersLockInfo=function(t){this.is_layer_lock=t;for(var e=0;e<this.layer_array.length;e++){var r=this.layer_array[e];r.movelock=t,r.resizelock=t,r.zorderlock=t,r.removelock=t,r.GetType()==PM.TYPE.TEXT&&r.tbox&&(r.resizelock?(r.tbox.setautoresize(!1),r.tbox.SetSize(r.width,r.height),r.tbox.SetMinHeight(r.height)):r.tbox.setautoresize(!0))}},PM.Core.Page.prototype.SetSharedImageInfo=function(t){for(var e=0;e<this.layer_array.length;e++){var r=this.layer_array[e];if(r&&r!=t&&r.GetType()==PM.TYPE.IMAGE&&"leather"==r.gid){r.SetSharedImageInfo(t);break}}},PM.Core.Page.prototype.ChangeColor=function(t){this.color=t,this.skin_link="",this.skin_storecode="",this.skin_image=null;var e=$.Deferred();return e.resolve()},PM.Core.Page.prototype.ChangeSkin=function(t){var e=this,r=$.Deferred(),o=PM.Util.LoadImage(t);return o.done(function(o){e.skin_link=t,e.skin_image=o,r.resolve()}),o.fail(function(){console.log("* Fail:PM.Core.Page.ChangeSkin(skin_image): "+t),r.reject()}),r.promise()},PM.Core.Page.prototype.ChangeLayout=function(t,e,r){var o=this,i=$.Deferred(),a=PM.Util.LoadXml(t);return a.done(function(a){o.layout_link=t;var s=$(a).find("foreground").find("rect");if(null!=s){var n=o.width/o.height,h=parseInt(s.attr("width"))/parseInt(s.attr("height"));if(n-h==0){var l=null==e?o.GetUserImageList():e,c=null==r?o.color:r;o.Parse(a);var p=o.LoadLayers(o);p.done(function(){o.color=c;var t=o.AddPhotos(l,0).promise;t.done(function(){i.resolve()}),t.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers>AddPhotos) ")})}),p.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers) "),i.reject()})}else i.reject()}}),a.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(layout_xml): "+t),i.reject()}),i.promise()},PM.Core.Page.prototype.GetLayerIndex=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e])return e;return-1},PM.Core.Page.prototype.AddLayerOrderly=function(t){var e=0,r=this.layer_array.length;if(t.GetType()==PM.TYPE.IMAGE){for(;r>e&&this.layer_array[e].GetType()==PM.TYPE.IMAGE;)e++;this.layer_array.splice(e,0,t)}else if(t.GetType()==PM.TYPE.ICON){for(;r>e&&(this.layer_array[e].GetType()==PM.TYPE.IMAGE||this.layer_array[e].GetType()==PM.TYPE.ICON);)e++;this.layer_array.splice(e,0,t)}else this.layer_array.push(t)},PM.Core.Page.prototype.AddNewLayer=function(t,e,r,o){var i=this,a=$.Deferred(),s=r.Load();return s.done(function(){i.AddLayerOrderly(r);var s=r.width,n=r.height;!o&&s>i.width/4&&(s=i.width/4,n=s*r.height/r.width),r.width=s,r.height=n,r.xpos=t-i.work_pos.x-r.width/2,r.ypos=e-i.work_pos.y-r.height/2,a.resolve()}),s.fail(function(){console.log("* Fail:PM.Core.Page.AddNewLayer "),a.reject()}),a.promise()},PM.Core.Page.prototype.AddLayerAndLoad=function(t){this.AddLayerOrderly(t),t.Load()},PM.Core.Page.prototype.AddLayer=function(t){this.AddLayerOrderly(t)},PM.Core.Page.prototype.RemoveLayer=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e]){this.layer_array.splice(e,1);break}},PM.Core.Page.prototype.RemoveEmptyLayers=function(){for(var t=[],e=this.layer_array.length-1;e>=0;e--){var r=this.layer_array[e];if(r.GetType()==PM.TYPE.IMAGE&&r.photo.length<=0){var o={page_pos:-1,layer_pos:e,data:r};t.push(o),this.layer_array.splice(e,1)}}return t},PM.Core.Page.prototype.SwapLayer=function(t,e,r){if(0>e||e>=t.length)return-1;if(0>r||r>=t.length)return-1;if(t[e].GetType()!=t[r].GetType())return-1;var o=t[e];return t[e]=t[r],t[r]=o,r},PM.Core.Page.prototype.RotateLayer=function(t,e){return t?t.RotateAngle(e):!1},PM.Core.Page.prototype.UpLayer=function(t){for(var e=-1,r=0;r<this.layer_array.length;r++)if(t==this.layer_array[r]){e=this.SwapLayer(this.layer_array,r,r+1);break}return e},PM.Core.Page.prototype.DownLayer=function(t){for(var e=-1,r=0;r<this.layer_array.length;r++)if(t==this.layer_array[r]){e=this.SwapLayer(this.layer_array,r,r-1);break}return e},PM.Core.Page.prototype.ResetFocus=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];e.GetType()==PM.TYPE.TEXT&&e.ResetFocus()}},PM.Core.Page.prototype.AddPhotos=function(t,e){var r=e,o=[],i=[],a=$.Deferred();if(r>=0&&r<t.length)for(var s=0;s<this.layer_array.length;s++)try{var n=t[r],h=JSON.parse(n),l=this.layer_array[s];if(l&&l.GetType()==PM.TYPE.IMAGE){var c="",p="",d=0,u=0;void 0==h.url_domain?(c=h.edit_link,p=h.org_link,d=h.original_width,u=h.original_height):(c=h.url_domain+h.url_path+h.url_edit,p=h.url_domain+h.url_path+h.url_file,d=h.img_width,u=h.img_height);var _=!1,g=l.AddPhoto(c,p,d,u,_);g.added&&(r++,o.push({page_pos:-1,layer_pos:s,json:n}),i.push(g.promise))}}catch(f){r++,console.error(f)}finally{if(r>=t.length){r=-1;break}}else r=-1;return i.length>0?$.when.apply($,i).then(function(){a.resolve()},function(){a.reject()}):a.resolve(),{next_idx:r,result_photos:o,promise:a.promise()}},PM.Core.Page.prototype.DeletePhotos=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var r=this.layer_array[e];if(r&&r.GetType()==PM.TYPE.IMAGE){var o={page_pos:-1,layer_pos:e,info:r.GetPhotoState()};r.DeletePhotoProp()&&t.push(o)}}return t},PM.Core.Page.prototype.GetUserImageList=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var r=this.layer_array[e];if(r&&r.GetType()==PM.TYPE.IMAGE&&r.photo.length>0&&r.photo_org.length>0){var o="{";o+='"edit_link": "'+r.photo+'"',o+=', "org_link": "'+r.photo_org+'"',o+=', "original_width": '+r.original_w,o+=', "original_height": '+r.original_h,o+="}",t.push(o)}}return t},PM.Core.Page.prototype.GetImageLayerCount=function(){for(var t=0,e=0;e<this.layer_array.length;e++){var r=this.layer_array[e];r&&r.GetType()==PM.TYPE.IMAGE&&t++}return t},PM.Core.Page.prototype.GetWorkRect=function(){var t="layflat"==this.layout_style?2*this.width:this.width;return{l:this.work_pos.x,t:this.work_pos.y,w:t,h:this.height}},PM.Core.Page.prototype.HitTestLayers=function(t,e,r){e-=this.work_pos.x,r-=this.work_pos.y;for(var o=this.layer_array.length-1;o>=0;o--){var i=this.layer_array[o].HitTest(t,e,r);if(i)return i}return null},PM.Core.Page.prototype.DrawBackground=function(t,e,r){if(t.save(),this.color&&this.color.length>0&&(t.fillStyle=this.color,t.fillRect(e,r,this.width,this.height)),null!=this.skin_image){var o=this.width/this.height,i=this.skin_image.width/this.skin_image.height;if(o-i==0)t.drawImage(this.skin_image,e,r,this.width,this.height);else{var a=PM.Util.GetScaledRect(this.width,this.height,this.skin_image.width,this.skin_image.height,!1);t.drawImage(this.skin_image,a.l,a.t,a.w,a.h,e,r,this.width,this.height)}}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.work_pos.x=e,this.work_pos.y=r),t.restore()},PM.Core.Page.prototype.DrawLayers=function(t,e,r,o){t.save();for(var i=0;i<this.layer_array.length;i++){var a=this.layer_array[i];(o==PM.TYPE.UNKNOWN||o==a.GetType())&&a.Draw(t,e,r,i)}t.restore()},PM.Core.Page.prototype.DrawBorder=function(t,e,r){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.strokeStyle=PM.COLOR_PAGE_BORDER,t.strokeRect(e,r,this.width,this.height),t.restore())},PM.Core.Page.prototype.DrawProlog=function(t,e,r){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.font=PM.CONFIG.PROLOG_FONT,t.fillStyle=PM.CONFIG.PROLOG_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(PM.CONFIG.PROLOG_TEXT,e,r),t.restore())},PM.Core.Page.prototype.GetDrawItemList=function(){var t="\n[skin] "+this.skin_link,e=[];e.push(t);for(var r=0;r<this.layer_array.length;r++)e.push(this.layer_array[r].GetDrawItemList());return e},PM.Core.Page.prototype.Parse=function(t){var e=this;e.layer_array=[];var r=$(t).find("foreground").find("rect");if(null==r)return!1;e.width=parseInt(r.attr("width")),e.height=parseInt(r.attr("height"));var o=$(t).find("pagefileargb");if(null==o)return!1;e.color=PM.Util.ToHexColor(o.attr("r"),o.attr("g"),o.attr("b"));var i=$(t).find("layer").find("maskimage");i.find("maskrect").each(function(){var t=new PM.Core.ImageLayer;e.AddLayerOrderly(t),t.type=0,t.Parse($(this))}),$(t).find("iconinfo").each(function(){var t=new PM.Core.IconLayer;e.AddLayerOrderly(t),t.type=1,t.Parse($(this))}),$(t).find("textinfo").each(function(){var t=new PM.Core.TextLayer;e.AddLayerOrderly(t),t.type=2,t.Parse($(this))})},PM.Core.Page.prototype.LoadJson=function(t){var e=$.Deferred(),r=[];this.layout_kind=t.layout_kind,this.layout_type=t.layout_type,this.layout_link=t.layout_link,this.layout_style=t.layout_style,this.skin_kind=t.skin_kind,this.skin_type=t.skin_type,this.skin_link=t.skin_link,this.skin_storecode=t.skin_storecode,this.width=t.width,this.height=t.height,this.color=t.color,this.layer_array=[];for(var o in t.layer_array){var i=null;switch(t.layer_array[o].type){case PM.TYPE.ICON:i=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:i=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:i=new PM.Core.TextLayer}i&&(this.layer_array.push(i),r.push(i.LoadJson(t.layer_array[o])))}var a=this,s=PM.Util.LoadImage(a.skin_link);return s.done(function(t){a.skin_image=t}),s.fail(function(){console.log("* Fail:PM.Core.Page.LoadJson(skin_image): "+a.skin_link)}),r.push(s),$.when.apply($,r).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadJson Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.SaveJson=function(){var t="\n    {";t+='\n    "layout_kind": "'+this.layout_kind+'"',t+='\n    , "layout_type": "'+this.layout_type+'"',t+='\n    , "layout_link": "'+this.layout_link+'"',t+='\n    , "layout_style": "'+this.layout_style+'"',t+='\n    , "skin_kind": "'+this.skin_kind+'"',t+='\n    , "skin_type": "'+this.skin_type+'"',t+='\n    , "skin_link": "'+this.skin_link+'"',t+='\n    , "skin_storecode": "'+this.skin_storecode+'"',t+='\n    , "width": '+this.width,t+='\n    , "height": '+this.height,t+='\n    , "color": "'+this.color+'"',t+='\n    , "layer_array": [';for(var e=0;e<this.layer_array.length;e++)t+=this.layer_array[e].SaveJson(),e<this.layer_array.length-1&&(t+="\n    ,");return t+="\n    ]",t+="\n    }"},PM.Core.Page.prototype.CheckComplete=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];if(e&&e.GetType()==PM.TYPE.IMAGE&&e.photo.length<=0)return!1}return!0},PM.Core.ProductBase=function(){this.base_type=PM.PRODUCT.UNKNOWN,this.user_id="",this.session_id="",this.add_param="",this.price=0,this.basket_name="",this.order_code="",this.product_code="",this.product_key="",this.product_name="",this.cover=null,this.prolog=null,this.page_array=[],this.epilog=null,this.is_complete=!1,this.dragger=null,this.work_pos={x:0,y:0},this.clipboard_memory="",this.keep_photos=null,this.move_state=null},PM.Core.ProductBase.prototype.GetType=function(){return this.base_type},PM.Core.ProductBase.prototype.PreProcess=function(){console.assert(!1,"PreProcess")},PM.Core.ProductBase.prototype.Load=function(){console.assert(!1,"Load")},PM.Core.ProductBase.prototype.AddPhotosPerPage=function(t){var e=[];if(this.cover&&this.cover.back_page&&!PM.Editor.Framework.IsHoleLeatherCoverProduct()){var r=0,o=this.cover.back_page.AddPhotos(t[0],r);if(e.push(o.promise),this.cover.middle_page){var r=0,o=this.cover.middle_page.AddPhotos(t[1],r);e.push(o.promise)}if(this.cover.front_page){var r=0,o=this.cover.front_page.AddPhotos(t[2],r);e.push(o.promise)}}if(this.prolog,this.page_array.length>0)for(var i=3,a=0;a<this.page_array.length;a++){var r=0,o=this.page_array[a].AddPhotos(t[i++],r);if(e.push(o.promise),i>=t.length)break}this.epilog;var s=this;$.when.apply($,e).then(function(){s.AddPhotosComplete(),s.keep_photos=null},function(){s.AddPhotosFailure()})},PM.Core.ProductBase.prototype.ConcatArrayAndAddInfo=function(t,e,r){if(e.length<=0)return t;for(var o=0;o<e.length;o++)e[o].page_pos=r;return t.concat(e)},PM.Core.ProductBase.prototype.AddPhotos=function(t){var e=0,r=[],o=[];if(this.cover&&this.cover.back_page&&!PM.Editor.Framework.IsHoleLeatherCoverProduct()){var i=this.cover.back_page.AddPhotos(t,e);if(e=i.next_idx,o.push(i.promise),r=this.ConcatArrayAndAddInfo(r,i.result_photos,PM.PAGE.COVER_BACK),e>=0&&this.cover.middle_page){var i=this.cover.middle_page.AddPhotos(t,e);e=i.next_idx,o.push(i.promise),r=this.ConcatArrayAndAddInfo(r,i.result_photos,PM.PAGE.COVER_MIDDLE)}if(e>=0&&this.cover.front_page){var i=this.cover.front_page.AddPhotos(t,e);e=i.next_idx,o.push(i.promise),r=this.ConcatArrayAndAddInfo(r,i.result_photos,PM.PAGE.COVER_FRONT)}}if(e>=0&&this.prolog){var i=this.prolog.AddPhotos(t,e);e=i.next_idx,o.push(i.promise),r=this.ConcatArrayAndAddInfo(r,i.result_photos,PM.PAGE.PROLOG)}if(e>=0&&this.page_array.length>0)for(var a=0;a<this.page_array.length;a++){var i=this.page_array[a].AddPhotos(t,e);if(e=i.next_idx,o.push(i.promise),r=this.ConcatArrayAndAddInfo(r,i.result_photos,a),0>e)break}if(e>=0&&this.epilog,r.length>0){var s=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_ADDALL,s,null,{page_pos:-1,layer_pos:-1,data:r},"일괄사진넣기")}var n=this;$.when.apply($,o).then(function(){n.AddPhotosComplete(),n.keep_photos=null},function(){n.AddPhotosFailure()})},PM.Core.ProductBase.prototype.AddPhotosComplete=function(){console.log("AddPhotos Complete................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},PM.Core.ProductBase.prototype.AddPhotosFailure=function(){console.log("AddPhotos Failure.................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(-1,"failure")},PM.Core.ProductBase.prototype.DeletePhotos=function(){var t=[];if(this.cover&&this.cover.back_page){var e=this.cover.back_page.DeletePhotos();if(t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_BACK),this.cover.middle_page){var e=this.cover.middle_page.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_MIDDLE)}if(this.cover.front_page){var e=this.cover.front_page.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_FRONT)}}if(this.prolog){var e=this.prolog.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.PROLOG)}if(this.page_array.length>0)for(var r=0;r<this.page_array.length;r++){var e=this.page_array[r].DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,r)}if(this.epilog,t.length>0){var o=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_DELALL,o,{page_pos:-1,layer_pos:-1,data:t},null,"일괄사진제거")}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Core.ProductBase.prototype.GetUserImageList=function(){var t=[];if(this.cover){var e=this.cover.back_page?this.cover.back_page.GetUserImageList():[],r=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],o=this.cover.front_page?this.cover.front_page.GetUserImageList():[];t=t.concat(e,r,o)}this.prolog;for(var i=0;i<this.page_array.length;i++)t=t.concat(this.page_array[i].GetUserImageList());return t},PM.Core.ProductBase.prototype.GetUserImageListPerPage=function(){var t=[];this.cover&&(t[0]=this.cover.back_page?this.cover.back_page.GetUserImageList():[],t[1]=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],t[2]=this.cover.front_page?this.cover.front_page.GetUserImageList():[]),this.prolog;for(var e=3,r=0;r<this.page_array.length;r++)t[e++]=this.page_array[r].GetUserImageList();return t},PM.Core.ProductBase.prototype.DeleteEmptyLayers=function(t){var e=[],r=[];if(t>=0){var o=this.Pair2PageIndex(t);if(o>PM.PAGE.ERROR)switch(o){case PM.PAGE.COVER:this.cover&&this.cover.back_page&&(PM.Editor.Framework.IsHoleLeatherCoverProduct()||(r=this.cover.back_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_BACK),this.cover.middle_page&&(r=this.cover.middle_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_MIDDLE)),this.cover.front_page&&(r=this.cover.front_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_FRONT))));break;case PM.PAGE.PROLOG:r=this.page_array[0].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,0);break;default:r=this.page_array[o].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,o),r=this.page_array[o+1].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,o+1)}}else{this.cover&&this.cover.back_page&&(PM.Editor.Framework.IsHoleLeatherCoverProduct()||(r=this.cover.back_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_BACK),this.cover.middle_page&&(r=this.cover.middle_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_MIDDLE)),this.cover.front_page&&(r=this.cover.front_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,PM.PAGE.COVER_FRONT))));for(var i=0;i<this.page_array.length;i++)r=this.page_array[i].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,r,i)}e.length>0&&(t=PM.Editor.Framework.GetPairNumber(),PM.Editor.Framework.RecordOperation(PM.RECORD_EMPTYLAYERS_DELETE,t,{page_pos:-1,layer_pos:-1,data:e},null,"빈레이어 삭제("+e.length+")"),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success"))},PM.Core.ProductBase.prototype.DeleteLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),r=this.GetPageIndex(t),o=t.GetLayerIndex(e),i=[],a=[],s=PM.RECORD_LAYER_DELETE,n={type:e.GetType(),value:$.extend(!0,{},e)};if(i.push(n),this.dragger.DeleteLayer()){var h=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(s,h,{page_pos:r,layer_pos:o,data:i},{page_pos:r,layer_pos:o,data:a},e.GetDesc()+" 삭제")}},PM.Core.ProductBase.prototype.RotateLayer=function(t){var e=this.dragger.GetSelectedPage(),r=this.dragger.GetSelectedLayer(),o=this.GetPageIndex(e),i=e.GetLayerIndex(r),a=r.GetMoveInfo();if(this.dragger.RotateLayer(t)){PM.Editor.Framework.CheckBoundary();var s=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,s,{page_pos:o,layer_pos:i,data:a},{page_pos:o,layer_pos:i,data:r.GetMoveInfo()},"레이어 90도 단위 회전"),!0}return!1},PM.Core.ProductBase.prototype.UpLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),r=this.GetPageIndex(t),o=t.GetLayerIndex(e),i=this.dragger.UpLayer();if(i>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:r,layer_pos:o,data:null},{page_pos:r,layer_pos:i,data:null},"레이어 앞으로 이동"),!0}return!1},PM.Core.ProductBase.prototype.DownLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),r=this.GetPageIndex(t),o=t.GetLayerIndex(e),i=this.dragger.DownLayer();if(i>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:r,layer_pos:o,data:null},{page_pos:r,layer_pos:i,data:null},"레이어 뒤로 이동"),!0}return!1},PM.Core.ProductBase.prototype.Copy=function(){var t=this.dragger.GetSelectedLayer();return t?"spine"==t.gid?(PM.Editor.Framework.ShowMessageBar("복사할 수 없습니다."),!1):(this.clipboard_memory=t.SaveJson(),this.clipboard_memory.length>0):!1},PM.Core.ProductBase.prototype.Cut=function(){var t=this.dragger.GetSelectedLayer();return t?(this.clipboard_memory=t.SaveJson(),this.DeleteLayer(),this.clipboard_memory.length>0):!1},PM.Core.ProductBase.prototype.Paste=function(t){if(this.clipboard_memory.length<=0)return!1;var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return!1;var r=this.dragger.GetSelectedPage();if(!r||r==this.prolog||this.cover&&r==this.cover.middle_page)switch(e){case PM.PAGE.COVER:r=this.cover.back_page;break;case PM.PAGE.PROLOG:r=this.page_array[0];break;default:r=this.page_array[e]}if(r&&!r.IsLayerLock()){var o=null,i=JSON.parse(this.clipboard_memory);switch(i.type){case PM.TYPE.ICON:o=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:o=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:o=new PM.Core.TextLayer}if(o){o.LoadJson(i),o.movelock=o.resizelock=o.zorderlock=o.removelock=!1;var a=r.work_pos.x+o.xpos+o.width/2+20,s=r.work_pos.y+o.ypos+o.height/2+20,n=this,h=r.AddNewLayer(a,s,o,!0);return h.done(function(){n.SetSelectLayer(r,o),PM.Editor.Framework.CheckBoundary();var e=[],i=[],a=n.GetPageIndex(r),s=r.GetLayerIndex(o),h={type:o.GetType(),value:$.extend(!0,{},o)};i.push(h),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_INSERT,t,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:i},o.GetDesc()+" 붙여넣기")}),!0}}return!1},PM.Core.ProductBase.prototype.MakeMoveLayerCallback=function(t){var e=this.dragger.GetSelectedLayer(),r=this.dragger.GetSelectedLayerRect();return null!=r&&(r=PM.Util.L2PRect(r,t)),{layer:e,rect:r}},PM.Core.ProductBase.prototype.ResizeFromTBoxCallbackProcess=function(t){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)},PM.Core.ProductBase.prototype.MovedCallbackProcess=function(t){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)}},PM.Core.ProductBase.prototype.CheckComplete=function(){if(this.is_complete=!1,this.cover&&!this.cover.CheckComplete())return!1;for(var t=0;t<this.page_array.length;t++)if(!this.page_array[t].CheckComplete())return!1;return this.is_complete=!0,!0},PM.Core.ProductBase.prototype.GetTotalPageCount=function(){return this.ExtraCount()+this.page_array.length},PM.Core.ProductBase.prototype.GetInnerPageCount=function(){return this.page_array.length},PM.Core.ProductBase.prototype.PairCount=function(){var t=this.GetTotalPageCount();return Math.ceil(t/2)},PM.Core.ProductBase.prototype.ExtraCount=function(){var t=0;return null!=this.cover&&(t+=2),null!=this.prolog&&(t+=1),null!=this.epilog&&(t+=1),t},PM.Core.ProductBase.prototype.GetPageIndex=function(t){if(t){for(var e=0;e<this.page_array.length;e++){var r=this.page_array[e];if(r==t)return e}if(t==this.cover.back_page)return PM.PAGE.COVER_BACK;if(t==this.cover.middle_page)return PM.PAGE.COVER_MIDDLE;if(t==this.cover.front_page)return PM.PAGE.COVER_FRONT;if(t==this.prolog)return PM.PAGE.PROLOG;if(t==this.epilog)return PM.PAGE.EPILOG}return PM.PAGE.ERROR},PM.Core.ProductBase.prototype.Pair2PageIndex=function(t){if(0>t||t>=this.PairCount())return PM.PAGE.ERROR;var e=PM.PAGE.ERROR;return this.cover&&(e=0==t?PM.PAGE.COVER:this.prolog?1==t?PM.PAGE.PROLOG:2*t-3:2*t-2),e},PM.Core.ProductBase.prototype.GetSelectedLayer=function(){return this.dragger.GetSelectedLayer()},PM.Core.ProductBase.prototype.GetSelectedPage=function(){return this.dragger.GetSelectedPage()},PM.Core.ProductBase.prototype.GetSelectedPageIndex=function(){var t=this.dragger.GetSelectedPage();return t?this.GetPageIndex(t):PM.PAGE.ERROR},PM.Core.ProductBase.prototype.ClearSelect=function(){this.dragger.SetSelect(null,null,-1,-1)},PM.Core.ProductBase.prototype.SetSelectLayer=function(t,e){if(e){var r=PM.Editor.Framework.GetPairNumber();this.ResetFocus(r),this.dragger.SetSelect(t,e,-1,-1),this.dragger.drag_mode=PM.HIT.NONE}else this.ClearSelect()},PM.Core.ProductBase.prototype.ResetFocus=function(t){var e=this.Pair2PageIndex(t);if(!(e<=PM.PAGE.ERROR))switch(e){case PM.PAGE.COVER:this.cover.back_page&&this.cover.back_page.ResetFocus(),this.cover.middle_page&&this.cover.middle_page.ResetFocus(),this.cover.front_page&&this.cover.front_page.ResetFocus();break;case PM.PAGE.PROLOG:this.prolog.ResetFocus(),this.page_array[0].ResetFocus();break;default:this.page_array[e].ResetFocus(),this.page_array[e+1].ResetFocus()}},PM.Core.ProductBase.prototype.GetPairSize=function(){console.assert(!1,"GetPairSize")},PM.Core.ProductBase.prototype.GetPairText=function(){console.assert(!1,"GetPairText")},PM.Core.ProductBase.prototype.GetWorkRect=function(){console.assert(!1,"GetWorkRect")},PM.Core.ProductBase.prototype.GetFitScaleFactor=function(){console.assert(!1,"GetFitScaleFactor")},PM.Core.ProductBase.prototype.KeyDown=function(t){return this.dragger.KeyDown(t)},PM.Core.ProductBase.prototype.KeyPress=function(t){return this.dragger.KeyPress(t)},PM.Core.ProductBase.prototype.ContextMenu=function(t,e,r,o,i,a){var s=PM.Util.L2PPoint({x:o,y:i},a);PM.Editor.Framework.contextMenuCallback&&PM.Editor.Framework.contextMenuCallback(s.x,s.y)},PM.Core.ProductBase.prototype.Point2Page=function(t,e,r){var o=this.Pair2PageIndex(t);if(o<=PM.PAGE.ERROR)return null;var i=null;switch(o){case PM.PAGE.COVER:this.cover&&(this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),e,r)?i=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),e,r)?i=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),e,r)&&(i=this.cover.front_page));break;case PM.PAGE.PROLOG:this.prolog&&this.page_array[0]&&(PM.Util.PtInRect(this.prolog.GetWorkRect(),e,r)?i=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),e,r)&&(i=this.page_array[0]));break;default:this.page_array[o]&&this.page_array[o+1]&&(PM.Util.PtInRect(this.page_array[o].GetWorkRect(),e,r)?i=this.page_array[o]:PM.Util.PtInRect(this.page_array[o+1].GetWorkRect(),e,r)&&(i=this.page_array[o+1]))}return i},PM.Core.ProductBase.prototype.DblClick=function(t,e,r,o,i){this.Select(t,e,r,o,i),this.dragger.DblClick(t,e,o,i),this.Up(t,e,r,o,i)},PM.Core.ProductBase.prototype.Select=function(t,e,r,o,i,a){this.move_state=null;var s=this.dragger.HitTest(e,o,i);if(s==PM.HIT.NONE){var n=this.HitTest(e,r,o,i);this.dragger.SetSelect(n.page,n.layer,o,i),n.page||n.layer||this.ClearSelect()}else this.dragger.Down(t,e,o,i);var h=this.dragger.GetSelectedPage(),l=this.dragger.GetSelectedLayer(),c=this.dragger.GetSelectedLayerRect();if(null!=l){if(l.GetType()==PM.TYPE.TEXT){var p=l.GetEditableTextBox();p&&p.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)}this.dragger.IsMove()||this.dragger.IsRotate()||this.dragger.IsResize()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetMoveInfo()}:this.dragger.IsMoveCrop()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetCropInfo()}:this.dragger.IsEditText()}null!=c&&(c=PM.Util.L2PRect(c,a)),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(l,c)},PM.Core.ProductBase.prototype.Move=function(t,e,r,o,i,a){var s=PM.HIT.NONE,n=!0;if(this.dragger.IsMove()){var h=this.HitTest(e,r,o,i),l=h.page?h.page:this.dragger.GetSelectedPage(),c=h.layer?h.layer:this.dragger.GetSelectedLayer();if(l&&c){var p=l.GetWorkRect(),d=c.GetCenterPos(),u=this.Point2Page(r,p.l+d.x,p.t+d.y);u==this.prolog&&(u=null),this.dragger.Move(t,u,o,i),s=PM.HIT.MOVE}}else if(this.dragger.IsResize()){var l=this.dragger.GetSelectedPage(),c=this.dragger.GetSelectedLayer();if(l&&c){var p=l.GetWorkRect(),d=c.GetCenterPos(),u=this.Point2Page(r,p.l+d.x,p.t+d.y);u==this.prolog&&(u=null),u&&(l=u)}s=this.dragger.Resize(l,o,i)}else if(this.dragger.IsRotate())s=this.dragger.Rotate(o,i);else if(this.dragger.IsMoveCrop())s=this.dragger.MoveCrop(o,i);else if(this.dragger.IsEditText())s=this.dragger.EditText(t,o,i);else{if(this.dragger.IsSelect()&&(s=this.dragger.HitTest(e,o,i)),s==PM.HIT.NONE){var h=this.HitTest(e,r,o,i);s=h.layer?PM.HIT.MOVE:PM.HIT.NONE}n=!1}return this.MovedCallbackProcess(a),{hit_type:s,modified:n}},PM.Core.ProductBase.prototype.Up=function(t,e,r,o,i,a){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){if(PM.Editor.Framework.CheckBoundary(),null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);if(n.GetType()==PM.TYPE.TEXT&&this.dragger.IsResize()&&(n.ResizeFromTBoxCallback(n.width,n.tbox.edit_h),PM.Editor.Framework.CheckBoundary()),this.move_state.page_pos!=h||this.move_state.layer_pos!=l||!n.IsEqualMoveInfo(this.move_state.move_info)){var c="?";this.dragger.IsMove()?c=" 위치 변경":this.dragger.IsResize()?c=" 크기 변경":this.dragger.IsRotate()&&(c=" 회전"),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,r,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetMoveInfo()},n.GetDesc()+c)}}}else if(this.dragger.IsMoveCrop()){if(null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);this.move_state.page_pos==h&&this.move_state.layer_pos==l&&n.IsEqualCropInfo(this.move_state.move_info)||PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_CROP,r,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetCropInfo()},"사진 크롭")}}else this.dragger.IsEditText();this.MovedCallbackProcess(a),this.dragger.Up(t,o,i),this.move_state=null},PM.Core.ProductBase.prototype.HitTest=function(t,e,r,o){var i=this.Pair2PageIndex(e);if(i<=PM.PAGE.ERROR)return{page:null,layer:null};var a=null,s=null;switch(i){case PM.PAGE.COVER:if(this.cover){if(this.cover.back_page&&(s=this.cover.back_page.HitTestLayers(t,r,o),a=s?this.cover.back_page:null,s))break;if(this.cover.middle_page&&(s=this.cover.middle_page.HitTestLayers(t,r,o),a=s?this.cover.middle_page:null,s))break;if(this.cover.front_page&&(s=this.cover.front_page.HitTestLayers(t,r,o),a=s?this.cover.front_page:null,s))break;this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),r,o)?a=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),r,o)?a=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),r,o)&&(a=this.cover.front_page)}break;case PM.PAGE.PROLOG:if(this.prolog&&this.page_array[0]){if(s=this.prolog.HitTestLayers(t,r,o),a=s?this.prolog:null,s)break;if(s=this.page_array[0].HitTestLayers(t,r,o),a=s?this.page_array[0]:null,s)break;PM.Util.PtInRect(this.prolog.GetWorkRect(),r,o)?a=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),r,o)&&(a=this.page_array[0])}break;default:if(this.page_array[i]&&this.page_array[i+1]){if(s=this.page_array[i].HitTestLayers(t,r,o),a=s?this.page_array[i]:null,s)break;if(s=this.page_array[i+1].HitTestLayers(t,r,o),a=s?this.page_array[i+1]:null,s)break;PM.Util.PtInRect(this.page_array[i].GetWorkRect(),r,o)?a=this.page_array[i]:PM.Util.PtInRect(this.page_array[i+1].GetWorkRect(),r,o)&&(a=this.page_array[i+1])}}return{page:a,layer:s}},PM.Core.ProductBase.prototype.CheckBoundary=function(){console.assert(!1,"CheckBoundary")},PM.Core.ProductBase.prototype.DragOver=function(){console.assert(!1,"DragOver")},PM.Core.ProductBase.prototype.Drop=function(){console.assert(!1,"Drop")},PM.Core.ProductBase.prototype.DropDefault=function(){console.assert(!1,"DropDefault")},PM.Core.ProductBase.prototype.MakePreviewImages=function(){console.assert(!1,"MakePreviewImages")},PM.Core.ProductBase.prototype.ChangeAll=function(t,e,r){var o=[],i=[],a=[];switch(e){case"color":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];
n&&(o.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeColor(r)))}break;case"skin":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n){var h=JSON.parse(r);h.kind==n.skin_kind&&h.type==n.skin_type&&(o.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeSkin(PM.URL.SKIN_FILE+h.link)))}}break;case"layout":var h=JSON.parse(r);if("page"==h.type)for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n&&!n.IsLayerLock()&&h.kind==n.layout_kind&&h.type==n.layout_type){var l=n.SaveJson();o.push(l),a.push(n.ChangeLayout(PM.URL.LAYOUT_FILE+h.link,null,null))}}}if(o.length<=0)return void PM.Editor.Framework.ShowMessageBar("실행할 수 없습니다.");this.ClearSelect();var c=this;return $.when.apply($,a).then(function(){var r=PM.RECORD_UNKNOWN,a="";switch(e){case"color":r=PM.RECORD_PAGE_BKCOLOR,a="배경색 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];n&&i.push({skin_link:n.skin_link,color:n.color})}break;case"skin":r=PM.RECORD_PAGE_BKIMAGE,a="배경스킨 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];n&&i.push({skin_link:n.skin_link,color:n.color})}break;case"layout":r=PM.RECORD_PAGE_LAYOUT,a="레이아웃 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];if(n){n.layout_style="normal";var h=n.SaveJson();i.push(h)}}}PM.Editor.Framework.RecordOperation(r,t,{page_pos:0,layer_pos:-1,data:o},{page_pos:0,layer_pos:-1,data:i},a),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all",e)},function(){PM.Editor.Framework.ShowMessageBar(desc+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")}),a.length>0},PM.Core.ProductBase.prototype.DrawPair=function(){console.assert(!1,"DrawPair")},PM.Core.ProductBase.prototype.LoadJson=function(){console.assert(!1,"LoadJson")},PM.Core.ProductBase.prototype.SaveJson=function(){console.assert(!1,"SaveJson")},PM.Core.ProductPhotobook=function(){PM.Core.ProductBase.call(this),this.product_size="",this.product_type="",this.cover_type="",this.surface_type="",this.price_page=0,this.min_page=0,this.max_page=0,this.theme_depth1="",this.theme_depth2="",this.theme_name="",this.style_id="",this.cover_layout_id="",this.cover_skin_id="",this.page_layout_id="",this.page_skin_id="",this.base_type=PM.PRODUCT.PHOTOBOOK,this.dragger=new PM.Ctrl.Dragger},PM.Core.ProductPhotobook.prototype=new PM.Core.ProductBase,PM.Core.ProductPhotobook.prototype.PreProcess=function(t){var e=t.cover?t.cover.back_page:null,r=t.page_array[0];"leather"==t.cover_type?"design"==t.product_type?(e.SetLayersLockInfo(!0),r.SetLayersLockInfo(!0)):"layflat"==t.product_type&&e.SetLayersLockInfo(!0):"napura"==t.cover_type&&e.SetLayersLockInfo(!0)},PM.Core.ProductPhotobook.prototype.IsHoleLeatherCoverProduct=function(){return"design"==this.product_type&&"leather"==this.cover_type},PM.Core.ProductPhotobook.prototype.SetSharedImageInfo=function(t){this.IsHoleLeatherCoverProduct()&&(this.cover&&this.cover.back_page&&this.cover.back_page.SetSharedImageInfo(t),this.page_array[0]&&this.page_array[0].SetSharedImageInfo(t))},PM.Core.ProductPhotobook.prototype.Load=function(t){PM.Editor.Framework.Ready(PM.CONFIG.BOOT_LOADING);var e=PM.URL.EDIT_INFO+"depth1="+this.theme_depth1+"&depth2="+this.theme_depth2+"&productOption1="+this.product_key+"&addParam="+this.add_param;this.product_size=this.product_size.toLowerCase(),this.product_type=this.product_type.toLowerCase(),this.cover_type=this.cover_type.toLowerCase(),this.surface_type=this.surface_type.toLowerCase(),this.keep_photos=t;var r=this,o=PM.Util.LoadXml(e);o.done(function(t){r.Parse(t),r.LoadPages(r)}),o.fail(function(t,r){alert("* Fail PM.Core.ProductPhotobook.Load: "+r+":"+e)})},PM.Core.ProductPhotobook.prototype.LoadPages=function(t){var e=[];t.cover&&e.push(t.cover.Load()),t.prolog&&e.push(t.prolog.Load());for(var r=0;r<t.page_array.length;r++)e.push(t.page_array[r].Load());$.when.apply($,e).then(function(){t.PreProcess(t),t.LoadComplete(),null!=t.keep_photos&&t.AddPhotosPerPage(t.keep_photos),"layflat"!=t.product_type||"no"!=t.surface_type&&"n"!=t.surface_type||t.ResetSpine();for(var e="#ffffff",r=0;r<t.page_array.length;r++){var o=t.page_array[r];o.skin_link.length<=0&&o.color.length<=0&&(o.color=e),e=o.color}},function(){t.LoadFailure()})},PM.Core.ProductPhotobook.prototype.LoadComplete=function(){console.log("Load Complete................................................."),console.log(navigator.userAgent),this.cover&&(this.dragger.middle_page=this.cover.middle_page),this.page_array.length>=this.min_page?(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_SUCCESS),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(0,"success")):(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-2,"insufficient pages"))},PM.Core.ProductPhotobook.prototype.LoadFailure=function(){console.log("Load Failure.................................................."),PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"load failed")},PM.Core.ProductPhotobook.prototype.IsAvailableSpine=function(){return this.cover&&this.cover.middle_page},PM.Core.ProductPhotobook.prototype.IsEmptySpine=function(){if(this.cover&&this.cover.middle_page)for(var t=0;t<this.cover.middle_page.layer_array.length;t++){var e=this.cover.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.tbox.IsEmptyDoc()}return!1},PM.Core.ProductPhotobook.prototype.ResetSpine=function(){if(this.cover&&this.cover.middle_page){var t=PM.Codi.GetGuideInfo(0,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount());if(void 0!=t.middle_w&&t.middle_w>0){var e=this.cover.middle_page.width,r=t.middle_w;e!=r&&(PM.Editor.Framework.ShowMessageBar("커버의 책등(세네카) 크기가 변경되었습니다. 커버의 편집 내용을 다시 확인해 주십시오."),this.cover.middle_page.width=r,this.SetSpineWidth(t.spine_w))}}},PM.Core.ProductPhotobook.prototype.GetSpineWidth=function(){return this.cover?this.cover.GetSpineWidth():0},PM.Core.ProductPhotobook.prototype.SetSpineWidth=function(t){this.cover&&this.cover.SetSpineWidth(t)},PM.Core.ProductPhotobook.prototype.GetPoolInfo=function(){return{cover_layout_id:this.cover_layout_id,cover_skin_id:this.cover_skin_id,page_layout_id:this.page_layout_id,page_skin_id:this.page_skin_id}},PM.Core.ProductPhotobook.prototype.SwapPages=function(t,e){var r=this.PairCount();if(t>=r||e>=r)return!1;var o=this.Pair2PageIndex(t),i=this.Pair2PageIndex(e);if(0>o||0>i)return!1;var a=this.page_array[o],s=this.page_array[o+1];return this.page_array[o]=this.page_array[i],this.page_array[o+1]=this.page_array[i+1],this.page_array[i]=a,this.page_array[i+1]=s,!0},PM.Core.ProductPhotobook.prototype.ReorderPages=function(t,e){if(!e||e.length<=0)return!1;if(this.PairCount()!=e.length)return!1;var r=[],o=[],i=0;null!=this.cover&&i++,null!=this.prolog&&(i++,r.push(this.page_array[0]),o.push(0));for(var a=i;a<e.length;a++){var s=this.Pair2PageIndex(e[a]);r.push(this.page_array[s]),r.push(this.page_array[s+1]),o.push(s),o.push(s+1)}return this.page_array=r,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success"),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_REORDER,t,null,{page_pos:-1,layer_pos:-1,data:o},"페이지 순서 변경"),!0},PM.Core.ProductPhotobook.prototype.AddPages=function(t,e){var r=this.GetInnerPageCount();if(r>=this.max_page)return PM.ADDPAGE_LIMIT_ERROR;r+2*e>this.max_page&&(e=(this.max_page-r)/2);var o=!1;0>t&&(o=!0,t=this.PairCount()-1);for(var i=this.Pair2PageIndex(t);0>i;){if(t++,t>=this.PairCount())return PM.ADDPAGE_FAIL;i=this.Pair2PageIndex(t)}for(var a=this.page_array[i].CreateDefaultPage(),s=this.page_array[i+1].CreateDefaultPage(),n=o?i+2:i,h=[],l=0;e>l;l++)h.splice(0,0,a,s),a=a.CreateDefaultPage(),s=s.CreateDefaultPage();if(h.length>0){for(var l=0;l<h.length;l++)this.page_array.splice(n,0,h[l]);this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_INSERT,t,null,{page_pos:n,layer_pos:-1,data:h},"페이지 추가")}return t},PM.Core.ProductPhotobook.prototype.DeletePages=function(t,e){var r=this.GetInnerPageCount();if(r<=this.min_page)return PM.DELPAGE_LIMIT_ERROR;r-2*e<this.min_page&&(e=(r-this.min_page)/2);var o=!1;0>t&&(o=!0,t=this.PairCount()-e);var i=this.Pair2PageIndex(t);if(0>i)return PM.DELPAGE_FAIL;var a=this.page_array.slice(i,i+2*e);return this.page_array.splice(i,2*e),this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_DELETE,t,{page_pos:i,layer_pos:-1,data:a},null,"페이지 삭제"),PM.DELPAGE_SUCCESS},PM.Core.ProductPhotobook.prototype.GetPairSize=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return{w:0,h:0};switch(e){case PM.PAGE.COVER:return this.GetCoverSize();case PM.PAGE.PROLOG:return this.GetPagesSize(PM.PAGE.PROLOG,0);default:return this.GetPagesSize(e,e+1)}return{w:0,h:0}},PM.Core.ProductPhotobook.prototype.GetCoverSize=function(){var t=0;return this.cover.back_page&&(t+=this.cover.back_page.width),this.cover.middle_page&&(t+=this.cover.middle_page.width),this.cover.front_page&&(t+=this.cover.front_page.width),{w:t,h:this.cover.back_page.height}},PM.Core.ProductPhotobook.prototype.GetPages=function(t,e){return{lpage:t==PM.PAGE.PROLOG?this.prolog:this.page_array[t],rpage:e==PM.PAGE.EPILOG?this.epilog:this.page_array[e]}},PM.Core.ProductPhotobook.prototype.GetPagesSize=function(t,e){var r=this.GetPages(t,e);return{w:r.lpage.width+r.rpage.width,h:r.lpage.height}},PM.Core.ProductPhotobook.prototype.GetPairText=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return"";switch(e){case PM.PAGE.COVER:return"cover";case PM.PAGE.PROLOG:return"1p";case PM.PAGE.EPILOG:return"epilog";default:return""+(e+1)+"-"+(e+2)+"p"}return""},PM.Core.ProductPhotobook.prototype.GetFitScaleFactor=function(t,e){var r=this.GetPairSize(1);return r.w=Math.max(r.w,this.GetPairSize(0).w),PM.Util.GetScale(t,e,r.w,r.h,!0)},PM.Core.ProductPhotobook.prototype.GetWorkRect=function(t){var e=this.GetPairSize(t);return{l:this.work_pos.x,t:this.work_pos.y,w:e.w,h:e.h}},PM.Core.ProductPhotobook.prototype.GetDropData=function(t){var e="";return 0==t.indexOf("color")?e="color":0==t.indexOf("skin")?e="skin":0==t.indexOf("layout")?e="layout":0==t.indexOf("icon")?e="icon":0==t.indexOf("frame")?e="frame":0==t.indexOf("text")?e="text":0==t.indexOf("photo")&&(e="photo"),{id:e,value:t.substring(e.length)}},PM.Core.ProductPhotobook.prototype.CheckDrop=function(t,e,r,o){if("skin"==r){if(t&&!t.IsLayerLock()){var i=JSON.parse(o);return i.kind==t.skin_kind&&i.type==t.skin_type}}else if("layout"==r&&t&&!t.IsLayerLock()){if(this.IsAvailableSpine()&&t==this.cover.middle_page)return!1;var i=JSON.parse(o),a=!1;return"cover"==i.type&&"cover"==t.layout_type?a=!0:"page"==i.type&&"page"==t.layout_type?a=!0:"layflat"==this.product_type&&"page_spread"==i.type&&"page"==t.layout_type&&(a=!0),i.kind==t.layout_kind&&a}return null!=t&&t!=this.prolog},PM.Core.ProductPhotobook.prototype.DropItem=function(t,e,r,o,i,a,s){var n="",h=null,l=null,c=[],p=[],d=PM.RECORD_UNKNOWN;switch(a){case"color":if(n="배경색 변경",e&&!e.IsLayerLock()){d=PM.RECORD_PAGE_BKCOLOR;var u={skin_link:e.skin_link,color:e.color};c.push(u),h=e.ChangeColor(s)}break;case"skin":if(n="배경스킨 변경",e&&!e.IsLayerLock()){var _=JSON.parse(s);if(_.kind==e.skin_kind&&_.type==e.skin_type){d=PM.RECORD_PAGE_BKIMAGE;var u={skin_link:e.skin_link,color:e.color};c.push(u),h=e.ChangeSkin(PM.URL.SKIN_FILE+_.link)}}break;case"layout":if(n="레이아웃 변경",e&&!e.IsLayerLock()){if(this.cover&&e==this.cover.middle_page)break;var _=JSON.parse(s);if(_.kind==e.layout_kind){d=PM.RECORD_PAGE_LAYOUT;var u=e.SaveJson();if("cover"==_.type&&"cover"==e.layout_type)c.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else if("page"==_.type&&"page"==e.layout_type)if("layflat"==e.layout_style){var g=this.GetPageIndex(e);if(g>0&&g<this.page_array.length-1){c.push(u);var f=this.page_array[g+1].SaveJson();c.push(f),this.page_array[g+1]=null,this.page_array[g+1]=e.CreateDefaultPage(),this.page_array[g+1].layout_style=e.layout_style="normal",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null)}}else c.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else if("layflat"==this.product_type&&"page_spread"==_.type&&"page"==e.layout_type)if("layflat"==e.layout_style)c.push(u),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null);else{var g=this.GetPageIndex(e);if(g>0&&(this.page_array[g-1].work_pos.x<e.work_pos.x&&(g--,e=this.page_array[g]),g<this.page_array.length-1)){var u=e.SaveJson();c.push(old_info1);var f=this.page_array[g+1].SaveJson();c.push(f);var P=e.GetDefaultDummyLink(e);this.page_array[g+1].layout_link=P,this.page_array[g+1].layout_style="dummy",this.page_array[g+1].layer_array=[],e.layout_style="layflat",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+_.link,null,null)}}}}break;case"text":n="글상자 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.TextLayer,h=e.AddNewLayer(o,i,l,!1),l.LoadJsonAtPos(l.xpos,l.ypos,s));break;case"icon":n="스티커 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.IconLayer,l.icon=s,h=e.AddNewLayer(o,i,l,!1));break;case"frame":if(n="사진틀 추가",e&&!e.IsLayerLock())if(r&&r.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_FRAME_CHANGE;var u={type:r.GetType(),value:r.diagram};c.push(u),s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0?(h=r.AddDiagram(s),n="사진틀 변경"):(r.DeleteDiagram(),h=$.Deferred().resolve(),n="사진틀 제거")}else e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX&&s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.diagram=s,h=e.AddNewLayer(o,i,l,!1));break;case"photo":if(n="사진 추가",e)if(r&&r.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_PHOTO_CHANGE;var u={type:r.GetType(),value:r.GetPhotoState()};c.push(u);var _=JSON.parse(s),y=_.url_domain+_.url_path+_.url_edit,m=_.url_domain+_.url_path+_.url_file,M=r.AddPhoto(y,m,_.img_width,_.img_height,!0);M.added&&(h=M.promise),n="사진 변경"}else if(e.IsLayerLock());else if(e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX){var _=JSON.parse(s),y=_.url_domain+_.url_path+_.url_edit,m=_.url_domain+_.url_path+_.url_file;d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.photo=y,l.photo_org=m,l.original_w=_.img_width,l.original_h=_.img_height,h=e.AddNewLayer(o,i,l,!1)}}if(this.SetSelectLayer(e,l),PM.Editor.Framework.CheckBoundary(),h){var v=this;h.done(function(){var o=v.GetPageIndex(e),i=-1;switch(a){case"color":p.push({skin_link:e.skin_link,color:s});break;case"skin":p.push({skin_link:PM.URL.SKIN_FILE+_.link,color:e.color});break;case"layout":var h=e.SaveJson();if(p.push(h),c.length>1){var u=v.page_array[o+1].SaveJson();p.push(u)}break;case"text":case"icon":case"frame":case"photo":if(d==PM.RECORD_LAYER_INSERT){i=e.GetLayerIndex(l);var g={type:l.GetType(),value:$.extend(!0,{},l)};p.push(g)}else if(d==PM.RECORD_FRAME_CHANGE){i=e.GetLayerIndex(r);var g={type:r.GetType(),value:r.diagram};p.push(g)}else if(d==PM.RECORD_PHOTO_CHANGE){i=e.GetLayerIndex(r);var g={type:r.GetType(),value:r.GetPhotoState()};p.push(g)}}d>PM.RECORD_UNKNOWN&&PM.Editor.Framework.RecordOperation(d,t,{page_pos:o,layer_pos:i,data:c},{page_pos:o,layer_pos:i,data:p},n),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback(a,s)}),h.fail(function(){PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")})}else PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")},PM.Core.ProductPhotobook.prototype.DragOver=function(t,e,r,o,i){var a=this.HitTest(e,r,o,i),s=this.GetDropData(t.dataTransfer.getData("text"));return this.CheckDrop(a.page,a.layer,s.id,s.value)},PM.Core.ProductPhotobook.prototype.Drop=function(t,e,r,o,i){t.preventDefault();var a=this.HitTest(e,r,o,i);if(a.page){var s=a.page,n=a.layer,h=this.GetDropData(t.dataTransfer.getData("text"));if(("skin"==h.id||"color"==h.id)&&"layflat"==s.layout_style){var l=s.GetWorkRect();if(l.l+=l.w/2,PM.Util.PtInRect(l,o,i)){var c=this.Pair2PageIndex(r);if(c<=PM.PAGE.ERROR)return;s=this.page_array[c+1]}}this.DropItem(r,s,n,o,i,h.id,h.value)}},PM.Core.ProductPhotobook.prototype.DropDefault=function(t,e,r){var o=this.Pair2PageIndex(t);if(!(o<=PM.PAGE.ERROR)){var i=this.dragger.GetSelectedPage(),a=this.dragger.GetSelectedLayer();if(!i)switch(o){case PM.PAGE.COVER:i=this.cover.back_page;break;case PM.PAGE.PROLOG:i=this.page_array[0];break;default:i=this.page_array[o]}if(i&&this.CheckDrop(i,a,e,r)){var s=i.work_pos.x+i.width/2,n=i.work_pos.y+i.height/2;this.DropItem(t,i,a,s,n,e,r)}}},PM.Core.ProductPhotobook.prototype.MakePreviewImages=function(t){for(var e=document.createElement("canvas"),r=e.getContext("2d"),o=0,i=[],a=0;a<this.PairCount();a++){var s=this.GetPairSize(a),n=0==a&&(null==this.cover.middle_page||null==this.cover.front_page);t||n?(e.width=s.w,e.height=s.h,this.DrawPair(r,a,s.w,s.h),i[o++]=PM.Util.CanvasToImage(e)):(e.width=s.w/2,e.height=s.h,PM.PAGE.PROLOG!=this.Pair2PageIndex(a)&&(this.DrawPair(r,a,s.w,s.h),i[o++]=PM.Util.CanvasToImage(e)),r.translate(-e.width,0),this.DrawPair(r,a,s.w,s.h),i[o++]=PM.Util.CanvasToImage(e),r.translate(e.width,0))}return i},PM.Core.ProductPhotobook.prototype.CheckBoundary=function(t){var e=this.dragger.GetSelectedPage(),r=this.dragger.GetSelectedLayer();if(e&&r&&"spine"!=r.gid){var o=PM.Codi.GetGuideInfo(t,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount()),i=o.cut_w+5,a=o.cut_h+5,s=e.GetWorkRect(),n=r.GetCenterPos(),h=r.GetOutRect();PM.Editor.Framework.GetGridMode()&&(h.l=Math.floor(h.l/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,h.t=Math.floor(h.t/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,n.x=h.l+h.w/2,n.y=h.t+h.h/2,r.xpos=n.x-r.width/2,r.ypos=n.y-r.height/2);var l=this.Point2Page(t,s.l+n.x,s.t+n.y);if(l==this.prolog&&(l=null),l||(n.x<i?n.x=i:n.x>s.w-i&&(n.x=s.w-i),n.y<a?n.y=a:n.y>s.h-a&&(n.y=s.h-a),r.xpos=n.x-r.width/2,r.ypos=n.y-r.height/2),r.GetType()==PM.TYPE.TEXT){h.l<i?h.l=i:h.l+h.w>s.w-i&&(h.l=h.w>s.w-2*i?i:s.w-h.w-i),h.t<a?h.t=a:h.t+h.h>s.h-a&&(h.t=h.h>s.h-2*a?a:s.h-h.h-a);var c=h.l+h.w/2,p=h.t+h.h/2;r.xpos=c-r.width/2,r.ypos=p-r.height/2}r.GetType()==PM.TYPE.TEXT&&(h.w>s.w-2*i||h.h>s.h-2*a)&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE),this.cover&&0==t?this.cover.middle_page&&r.GetType()==PM.TYPE.IMAGE&&(l==this.cover.back_page?h.l+h.w>s.w&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA):l==this.cover.front_page&&h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA)):!this.prolog||null!=l&&l!=this.page_array[0]||h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA)}},PM.Core.ProductPhotobook.prototype.DrawCover=function(t,e,r){var o=this.GetCoverSize(),i=PM.Util.GetCenterPos(e,r,o.w,o.h);this.cover.back_page&&this.cover.back_page.DrawBackground(t,i.x,i.y),this.cover.middle_page&&this.cover.middle_page.DrawBackground(t,i.x+this.cover.back_page.width,i.y),this.cover.front_page&&this.cover.front_page.DrawBackground(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.IMAGE),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.IMAGE),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.IMAGE),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.ICON),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.ICON),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.ICON),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.TEXT),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.TEXT),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.TEXT),this.cover.back_page&&this.cover.back_page.DrawBorder(t,i.x,i.y),this.cover.middle_page&&this.cover.middle_page.DrawBorder(t,i.x+this.cover.back_page.width,i.y),this.cover.front_page&&this.cover.front_page.DrawBorder(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y),PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=i)},PM.Core.ProductPhotobook.prototype.DrawPages=function(t,e,r,o,i){var a=this.GetPagesSize(o,i),s=PM.Util.GetCenterPos(e,r,a.w,a.h),n=this.GetPages(o,i);if(n.rpage.DrawBackground(t,s.x+n.lpage.width,s.y),n.lpage.DrawBackground(t,s.x,s.y),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.IMAGE),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.IMAGE),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.ICON),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.ICON),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.TEXT),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.TEXT),n.lpage.DrawBorder(t,s.x,s.y),n.rpage.DrawBorder(t,s.x+n.lpage.width,s.y),-1==o&&this.prolog&&this.prolog==n.lpage&&this.prolog.DrawProlog(t,s.x+n.lpage.width/2,s.y+n.lpage.height/2),"layflat"!=this.product_type&&PM.Editor.Framework.page_gradation_image&&!PM.Editor.Framework.IsPreviewMode()){var h=s.x+n.lpage.width-PM.Editor.Framework.page_gradation_image.width/2,l=s.y,c=PM.Editor.Framework.page_gradation_image.width,p=a.h;t.drawImage(PM.Editor.Framework.page_gradation_image,h,l,c,p)}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=s)},PM.Core.ProductPhotobook.prototype.DrawPair=function(t,e,r,o){var i=this.Pair2PageIndex(e);if(!(i<=PM.PAGE.ERROR))switch(i){case PM.PAGE.COVER:this.DrawCover(t,r,o);break;case PM.PAGE.PROLOG:this.DrawPages(t,r,o,PM.PAGE.PROLOG,0);break;default:this.DrawPages(t,r,o,i,i+1)}},PM.Core.ProductPhotobook.prototype.Parse=function(t){var e=this,r=$(t).find("photo").find("theme").find("theme");return r.attr("id")!=e.product_key?!1:r.find("theme").attr("themename")!=e.theme_depth1?!1:r.find("theme").find("theme").attr("id")!=e.theme_depth2?!1:(r=r.find("theme").find("theme"),void r.find("theme").each(function(){if("styles"==$(this).attr("type")&&(e.style_id=$(this).attr("id")),"pages"==$(this).attr("type")){var t=null,r=null,o=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.page_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.page_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")?r=e.ParseItems($(this)):"prolog"==$(this).attr("type")&&(o=e.ParseItems($(this)))}),o&&o.length>0){var i=o[0];i.type="prolog";var a=new PM.Core.Page;a.SetLayoutInfo(i),a.SetSkinInfo(new PM.Core.Skin),e.prolog=a}if(t.length>0&&r.length>0)for(var s=0,n=0,h=0;h<e.min_page;h++){s>=t.length&&(s=0),n>=r.length&&(n=0);var i=t[s++],l=r[n++],c=new PM.Core.Page;c.SetLayoutInfo(i),c.SetSkinInfo(l),e.page_array.push(c)}}if("cover"==$(this).attr("type")){var t=null,r=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.cover_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.cover_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")&&(r=e.ParseItems($(this)))}),1==t.length&&1==r.length){var p=t[0],d=r[0],u=new PM.Core.Cover;u.back_page.SetLayoutInfo(p),u.back_page.SetSkinInfo(d),u.middle_page=null,u.front_page=null,e.cover=u}else if(t.length>=3&&r.length>=3){var p=t[0],_=t[1],g=t[2],d=r[0],f=r[1],P=r[2],u=new PM.Core.Cover;u.back_page.SetLayoutInfo(p),u.back_page.SetSkinInfo(d),u.middle_page.SetLayoutInfo(_),u.middle_page.SetSkinInfo(f),u.front_page.SetLayoutInfo(g),u.front_page.SetSkinInfo(P),e.cover=u}}}))},PM.Core.ProductPhotobook.prototype.ParseItems=function(t){var e=this,r=t.attr("type"),o=[];return t.find("skinthumb").each(function(){var t="normal",i=$(this).attr("type"),a=$(this).attr("kind"),s=$(this).attr("imgcnt"),n=$(this).attr("link"),h=$(this).text(),l=$(this).attr("storecode");if("layflat"==e.product_type){var c=$(this).attr("spreadimgcnt");c&&c.length>0&&(s=$(this).attr("spreadimgcnt"));var p=$(this).attr("spreadlink");p&&p.length>0&&(n=$(this).attr("spreadlink"),t="s_bg.xml"==p||"w_bg.xml"==p||"h_bg.xml"==p?"dummy":"layflat")}if("layout"==r||"prolog"==r){var d=new PM.Core.Layout;d.style=t,d.type=i,d.kind=a,d.imgcnt=s,d.link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n),d.thumb=PM.Util.GetFullPathName(PM.URL.LAYOUT_THUMB,h),o.push(d)}else if("skin"==r){var d=new PM.Core.Skin;d.type=i,d.kind=a,d.link=PM.Util.GetFullPathName(PM.URL.SKIN_FILE,n),d.thumb=PM.Util.GetFullPathName(PM.URL.SKIN_THUMB,h),d.storecode=l,o.push(d)}}),o},PM.Core.ProductPhotobook.prototype.LoadJson=function(t){void 0!=t.base_type&&console.assert(this.base_type==t.base_type,"mismatch product base_type"),this.user_id=t.user_id,this.session_id=t.session_id,this.add_param=t.add_param,this.price=t.price,this.basket_name=t.basket_name,this.order_code=t.order_code,this.product_code=t.product_code,this.product_key=t.product_key,this.product_name=t.product_name,this.product_size=t.product_size,this.product_type=t.product_type,this.cover_type=t.cover_type,this.surface_type=t.surface_type,this.price_page=t.price_page,this.min_page=t.min_page,this.max_page=t.max_page,this.theme_depth1=t.theme_depth1,this.theme_depth2=t.theme_depth2,this.theme_name=t.theme_name,this.style_id=t.style_id,this.cover_layout_id=t.cover_layout_id,this.cover_skin_id=t.cover_skin_id,this.page_layout_id=t.page_layout_id,this.page_skin_id=t.page_skin_id,this.is_complete=t.is_complete;var e=[];this.cover=null,t.cover&&(this.cover=new PM.Core.Cover,e.push(this.cover.LoadJson(t.cover))),this.prolog=null,t.prolog&&(this.prolog=new PM.Core.Page,e.push(this.prolog.LoadJson(t.prolog)));for(var r in t.page_array){var o=new PM.Core.Page;this.page_array.push(o),e.push(o.LoadJson(t.page_array[r]))}var i=this;$.when.apply($,e).then(function(){i.PreProcess(i),i.LoadComplete()},function(){i.LoadFailure()})},PM.Core.ProductPhotobook.prototype.SaveJson=function(){var t="{";navigator&&navigator.userAgent&&(t+='\n  "user_agent": "'+navigator.userAgent+'"'),t+='\n, "base_type": '+this.base_type,t+='\n, "user_id": "'+this.user_id+'"',t+='\n, "session_id": "'+this.session_id+'"',t+='\n, "add_param": "'+this.add_param+'"',t+='\n, "price": '+this.price,t+='\n, "basket_name": "'+this.basket_name+'"',t+='\n, "order_code": "'+this.order_code+'"',t+='\n, "product_code": "'+this.product_code+'"',t+='\n, "product_key": "'+this.product_key+'"',t+='\n, "product_name": "'+this.product_name+'"',t+='\n, "product_size": "'+this.product_size+'"',t+='\n, "product_type": "'+this.product_type+'"',t+='\n, "cover_type": "'+this.cover_type+'"',t+='\n, "surface_type": "'+this.surface_type+'"',t+='\n, "price_page": '+this.price_page,t+='\n, "min_page": '+this.min_page,t+='\n, "max_page": '+this.max_page,t+='\n, "inner_page_count": '+this.page_array.length,t+='\n, "theme_depth1": "'+this.theme_depth1+'"',t+='\n, "theme_depth2": "'+this.theme_depth2+'"',t+='\n, "theme_name": "'+this.theme_name+'"',t+='\n, "style_id": "'+this.style_id+'"',t+='\n, "cover_layout_id": "'+this.cover_layout_id+'"',t+='\n, "cover_skin_id": "'+this.cover_skin_id+'"',t+='\n, "page_layout_id": "'+this.page_layout_id+'"',t+='\n, "page_skin_id": "'+this.page_skin_id+'"',t+='\n, "is_complete": '+this.is_complete,this.cover?(t+='\n, "cover": ',t+=this.cover.SaveJson()):t+='\n, "cover": null',this.prolog?(t+='\n, "prolog": ',t+=this.prolog.SaveJson()):t+='\n, "prolog": null',t+='\n, "page_array": [';for(var e=0;e<this.page_array.length;e++)t+=this.page_array[e].SaveJson(),e<this.page_array.length-1&&(t+="\n,");return t+="\n]",t+="\n}"},PM.Ctrl.Dragger=function(){this.drag_mode=PM.HIT.NONE,this.move={x:-1,y:-1},this.sel_page=null,this.sel_layer=null,this.is_editmode=!1,this.middle_page=null},PM.Ctrl.Dragger.prototype.IsMove=function(){return this.drag_mode==PM.HIT.MOVE},PM.Ctrl.Dragger.prototype.IsMoveCrop=function(){return this.drag_mode==PM.HIT.MOVE_CROP},PM.Ctrl.Dragger.prototype.IsEditText=function(){return this.drag_mode==PM.HIT.EDIT_TEXT},PM.Ctrl.Dragger.prototype.IsResize=function(){return this.drag_mode>=PM.HIT.RESIZE_T&&this.drag_mode<=PM.HIT.RESIZE_LB},PM.Ctrl.Dragger.prototype.IsRotate=function(){return this.drag_mode==PM.HIT.ROTATE},PM.Ctrl.Dragger.prototype.IsSelect=function(){return null!=this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedPage=function(){return this.sel_page},PM.Ctrl.Dragger.prototype.GetSelectedLayer=function(){return this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedLayerRect=function(){if(!this.sel_layer)return null;if(!this.sel_page)return null;var t=this.sel_page.GetWorkRect(),e=this.sel_layer.GetRect(),r=e.l+e.w/2,o=e.t+e.h/2,i=this.sel_layer.GetRotateInnerPoints(r,o),a=this.sel_layer.Points2OutRect(i);return{l:t.l+a.l,t:t.t+a.t,w:a.w,h:a.h}},PM.Ctrl.Dragger.prototype.DeleteLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.removelock?!1:(this.sel_page.RemoveLayer(this.sel_layer),this.sel_layer=null,!0):!1},PM.Ctrl.Dragger.prototype.RotateLayer=function(t){return this.sel_layer&&this.sel_page?this.sel_layer.movelock?!1:this.sel_page.RotateLayer(this.sel_layer,t):!1},PM.Ctrl.Dragger.prototype.UpLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.UpLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.DownLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.DownLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.KeyDown=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyDown(t):!1},PM.Ctrl.Dragger.prototype.KeyPress=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyPress(t):!1},PM.Ctrl.Dragger.prototype.SetSelect=function(t,e,r,o){this.is_editmode=e&&e==this.sel_layer&&this.is_editmode,this.sel_page=t,this.sel_layer=e,this.drag_mode=e?PM.HIT.MOVE:PM.HIT.NONE,this.move.x=r,this.move.y=o},PM.Ctrl.Dragger.prototype.ResetSelectedPage=function(t,e,r){if(this.sel_layer&&this.sel_page&&(this.sel_layer.GetType()!=PM.TYPE.TEXT||t!=this.middle_page)&&t){var o=this.sel_layer,i=this.sel_page,a=t;a.AddLayer(o),i.RemoveLayer(o);var s=i.GetWorkRect(),n=e-s.l-o.xpos,h=r-s.t-o.ypos,l=a.GetWorkRect();o.xpos=e-l.l-n,o.ypos=r-l.t-h,this.sel_page=a,this.sel_layer=o}},PM.Ctrl.Dragger.prototype.DblClick=function(t,e,r,o){this.sel_layer&&(this.is_editmode=this.drag_mode==PM.HIT.MOVE||this.drag_mode==PM.HIT.EDIT_TEXT,this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,r,o),this.drag_mode=PM.HIT.EDIT_TEXT))},PM.Ctrl.Dragger.prototype.Down=function(t,e,r,o){if(this.sel_layer&&this.sel_page){this.move.x=r,this.move.y=o;var i=this.sel_page.GetWorkRect();this.drag_mode=this.sel_layer.HitTestController(e,r-i.l,o-i.t),this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,r-i.l,o-i.t),this.drag_mode=PM.HIT.EDIT_TEXT)}},PM.Ctrl.Dragger.prototype.Move=function(t,e,r,o){if(this.sel_layer&&this.sel_page&&this.IsMove()&&!this.sel_layer.movelock){e&&e!=this.sel_page&&this.ResetSelectedPage(e,r,o);var i=this.move.x,a=this.move.y;this.move.x=r,this.move.y=o,this.sel_layer.Move(i,a,this.move.x,this.move.y)}},PM.Ctrl.Dragger.prototype.Up=function(t,e,r){if(this.sel_layer&&this.sel_page){if(this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT){var o=this.sel_page.GetWorkRect();this.sel_layer.MouseUp(t,e-o.l,r-o.t)}this.is_editmode||this.sel_layer.GetType()!=PM.TYPE.TEXT||(this.sel_layer.SelectAll(),this.IsResize()&&this.sel_layer.AdjustSize()),this.drag_mode=PM.HIT.NONE}},PM.Ctrl.Dragger.prototype.EditText=function(t,e,r){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsEditText())return PM.HIT.NONE;if(!this.is_editmode)return PM.HIT.NONE;
var o=this.sel_page.GetWorkRect();return this.sel_layer.MouseMove(t,e-o.l,r-o.t),this.drag_mode},PM.Ctrl.Dragger.prototype.MoveCrop=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsMoveCrop())return PM.HIT.NONE;var r=this.move.x,o=this.move.y;return this.move.x=t,this.move.y=e,this.sel_layer.MoveCrop(r,o,this.move.x,this.move.y),this.drag_mode},PM.Ctrl.Dragger.prototype.Resize=function(t,e,r){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsResize())return PM.HIT.NONE;t&&t!=this.sel_page&&this.ResetSelectedPage(t,e,r);var o=this.move.x,i=this.move.y;this.move.x=e,this.move.y=r;var a=this.sel_page.GetWorkRect();return this.sel_layer.Resize(this.drag_mode,o-a.l,i-a.t,this.move.x-a.l,this.move.y-a.t),this.drag_mode},PM.Ctrl.Dragger.prototype.Rotate=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsRotate())return PM.HIT.NONE;var r=this.move.x,o=this.move.y;this.move.x=t,this.move.y=e;var i=this.sel_page.GetWorkRect();return this.sel_layer.Rotate(r-i.l,o-i.t,this.move.x-i.l,this.move.y-i.t),this.drag_mode},PM.Ctrl.Dragger.prototype.HitTest=function(t,e,r){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;var o=this.sel_page.GetWorkRect(),i=this.sel_layer.HitTestController(t,e-o.l,r-o.t);return i},PM.Ctrl.Dragger.prototype.Draw=function(t){if(this.sel_page&&!PM.Editor.Framework.IsPreviewMode()){var e=this.sel_page.GetWorkRect();if(PM.Util.DrawRect(t,e.l,e.t,e.w,e.h,5,PM.COLOR_PAGE_FOCUS_STROKE,null),this.sel_layer){var r=this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT;this.sel_layer.DrawController(t,e.l,e.t,r)}}},PM.Ctrl.Message=function(){this.is_show=!1,this.text="^^",this.timer_id=-1},PM.Ctrl.Message.prototype.Show=function(t){this.Hide(),this.is_show=!0,this.text=t;var e=PM.CONFIG.MESSAGEBAR_TIMEOUT;t.length>parseInt(e/100)&&(e=100*t.length);var r=this;this.timer_id=setTimeout(function(){r.is_show=!1,r.text=""},e)},PM.Ctrl.Message.prototype.Hide=function(){this.is_show=!1,this.text="",-1!=this.timer_id&&clearTimeout(this.timer_id)},PM.Ctrl.Message.prototype.Draw=function(t,e,r,o,i){this.is_show&&(t.save(),t.fillStyle=PM.CONFIG.MESSAGEBAR_BACKCOLOR,t.fillRect(e,r,o,i),t.font=PM.CONFIG.MESSAGEBAR_FONT,t.fillStyle=PM.CONFIG.MESSAGEBAR_TEXTCOLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,e+o/2,r+i/2),t.restore())},PM.Ctrl.TextBox=function(){this.doc_pos=new xpos(0,0),this.caret=new xcaret,this.dox=new xdoc,this.ime=new xime,this.valign=0,this.edit_w=0,this.edit_h=0,this.min_h=0,this.ctx=null,this.is_singleline=!1,this.is_autoresize=!0,this.is_editable=!0,this.is_spine=!1,this.is_drag=!1,this.undo_stack=[],this.redo_stack=[],this.clipboard_memory=""},PM.Ctrl.TextBox.prototype.callback_update_state=function(){PM.Editor.Framework.updateTextStateCallback&&PM.Editor.Framework.updateTextStateCallback()},PM.Ctrl.TextBox.prototype.callback_update_size=function(t,e){PM.Editor.Framework.updateTextBoundsCallback&&PM.Editor.Framework.updateTextBoundsCallback(t,e)},PM.Ctrl.TextBox.prototype.LoadJson=function(t){this.undo_stack=[],this.redo_stack=[];var e=t;null!=e&&(this.dox.loaddata(e),this.doc_pos.init(),this.movecaretpos(this.doc_pos.getmove()))},PM.Ctrl.TextBox.prototype.SaveJson=function(){return this.dox.toJSON()},PM.Ctrl.TextBox.prototype.SaveJsonEx=function(){var t=0,e=this.getdocy();return this.dox.toJSONEx(t,e)},PM.Ctrl.TextBox.prototype.IsEmptyDoc=function(){return this.dox.getlength()<=0},PM.Ctrl.TextBox.prototype.SetSize=function(t,e){this.edit_w=t,this.edit_h=e,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.SetMinHeight=function(t){this.min_h=t,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.adjustsize=function(t){if(!this.is_singleline&&this.is_autoresize){var e=Math.floor(this.dox.getdocheight()),r=Math.floor(this.edit_h);if(e>this.edit_h)r=e;else if(e<this.edit_h){var o=this.min_h;r=o>e?o:e}r>0&&r!=this.edit_h&&(this.edit_h=r,t&&this.callback_update_size(this.edit_w,this.edit_h))}},PM.Ctrl.TextBox.prototype.Draw=function(t){t&&(t.save(),this.align(t,!0),this.draw(t),this.ctx=t,t.restore())},PM.Ctrl.TextBox.prototype.align=function(t,e){this.dox.aligndoc(t,this.edit_w,e),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.draw=function(t){t.beginPath(),t.rect(0,-4,this.edit_w,this.edit_h+4),t.clip(),this.isOverflowText()&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(t.fillStyle=PM.COLOR_TBOX_WARNING_FILL,t.fillRect(0,0,this.edit_w,this.edit_h));var e=0,r=this.getdocy(),o=this.doc_pos.getblock();this.dox.display(t,e,r,this.edit_h,o.left,o.right,this.isfocus()),this.is_editable&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&!PM.Editor.Framework.IsPreviewMode()&&this.caret.display(t,e,r)},PM.Ctrl.TextBox.prototype.getdocy=function(){var t=0;switch(this.valign){case 0:t=0;break;case 1:t=this.edit_h/2-this.getdocheight()/2;break;case 2:t=this.edit_h-this.getdocheight()}return t},PM.Ctrl.TextBox.prototype.MouseDown=function(t,e,r,o){var t=window.event||t;this.setfocus(),o-=this.getdocy();var i=new xpoint(r,o),a=this.movecaretpoint(i,!0);a>=0&&(t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.is_drag=!0)},PM.Ctrl.TextBox.prototype.MouseMove=function(t,e,r){if(this.is_drag){var t=window.event||t;r-=this.getdocy();var o=new xpoint(e,r),i=this.movecaretpoint(o,!0);i>=0&&this.doc_pos.setmove(i)}},PM.Ctrl.TextBox.prototype.MouseUp=function(t){this.is_drag=!1,t.target.id==PM.Core.MAIN_CANVAS_ID&&this.callback_update_state()},PM.Ctrl.TextBox.prototype.KeyDown=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;switch(e){case 112:t.preventDefault(),this.dox.dump();break;case 113:check_bbox=!check_bbox;break;case 114:this.pastetext("朴大熙㉿ ■ ♥ ☆ ◆ ⊙");break;case 21:case 229:t.preventDefault(),this.setimemode(!this.ime.is_activate());break;case 32:t.preventDefault(),t.shiftKey?this.setimemode(!this.ime.is_activate()):this.keyprocess(e);break;case 10:case 13:this.is_singleline||(t.preventDefault(),this.completecompose(),this.insertchars(X.ENTERKEY,1,X.RECORD_INS));break;case 220:break;case 90:t.ctrlKey&&(t.preventDefault(),this.completecompose(),t.shiftKey?PM.Editor.Framework.Redo():PM.Editor.Framework.Undo());break;case 89:t.ctrlKey&&(t.preventDefault(),this.completecompose(),PM.Editor.Framework.Redo());break;case 67:case 88:case 86:t.ctrlKey&&(t.preventDefault(),this.completecompose(),67==e?this.copy():88==e?(this.copy(),this.deletechars(0,X.RECORD_DEL)):86==e&&this.paste(""));break;case 48:case 107:case 109:case 187:case 189:t.ctrlKey&&this.completecompose();break;case 8:if(t.preventDefault(),this.ime.is_composite()){var r=this.ime.composite(-1);if(r.comp_update>=0){this.deletechars(-1,X.RECORD_OFF);var o=String.fromCharCode(r.comp_update);this.insertchars(o,1,X.RECORD_REPL)}else this.deletechars(-1,X.RECORD_DEL)}else this.deletechars(-1,X.RECORD_DEL);break;case 46:t.preventDefault(),this.ime.is_composite()?this.completecompose():this.deletechars(1,X.RECORD_DEL);break;case 65:t.ctrlKey&&(t.preventDefault(),this.completecompose(),this.select(0,this.dox.getlength()),this.callback_update_state());break;case 33:case 36:t.preventDefault(),this.completecompose(),this.movehome(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 34:case 35:t.preventDefault(),this.completecompose(),this.moveend(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 37:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveleft(0):this.doc_pos.moveleft(0),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();break;case 39:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveright(this.dox.getlength()):this.doc_pos.moveright(this.dox.getlength()),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();break;case 38:t.preventDefault(),this.completecompose();var i=new xpoint(0,0);i.x=this.caret.getbase_x(),i.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(i,!1,-1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state();break;case 40:t.preventDefault(),this.completecompose();var i=new xpoint(0,0);i.x=this.caret.getbase_x(),i.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(i,!1,1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state()}return!0},PM.Ctrl.TextBox.prototype.KeyPress=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;return this.keyprocess(e),!0},PM.Ctrl.TextBox.prototype.keyprocess=function(t){if((!this.is_singleline||13!=t)&&92!=t){if(PM.Editor.Framework.IsMacintosh()&&t>255)return PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_IME),void PM.Editor.Framework.SetIMEState();if(this.ime.is_activate()){var e=this.ime.is_composite(),r=this.ime.composite(t);if(r.comp_update>=0){if(e&&this.deletechars(-1,X.RECORD_OFF),r.comp_end>=0){var o=String.fromCharCode(r.comp_end);this.insertchars(o,1,X.RECORD_REPL)}if(r.comp_update>=0){var o=String.fromCharCode(r.comp_update);X.RECORD_type=X.RECORD_REPL,(!e||r.comp_end>=0)&&(X.RECORD_type=X.RECORD_INS),this.insertchars(o,1,X.RECORD_type)}}else{this.completecompose();var o=String.fromCharCode(t);this.insertchars(o,1,X.RECORD_INS)}}else{var o=String.fromCharCode(t);this.insertchars(o,1,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.completecompose=function(){this.ime.is_composite()&&(this.ime.flush(),this.movecaretpos(this.doc_pos.getmove()+1))},PM.Ctrl.TextBox.prototype.record_op=function(t,e,r,o){this.redo_stack=[];var i=null,a="";switch(t){case X.RECORD_INS:i=new xop(t,e,null,o),a="문자 입력";break;case X.RECORD_DEL:i=new xop(t,e,r,null),a="문자 삭제";break;case X.RECORD_REPL:this.undo_stack.pop(),PM.Editor.Framework.GetUndoStack().pop(),i=new xop(t,e,null,o),a="문자 입력.";break;case X.RECORD_ATTR:i=new xop(t,e,r,o),a="글꼴 속성 변경";break;case X.RECORD_PARA:i=new xop(t,e,r,o),a="단락 속성 변경";break;case X.RECORD_VALIGN:i=new xop(t,e,r,o),a="세로 정렬"}if(null!=i){var s=PM.Editor.Framework.GetSelectedLayer();if(s&&s.GetType()==PM.TYPE.TEXT){var n=PM.Editor.Framework.GetPairNumber(),h=PM.Editor.Framework.GetSelectedPageIndex(),l=PM.Editor.Framework.GetSelectedLayerIndex(),c={text_data:i,layer_data:s.GetMoveInfo()};this.ctx&&(this.align(this.ctx,!0),PM.Editor.Framework.ResizeFromTBox(s,this.edit_w,this.edit_h));var p={text_data:i,layer_data:s.GetMoveInfo()};PM.Editor.Framework.RecordOperation(PM.RECORD_TEXT_CHANGE,n,{page_pos:h,layer_pos:l,data:c},{page_pos:h,layer_pos:l,data:p},a)}}this.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)},PM.Ctrl.TextBox.prototype.isOverflowText=function(){if(this.is_singleline&&this.dox.getlength()>0){var t=this.dox.getalignedwidth();if(t>0&&t>this.edit_w)return!0;if(this.getdocheight()>this.edit_h)return!0}return!1},PM.Ctrl.TextBox.prototype.insertdoc=function(t,e){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var r=this.doc_pos.getmove(),o=r+t.strings.length;if(this.dox.insertdoc(r,t),this.doc_pos.setpos(o),e!=X.RECORD_OFF){var i=new xpos(r,r),a=t;this.record_op(e,i,null,a)}}},PM.Ctrl.TextBox.prototype.insertchars=function(t,e,r){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var o=this.doc_pos.getmove(),i=o+e;if(this.dox.insertchars(o,t,e),this.doc_pos.setpos(i),r!=X.RECORD_OFF){var a=new xpos(o,o),s=this.dox.getblockdoc(o,i-1);this.record_op(r,a,null,s)}}},PM.Ctrl.TextBox.prototype.deletechars=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var r=this.doc_pos.getblock();if(r.left>=0&&r.right>=0){if(e!=X.RECORD_OFF){var o=new xpos(r.left,r.left),i=this.dox.getblockdoc(r.left,r.right);this.record_op(e,o,i,null)}this.doc_pos.setpos(r.left),this.dox.deletechars(r.left,r.right-r.left+1)}}else{if(0>t){if(!this.doc_pos.moveleft(0))return;t=1}var a=this.doc_pos.getmove();if(e!=X.RECORD_OFF){var o=new xpos(a,a),i=this.dox.getblockdoc(a,a+t-1);this.record_op(e,o,i,null)}this.dox.deletechars(a,t),this.doc_pos.setpos(a)}},PM.Ctrl.TextBox.prototype.select=function(t,e){if(!(0>t||t>=e)){this.doc_pos.setpos(t),this.doc_pos.setmove(e);var r=this.dox.pos2caretrect(e,!1);this.caret.setrect(r),this.caret.setbase_x(r.l)}},PM.Ctrl.TextBox.prototype.movehome=function(t,e){var r=this.dox.pos2linepos(t,0);e?this.doc_pos.setmove(r):this.doc_pos.setpos(r);var o=this.dox.pos2caretrect(r,!1);this.caret.setrect(o),this.caret.setbase_x(o.l)},PM.Ctrl.TextBox.prototype.moveend=function(t,e){var r=this.dox.pos2linepos(t,1);e?this.doc_pos.setmove(r):this.doc_pos.setpos(r);var o=this.dox.pos2caretrect(r,!1);this.caret.setrect(o),this.caret.setbase_x(o.l)},PM.Ctrl.TextBox.prototype.movecaretpos=function(t){this.ime.is_composite()&&--t,0>t&&(t=0),t>this.dox.getlength()&&(t=this.dox.getlength());var e=this.dox.pos2caretrect(t,this.ime.is_composite());this.caret.setrect(e),this.caret.setbase_x(e.l)},PM.Ctrl.TextBox.prototype.movecaretpoint=function(t,e){var r=this.dox.point2caretrect(t,0);return this.caret.setrect(r.rect),e&&this.caret.setbase_x(r.rect.l),r.pos},PM.Ctrl.TextBox.prototype.movelinecaretpoint=function(t,e,r){var o=this.dox.point2caretrect(t,r);return this.caret.setrect(o.rect),e&&this.caret.setbase_x(o.rect.l),o.pos},PM.Ctrl.TextBox.prototype.copydox=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock(),e=this.dox.getblockdoc(t.left,t.right);return null!=e?e.toJSON():""},PM.Ctrl.TextBox.prototype.pastedox=function(t){if(this.is_editable){var e=JSON.parse(t);if(null!=e){var r=new xdoc;r.loaddata(e),this.insertdoc(r,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.setfontprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var r=this.doc_pos.getblock(),o=this.dox.getblockdoc(r.left,r.right);this.dox.setblockattrstate(r.left,r.right,t,e);var i=new xpos(r.left,r.right),a=this.dox.getblockdoc(r.left,r.right);this.record_op(X.RECORD_ATTR,i,o,a)}else{var i=this.doc_pos.getmove();this.dox.setattrstate(i,t,e)}},PM.Ctrl.TextBox.prototype.setparaprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var r=this.doc_pos.getblock(),o=this.dox.getselparas(r.left,r.right);this.dox.setblockparastate(r.left,r.right,t,e);var i=new xpos(r.left,r.right),a=this.dox.getselparas(r.left,r.right);this.record_op(X.RECORD_PARA,i,o,a)}else{var s=this.doc_pos.getmove(),o=this.dox.getselparas(s,-1);this.dox.setparastate(s,t,e);var i=new xpos(s,-1),a=this.dox.getselparas(s,-1);this.record_op(X.RECORD_PARA,i,o,a)}},PM.Ctrl.TextBox.prototype.dump_undoredo=function(){console.log(".>> tbox stack log");for(var t=null,e=0;2>e;e++){0==e?(console.log("undo_stack"),t=this.undo_stack):(console.log("redo_stack"),t=this.redo_stack);for(var r=0;r<t.length;r++){var o="";switch(t[r].type){case X.RECORD_INS:o="insert ";break;case X.RECORD_DEL:o="delete ";break;case X.RECORD_REPL:o="replace";break;case X.RECORD_ATTR:o="attr   ";break;case X.RECORD_PARA:o="para   "}o+="["+t[r].pos.getpivot()+","+t[r].pos.getmove()+"]",t[r].ins&&(o+=" (ins)",o+=t[r].ins.strings),t[r].del&&(o+=" (del)",o+=t[r].del.strings),console.log(o)}}},PM.Ctrl.TextBox.prototype.setfontdefault=function(t,e,r,o,i){var a=new xattr;a.facename=t,a.point=parseInt(e),a.textcolor=r,a.bold=o,a.italic=i,this.dox.setdefault(a,null)},PM.Ctrl.TextBox.prototype.setparadefault=function(t,e,r){var o=new xpara;switch(t){case"left":o.align=0;break;case"right":o.align=1;break;case"center":o.align=2;break;case"scattering":o.align=3;break;case"justify":o.align=4}o.paragap=e,o.linegap=r,this.dox.setdefault(null,o)},PM.Ctrl.TextBox.prototype.getfontstate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockattrstate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getattrstate(e)}return null==t.attr||null==t.filter?null:{fontface:t.filter.facename?t.attr.facename:"",fontpoint:t.filter.point?t.attr.point:0,fillcolor:t.filter.textcolor?t.attr.textcolor:"",isstroke:t.filter.strokecolor&&""!=t.attr.strokecolor?!0:!1,isbold:t.filter.bold?t.attr.bold:!1,isitalic:t.filter.italic?t.attr.italic:!1,isunderline:t.filter.underline?t.attr.underline:!1,charw:t.filter.charw?t.attr.charw:0}},PM.Ctrl.TextBox.prototype.getparastate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockparastate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getparastate(e)}if(null==t.para||null==t.filter)return null;var r=t.filter.linegap?t.para.linegap:"",o=t.filter.paragap?t.para.paragap:"",i="";if(t.filter.align)switch(t.para.align){case 0:i="left";break;case 1:i="right";break;case 2:i="center";break;case 3:i="scattering";break;case 4:i="justify"}return{lineh:r,parah:o,align:i}},PM.Ctrl.TextBox.prototype.setfontname=function(t){var e=this;PM.Util.LoadWebFont(t,function(){var r=new xattr,o=new xattr_filter(!1);r.facename=t,o.facename=!0,e.setfontprop(r,o)})},PM.Ctrl.TextBox.prototype.setfontsize=function(t){var e=new xattr,r=new xattr_filter(!1);e.point=t,r.point=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontcolor=function(t){var e=new xattr,r=new xattr_filter(!1);e.textcolor=t,r.textcolor=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontstroke=function(t){var e=new xattr,r=new xattr_filter(!1);e.strokecolor=t?"#ff7f00":"",r.strokecolor=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontbold=function(t){var e=new xattr,r=new xattr_filter(!1);e.bold=t,r.bold=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontitalic=function(t){var e=new xattr,r=new xattr_filter(!1);e.italic=t,r.italic=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontunderline=function(t){var e=new xattr,r=new xattr_filter(!1);e.underline=t,r.underline=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setfontwidth=function(t){var e=new xattr,r=new xattr_filter(!1);e.charw=t,r.charw=!0,this.setfontprop(e,r)},PM.Ctrl.TextBox.prototype.setalign=function(t){var e=new xpara,r=new xpara_filter(!1);switch(t){case"left":e.align=0;break;case"right":e.align=1;break;case"center":e.align=2;break;case"scattering":e.align=3;break;case"justify":e.align=4}r.align=!0,this.setparaprop(e,r)},PM.Ctrl.TextBox.prototype.setvalign=function(t,e){var r=PM.Editor.Framework.GetSelectedLayer();if(r&&r.gid&&"spine"==r.gid)return PM.Editor.Framework.ShowMessageBar("책등은 가운데 정렬만 지원합니다."),!1;var o=this.valign;switch(t){case"top":this.valign=0;break;case"middle":this.valign=1;break;case"bottom":this.valign=2}var i=this.valign;return e&&this.record_op(X.RECORD_VALIGN,0,o,i),!0},PM.Ctrl.TextBox.prototype.getvalign=function(){var t="";switch(this.valign){case 0:t="top";break;case 1:t="middle";break;case 2:t="bottom"}return t},PM.Ctrl.TextBox.prototype.setlineh=function(t){var e=new xpara,r=new xpara_filter(!1);e.linegap=t,r.linegap=!0,this.setparaprop(e,r)},PM.Ctrl.TextBox.prototype.setparah=function(t){var e=new xpara,r=new xpara_filter(!1);e.paragap=t,r.paragap=!0,this.setparaprop(e,r)},PM.Ctrl.TextBox.prototype.fromString=function(t){this.undo_stack=[],this.redo_stack=[];var t=t.replace(/\r\n/gi,X.ENTERKEY);t=t.replace(/\n/gi,X.ENTERKEY),t=t.replace(/\r/gi,X.ENTERKEY),this.select(0,this.dox.getlength()),this.insertchars(t,t.length,X.RECORD_OFF)},PM.Ctrl.TextBox.prototype.toString=function(){return this.dox.toString()},PM.Ctrl.TextBox.prototype.toSVG=function(){return this.dox.toSVG()},PM.Ctrl.TextBox.prototype.setimemode=function(t){this.completecompose(),this.ime.activate(t),this.movecaretpos(this.doc_pos.getmove())},PM.Ctrl.TextBox.prototype.copytext=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock();return this.dox.getblocktext(t.left,t.right)},PM.Ctrl.TextBox.prototype.pastetext=function(t){this.insertchars(t,t.length,X.RECORD_INS)},PM.Ctrl.TextBox.prototype.copy=function(){return this.clipboard_memory=this.copydox(),this.clipboard_memory},PM.Ctrl.TextBox.prototype.paste=function(t){""==t&&(t=this.clipboard_memory),this.clipboard_memory.length>0&&this.pastedox(this.clipboard_memory)},PM.Ctrl.TextBox.prototype.undo=function(){if(!this.is_editable)return!1;if(this.undo_stack.length<=0)return!1;var t=this.undo_stack.pop();return null!=t&&(this.undo_action(t),this.redo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.redo=function(){if(!this.is_editable)return!1;if(this.redo_stack.length<=0)return!1;var t=this.redo_stack.pop();return null!=t&&(this.redo_action(t),this.undo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.undo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.del);break;case X.RECORD_VALIGN:this.valign=t.del}return!0},PM.Ctrl.TextBox.prototype.redo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.ins);break;case X.RECORD_VALIGN:this.valign=t.ins}return!0},PM.Ctrl.TextBox.prototype.setsingleline=function(t){this.is_singleline=t,this.dox.is_singleline=t},PM.Ctrl.TextBox.prototype.isspine=function(){return this.is_spine},PM.Ctrl.TextBox.prototype.setspine=function(t){this.is_spine=t},PM.Ctrl.TextBox.prototype.getautoresize=function(){return this.is_autoresize},PM.Ctrl.TextBox.prototype.setautoresize=function(t){this.is_autoresize=t},PM.Ctrl.TextBox.prototype.seteditable=function(t){this.is_editable=t},PM.Ctrl.TextBox.prototype.getwidth=function(){return this.edit_w},PM.Ctrl.TextBox.prototype.getheight=function(){return this.edit_h},PM.Ctrl.TextBox.prototype.getdocwidth=function(){return this.dox.getdocwidth()},PM.Ctrl.TextBox.prototype.getdocheight=function(){return this.dox.getdocheight()},PM.Ctrl.TextBox.prototype.isfocus=function(){return this.caret.is_show()},PM.Ctrl.TextBox.prototype.setfocus=function(){this.caret.show(!0)},PM.Ctrl.TextBox.prototype.killfocus=function(){this.completecompose(),this.caret.show(!1)},PM.Ctrl.TextBox.prototype.selectAll=function(){this.select(0,this.dox.getlength()),this.callback_update_state()},PM.Ctrl.TextBox.prototype.updateall=function(t){if(null!=this.ctx){var e=this.ctx;this.dox.aligndoc(e,this.edit_w,!0),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(t),this.draw(e)}},PM.Editor.Framework=new function(){var t=this,e=!1,r=!1,o=PM.CONFIG.BOOT_LOADING,i="",a=new PM.Ctrl.Message,s=null,n=null,h=null,l=null,c=0,p=1,d=!1,u=!1,_=PM.CONFIG.GRID_SPACE,g=PM.CONFIG.GRID_COLOR,f=[],P=[],y=[];this.Init=function(e){PM.Util.LoadWebFont(PM.CONFIG.FONT_DEFAULT,function(){}),i=document.title,document.title=i+"."+PM.Core.Version,PM.Core.MAIN_CANVAS_ID=e.canvasTarget.id,n=e.canvasTarget,h=n.getContext("2d"),n.width=2e3,n.height=2e3,n.ondragover=this.OnDragOver,n.ondrop=this.OnDrop,n.addEventListener("contextmenu",this.OnContextMenu,!1),n.addEventListener("dblclick",this.OnDoubleClick,!1),n.addEventListener("mousedown",this.OnMouseDown,!1),n.addEventListener("mousemove",this.OnMouseMove,!1),document.addEventListener("mouseup",this.OnMouseUp,!1),document.addEventListener("keydown",this.OnKeyDown,!1),document.addEventListener("keypress",this.OnKeyPress,!1),document.addEventListener("keyup",this.OnKeyUp,!1),window.addEventListener("resize",this.OnResize,!0),document.body.addEventListener("online",this.OnUpdateConnection,!1),document.body.addEventListener("offline",this.OnUpdateConnection,!1),$(window).on("beforeunload",function(){}),window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3)}}(),window.requestAnimationFrame(this.OnMainLoop),l=e.productInfo,l.Load(null),this.SetModified(!1),P=[],y=[],this.loadCompleteCallback=e.loadCompleteCallback,this.addPhotosCompleteCallback=e.addPhotosCompleteCallback,this.deletePhotosCompleteCallback=e.deletePhotosCompleteCallback,this.updateTextStateCallback=e.updateTextStateCallback,this.selectLayerCallback=e.selectLayerCallback,this.moveLayerCallback=e.moveLayerCallback,this.contextMenuCallback=e.contextMenuCallback,this.movePageCallback=e.movePageCallback,this.dropTargetCallback=e.dropTargetCallback,this.updateTextBoundsCallback=function(e,r){var o=t.GetSelectedLayer();o&&o.GetType()==PM.TYPE.TEXT&&t.ResizeFromTBox(o,e,r)},s=e.infoTarget;var r=PM.Util.LoadImage(PM.CONFIG.COVER_BARCODE_IMAGE);r.done(function(e){t.cover_barcode_image=e}),r.fail(function(){t.cover_barcode_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.COVER_BARCODE_IMAGE)});var o=PM.Util.LoadImage(PM.CONFIG.PAGE_GRADATION_IMAGE);o.done(function(e){t.page_gradation_image=e}),o.fail(function(){t.page_gradation_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PAGE_GRADATION_IMAGE)});var a=PM.Util.LoadImage(PM.CONFIG.PHOTO_EMPTY_IMAGE);a.done(function(e){t.photo_empty_image=e}),a.fail(function(){t.photo_empty_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_EMPTY_IMAGE)});var c=PM.Util.LoadImage(PM.CONFIG.PHOTO_WARNING_IMAGE);c.done(function(e){t.photo_warning_image=e}),c.fail(function(){t.photo_warning_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_WARNING_IMAGE)})},this.Ready=function(t){o=t,o==PM.CONFIG.BOOT_SUCCESS&&(this.RecalcCanvasSize(),e=PM.Util.IsMacintosh())},this.IsShiftState=function(){return r},this.IsMacintosh=function(){return e},this.SetIMEState=function(){n.style.imeMode="disable"},this.GetParentElementSize=function(){var t={w:1e3,h:600};if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var e=n.parentElement.getBoundingClientRect();t.w=e.width,t.h=e.height}return t},this.RecalcCanvasSize=function(){if(l){var t=PM.Util.P2LSize(this.GetParentElementSize(),p),e=this.GetPairSize(c),r={w:e.w+PM.CONFIG.CANVAS_MARGIN_W,h:e.h+PM.CONFIG.CANVAS_MARGIN_H},o=Math.max(r.w,t.w),i=Math.max(r.h,t.h);n.width=o*p-20,n.height=i*p-20}},this.ResizeFromTBox=function(t,e,r){l&&(l.dragger.IsResize()||t.ResizeFromTBoxCallback(e,r),l.ResizeFromTBoxCallbackProcess(p),l.CheckBoundary(c))},this.CheckBoundary=function(){l&&l.CheckBoundary(c)},this.ShowMessageBar=function(t){a.Show(t)},this.HideMessageBar=function(){a.Hide()},this.GetProduct=function(){return l},this.LoadProduct=function(t){var e=null;try{e=JSON.parse(t)}catch(r){e=null,console.error(r)}if(e){var o=null;void 0==e.base_type?o=new PM.Core.ProductPhotobook:e.base_type==PM.PRODUCT.PHOTOBOOK?o=new PM.Core.ProductPhotobook:e.base_type==PM.PRODUCT.CALENDAR?o=new PM.Core.ProductCalendar:console.assert(!1,"unknown product base_type.."),o.LoadJson(e),l=null,l=o,this.SetModified(!1),P=[],y=[]}else PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"Parse failed")},this.SaveProduct=function(){return l?(this.SetModified(!1),l.SaveJson()):""},this.ClearProduct=function(){l=null,c=0,p=1,this.SetModified(!1)},this.LoadTheme=function(t,e,r){var o=new PM.Core.ProductPhotobook;o.user_id=l.user_id,o.session_id=l.session_id,o.add_param=l.add_param,o.price=l.price,o.product_code=l.product_code,o.product_key=l.product_key,o.product_name=l.product_name,o.product_size=l.product_size,o.product_type=l.product_type,o.cover_type=l.cover_type,o.surface_type=l.surface_type,o.theme_depth1=t,o.theme_depth2=e,o.theme_name=r,o.price_page=l.price_page,o.min_page=l.min_page,o.max_page=l.max_page;var i=l.GetUserImageListPerPage();this.ClearProduct(),l=o,l.Load(i),this.SetModified(!1),P=[],y=[]},this.IsComplete=function(){return l?l.CheckComplete():!1},this.IsModified=function(){return this.is_modified},this.SetModified=function(t){this.is_modified=t,document.title=i+"."+PM.Core.Version+(this.is_modified?"*":"")},this.SetPreviewMode=function(t){d=t},this.IsPreviewMode=function(){return d},this.GetPoolInfo=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.GetPoolInfo():null},this.IsEmptySpine=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.IsEmptySpine():!1},this.IsHoleLeatherCoverProduct=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.IsHoleLeatherCoverProduct():!1},this.SetSharedImageInfo=function(t){l&&l.GetType()==PM.PRODUCT.PHOTOBOOK&&l.IsHoleLeatherCoverProduct()&&l.SetSharedImageInfo(t)},this.MakePreviewImages=function(t){if(!l)return null;var e=null,r=d;d=!0;try{e=l.MakePreviewImages(t)}catch(o){e=null,console.error(o)}finally{d=!1,d=r}return e},this.ConnectPageThumbnail=function(t,e){if(l&&t){f[e]=t;var r=t,o=t.getContext("2d"),i=l.GetFitScaleFactor(r.width-5,r.height-5);r&&o&&this.Draw(o,r,i,e)}},this.SetCurrentThumbnail=function(){l&&this.ModifyCurrentThumbnail(c)},this.ModifyCurrentThumbnail=function(t){this.DrawThumbnail(t),this.IsHoleLeatherCoverProduct()&&(0==t?this.DrawThumbnail(1):1==t&&this.DrawThumbnail(0))},this.DrawThumbnail=function(t){if(!(0>t||t>=f.length)&&null!=f[t]&&void 0!=f[t]){var e=f[t],r=e.getContext("2d"),o=l.GetFitScaleFactor(e.width-5,e.height-5);this.Draw(r,e,o,t)}},this.MovePair=function(t){return l?(pair_count=l.PairCount(),0>t?t=0:t>=pair_count&&(t=pair_count-1),c=t,this.RecalcCanvasSize(),l.ClearSelect(),this.Draw(h,n,p,c),this.movePageCallback&&this.movePageCallback(c),c):0},this.SwapPair=function(t,e){return!1},this.ReorderPair=function(t){return l?d?!1:(this.SetModified(!0),l.ReorderPages(c,t)):!1},this.AddPair=function(t,e){return l?d?PM.ADDPAGE_FAIL:(this.SetModified(!0),"current"==t?l.AddPages(c,parseInt(e)):"last"==t?l.AddPages(-1,parseInt(e)):PM.ADDPAGE_FAIL):PM.ADDPAGE_FAIL},this.DeletePair=function(t,e){if(!l)return PM.DELPAGE_FAIL;if(d)return PM.DELPAGE_FAIL;this.SetModified(!0);var r=PM.DELPAGE_FAIL;return"current"==t?r=l.DeletePages(c,parseInt(e)):"last"==t&&(r=l.DeletePages(-1,parseInt(e))),this.MovePair(c),r},this.GetInnerPageCount=function(){return l?l.GetInnerPageCount():0},this.GetPairText=function(t){return l?l.GetPairText(t):""},this.GetPairNumber=function(){return c},this.GetPairCount=function(){return l?l.PairCount():0},this.GetPairSize=function(t){return l?l.GetPairSize(t):{w:0,h:0}},this.GetCurrentPairSize=function(){return l?l.GetPairSize(c):{w:0,h:0}},this.GetPageNumber=function(t){return l?l.Pair2PageIndex(t):PM.PAGE.ERROR},this.DeleteEmptyLayers=function(t){l&&(d||(l.ClearSelect(),this.SetModified(!0),l.DeleteEmptyLayers(t)))},this.DeleteLayer=function(){l&&(d||(this.SetModified(!0),l.DeleteLayer()))},this.RotateLayer=function(t){return l?d?!1:(this.SetModified(!0),l.RotateLayer(t)):!1},this.UpLayer=function(){return l?d?!1:(this.SetModified(!0),l.UpLayer()):!1},this.DownLayer=function(){return l?d?!1:(this.SetModified(!0),l.DownLayer()):!1},this.AddPhotos=function(t){l&&(d||(this.SetModified(!0),l.AddPhotos(t)))},this.DeletePhotos=function(){l&&(d||(this.SetModified(!0),l.DeletePhotos()))},this.GetUserImageList=function(){return l?l.GetUserImageList():""},this.GetUserImageListText=function(){if(!l)return"";for(var t="",e=l.GetUserImageList(),r=0;r<e.length;r++){var o=JSON.parse(e[r]);t+=o.org_link,t+="\n"}return t},this.GetSelectedLayer=function(){return l?d?null:l.GetSelectedLayer():null},this.GetSelectedLayerIndex=function(){if(!l)return null;if(d)return null;var t=this.GetSelectedPage();if(t){var e=l.GetSelectedLayer();return t.GetLayerIndex(e)}return-1},this.GetSelectedPage=function(){return l?d?null:l.GetSelectedPage():null},this.GetSelectedPageIndex=function(){return l?d?null:l.GetSelectedPageIndex():null
},this.GetEditableTextBox=function(){if(!l)return null;if(d)return null;var t=l.GetSelectedLayer();return t&&t.GetType()==PM.TYPE.TEXT?t.GetEditableTextBox():null},this.IsFocusTextBox=function(){if(!l)return null;if(d)return null;var t=l.GetSelectedLayer();return t&&t.GetType()==PM.TYPE.TEXT?t.IsFocusTextBox():!1},this.FitScale=function(){if(!l)return 1;var t=this.GetParentElementSize();return n.width=t.w,n.height=t.h,p=l.GetFitScaleFactor(n.width-PM.CONFIG.CANVAS_MARGIN_W,n.height-PM.CONFIG.CANVAS_MARGIN_H),this.Draw(h,n,p,c),p},this.SetScale=function(t){return l?(t<PM.CONFIG.SCALE_MIN?t=PM.CONFIG.SCALE_MIN:t>PM.CONFIG.SCALE_MAX&&(t=PM.CONFIG.SCALE_MAX),p=t,this.RecalcCanvasSize(),this.Draw(h,n,p,c),t):1},this.GetScale=function(){return p},this.GetGridMode=function(){return u},this.SetGridMode=function(t){d||(u=t)},this.GetGridOption=function(){return{space:_,color:g}},this.SetGridOption=function(t){_=t.space,g=t.color},this.Draw=function(t,e,r,i){t.clearRect(0,0,e.width,e.height),t.save(),t.scale(r,r);var s={w:e.width,h:e.height};if(s=PM.Util.P2LSize(s,r),l&&o==PM.CONFIG.BOOT_SUCCESS&&(l.DrawPair(t,i,s.w,s.h),e==n&&(this.DrawBarcode(t,i),d||(this.DrawGuideline(t,i),u&&this.DrawGrid(t,i),this.DebugInfo(t)))),t.restore(),e==n&&!d){if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var h=n.parentElement.scrollLeft,c=n.parentElement.scrollTop,p=n.parentElement.getBoundingClientRect().width,_=PM.CONFIG.MESSAGEBAR_HEIGHT;a.Draw(t,h,c,p,_)}if(o!=PM.CONFIG.BOOT_SUCCESS){var g=o==PM.CONFIG.BOOT_FAILURE?PM.CONFIG.BOOT_FAILURE_MSG:PM.CONFIG.BOOT_LOADING_MSG,h=n.parentElement.scrollLeft,c=n.parentElement.scrollTop,f=n.parentElement.getBoundingClientRect();this.DrawBootMessage(t,h,c,f.width,f.height,g)}}},this.DrawBarcode=function(t,e){t.save();var r=0>=e;if(r&&this.cover_barcode_image){var o=l.GetWorkRect(e),i=o.l,a=o.t,s=PM.Codi.GetGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());t.drawImage(this.cover_barcode_image,i+s.barcode_rect.x,a+s.barcode_rect.y,s.barcode_rect.w,s.barcode_rect.h)}t.restore()},this.DrawGuideline=function(t,e){t.save();var r=l.GetWorkRect(e),o=r.l,i=r.l+r.w,a=r.t,s=r.t+r.h,n=0>=e,h=l.GetSpineWidth(),c=PM.Codi.GetGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount()),p=PM.CONFIG.GUIDE_EXTRA;if(t.strokeStyle=PM.CONFIG.GUIDE_COLOR,t.fillStyle=PM.CONFIG.GUIDE_TEXT_COLOR,t.lineWidth=PM.CONFIG.GUIDE_LINEW,t.beginPath(),t.moveTo(o-p,a+c.cut_h),t.lineTo(i+p,a+c.cut_h),t.moveTo(o-p,s-c.cut_h),t.lineTo(i+p,s-c.cut_h),t.moveTo(o+c.cut_w,a-p),t.lineTo(o+c.cut_w,s+p),t.moveTo(i-c.cut_w,a-p),t.lineTo(i-c.cut_w,s+p),t.font=PM.CONFIG.GUIDE_FONT,n)if(l.IsAvailableSpine()){var d=o+r.w/2-c.middle_w/2,u=d+c.middle_w,_=o+r.w/2-h/2,g=_+h,f="";PM.DEBUG&&l.cover.middle_page&&(f=":"+c.middle_w+"=="+l.cover.middle_page.width+"("+h+")"),t.moveTo(d,a-p),t.lineTo(d,s+p),t.moveTo(u,a-p),t.lineTo(u,s+p),t.moveTo(_,a-p),t.lineTo(_,s+p),t.moveTo(g,a-p),t.lineTo(g,s+p),t.textAlign="center",t.textBaseline="bottom",t.fillText("책등"+f,o+r.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("뒷면->",_,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-앞면",g,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-인쇄영역",o,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("인쇄영역->",i,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.fillText("(인쇄영역까지 사진을 넣어주셔야 여백없이 제작됩니다)",i,s+PM.CONFIG.GUIDE_FONT_H+2*PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-접히는면",o+c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->",i-c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}else l.IsHoleLeatherCoverProduct()&&(t.textAlign="center",t.textBaseline="bottom",t.fillText(PM.CONFIG.GUIDE_LEATHERCOVER_TEXT,o+r.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN));else{var P=o+r.w/2;t.moveTo(P,a-p),t.lineTo(P,s+p),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->   ",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("   <-접히는면",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-잘리는면",o+c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("잘리는면->",i-c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}t.stroke(),t.restore()},this.DrawGrid=function(t,e){t.save();var r=l.GetWorkRect(e),o=r.l,i=r.l+r.w,a=r.t,s=r.t+r.h,n=_;t.strokeStyle=g,t.lineWidth=PM.CONFIG.GRID_LINEW,t.beginPath();for(var h=o;i>=h;h+=n)t.moveTo(h,a),t.lineTo(h,s);for(var h=a;s>=h;h+=n)t.moveTo(o,h),t.lineTo(i,h);t.stroke(),t.restore()},this.DrawBootMessage=function(t,e,r,o,i,a){t.save(),t.font=PM.CONFIG.BOOT_FONT,t.fillStyle=PM.CONFIG.BOOT_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+o/2,r+i/2),t.restore()},this.DebugString=function(){return""},this.DebugInfo=function(){if(!PM.DEBUG)return"";if(!l)return"";if(s){var t="";t+="["+l.product_code,t+=" "+l.product_size,t+=" "+l.product_type,t+=" "+l.cover_type,t+=" "+l.surface_type,t+=" "+l.theme_depth1,t+=" "+l.theme_depth2,t+="] ";var e=PM.Codi.GetGuideInfo(c,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());t+="[",t+=" 책등폭:"+e.middle_w,t+=" 재단선:"+e.cut_w+" "+e.cut_h,t+=" ] ",s.html(t)}},this.DropDefault=function(t,e){l&&(d||(l.ResetFocus(c),l.DropDefault(c,t,e),this.SetModified(!0)))},this.ChangeAll=function(t,e){if(!l)return!1;if(d)return!1;l.ResetFocus(c);var r=l.ChangeAll(c,t,e);return r?(this.SetModified(!0),!0):!1},this.Copy=function(){return l?d?!1:this.IsCopyAvailable()?l.Copy(c):(console.log("Copy is not available."),!1):!1},this.Cut=function(){return l?d?!1:this.IsCutAvailable()?(this.SetModified(!0),l.Cut(c)):(console.log("Cut is not available."),!1):!1},this.Paste=function(){return l?d?!1:this.IsPasteAvailable()?(this.SetModified(!0),l.Paste(c)):(console.log("Paste is not available."),!1):!1},this.IsCopyAvailable=function(){if(!l)return!1;if(d)return!1;if(this.IsFocusTextBox())return!1;var t=l.GetSelectedLayer();return t&&"spine"!=t.gid},this.IsCutAvailable=function(){return this.IsCopyAvailable()},this.IsPasteAvailable=function(){return l?d?!1:this.IsFocusTextBox()?!1:l.clipboard_memory.length>0:!1},this.RecordOperation=function(t,e,r,o,i){var a=new PM.Record(t,e,r,o,i);null!=a&&(y=[],P.push(a))},this.DumpRecord=function(){if(PM.DEBUG){console.log("\n[undo stack...................]");for(var t=0;t<P.length;t++)console.log(t+". "+P[t].desc);console.log("\n[redo stack...................]");for(var t=0;t<y.length;t++)console.log(t+". "+y[t].desc);console.log("\n")}},this.Undo=function(){this.IsUndoAvailable()||console.log("Undo is not available.");var t=P.pop();t&&(l.ResetFocus(c),t.UndoAction(),y.push(t),l.ResetFocus(c),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.Redo=function(){this.IsRedoAvailable()||console.log("Redo is not available.");var t=y.pop();t&&(l.ResetFocus(c),t.RedoAction(),P.push(t),l.ResetFocus(c),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.GetUndoStack=function(){return P},this.GetUndoDesc=function(){if(P.length>0){var t=P[P.length-1];if(t&&t.desc)return t.desc}return""},this.GetRedoDesc=function(){if(P.length>0){var t=y[y.length-1];if(t&&t.desc)return t.desc}return""},this.IsUndoAvailable=function(){return P.length>0},this.IsRedoAvailable=function(){return y.length>0},this.WindowToCanvas=function(t){var t=window.event||t,e=n.getBoundingClientRect();return{x:t.clientX-e.left*(n.width/e.width),y:t.clientY-e.top*(n.height/e.height)}},this.OnMainLoop=function(){t.OnIdle(),window.requestAnimationFrame(t.OnMainLoop)};var m=0;this.OnIdle=function(){t.Draw(h,n,p,c);var e=+new Date;e-m>1e3&&(t.ModifyCurrentThumbnail(c),m=e)},this.OnUpdateConnection=function(){var e=navigator.onLine?PM.CONFIG.MESSAGE_ONLINE:PM.CONFIG.MESSAGE_OFFLINE;t.ShowMessageBar(e)},this.OnKeyDown=function(e){if(l&&!d)if(l.KeyDown(e))t.SetModified(!0);else{r=e.shiftKey;var o=e.which||e.keyCode;switch(o){case 90:e.ctrlKey&&(e.shiftKey?t.Redo():t.Undo());break;case 89:e.ctrlKey&&t.Redo()}}},this.OnKeyPress=function(e){l&&(d||l.KeyPress(e)&&t.SetModified(!0))},this.OnKeyUp=function(){r=!1},this.OnDoubleClick=function(e){if(l&&!d){l.ResetFocus(c);var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);if(l.DblClick(e,h,c,r.x,r.y),2==p&&u&&e.shiftKey){var o=l.GetWorkRect(c);r.x<o.l&&r.x>o.l-20&&(PM.DEBUG=!PM.DEBUG)}}},this.OnMouseDown=function(e){if(l&&!d&&3!=e.which){l.ResetFocus(c);var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Select(e,h,c,r.x,r.y,p)}},this.OnMouseMove=function(e){if(l&&!d){var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p),o=l.Move(e,h,c,r.x,r.y,p);switch(o.hit_type){case PM.HIT.MOVE:e.target.style.cursor="move";break;case PM.HIT.RESIZE_T:e.target.style.cursor="n-resize";break;case PM.HIT.RESIZE_R:e.target.style.cursor="e-resize";break;case PM.HIT.RESIZE_B:e.target.style.cursor="s-resize";break;case PM.HIT.RESIZE_L:e.target.style.cursor="w-resize";break;case PM.HIT.RESIZE_LT:e.target.style.cursor="nw-resize";break;case PM.HIT.RESIZE_RT:e.target.style.cursor="ne-resize";break;case PM.HIT.RESIZE_RB:e.target.style.cursor="se-resize";break;case PM.HIT.RESIZE_LB:e.target.style.cursor="sw-resize";break;case PM.HIT.ROTATE:e.target.style.cursor="pointer";break;case PM.HIT.MOVE_CROP:e.target.style.cursor="pointer";break;case PM.HIT.EDIT_TEXT:e.target.style.cursor="text";break;default:e.target.style.cursor="default"}o.modified&&t.SetModified(!0)}},this.OnMouseUp=function(e){if(l&&!d){var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Up(e,h,c,r.x,r.y,p),e.target.style.cursor="default"}},this.OnContextMenu=function(e){if(!d){e.preventDefault();var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.ContextMenu(e,h,c,r.x,r.y,p)}},this.OnResize=function(){t.RecalcCanvasSize()},this.OnDragOver=function(e){if(l&&!d){var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.DragOver(e,h,c,r.x,r.y)&&e.preventDefault()}},this.OnDrop=function(e){if(l&&!d){l.ResetFocus(c);var r=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Drop(e,h,c,r.x,r.y),t.SetModified(!0)}}},PM.Lib.AjaxItem=function(){this.status="ready",this.params=null,this.xhr=null,this.result={},this.success=null,this.error=null,this.abort=null},PM.Lib.AjaxItem.prototype.Init=function(t,e,r,o){this.params=t,this.success=e,this.error=r,this.abort=o},PM.Lib.AjaxItem.prototype.Send=function(){if(null!=this.params){this.params.timeout=3e4;var t=this;this.status="waiting",this.xhr=$.ajax(this.params),this.xhr.done(function(e,r,o){t.status="success",t.result={data:e,textStatus:r,jqXHR:o}}),this.xhr.fail(function(e,r,o){t.status="fail",t.result={jqXHR:e,textStatus:r,errorThrown:o}})}},PM.Lib.AjaxItem.CommitSuccess=function(){null!=this.success&&this.success(this.result.data,this.result.textStatus,this.result.jqXHR)},PM.Lib.AjaxItem.CommitError=function(){null!=this.error&&this.error(this.result.jqXHR,this.result.textStatus,this.result.errorThrown)},PM.Lib.AjaxItem.CommitAbort=function(){null!=this.xhr&&this.xhr.abort(),null!=this.abort&&this.abort()},PM.Lib.AjaxManager=new function(){this.request_array=[],this.Add=function(t,e,r,o){var i=new PM.Lib.AjaxItem;i.Init(t,e,r,o),this.request_array.push(i)},this.Download=function(){for(var t in this.request_array)this.request_array[t].Send()}},PM.Lib.SeqItem=function(){this.deferred=$.Deferred(),this.func=null},PM.Lib.SeqManager=function(){this.seq_array=[],this.result={}},PM.Lib.SeqManager.prototype.Add=function(t){var e=new PM.Lib.SeqItem;e.func=t,this.seq_array.push(e)},PM.Lib.SeqManager.prototype.Connect=function(t,e){$.when(e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.ConnectArray=function(t,e){$.when.apply($,e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.Run=function(t,e){for(var r=this,o=0;o<r.seq_array.length;o++){var i=function(o,i){$.when(o.deferred).then(function(){void 0==i?t(r.result):(r.result.deferred=i.deferred,i.func(r.result))},function(){e(r.result)})};i(r.seq_array[o],r.seq_array[o+1])}r.seq_array.length>0?(r.result.deferred=r.seq_array[0].deferred,r.seq_array[0].func(r.result)):t(r.result)},PM.Record=function(t,e,r,o,i){this.type=t,this.pair_pos=e,this.old_info=r,this.new_info=o,this.desc=i},PM.Record.prototype.GetPageFromIndex=function(t){var e=null;if(t>=0)e=PM.Editor.Framework.GetProduct().page_array[t];else switch(t){case PM.PAGE.COVER_FRONT:e=PM.Editor.Framework.GetProduct().cover.front_page;break;case PM.PAGE.COVER_MIDDLE:e=PM.Editor.Framework.GetProduct().cover.middle_page;break;case PM.PAGE.COVER_BACK:e=PM.Editor.Framework.GetProduct().cover.back_page}return e},PM.Record.prototype.ChangeBackground=function(t,e){for(var r=[],o=0;o<e.length;o++){var i=e[o],a=this.GetPageFromIndex(t+o);a&&r.push(i.skin_link.length>0?a.ChangeSkin(i.skin_link):a.ChangeColor(i.color))}$.when.apply($,r).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.ChangeLayout=function(t,e){for(var r=[],o=0;o<e.length;o++){var i=e[o],a=this.GetPageFromIndex(t+o);if(a){var s=JSON.parse(i);r.push(a.LoadJson(s))}}$.when.apply($,r).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.InsertLayer=function(t,e,r){var o=this.GetPageFromIndex(t);o&&o.layer_array.splice(e,0,r)},PM.Record.prototype.DeleteLayer=function(t,e){var r=null,o=this.GetPageFromIndex(t);return o&&(r=o.layer_array[e],o.layer_array.splice(e,1)),r},PM.Record.prototype.MoveLayer=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var r=e.layer_array[t.layer_pos];r&&(r.SetMoveInfo(t.data),r.GetType()==PM.TYPE.TEXT&&r.RecalcTBoxSize(!0))}},PM.Record.prototype.SwapLayer=function(t,e,r){var o=this.GetPageFromIndex(t);if(o){var i=o.layer_array[e];o.layer_array[e]=o.layer_array[r],o.layer_array[r]=i}},PM.Record.prototype.ReorderLayer=function(t,e,r){var o=this.GetPageFromIndex(t);if(o){var i=o.layer_array[r];o.layer_array.splice(r,1),o.layer_array.splice(e,0,i)}},PM.Record.prototype.ChangeFrame=function(t){var e=t.data;if(e.length>0){var r=this.GetPageFromIndex(t.page_pos);if(r){var o=r.layer_array[t.layer_pos];if(o.GetType()==PM.TYPE.IMAGE){var i=e[0];i.value.length>0?o.AddDiagram(i.value):o.DeleteDiagram()}}}},PM.Record.prototype.ChangePhoto=function(t){var e=t.data;if(e.length>0){var r=this.GetPageFromIndex(t.page_pos);if(r){var o=r.layer_array[t.layer_pos];if(o.GetType()==PM.TYPE.IMAGE){var i=e[0];o.SetPhotoState(i.value)}}}},PM.Record.prototype.CropPhoto=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var r=e.layer_array[t.layer_pos];r&&r.SetCropInfo(t.data)}},PM.Record.prototype.AddAllPhotos=function(t,e){for(var r=[],o=t.data,i=0;i<o.length;i++){var a=this.GetPageFromIndex(o[i].page_pos);if(a){var s=a.layer_array[o[i].layer_pos];if(s&&s.GetType()==PM.TYPE.IMAGE)if(e){var n=JSON.parse(o[i].json),h=n.url_domain+n.url_path+n.url_edit,l=n.url_domain+n.url_path+n.url_file,c=n.img_width,p=n.img_height,d=!1,u=s.AddPhoto(h,l,c,p,d);u.added&&r.push(u.promise)}else{var _=s.SetPhotoState(o[i].info);r.push(_)}}}$.when.apply($,r).then(function(){PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},function(){})},PM.Record.prototype.DeleteAllPhotos=function(t){for(var e=t.data,r=0;r<e.length;r++){var o=this.GetPageFromIndex(e[r].page_pos);if(o){var i=o.layer_array[e[r].layer_pos];i&&i.GetType()==PM.TYPE.IMAGE&&i.DeletePhotoProp()}}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Record.prototype.UndoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:var e=PM.Editor.Framework.GetProduct(),r=this.new_info.data;e.page_array.splice(this.new_info.page_pos,r.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:for(var e=PM.Editor.Framework.GetProduct(),r=this.old_info.data,o=r.length-1;o>=0;o--)e.page_array.splice(this.old_info.page_pos,0,r[o]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),r=this.new_info.data,i=[],o=0;o<r.length;o++){var a=r[o];i[a]=e.page_array[o]}e.page_array=i,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_LAYER_INSERT:this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);break;case PM.RECORD_LAYER_DELETE:var r=this.old_info.data;if(r.length>0){var s=r[0];this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,s.value)}break;case PM.RECORD_EMPTYLAYERS_DELETE:for(var r=this.old_info.data,o=r.length-1;o>=0;o--){var s=r[o];this.InsertLayer(s.page_pos,s.layer_pos,s.data)}PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);n&&this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);this.MoveLayer(this.old_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.old_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.old_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.old_info);break;case PM.RECORD_PHOTO_ADDALL:this.DeleteAllPhotos(this.new_info);break;case PM.RECORD_PHOTO_DELALL:this.AddAllPhotos(this.old_info,!1);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.old_info.data,this.old_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Undo(this.old_info.data.text_data),l.SetMoveInfo(this.old_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Record.prototype.RedoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:for(var e=PM.Editor.Framework.GetProduct(),r=this.new_info.data,o=r.length-1;o>=0;o--)e.page_array.splice(this.new_info.page_pos,0,r[o]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:var e=PM.Editor.Framework.GetProduct(),r=this.old_info.data;e.page_array.splice(this.old_info.page_pos,r.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),r=this.new_info.data,i=[],o=0;o<r.length;o++){var a=r[o];i.push(e.page_array[a])}e.page_array=i,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_LAYER_INSERT:var r=this.new_info.data;if(r.length>0){var s=r[0];this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,s.value)}break;case PM.RECORD_LAYER_DELETE:this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);break;case PM.RECORD_EMPTYLAYERS_DELETE:for(var r=this.old_info.data,o=0;o<r.length;o++){var s=r[o];this.DeleteLayer(s.page_pos,s.layer_pos,s.data)}PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);n&&this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.new_info.page_pos,this.new_info.layer_pos,this.old_info.layer_pos);this.MoveLayer(this.new_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.new_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.new_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.new_info);break;case PM.RECORD_PHOTO_ADDALL:this.AddAllPhotos(this.new_info,!0);break;case PM.RECORD_PHOTO_DELALL:this.DeleteAllPhotos(this.old_info);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.new_info.data,this.new_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Redo(this.new_info.data.text_data),l.SetMoveInfo(this.new_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Util=new function(){this.P2LPoint=function(t,e){return t.x/=e,t.y/=e,t},this.P2LSize=function(t,e){return t.w/=e,t.h/=e,t},this.P2LRect=function(t,e){return t.l/=e,t.t/=e,t.w/=e,t.h/=e,t},this.L2PPoint=function(t,e){return t.x*=e,t.y*=e,t},this.L2PSize=function(t,e){return t.w*=e,t.h*=e,t},this.L2PRect=function(t,e){return t.l*=e,t.t*=e,t.w*=e,t.h*=e,t},this.PtInRect=function(t,e,r){return e>=t.l&&e<=t.l+t.w&&r>=t.t&&r<=t.t+t.h?!0:!1},this.PtInCircle=function(t,e,r,o,i){var a={l:t-r,t:e-r,w:2*r,h:2*r};return this.PtInRect(a,o,i)},this.ToRadian=function(t){return t*Math.PI/180},this.ToAngle=function(t){return 180*t/Math.PI},this.DrawLine=function(t,e,r,o,i,a,s){t.beginPath(),t.lineWidth=a,t.strokeStyle=s,t.moveTo(e,r),t.lineTo(o,i),t.stroke(),t.closePath()},this.DrawRect=function(t,e,r,o,i,a,s,n){t.lineWidth=a,t.strokeStyle=s,t.strokeRect(e,r,o,i),n&&(t.fillStyle=n,t.fillRect(e,r,o,i))},this.DrawCircle=function(t,e,r,o,i,a,s){t.beginPath(),t.lineWidth=i,t.strokeStyle=a,s&&(t.fillStyle=s),t.arc(e,r,o,0,2*Math.PI,!1),t.stroke(),s&&t.fill(),t.closePath()},this.DrawDashLine=function(t,e,r,o,i,a,s){var n=t.getLineDash();t.setLineDash([4,4]),this.DrawLine(t,e,r,o,i,a,s),t.setLineDash(n)},this.DrawDashRect=function(t,e,r,o,i,a,s,n){var h=t.getLineDash();t.setLineDash([4,4]),this.DrawRect(t,e,r,o,i,a,s,n),t.setLineDash(h)},this.GetFullPathName=function(t,e){return e.indexOf("colorempty.png")>=0?"":t+e},this.ToHexColor=function(t,e,r){if(!t||!e||!r)return"";var o=parseInt(t,10).toString(16),i=parseInt(e,10).toString(16),a=parseInt(r,10).toString(16);return o=1==o.length?"0"+o:o,i=1==i.length?"0"+i:i,a=1==a.length?"0"+a:a,"#"+o+i+a},this.String2HexColor=function(t){var e=t.split(",");return e.length<4?"#000000":this.ToHexColor(e[1],e[2],e[3])},this.GetWebFont=function(t){for(var e in PM.CONFIG.FONT_POOL)if(t==PM.CONFIG.FONT_POOL[e])return t;return PM.CONFIG.FONT_DEFAULT},this.LoadWebFont=function(t,e){t=this.GetWebFont(t);var r=PM.CONFIG.FONT_PATH[t];r.length<=0||WebFont.load({timeout:6e3,custom:{families:[t],urls:[r]},loading:function(){},inactive:function(){console.error("webfont inactive!!!! "+t+" "+Date.now()),PM.Editor.Framework.ShowMessageBar("웹폰트를 로드할 수 없습니다.")},active:e})},this.LoadXml=function(t){var e=$.Deferred();return $.ajax({type:"get",dataType:"xml",timeout:2e4,url:t,success:function(t,r,o){e.resolve(t,r,o)},error:function(t,r,o){e.reject(t,r,o)}}),e.promise()},this.LoadImage=function(t){var e=$.Deferred(function(e){if(null==t||t.length<=0)e.resolve(null);else{var r=new Image;r.crossOrigin="Anonymous",r.onload=function(){e.resolve(r)},r.onerror=function(){e.reject()},r.src=t,(r.complete||void 0===r.complete)&&(r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",r.src=t)}});return e.promise()},this.CanvasToImage=function(t){var e=null;try{e=t.toDataURL("image/jpeg",1)}catch(r){e=null,console.error(r)}return e},this.GetCenterPos=function(t,e,r,o){var i=0,a=0;return t>=r&&(i=t/2-r/2),e>=o&&(a=e/2-o/2),{x:i,y:a}},this.GetScale=function(t,e,r,o,i){var a=t/r,s=e/o,n=i?Math.min(a,s):Math.max(a,s);return n},this.GetScaledRect=function(t,e,r,o,i){var a=this.GetScale(t,e,r,o,i),s=r*a,n=o*a,h=(t-s)/2,l=(e-n)/2,c={l:-h/a,t:-l/a,w:t/a,h:e/a};return c.l<0&&(c.l=0),c.t<0&&(c.t=0),c.l+c.w>r&&(c.w=r-c.l),c.t+c.h>o&&(c.h=o-c.t),c},this.IsMacintosh=function(){var t=navigator.userAgent;return t.indexOf("Macintosh")>=0||t.indexOf("Mac OS")>=0?!0:!1},this.ProductSize2SizeId=function(t){var e=t,r=-1;switch(e){case"6x6":r=PM.SIZE6X6;break;case"6x8":case"a5h":r=PM.SIZE6X8;break;case"8x6":case"a5w":r=PM.SIZE8X6;break;case"8x8":r=PM.SIZE8X8;break;case"8x11":case"a4h":r=PM.SIZE8X11;break;case"11x8":case"a4w":r=PM.SIZE11X8;break;case"10x10":r=PM.SIZE10X10}return r},this.ProductSize2InchSize=function(t){var e={w:0,h:0},r=this.ProductSize2SizeId(t);switch(r){case PM.SIZE6X6:e.w=6,e.h=6;break;case PM.SIZE6X8:e.w=6,e.h=8;break;case PM.SIZE8X6:e.w=8,e.h=6;break;case PM.SIZE8X8:e.w=8,e.h=8;break;case PM.SIZE8X11:e.w=8,e.h=11;break;case PM.SIZE11X8:e.w=11,e.h=8;break;case PM.SIZE10X10:e.w=10,e.h=10}return e};var t=0;this.CalcFps=function(){var e=new Date,r=1e3/(e-t);return t=e,r},this.IsValidURL=function(t){return t&&t.length>0&&(t=t.toLowerCase(),t.indexOf("http://")>=0||t.indexOf("https://")>=0)?!0:!1},this.replaceEscapeChar=function(t){var e=t;return e=e.replace(/"/gi,'\\"')}},X={},X.ENTERKEY="¶",X.COLOR_CARET="rgba(255, 0, 0, 0.5)",X.COLOR_ULINE="rgba(0, 0, 0, 1)",X.COLOR_BLOCK="rgba(0, 0, 255, 0.5)",X.COLOR_BLOCK_KILLFOCUS="rgba(0, 0, 255, 0.0)",X.RECORD_OFF=0,X.RECORD_INS=1,X.RECORD_DEL=2,X.RECORD_REPL=3,X.RECORD_ATTR=4,X.RECORD_PARA=5,X.RECORD_VALIGN=6,X.MARGIN_H=5;var check_bbox=!1,xpoint=function(t,e){this.x=t,this.y=e};xpoint.prototype={clone:function(){var t=new xpoint;return t.x=this.x,t.y=this.y,t}};var xrect=function(t,e,r,o){this.l=t,this.t=e,this.r=r,this.b=o};xrect.prototype={clone:function(){var t=new xrect;return t.l=this.l,t.t=this.t,t.r=this.r,t.b=this.b,t},width:function(){return this.r-this.l},height:function(){return this.b-this.t}};var xattr_filter=function(t){this.bold=t,this.italic=t,this.underline=t,this.point=t,this.facename=t,this.charw=t,this.textcolor=t,this.strokecolor=t,this.shadowcolor=t},xattr=function(){this.bold=!1,this.italic=!1,this.underline=!1,this.point=12,this.facename="",this.charw=100,this.textcolor="#000000",this.strokecolor="",this.shadowcolor="",this.ascent=0,this.descent=0};xattr.prototype={clone:function(){var t=new xattr;return t.bold=this.bold,t.italic=this.italic,t.underline=this.underline,t.point=this.point,t.facename=this.facename,t.charw=this.charw,t.textcolor=this.textcolor,t.strokecolor=this.strokecolor,t.shadowcolor=this.shadowcolor,t.ascent=this.ascent,t.descent=this.descent,t},loaddata:function(t){this.bold=t.bold,this.italic=t.italic,this.underline=t.underline,this.point=t.point,this.facename=t.facename,this.charw=t.charw,this.textcolor=t.textcolor,this.strokecolor=t.strokecolor,this.shadowcolor=t.shadowcolor;var e=this.facename;PM.Util.LoadWebFont(e,function(){console.log("[xdoc-load] webfont loaded... "+e+" "+Date.now())});var r=getbaselineinfo(this.facename,this.point);this.ascent=r.ascent,this.descent=r.descent},toJSON:function(){var t="  {";return t+='"bold":'+this.bold,t+=', "italic":'+this.italic,t+=', "underline":'+this.underline,t+=', "point":'+this.point,t+=', "facename":"'+this.facename+'"',t+=', "charw":"'+this.charw+'"',t+=', "textcolor":"'+this.textcolor+'"',t+=', "strokecolor":"'+this.strokecolor+'"',t+=', "shadowcolor":"'+this.shadowcolor+'"',t+="}"},set_prop:function(t,e){if(e.bold&&(this.bold=t.bold),e.italic&&(this.italic=t.italic),e.underline&&(this.underline=t.underline),e.point&&(this.point=t.point),e.facename&&(this.facename=t.facename),e.charw&&(this.charw=t.charw),e.textcolor&&(this.textcolor=t.textcolor),e.strokecolor&&(this.strokecolor=t.strokecolor),e.shadowcolor&&(this.shadowcolor=t.shadowcolor),e.point||e.facename){var r=getbaselineinfo(this.facename,this.point);this.ascent=r.ascent,this.descent=r.descent}},is_equal:function(t){return this.bold!=t.bold?!1:this.italic!=t.italic?!1:this.underline!=t.underline?!1:this.point!=t.point?!1:this.facename!=t.facename?!1:this.charw!=t.charw?!1:this.textcolor!=t.textcolor?!1:this.strokecolor!=t.strokecolor?!1:this.shadowcolor!=t.shadowcolor?!1:!0}};var xattr_pool=function(){this.array={}};xattr_pool.prototype.clone=function(){var t=new xattr_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xattr_pool.prototype.add_nodup=function(t){var e=-1;for(var r in this.array)if(this.array[r].is_equal(t)){e=r,t=null;break}if(0>e){var o=getbaselineinfo(t.facename,t.point);t.ascent=o.ascent,t.descent=o.descent,e=get_key(this.array),this.array[e]=t}return e},xattr_pool.prototype.toJSON=function(){var t=0,e=0;for(var r in this.array)e++;var o='"attr_pool": {\n';for(var i in this.array)o+='"'+i+'":',o+=this.array[i].toJSON(),e-1>t&&(o+=","),o+="\n",t++;return o+="}"},xattr_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var r=parseInt(e);this.array[r]=new xattr,this.array[r].loaddata(t[e])}};var xpara_filter=function(t){this.align=t,this.linegap=t,this.paragap=t},xpara=function(){this.align=4,this.linegap=5,this.paragap=0};xpara.prototype={clone:function(){var t=new xpara;return t.align=this.align,t.linegap=this.linegap,t.paragap=this.paragap,t},loaddata:function(t){this.align=t.align,this.linegap=t.linegap,this.paragap=t.paragap},toJSON:function(){var t="  {";return t+='"align":'+this.align,t+=', "linegap":'+this.linegap,t+=', "paragap":'+this.paragap,t+=" }"},set_prop:function(t,e){e.align&&(this.align=t.align),e.linegap&&(this.linegap=t.linegap),e.paragap&&(this.paragap=t.paragap)},is_equal:function(t){return this.align!=t.align?!1:this.linegap!=t.linegap?!1:this.paragap!=t.paragap?!1:!0}};var xpara_pool=function(){this.array={}};xpara_pool.prototype.clone=function(){var t=new xpara_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xpara_pool.prototype.add_nodup=function(t){var e=-1;for(var r in this.array)if(this.array[r].is_equal(t)){e=r,t=null;break}return 0>e&&(e=get_key(this.array),this.array[e]=t),e},xpara_pool.prototype.toJSON=function(){var t=0,e=0;for(var r in this.array)e++;var o='"para_pool": {\n';for(var i in this.array)o+='"'+i+'":',o+=this.array[i].toJSON(),e-1>t&&(o+=","),o+="\n",t++;return o+="}"},xpara_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var r=parseInt(e);this.array[r]=new xpara,this.array[r].loaddata(t[e])}};var xcodeinfo=function(){this.code="",this.width=0,this.ascent=0,this.descent=0,this.x=0,this.y=0,this.step_w=0};xcodeinfo.prototype={clone:function(){var t=new xcodeinfo;return t.code=this.code,t.width=this.width,t.ascent=this.ascent,t.descent=this.descent,t.x=this.x,t.y=this.y,t.step_w=this.step_w,t}};var xline=function(){this.begin=0,this.end=0,this.total_w=0,this.remain_w=0,this.max_ascent=0,this.max_descent=0,this.gap=0,this.is_lastline,this.ci_array=null},xlines=function(){this.array=new Array};xlines.prototype={pos2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0;e<this.array.length;e++){var r=this.array[e];
if(t>=r.begin&&t<=r.end)return e}return-1},point2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0,r=0;r<this.array.length;r++){var o=this.array[r],i=o.max_ascent+o.max_descent+o.gap;if(e+i>t)return r;e+=i}return this.array.length-1},gettotalheight:function(){for(var t=0,e=0;e<this.array.length;e++){var r=this.array[e],o=r.max_ascent+r.max_descent+r.gap;t+=o}return t},getlinerect:function(t,e){if(this.array.length<=0)return new xrect(0,0,0,0);if(0>t)return new xrect(0,0,0,0);if(t>=this.array.length)return new xrect(0,0,0,0);for(var r=0,o=new xrect(0,0,0,0),i=0;i<this.array.length;i++){var a=this.array[i];if(o.r=o.l+(a.total_w-a.remain_w),o.b=o.t+(a.max_ascent+a.max_descent+a.gap),r=a.gap,i==t)break;o.t=o.b}return e||(o.b-=r),o}};var xsel_state=function(){this.inspos=-1,this.attrid=-1};xsel_state.prototype={reset:function(){this.inspos=-1,this.attrid=-1},clone:function(){var t=new xsel_state;return t.inspos=this.inspos,t.attrid=this.attrid,t},setstate:function(t,e){this.inspos=t,this.attrid=e},getinspos:function(){return this.inspos},getattrid:function(){return this.attrid}};var xpos=function(t,e){this.pivot=t,this.move=e};xpos.prototype={init:function(){this.pivot=0,this.move=0},clone:function(){var t=new xpos(0,0);return t.pivot=this.pivot,t.move=this.move,t},isblock:function(){return this.pivot<0||this.move<0?!1:this.pivot!=this.move},setpos:function(t){this.pivot=t,this.move=t},getpivot:function(){return this.pivot},getmove:function(){return this.move},setpivot:function(t){this.pivot=t},setmove:function(t){this.move=t},setleft:function(){var t=this.pivot<=this.move?this.pivot:this.move;this.pivot=this.move=t},setright:function(){var t=this.pivot>this.move?this.pivot:this.move;this.pivot=this.move=t},moveleft:function(t){if(this.isblock())this.setleft();else{if(this.pivot<=t)return!1;this.pivot--,this.move=this.pivot}return!0},moveright:function(t){if(this.isblock())this.setright();else{if(this.pivot>=t)return!1;this.pivot++,this.move=this.pivot}return!0},blockmoveleft:function(t){return this.move<=t?!1:(this.move--,!0)},blockmoveright:function(t){return this.move>=t?!1:(this.move++,!0)},getblock:function(){if(this.isblock()){var t=this.pivot<=this.move?this.pivot:this.move,e=this.pivot>this.move?this.pivot:this.move;return{left:t,right:e-1}}return{left:-1,right:-1}},setblock:function(t,e){return 0>t||0>e?!1:(this.pivot=t,this.move=e,this.pivot<this.move)}};var xcaret=function(){this.visible=!1,this.base_x=0,this.rect=new xrect(0,0,0,0)};xcaret.prototype={is_show:function(){return this.visible},show:function(t){this.visible=t},getbase_x:function(){return this.base_x},setbase_x:function(t){this.base_x=t},getrect:function(){return this.rect.clone()},setrect:function(t){this.rect=null,this.rect=t.clone()},display:function(t,e,r){0!=this.visible&&(t.save(),t.fillStyle=X.COLOR_CARET,t.fillRect(this.rect.l+e,this.rect.t+r,this.rect.width(),this.rect.height()),t.restore())}};var xop=function(t,e,r,o){this.type=t,this.pos=e,this.del=r,this.ins=o},xdoc=function(){this.is_singleline=!1,this.strings=[],this.offsets=[],this.attr_pool=new xattr_pool,this.para_pool=new xpara_pool,this.lines=new xlines,this.sel_state=new xsel_state,this.strings.push(X.ENTERKEY),this.offsets.push(0),this.attr_pool.array[0]=new xattr,this.para_pool.array[0]=new xpara};xdoc.prototype={clone:function(){var t=new xdoc;return t.strings=this.strings.slice(0),t.offsets=this.offsets.slice(0),t.attr_pool=this.attr_pool.clone(),t.para_pool=this.para_pool.clone(),t},setdefault:function(t,e){null!=t&&(this.attr_pool.array[0]=t),null!=e&&(this.para_pool.array[0]=e)},delete_unused:function(){var t={},e={};for(var r in this.attr_pool.array)t[r]=0;for(var r in this.para_pool.array)e[r]=0;for(var r=0;r<this.offsets.length;r++){var o=this.offsets[r];this.strings[r]==X.ENTERKEY?e[o]=1:t[o]=1}t[0]=e[0]=1;for(var r in this.attr_pool.array)0==t[r]&&delete this.attr_pool.array[r];for(var r in this.para_pool.array)0==e[r]&&delete this.para_pool.array[r]},loaddata:function(t){this.strings=t.strings,this.offsets=t.offsets,this.attr_pool.loaddata(t.attr_pool),this.para_pool.loaddata(t.para_pool)},toString:function(){for(var t="",e=0;e<this.strings.length-1;e++)t+=this.strings[e];return t=PM.Util.replaceEscapeChar(t)},toJSON:function(){var t="{\n";t+='"strings": [\n';for(var e=0;e<this.strings.length;e++){var r=PM.Util.replaceEscapeChar(this.strings[e]);t+='"'+r+'"',e<this.strings.length-1&&(t+=",")}t+="],\n",t+='"offsets": [\n';for(var e=0;e<this.offsets.length;e++)t+=this.offsets[e],e<this.offsets.length-1&&(t+=",");return t+="],\n",t+=this.attr_pool.toJSON()+",\n",t+=this.para_pool.toJSON()+"\n",t+="}\n"},toJSONEx:function(t,e){var r="{\n";r+='"strings": [\n';for(var o=0;o<this.strings.length;o++){var i=PM.Util.replaceEscapeChar(this.strings[o]);r+='"'+i+'"',o<this.strings.length-1&&(r+=",")}r+="],\n",r+='"offsets": [\n';for(var o=0;o<this.offsets.length;o++)r+=this.offsets[o],o<this.offsets.length-1&&(r+=",");return r+="],\n",r+=this.attr_pool.toJSON()+",\n",r+=this.para_pool.toJSON()+"\n",r+=",\n"+this.toCoordinatesJSON(t,e)+"\n",r+="}\n"},toCoordinatesJSON:function(t,e){for(var r='"coordinates": [\n',o=e+X.MARGIN_H,i=0;i<this.lines.array.length;){for(var a=this.lines.array[i++],s=a.begin;s<=a.end;){var n=a.ci_array[s-a.begin],h=n.x,l=o+n.y,c=n.width,p=n.ascent+n.descent,d=n.ascent;r+="{ ",r+='"x": '+h.toFixed(2)+", ",r+='"y": '+l.toFixed(2)+", ",r+='"w": '+c.toFixed(2)+", ",r+='"h": '+p.toFixed(2)+", ",r+='"ascent": '+d.toFixed(2),r+="}",s++,s<this.strings.length&&(r+=","),r+="\n"}var u=a.max_ascent+a.max_descent+a.gap;o+=u}return r+="]"},toSVG:function(){this.delete_unused();var t='<?xml version="1.0" encoding="utf-8"?>\n';t+='<svg xmlns="http://www.w3.org/2000/svg" ',t+='width="'+canvas.width+'px" height="'+canvas.height+'px">\n';for(var e=0;e<this.lines.array.length;)for(var r=this.lines.array[e++],o=r.begin;o<=r.end;){var i=r.ci_array[o-r.begin],a=this.strings[o];if(a!=X.ENTERKEY){t+="<text ";var s=this.getattr(o);t+='x="'+i.x+'" ',t+='y="'+(i.y+i.ascent+i.descent)+'" ',t+='style="',t+="font-family:"+s.facename+";",t+="font-size:"+s.point+"pt;",t+="fill:"+s.textcolor+";",t+=""!=s.strokecolor?"stroke:"+s.strokecolor+";":"",t+=s.bold?"font-weight:bold;":"",t+=s.italic?"font-style:italic;":"",t+='"',t+=">",t+=a,t+="</text>\n"}o++}return t+="</svg>\n"},getlength:function(){return this.strings.length-1},getdocheight:function(){return this.lines.gettotalheight()+2*X.MARGIN_H},getdocwidth:function(){if(0<this.lines.array.length){var t=this.lines.array[0];return t.total_w}return 0},getalignedwidth:function(){if(this.lines.array.length>0){var t=this.lines.array[0];return t.total_w-t.remain_w}return 0},insertchars:function(t,e,r){if(0>t||t>=this.strings.length)return!1;if(e[0]==X.ENTERKEY&&1==r){var o=this.getpara(t-1),i=null!=o?o.clone():new xpara,a=get_key(this.para_pool.array);this.para_pool.array[a]=i,this.strings.splice(t,0,X.ENTERKEY),this.offsets.splice(t,0,a)}else{var s=0;s=t==this.sel_state.getinspos()?this.sel_state.getattrid():this.getattrid(t-1);for(var n=t,h=0;r>h;h++)this.strings.splice(n,0,e[h]),this.offsets.splice(n,0,s),n++}return t!=this.sel_state.getinspos()&&this.sel_state.reset(),!0},insertdoc:function(t,e){if(0>t||t>=this.strings.length)return!1;var r=e.clone(),o={};for(var i in r.attr_pool.array)o[i]=this.attr_pool.add_nodup(r.attr_pool.array[i]);var a={};for(var i in r.para_pool.array){var s=get_key(this.para_pool.array);this.para_pool.array[s]=r.para_pool.array[i],a[i]=s}for(var i=0;i<r.offsets.length;i++){var n=r.offsets[i];r.offsets[i]=r.strings[i]==X.ENTERKEY?a[n]:o[n]}for(var h=t,i=0;i<r.strings.length;i++)this.strings.splice(h,0,r.strings[i]),this.offsets.splice(h,0,r.offsets[i]),h++;this.delete_unused()},deletechars:function(t,e){return 0>t||t+e>this.getlength()?!1:(this.strings.splice(t,e),this.offsets.splice(t,e),t!=this.sel_state.getinspos()&&this.sel_state.reset(),e>2&&this.delete_unused(),!0)},getblockdoc:function(t,e){if(t>=0&&e>=t&&e<this.strings.length-1){var r=new xdoc;r.strings=this.strings.slice(t,e+1),r.offsets=this.offsets.slice(t,e+1);for(var o=t;e+1>o;o++){var i=this.offsets[o];this.strings[o]==X.ENTERKEY?r.para_pool.array[i]=this.para_pool.array[i].clone():r.attr_pool.array[i]=this.attr_pool.array[i].clone()}return r}return null},getblocktext:function(t,e){return t>=0&&e>t&&e<this.strings.length?this.strings.slice(t,e+1).join(""):""},getattrid:function(t){for(;t>=0;){var e=this.strings[t];if(e!=X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getparaid:function(t){for(;t>=0;){var e=this.strings[t];if(e==X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getattr:function(t){var e=this.getattrid(t);return this.attr_pool.array.hasOwnProperty(e)?this.attr_pool.array[e]:null},getpara:function(t){var e=this.getparaid(t);return this.para_pool.array.hasOwnProperty(e)?this.para_pool.array[e]:null},getattrstate:function(t){if(t>=0&&t<this.strings.length){var e=this.getattr(t-1);if(e){var r=e.clone(),o=new xattr_filter(!0);return{attr:r,filter:o}}}return{attr:null,filter:null}},getparastate:function(t){if(t>=0&&t<this.strings.length){var e=this.getpara(t-1);if(e){var r=e.clone(),o=new xpara_filter(!0);return{para:r,filter:o}}}return{para:null,filter:null}},getblockattrstate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var r=this.getattr(t);if(r){for(var o=r.clone(),i=new xattr_filter(!0),a=t+1;e>=a;a++){var s=this.getattr(a);r.bold!=s.bold&&(i.bold=!1),r.italic!=s.italic&&(i.italic=!1),r.point!=s.point&&(i.point=!1),r.facename!=s.facename&&(i.facename=!1),r.charw!=s.charw&&(i.charw=!1),r.textcolor!=s.textcolor&&(i.textcolor=!1),r.strokecolor!=s.strokecolor&&(i.strokecolor=!1),r.shadowcolor!=s.shadowcolor&&(i.shadowcolor=!1)}return{attr:o,filter:i}}}return{attr:null,filter:null}},getblockparastate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var r=this.getpara(t);if(r){for(var o=r.clone(),i=new xpara_filter(!0),a=t+1;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.getpara(a);r.align!=n.align&&(i.align=!1),r.linegap!=n.linegap&&(i.linegap=!1),r.paragap!=n.paragap&&(i.paragap=!1)}}return{para:o,filter:i}}}return{para:null,filter:null}},setattrstate:function(t,e,r){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var o=null;if(r){var i=this.getattr(t-1);i&&(o=i.clone(),o.set_prop(e,r))}else o=e.clone();var a=this.attr_pool.add_nodup(o);return this.sel_state.setstate(t,a),!0},setparastate:function(t,e,r){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var o=this.getpara(t-1);return o?(o.set_prop(e,r),!0):!1},setblockattrstate:function(t,e,r,o){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==r)return!1;if(o)for(var i=new Array,a=new Array,s=t;e>=s;s++){var n=this.strings[s];if(n!=X.ENTERKEY){for(var h=this.offsets[s],l=!1,c=0;c<i.length;c++)if(h==a[c]){var p=a[c];this.offsets[s]=p,l=!0;break}if(!l){var d=this.attr_pool.array[h],u=d.clone();u.set_prop(r,o);var p=this.attr_pool.add_nodup(u);this.offsets[s]=p,i.push(h),a.push(p)}}}else for(var u=r.clone(),_=this.attr_pool.add_nodup(u),s=t;e>=s;s++){var n=this.strings[s];n!=X.ENTERKEY&&(this.offsets[s]=_)}return!0},setblockparastate:function(t,e,r,o){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==r)return!1;if(this.setparastate(t,r,o)){for(var i=t;e>=i;i++){var a=this.strings[i];if(a==X.ENTERKEY){var s=this.offsets[i];if(this.para_pool.array.hasOwnProperty(s)){var n=this.para_pool.array[s];n.set_prop(r,o)}}}return!0}return!1},getselparas:function(t,e){if(!(0>t)){var r=[],o=this.getpara(t-1);if(o){r.push(o.clone());for(var i=t;e>=i;i++)if(this.strings[i]==X.ENTERKEY){var a=this.offsets[i];this.para_pool.array.hasOwnProperty(a)&&(o=this.para_pool.array[a],o&&r.push(o.clone()))}return r}return null}},setselparas:function(t,e,r){if(!(0>t)){var o=new xpara_filter(!0);if(this.setparastate(t,r[0],o))for(var i=1,a=t;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.offsets[a];if(this.para_pool.array.hasOwnProperty(n)){var h=this.para_pool.array[n];h.set_prop(r[i],o)}i++}}}},is_dbcs:function(t){var e=t.charCodeAt();return e>=4352&&4607>=e?!0:e>=12592&&12687>=e?!0:e>=44032&&55203>=e?!0:!1},preparedc:function(t,e){if(this.attr_pool.array.hasOwnProperty(e)){var r=this.attr_pool.array[e];if(r){var o=r.bold?"bold ":"";o+=r.italic?"italic ":"",t.font=o+r.point+"pt '"+r.facename+"'",t.fillStyle=r.textcolor,t.strokeStyle=r.strokecolor,""!=r.strokecolor&&(t.lineWidth=1),t.shadowColor=r.shadowcolor,""!=r.shadowcolor&&(t.shadowOffsetX=3,t.shadowOffsetY=2),t.textAlign="left",t.textBaseline="alphabetic"}}},getcodeinfo:function(t,e,r,o,i){var a=this.getattrid(e);this.prev_attr_id!=a&&(this.preparedc(t,a,this.is_dbcs(r)),this.prev_attr_id=a);var s=this.getattr(e);if(s){var n=t.measureText(r);if(o.code=r,o.width=n.width*s.charw/100,!i||s.ascent<=0||s.descent<=0){var h=getbaselineinfo(s.facename,s.point);s.ascent=h.ascent,s.descent=h.descent}o.ascent=s.ascent,o.descent=s.descent,o.x=0,o.y=0,r==X.ENTERKEY&&(o.width=0)}},aligndoc:function(t,e,r){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0,this.lines=null,this.lines=new xlines;for(var o=0;;){var i=this.alignline(t,e,o,r);if(i>=this.strings.length)break;o=i}for(var a=0,s=0,n=0;n<this.lines.array.length;){{var h=this.lines.array[n++];h.max_ascent+h.max_descent+h.gap}this.alignlinexy(a,s,h)}return n+1}},alignline:function(t,e,r,o){var i=new xline;i.begin=r,i.end=r,i.total_w=e,i.remain_w=e,i.max_ascent=0,i.max_descent=0,i.gap=0,i.is_lastline=!1,i.ci_array=new Array;var a=this.getpara(r);a&&(i.gap=a.linegap);for(var s=r,n=r,h=0,l=0,c=!1;s<this.strings.length;){var p=this.strings[s],d=new xcodeinfo;if(this.getcodeinfo(t,s,p,d,o),i.ci_array.push(d),i.max_ascent<d.ascent&&(i.max_ascent=d.ascent),i.max_descent<d.descent&&(i.max_descent=d.descent),h+=d.width," "==p?(n=s,l+=h,h=0):1==c&&(n=s-1,l+=h-d.width,h=d.width),p==X.ENTERKEY||s>=this.strings.length-1){n=s,i.is_lastline=!0,a&&(i.gap+=a.paragap);break}if(!this.is_singleline&&l+h>e){if(s==r){l=e,n=s;break}n==r&&(l=h-d.width,n=s-1);for(var u=s;u>n;)i.ci_array.pop(),u--;break}s++,c=!1;var _=this.strings[s];this.is_dbcs(p)&&this.is_dbcs(_)&&(c=!0),this.is_dbcs(p)!=this.is_dbcs(_)&&(c=!0)}for(var u=n+1;u<this.strings.length&&" "==this.strings[u];){var g=d.clone();i.ci_array.push(g),u++}return n=u-1,i.end=n,this.lines.array.push(i),n+1},alignlinexy:function(t,e,r){if(!(r.begin>r.end)){var o=this.getpara(r.begin);if(null!=o){for(var i=r.ci_array.length-1;" "==r.ci_array[i].code;)i--;for(var a=0,s=0,n=0;i>=n;n++)" "==r.ci_array[n].code&&a++,s+=r.ci_array[n].width;r.remain_w=r.total_w-s;var h=0,l=0,c=t,p=e,d=p+r.max_ascent;switch(o.align){case 0:break;case 1:c=t+r.remain_w;break;case 2:c=t+r.remain_w/2;break;case 3:if(r.ci_array.length<=1)c=t+r.remain_w/2;else{var u=r.ci_array.length-1;1==r.is_lastline&&u--,h=r.remain_w/u}case 4:a>0&&(l=r.remain_w/a)}for(var n=0;i>=n;n++){var _=r.ci_array[n];switch(_.x=c,_.y=d-_.ascent,o.align){case 0:case 1:case 2:_.step_w=_.width,c+=_.step_w;break;case 3:_.step_w=_.width+h,c+=_.step_w;break;case 4:_.step_w=_.width," "!=_.code||r.is_lastline||(_.step_w+=l),c+=_.step_w}}for(var n=i+1;n<r.ci_array.length;n++){var _=r.ci_array[n];_.x=c,_.y=d-_.ascent}}}},display:function(t,e,r,o,i,a,s){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0;for(var n=r,h=n+o,l=e,c=X.MARGIN_H+r,p=0;p<this.lines.array.length;){var d=this.lines.array[p++],u=d.max_ascent+d.max_descent+d.gap;if(c+u>0&&this.displayline(t,l,c,d,i,a,s),c+=u,c>h)break}}},displayline:function(t,e,r,o,i,a,s){if(!(o.begin>o.end)){for(var n=-1,h=-1,l=-1,c=o.begin;c<=o.end;){var p=o.ci_array[c-o.begin];c==i&&(h=p.x),c==a&&(l=p.x+p.step_w);var d=this.strings[c];if(d!=X.ENTERKEY){var u=this.getattrid(c);if(this.prev_attr_id!=u&&(this.preparedc(t,u,this.is_dbcs(d)),this.prev_attr_id=u),t.fillText(d,p.x,r+p.y+p.ascent,p.width),""!=this.attr_pool.array[u].strokecolor&&t.strokeText(d,p.x,r+p.y+p.ascent,p.width),this.attr_pool.array[u].underline&&0>n&&(n=p.x),n>=0){var _=-1;this.attr_pool.array[u].underline?(c>=o.end||o.is_lastline&&this.strings[c+1]==X.ENTERKEY)&&(_=p.x+p.width):_=p.x,_>=0&&(t.save(),t.strokeStyle=X.COLOR_ULINE,t.beginPath(),t.moveTo(n,r+o.max_ascent+o.max_descent),t.lineTo(_,r+o.max_ascent+o.max_descent),t.stroke(),n=-1,t.restore())}1==check_bbox&&(t.beginPath(),t.rect(p.x,r+p.y,p.width,p.ascent+p.descent),t.moveTo(p.x,r+p.y+p.ascent),t.lineTo(p.x+p.width,r+p.y+p.ascent),t.stroke())}c++}t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(o.begin>=i&&o.begin<=a||o.end>=i&&o.begin<=a)&&(0>h&&(h=e),0>l&&(l=o.total_w),t.save(),t.fillStyle=s?X.COLOR_BLOCK:X.COLOR_BLOCK_KILLFOCUS,t.fillRect(h,r,l-h,o.max_ascent+o.max_descent+o.gap),t.restore())}},pos2linepos:function(t,e){var r=this.lines.pos2lineindex(t);if(r>=0){var o=this.lines.array[r];if(t>=o.begin&&t<=o.end)return 0==e?o.begin:o.end}return 0},pos2caretrect:function(t,e){var r=this.lines.pos2lineindex(t);if(0>r)return new xrect(0,0,0,0);var o=this.lines.array[r];t<o.begin&&(t=o.begin),t>o.end&&(t=o.end);var i=o.ci_array[t-o.begin].x,a=o.ci_array[t-o.begin].width,s=this.lines.getlinerect(r,!1);return s.l=i,s.r=e?i+a:s.l+1,s.t+=X.MARGIN_H,s.b+=X.MARGIN_H,s},point2caretrect:function(t,e){var r=-1,o=(new xrect(0,0,0,0),this.lines.point2lineindex(t.y));o+=e,0>o&&(o=0),o>=this.lines.array.length&&(o=this.lines.array.length-1);for(var i=this.lines.array[o],a=null,s=i.begin;s<=i.end&&(r=s,a=i.ci_array[s-i.begin],!(t.x<=a.x+a.width/2));s++);var n=this.lines.getlinerect(o,!1);return n.l=a.x,n.r=a.x+1,n.t+=X.MARGIN_H,n.b+=X.MARGIN_H,{rect:n,pos:r}},dump:function(){for(var t="",e=0;e<this.strings.length;e++)t+=this.strings[e]+",";for(var r="",e=0;e<this.offsets.length;e++)r+=this.offsets[e]+",";console.log("strings:\n"+t),console.log("offsets:\n"+r);for(var e in this.attr_pool.array){var o=this.attr_pool.array[e];console.log("attr_pool key:"+e+" value:"+o.facename+","+o.point+","+o.bold+","+o.italic)}for(var e in this.para_pool.array){var i=this.para_pool.array[e];console.log("para_pool key:"+e+" value:"+i.align+","+i.linegap+","+i.paragap)}console.log("<-- end of dump.\n")}};var xime=function(){this.cho_han=[12593,12594,12596,12599,12600,12601,12609,12610,12611,12613,12614,12615,12616,12617,12618,12619,12620,12621,12622],this.cho_eng=[114,82,115,101,69,102,97,113,81,116,84,100,119,87,99,122,120,118,103],this.jung_han=[12623,12624,12625,12626,12627,12628,12629,12630,12631,12632,12633,12634,12635,12636,12637,12638,12639,12640,12641,12642,12643],this.jung_eng=[107,111,105,79,106,112,117,80,104,0,0,0,121,110,0,0,0,98,109,0,108],this.jong_han=[0,12593,12594,12595,12596,12597,12598,12599,12601,12602,12603,12604,12605,12606,12607,12608,12609,12610,12612,12613,12614,12615,12616,12618,12619,12620,12621,12622],this.jong_eng=[0,114,82,0,115,0,0,101,102,0,0,0,0,0,0,0,97,113,0,116,84,100,119,99,122,120,118,103],this.cho_jong=[1,2,4,7,0,8,16,17,0,19,20,21,22,0,23,24,25,26,27],this.state=0,this.queue=[],this.last_comp=0,this.is_act=!1};xime.prototype={activate:function(t){this.is_act=t,this.state=0,this.queue=[],this.last_comp=-1},flush:function(){var t=this.last_comp;return this.state=0,this.queue=[],this.last_comp=-1,t},is_activate:function(){return this.is_act},is_composite:function(){return this.is_act&&this.last_comp>=0?!0:!1},composite:function(t){var e=this.cho_eng.indexOf(t),r=this.jung_eng.indexOf(t);if(t>=0&&0>e&&0>r)return this.state=0,{comp_end:this.last_comp,comp_update:-1};var o=-1,i=-1;switch(this.state){case 0:e>=0?(this.state=1,o=this.cho_han[e],this.queue.push(e)):(this.state=2,o=this.jung_han[r],this.queue.push(r));break;case 1:if(0>t)this.flush();else if(e>=0){var a=this.comp_conx(this.queue[this.queue.length-1],e);a>=0?(this.state=3,o=this.jong_han[a],this.queue.pop(),this.queue.push(a)):(this.state=1,i=this.cho_han[this.queue.shift()],o=this.cho_han[e],this.queue.push(e))}else this.state=4,o=44032+588*this.queue[0]+28*r+0,this.queue.push(r);break;case 2:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),o=this.jung_han[this.queue[0]],this.state=2}else this.flush()}else if(e>=0)this.state=1,i=this.jung_han[this.queue.shift()],o=this.cho_han[e],this.queue.push(e);else{var a=this.comp_vowx(this.queue[this.queue.length-1],r);a>=0?(this.state=2,o=this.jung_han[a],this.queue.pop(),this.queue.push(a)):(this.state=2,i=this.jung_han[this.queue.shift()],o=this.jung_han[r],this.queue.push(r))}break;case 3:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(a.prev),o=this.cho_han[this.queue[0]],this.state=1}else if(e>=0)this.state=1,o=this.jong_han[this.queue.shift()],this.queue.push(e);else{this.state=4;var a=this.div_conx(this.queue.pop());i=this.cho_han[a.prev],o=44032+588*a.next+28*r+0,this.queue.push(a.next),this.queue.push(r)}break;case 4:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),o=44032+588*this.queue[0]+28*this.queue[1],this.state=4}else o=this.cho_han[this.queue[0]],this.state=1}else if(e>=0){var n=this.jong_eng.indexOf(t);if(0>n){this.state=1;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0,o=this.cho_han[e],this.queue.push(e)}else this.state=5,o=44032+588*this.queue[0]+28*this.queue[1]+n,this.queue.push(n)}else{var a=this.comp_vowx(this.queue[this.queue.length-1],r);if(a>=0)this.state=4,o=44032+588*this.queue[0]+28*a+0,this.queue.pop(),this.queue.push(a);else{this.state=2;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0,o=this.jung_han[r],this.queue.push(r)}}break;case 5:if(0>t)this.queue.pop(),o=44032+588*this.queue[0]+28*this.queue[1],this.state=4;else if(e>=0){var a=this.comp_conx(this.jong2cho(this.queue[this.queue.length-1]),e);if(a>=0)this.state=6,o=44032+588*this.queue[0]+28*this.queue[1]+a,this.queue.pop(),this.queue.push(a);else{this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();i=44032+588*h+28*l+n,o=this.cho_han[e],this.queue.push(e)}}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0;var n=this.queue.shift(),a=this.jong2cho(n);o=44032+588*a+28*r+0,this.queue.push(a),this.queue.push(r)}break;case 6:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(this.cho2jong(a.prev)),o=44032+588*this.queue[0]+28*this.queue[1]+this.queue[2],this.state=5}else if(e>=0){this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();i=44032+588*h+28*l+n,o=this.cho_han[e],this.queue.push(e)}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift(),a=this.div_conx(n);i=44032+588*h+28*l+this.cho2jong(a.prev),o=44032+588*a.next+28*r+0,this.queue.push(a.next),this.queue.push(r)}}return this.last_comp=o,{comp_end:i,comp_update:o}},cho2jong:function(t){return this.cho_jong[t]},jong2cho:function(t){return this.cho_jong.indexOf(t)},comp_conx:function(t,e){switch(t){case 0:if(9==e)return 3;break;case 2:if(12==e)return 5;if(18==e)return 6;break;case 5:if(0==e)return 9;if(6==e)return 10;if(7==e)return 11;if(9==e)return 12;if(16==e)return 13;if(17==e)return 14;if(18==e)return 15;break;case 7:if(9==e)return 18}return-1},comp_vowx:function(t,e){switch(t){case 8:if(0==e)return 9;if(1==e)return 10;if(20==e)return 11;break;case 13:if(4==e)return 14;if(5==e)return 15;if(20==e)return 16;break;case 18:if(20==e)return 19}return-1},is_vowx:function(t){return 9==t||10==t||11==t||14==t||15==t||16==t||19==t?!0:!1},div_conx:function(t){switch(t){case 3:return{prev:0,next:9};case 5:return{prev:2,next:12};case 6:return{prev:2,next:18};case 9:return{prev:5,next:0};case 10:return{prev:5,next:6};case 11:return{prev:5,next:7};case 12:return{prev:5,next:9};case 13:return{prev:5,next:16};case 14:return{prev:5,next:17};case 15:return{prev:5,next:18};case 18:return{prev:7,next:9}}return{prev:-1,next:-1}},div_vowx:function(t){switch(t){case 9:return{prev:8,next:0};case 10:return{prev:8,next:1};case 11:return{prev:8,next:20};case 14:return{prev:13,next:4};case 15:return{prev:13,next:5};case 16:return{prev:13,next:20};case 19:return{prev:18,next:20}}return{prev:-1,next:-1}}};