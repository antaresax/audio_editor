function getbaselineinfo(t,e){var o=document.createElement("div"),r=document.body;if(!o||!r)return{ascent:0,descent:0};o.style.position="absolute",o.style.whiteSpace="nowrap",o.style.fontFamily=t,o.style.fontSize=e+"pt",r.appendChild(o);var i="Hg|Wjgm";o.innerHTML=i;var a=o.offsetHeight,s=document.createElement("span");s.style.display="inline-block",s.style.overflow="hidden",s.style.width="1px",s.style.height="0px",o.appendChild(s);var n=s.offsetTop+s.offsetHeight;return document.body.removeChild(o),{ascent:n,descent:a-n}}function get_key(t){for(var e=1e5,o=0;e>o;o++)if(!t.hasOwnProperty(o))return o;return console.log("!! table overflow !!"),e}!function(){function t(t){return t.call.apply(t.bind,arguments)}function e(t,e){if(!t)throw Error();if(2<arguments.length){var o=Array.prototype.slice.call(arguments,2);return function(){var r=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(r,o),t.apply(e,r)}}return function(){return t.apply(e,arguments)}}function o(){return o=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?t:e,o.apply(null,arguments)}function r(t,e){this.F=t,this.k=e||t,this.H=this.k.document}function i(t,e,o){t=t.H.getElementsByTagName(e)[0],t||(t=document.documentElement),t.insertBefore(o,t.lastChild)}function a(t,e,o){e=e||[],o=o||[];for(var r=t.className.split(/\s+/),i=0;i<e.length;i+=1){for(var a=!1,s=0;s<r.length;s+=1)if(e[i]===r[s]){a=!0;break}a||r.push(e[i])}for(e=[],i=0;i<r.length;i+=1){for(a=!1,s=0;s<o.length;s+=1)if(r[i]===o[s]){a=!0;break}a||e.push(r[i])}t.className=e.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function s(t,e){for(var o=t.className.split(/\s+/),r=0,i=o.length;i>r;r++)if(o[r]==e)return!0;return!1}function n(t){if("string"==typeof t.fa)return t.fa;var e=t.k.location.protocol;return"about:"==e&&(e=t.F.location.protocol),"https:"==e?"https:":"http:"}function h(t,e,o){function r(){h&&a&&s&&(h(n),h=null)}e=t.createElement("link",{rel:"stylesheet",href:e,media:"all"});var a=!1,s=!0,n=null,h=o||null;V?(e.onload=function(){a=!0,r()},e.onerror=function(){a=!0,n=Error("Stylesheet failed to load"),r()}):setTimeout(function(){a=!0,r()},0),i(t,"head",e)}function l(t,e,o,r){var i=t.H.getElementsByTagName("head")[0];if(i){var a=t.createElement("script",{src:e}),s=!1;return a.onload=a.onreadystatechange=function(){s||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(s=!0,o&&o(null),a.onload=a.onreadystatechange=null,"HEAD"==a.parentNode.tagName&&i.removeChild(a))},i.appendChild(a),setTimeout(function(){s||(s=!0,o&&o(Error("Script load timeout")))},r||5e3),a}return null}function c(){this.S=0,this.K=null}function p(t){return t.S++,function(){t.S--,_(t)}}function d(t,e){t.K=e,_(t)}function _(t){0==t.S&&t.K&&(t.K(),t.K=null)}function u(t){this.ea=t||"-"}function f(t,e){this.Q=t,this.M=4,this.L="n";var o=(e||"n4").match(/^([nio])([1-9])$/i);o&&(this.L=o[1],this.M=parseInt(o[2],10))}function g(t){return m(t)+" "+(t.M+"00")+" 300px "+P(t.Q)}function P(t){var e=[];t=t.split(/,\s*/);for(var o=0;o<t.length;o++){var r=t[o].replace(/['"]/g,"");e.push(-1!=r.indexOf(" ")||/^\d/.test(r)?"'"+r+"'":r)}return e.join(",")}function y(t){return t.L+t.M}function m(t){var e="normal";return"o"===t.L?e="oblique":"i"===t.L&&(e="italic"),e}function M(t){var e=4,o="n",r=null;return t&&((r=t.match(/(normal|oblique|italic)/i))&&r[1]&&(o=r[1].substr(0,1).toLowerCase()),(r=t.match(/([1-9]00|normal|bold)/i))&&r[1]&&(/bold/i.test(r[1])?e=7:/[1-9]00/.test(r[1])&&(e=parseInt(r[1].substr(0,1),10)))),o+e}function v(t,e){this.a=t,this.j=t.k.document.documentElement,this.O=e,this.f="wf",this.e=new u("-"),this.da=!1!==e.events,this.u=!1!==e.classes}function C(t){t.u&&a(t.j,[t.e.d(t.f,"loading")]),E(t,"loading")}function w(t){if(t.u){var e=s(t.j,t.e.d(t.f,"active")),o=[],r=[t.e.d(t.f,"loading")];e||o.push(t.e.d(t.f,"inactive")),a(t.j,o,r)}E(t,"inactive")}function E(t,e,o){t.da&&t.O[e]&&(o?t.O[e](o.getName(),y(o)):t.O[e]())}function k(){this.t={}}function x(t,e,o){var r,i=[];for(r in e)if(e.hasOwnProperty(r)){var a=t.t[r];a&&i.push(a(e[r],o))}return i}function R(t,e){this.a=t,this.h=e,this.m=this.a.createElement("span",{"aria-hidden":"true"},this.h)}function I(t,e){var o,r=t.m;o="display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+P(e.Q)+";"+("font-style:"+m(e)+";font-weight:"+(e.M+"00")+";"),r.style.cssText=o}function O(t){i(t.a,"body",t.m)}function L(t,e,o,r,i,a){this.G=t,this.J=e,this.g=r,this.a=o,this.v=i||3e3,this.h=a||void 0}function T(t,e,o,r,i,a,s){this.G=t,this.J=e,this.a=o,this.g=r,this.h=s||"BESbswy",this.s={},this.v=i||3e3,this.Z=a||null,this.D=this.C=this.A=this.w=null,this.w=new R(this.a,this.h),this.A=new R(this.a,this.h),this.C=new R(this.a,this.h),this.D=new R(this.a,this.h),I(this.w,new f(this.g.getName()+",serif",y(this.g))),I(this.A,new f(this.g.getName()+",sans-serif",y(this.g))),I(this.C,new f("serif",y(this.g))),I(this.D,new f("sans-serif",y(this.g))),O(this.w),O(this.A),O(this.C),O(this.D)}function b(){if(null===Q){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);Q=!!t&&(536>parseInt(t[1],10)||536===parseInt(t[1],10)&&11>=parseInt(t[2],10))}return Q}function G(t,e,o){for(var r in Z)if(Z.hasOwnProperty(r)&&e===t.s[Z[r]]&&o===t.s[Z[r]])return!0;return!1}function A(t){var e,o=t.w.m.offsetWidth,r=t.A.m.offsetWidth;(e=o===t.s.serif&&r===t.s["sans-serif"])||(e=b()&&G(t,o,r)),e?W()-t.ga>=t.v?b()&&G(t,o,r)&&(null===t.Z||t.Z.hasOwnProperty(t.g.getName()))?D(t,t.G):D(t,t.J):S(t):D(t,t.G)}function S(t){setTimeout(o(function(){A(this)},t),50)}function D(t,e){setTimeout(o(function(){this.w.remove(),this.A.remove(),this.C.remove(),this.D.remove(),e(this.g)},t),0)}function F(t,e,o){this.a=t,this.p=e,this.P=0,this.ba=this.Y=!1,this.v=o}function N(t){0==--t.P&&t.Y&&(t.ba?(t=t.p,t.u&&a(t.j,[t.e.d(t.f,"active")],[t.e.d(t.f,"loading"),t.e.d(t.f,"inactive")]),E(t,"active")):w(t.p))}function B(t){this.F=t,this.q=new k,this.$=0,this.T=this.U=!0}function U(t,e,r,i,s){var n=0==--t.$;(t.T||t.U)&&setTimeout(function(){var t=s||null,h=i||null||{};if(0===r.length&&n)w(e.p);else{e.P+=r.length,n&&(e.Y=n);var l,c=[];for(l=0;l<r.length;l++){var p=r[l],d=h[p.getName()],_=e.p,u=p;_.u&&a(_.j,[_.e.d(_.f,u.getName(),y(u).toString(),"loading")]),E(_,"fontloading",u),_=null,null===te&&(te=window.FontFace?(_=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent))?42<parseInt(_[1],10):!0:!1),_=te?new L(o(e.V,e),o(e.W,e),e.a,p,e.v,d):new T(o(e.V,e),o(e.W,e),e.a,p,e.v,t,d),c.push(_)}for(l=0;l<c.length;l++)c[l].start()}},0)}function H(t,e,o){var r=[],i=o.timeout;C(e);var r=x(t.q,o,t.a),a=new F(t.a,e,i);for(t.$=r.length,e=0,o=r.length;o>e;e++)r[e].load(function(e,o,r){U(t,a,e,o,r)})}function z(t,e,o){this.N=t?t:e+ee,this.o=[],this.R=[],this.ca=o||""}function X(t,e){for(var o=e.length,r=0;o>r;r++){var i=e[r].split(":");3==i.length&&t.R.push(i.pop());var a="";2==i.length&&""!=i[1]&&(a=":"),t.o.push(i.join(a))}}function Y(t){this.o=t,this.aa=[],this.I={}}function K(t,e){this.a=t,this.c=e}function q(t,e){this.a=t,this.c=e,this.X=[]}function $(t,e){this.a=t,this.c=e}function J(t,e){this.a=t,this.c=e}function j(t,e){this.a=t,this.c=e}var W=Date.now||function(){return+new Date},V=!!window.FontFace;r.prototype.createElement=function(t,e,o){if(t=this.H.createElement(t),e)for(var r in e)e.hasOwnProperty(r)&&("style"==r?t.style.cssText=e[r]:t.setAttribute(r,e[r]));return o&&t.appendChild(this.H.createTextNode(o)),t},u.prototype.d=function(){for(var t=[],e=0;e<arguments.length;e++)t.push(arguments[e].replace(/[\W_]+/g,"").toLowerCase());return t.join(this.ea)},f.prototype.getName=function(){return this.Q},R.prototype.remove=function(){var t=this.m;t.parentNode&&t.parentNode.removeChild(t)},L.prototype.start=function(){function t(){W()-r>=o.v?o.J(o.g):e.fonts.load(g(o.g),o.h).then(function(e){1<=e.length?o.G(o.g):setTimeout(t,25)},function(){o.J(o.g)})}var e=this.a.k.document,o=this,r=W();t()};var Z={ia:"serif",ha:"sans-serif"},Q=null;T.prototype.start=function(){this.s.serif=this.C.m.offsetWidth,this.s["sans-serif"]=this.D.m.offsetWidth,this.ga=W(),A(this)};var te=null;F.prototype.V=function(t){var e=this.p;e.u&&a(e.j,[e.e.d(e.f,t.getName(),y(t).toString(),"active")],[e.e.d(e.f,t.getName(),y(t).toString(),"loading"),e.e.d(e.f,t.getName(),y(t).toString(),"inactive")]),E(e,"fontactive",t),this.ba=!0,N(this)},F.prototype.W=function(t){var e=this.p;if(e.u){var o=s(e.j,e.e.d(e.f,t.getName(),y(t).toString(),"active")),r=[],i=[e.e.d(e.f,t.getName(),y(t).toString(),"loading")];o||r.push(e.e.d(e.f,t.getName(),y(t).toString(),"inactive")),a(e.j,r,i)}E(e,"fontinactive",t),N(this)},B.prototype.load=function(t){this.a=new r(this.F,t.context||this.F),this.U=!1!==t.events,this.T=!1!==t.classes,H(this,new v(this.a,t),t)};var ee="//fonts.googleapis.com/css";z.prototype.d=function(){if(0==this.o.length)throw Error("No fonts to load!");if(-1!=this.N.indexOf("kit="))return this.N;for(var t=this.o.length,e=[],o=0;t>o;o++)e.push(this.o[o].replace(/ /g,"+"));return t=this.N+"?family="+e.join("%7C"),0<this.R.length&&(t+="&subset="+this.R.join(",")),0<this.ca.length&&(t+="&text="+encodeURIComponent(this.ca)),t};var oe={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},re={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},ie={i:"i",italic:"i",n:"n",normal:"n"},ae=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;Y.prototype.parse=function(){for(var t=this.o.length,e=0;t>e;e++){var o=this.o[e].split(":"),r=o[0].replace(/\+/g," "),i=["n4"];if(2<=o.length){var a,s=o[1];if(a=[],s)for(var s=s.split(","),n=s.length,h=0;n>h;h++){var l;if(l=s[h],l.match(/^[\w-]+$/))if(l=ae.exec(l.toLowerCase()),null==l)l="";else{var c;if(c=l[1],null==c||""==c)c="4";else{var p=re[c];c=p?p:isNaN(c)?"4":c.substr(0,1)}l=l[2],l=[null==l||""==l?"n":ie[l],c].join("")}else l="";l&&a.push(l)}0<a.length&&(i=a),3==o.length&&(o=o[2],a=[],o=o?o.split(","):a,0<o.length&&(o=oe[o[0]])&&(this.I[r]=o))}for(this.I[r]||(o=oe[r])&&(this.I[r]=o),o=0;o<i.length;o+=1)this.aa.push(new f(r,i[o]))}};var se={Arimo:!0,Cousine:!0,Tinos:!0};K.prototype.load=function(t){var e=new c,o=this.a,r=new z(this.c.api,n(o),this.c.text),i=this.c.families;X(r,i);var a=new Y(i);a.parse(),h(o,r.d(),p(e)),d(e,function(){t(a.aa,a.I,se)})},q.prototype.B=function(t){var e=this.a;return n(this.a)+(this.c.api||"//f.fontdeck.com/s/css/js/")+(e.k.location.hostname||e.F.location.hostname)+"/"+t+".js"},q.prototype.load=function(t){var e=this.c.id,o=this.a.k,r=this;e?(o.__webfontfontdeckmodule__||(o.__webfontfontdeckmodule__={}),o.__webfontfontdeckmodule__[e]=function(e,o){for(var i=0,a=o.fonts.length;a>i;++i){var s=o.fonts[i];r.X.push(new f(s.name,M("font-weight:"+s.weight+";font-style:"+s.style)))}t(r.X)},l(this.a,this.B(e),function(e){e&&t([])})):t([])},$.prototype.B=function(t){return(this.c.api||"https://use.typekit.net")+"/"+t+".js"},$.prototype.load=function(t){var e=this.c.id,o=this.a.k;e?l(this.a,this.B(e),function(e){if(e)t([]);else if(o.Typekit&&o.Typekit.config&&o.Typekit.config.fn){e=o.Typekit.config.fn;for(var r=[],i=0;i<e.length;i+=2)for(var a=e[i],s=e[i+1],n=0;n<s.length;n++)r.push(new f(a,s[n]));try{o.Typekit.load({events:!1,classes:!1,async:!0})}catch(h){}t(r)}},2e3):t([])},J.prototype.B=function(t,e){var o=n(this.a),r=(this.c.api||"fast.fonts.net/jsapi").replace(/^.*http(s?):(\/\/)?/,"");return o+"//"+r+"/"+t+".js"+(e?"?v="+e:"")},J.prototype.load=function(t){function e(){if(i["__mti_fntLst"+o]){var r,a=i["__mti_fntLst"+o](),s=[];if(a)for(var n=0;n<a.length;n++){var h=a[n].fontfamily;void 0!=a[n].fontStyle&&void 0!=a[n].fontWeight?(r=a[n].fontStyle+a[n].fontWeight,s.push(new f(h,r))):s.push(new f(h))}t(s)}else setTimeout(function(){e()},50)}var o=this.c.projectId,r=this.c.version;if(o){var i=this.a.k;l(this.a,this.B(o,r),function(o){o?t([]):e()}).id="__MonotypeAPIScript__"+o}else t([])},j.prototype.load=function(t){var e,o,r=this.c.urls||[],i=this.c.families||[],a=this.c.testStrings||{},s=new c;for(e=0,o=r.length;o>e;e++)h(this.a,r[e],p(s));var n=[];for(e=0,o=i.length;o>e;e++)if(r=i[e].split(":"),r[1])for(var l=r[1].split(","),_=0;_<l.length;_+=1)n.push(new f(r[0],l[_]));else n.push(new f(r[0]));d(s,function(){t(n,a)})};var ne=new B(window);ne.q.t.custom=function(t,e){return new j(e,t)},ne.q.t.fontdeck=function(t,e){return new q(e,t)},ne.q.t.monotype=function(t,e){return new J(e,t)},ne.q.t.typekit=function(t,e){return new $(e,t)},ne.q.t.google=function(t,e){return new K(e,t)};var he={load:o(ne.load,ne)};"function"==typeof define&&define.amd?define(function(){return he}):"undefined"!=typeof module&&module.exports?module.exports=he:(window.WebFont=he,window.WebFontConfig&&ne.load(window.WebFontConfig))}(),PM.Core={},PM.Ctrl={},PM.Editor={},PM.Lib={},PM.URL={},PM.TYPE={},PM.PAGE={},PM.HIT={},PM.CONFIG={},PM.PRODUCT={},PM.Core.Version="83",PM.Core.MAIN_CANVAS_ID="",PM.PRODUCT.UNKNOWN=-1,PM.PRODUCT.PHOTOBOOK=0,PM.PRODUCT.CALENDAR=1,PM.TYPE.UNKNOWN=-1,PM.TYPE.ICON=0,PM.TYPE.IMAGE=1,PM.TYPE.TEXT=2,PM.PAGE.ERROR=-3,PM.PAGE.COVER=-2,PM.PAGE.PROLOG=-1,PM.PAGE.EPILOG=9999,PM.PAGE.COVER_FRONT=-10,PM.PAGE.COVER_MIDDLE=-11,PM.PAGE.COVER_BACK=-12,PM.ADDPAGE_SUCCESS=0,PM.ADDPAGE_FAIL=-1,PM.ADDPAGE_LIMIT_ERROR=-2,PM.DELPAGE_SUCCESS=0,PM.DELPAGE_FAIL=-1,PM.DELPAGE_LIMIT_ERROR=-2,PM.HIT.NONE=-1,PM.HIT.MOVE=0,PM.HIT.RESIZE_T=1,PM.HIT.RESIZE_R=2,PM.HIT.RESIZE_B=3,PM.HIT.RESIZE_L=4,PM.HIT.RESIZE_LT=5,PM.HIT.RESIZE_RT=6,PM.HIT.RESIZE_RB=7,PM.HIT.RESIZE_LB=8,PM.HIT.ROTATE=9,PM.HIT.MOVE_CROP=10,PM.HIT.EDIT_TEXT=11,PM.RECORD_ON=!0,PM.RECORD_OFF=!1,PM.RECORD_UNKNOWN=0,PM.RECORD_PAGE_INSERT=1,PM.RECORD_PAGE_DELETE=2,PM.RECORD_PAGE_REORDER=3,PM.RECORD_PAGE_BKCOLOR=4,PM.RECORD_PAGE_BKIMAGE=5,PM.RECORD_PAGE_LAYOUT=6,PM.RECORD_LAYER_INSERT=7,PM.RECORD_LAYER_DELETE=8,PM.RECORD_LAYER_MOVE=9,PM.RECORD_LAYER_ZORDER=10,PM.RECORD_FRAME_CHANGE=11,PM.RECORD_PHOTO_CHANGE=12,PM.RECORD_PHOTO_CROP=13,PM.RECORD_PHOTO_ADDALL=14,PM.RECORD_PHOTO_DELALL=15,PM.RECORD_ICON_OPACITY=16,PM.RECORD_TEXT_CHANGE=17,PM.RECORD_EMPTYLAYERS_DELETE=18,PM.SIZE6X6=0,PM.SIZE6X8=1,PM.SIZE8X6=2,PM.SIZE8X8=3,PM.SIZE8X11=4,PM.SIZE11X8=5,PM.SIZE10X10=6,PM.DEBUG=!1,PM.URL.PHOTOBOOK_THEME="http://tpl.photomon.com/Product/skin/mainxml/flex_photobook_productbook_div_utf8.asp?",PM.URL.PHOTOBOOK_LAYOUT="http://tpl.photomon.com/product/skin/thumb/",PM.URL.PHOTOBOOK_SKIN="http://tpl.photomon.com/product/skin/edit/",PM.URL.CALENDAR_THEME="http://tpl.photomon.com/product/cal25/themesxml/themes.asp?",PM.URL.CALENDAR_LAYOUT="http://tpl.photomon.com/product/cal25/skins/",PM.URL.CALENDAR_SKIN="http://tpl.photomon.com/product/cal25/skins/",PM.URL.LAYOUT_FILE="",PM.URL.SKIN_FILE="",PM.URL.STICKER_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.URL.FRAME_FILE="http://tpl.photomon.com/Product/clipart20120430/edit/",PM.CONFIG.SCALE_MIN=.3,PM.CONFIG.SCALE_MAX=2,PM.CONFIG.CANVAS_MARGIN_W=120,PM.CONFIG.CANVAS_MARGIN_H=120,PM.CONFIG.PHOTO_MIN_DPI=150,PM.CONFIG.GRID_COLOR="#777777",PM.CONFIG.GRID_LINEW=.5,PM.CONFIG.GRID_SPACE=10,PM.CONFIG.CONTROLLER_RADIUS=8,PM.CONFIG.CROP_RADIUS=22,PM.CONFIG.PHOTO_MAX=25,PM.CONFIG.GUIDE_COLOR="#ff0000",PM.CONFIG.GUIDE_LINEW=1,PM.CONFIG.GUIDE_EXTRA=32,PM.CONFIG.GUIDE_FONT="16px Nanum Gothic",PM.CONFIG.GUIDE_FONT_H=16,PM.CONFIG.GUIDE_TEXT_COLOR="#000000",PM.CONFIG.GUIDE_TEXT_MARGIN=10,PM.CONFIG.GUIDE_LEATHERCOVER_TEXT="커버내 사각홈에 보여지는 사진은 실제 제작시 1~3mm 정도 오차가 발생할 수 있습니다.",PM.CONFIG.PROLOG_FONT="16pt Nanum Gothic",PM.CONFIG.PROLOG_COLOR="#bbbbbb",PM.CONFIG.PROLOG_TEXT="인쇄되지 않는 페이지입니다.",PM.CONFIG.BOOT_FONT="14pt Nanum Gothic",PM.CONFIG.BOOT_COLOR="#bbbbbb",PM.CONFIG.BOOT_LOADING_MSG="상품정보를 불러오는 중...",PM.CONFIG.BOOT_FAILURE_MSG="상품정보를 정상적으로 불러오지 못했습니다.",PM.CONFIG.BOOT_LOADING=0,PM.CONFIG.BOOT_SUCCESS=1,PM.CONFIG.BOOT_FAILURE=-1,PM.CONFIG.MESSAGE_ONLINE="인터넷이 연결되었습니다.",PM.CONFIG.MESSAGE_OFFLINE="인터넷이 연결되지 않았습니다.",PM.CONFIG.MESSAGE_CANNOT_ADD="추가를 할 수 없습니다.",PM.CONFIG.MESSAGE_CHECK_IME="macOS에서는 영문모드 상태에서만 입력 가능합니다. (영문모드 상태에서 Shift+Space로 한/영 전환)",PM.CONFIG.MESSAGE_CHECK_TEXT_LEN="글상자의 내용이 범위를 넘어섭니다. 글꼴 크기를 줄이거나 글 내용을 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE="글상자의 크기가 범위를 넘어섭니다. 글상자의 크기를 줄여주시기 바랍니다.",PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA="인쇄되지 않는 페이지를 침범한 레이어 영역은 인쇄되지 않습니다.",PM.CONFIG.MESSAGE_CHECK_SPINE_AREA="커버의 책등(세네카)영역과 겹치지 않게 편집해 주십시오.",PM.CONFIG.MESSAGEBAR_TIMEOUT=3e3,PM.CONFIG.MESSAGEBAR_FONT="10pt Nanum Gothic",PM.CONFIG.MESSAGEBAR_TEXTCOLOR="#111111",PM.CONFIG.MESSAGEBAR_BACKCOLOR="#ffff00",PM.CONFIG.MESSAGEBAR_HEIGHT=30,PM.CONFIG.ROUNDMASK_IMAGE="http://tpl.photomon.com/Product/clipart20120430/edit/frame_diagram_56.png",PM.CONFIG.FRAME_EMPTY_IMAGE="frame_diagram_delete.png",PM.CONFIG.COVER_BARCODE_IMAGE="./images/common/cover_barcode.jpg",PM.CONFIG.PAGE_GRADATION_IMAGE="./images/common/page_gradation.png",PM.CONFIG.PHOTO_EMPTY_IMAGE="./images/common/photo_empty.png",PM.CONFIG.PHOTO_WARNING_IMAGE="./images/common/photo_warning.png",PM.CONFIG.FONT_DEFAULT="Nanum Gothic",PM.CONFIG.FONT_POOL=["BM Dohyeon","BM Hanna","BM Jua","Jeju Gothic","Jeju Myeongjo","Jeju Hallasan","KoPub Batang","Nanum Barun Gothic","Nanum Barun Gothic Light","Nanum Barun Pen","Nanum Gothic","Nanum Myeongjo","Nanum Pen Script","Nanum Brush Script","Nanum Square","Noto Sans KR","Seoul Hangang","Seoul Namsan","TDc Ballerina","TDc Bearnrabbit","TDc Bigeyes","TDc Childheart","TDc Donkiprince","TDc Donkiround","TDc Pororomc","TDc Poundingheart","TDc Todayweather","TDc Valentine","Avenir LT Std 35 Light","OratorStd Medium","ITCAvantGardeStd-XLtCn","Times New Roman"],PM.CONFIG.FONT_PATH={"BM Dohyeon":"./webfont/kor/bmdohyeon.css","BM Hanna":"./webfont/kor/bmhanna.css","BM Jua":"./webfont/kor/bmjua.css","Jeju Gothic":"./webfont/kor/jejugothic.css","Jeju Myeongjo":"./webfont/kor/jejumyeongjo.css","Jeju Hallasan":"./webfont/kor/jejuhallasan.css","KoPub Batang":"./webfont/kor/kopubbatang.css","Nanum Barun Gothic":"./webfont/kor/nanumbarungothic.css","Nanum Barun Gothic Light":"./webfont/kor/nanumbarungothic-light.css","Nanum Barun Pen":"./webfont/kor/nanumbarunpen.css","Nanum Gothic":"./webfont/kor/nanumgothic.css","Nanum Myeongjo":"./webfont/kor/nanummyeongjo.css","Nanum Pen Script":"./webfont/kor/nanumsonpen.css","Nanum Brush Script":"./webfont/kor/nanumsonbrush.css","Nanum Square":"./webfont/kor/nanumsquare.css","Noto Sans KR":"./webfont/kor/notosanskr.css","Seoul Hangang":"./webfont/kor/seoulhangang.css","Seoul Namsan":"./webfont/kor/seoulnamsan.css","TDc Ballerina":"./webfont/kor/tdc_ballerina.css","TDc Bearnrabbit":"./webfont/kor/tdc_bearnrabbit.css","TDc Bigeyes":"./webfont/kor/tdc_bigeyes.css","TDc Childheart":"./webfont/kor/tdc_childheart.css","TDc Donkiprince":"./webfont/kor/tdc_donkiprince.css","TDc Donkiround":"./webfont/kor/tdc_donkiround.css","TDc Pororomc":"./webfont/kor/tdc_pororomc.css","TDc Poundingheart":"./webfont/kor/tdc_poundingheart.css","TDc Todayweather":"./webfont/kor/tdc_todayweather.css","TDc Valentine":"./webfont/kor/tdc_valentine.css","Avenir LT Std 35 Light":"./webfont/eng/AvenirLT35Light.css","OratorStd Medium":"./webfont/eng/OratorStd.css","ITCAvantGardeStd-XLtCn":"./webfont/eng/ITCAvantGardeStd.css","Times New Roman":"./webfont/eng/TimesNewRoman.css"},PM.COLOR_PAGE_BORDER="rgba(0, 255, 0, 0.5)",PM.COLOR_PAGE_FOCUS_STROKE="rgba(0, 255, 255, 0.5)",PM.COLOR_LAYER_STROKE="rgba(0,0,0,0.5)",PM.COLOR_LAYER_FILL="rgba(0,0,0,0.1)",PM.COLOR_TBOX_WARNING_FILL="rgba(255,255,0,0.5)",PM.COLOR_DRAGGER_FOCUS_STROKE="rgba(255,0,0,1.0)",PM.COLOR_DRAGGER_FOCUS_FILL="rgba(255,100,100,0.6)",PM.COLOR_DRAGGER_NORMAL_STROKE="rgba(0,0,0,0.5)",PM.COLOR_DRAGGER_NORMAL_FILL="rgba(80,190,240,0.6)",PM.TBOX_COMMENT_DEFAULT="내용을 입력해 주십시오",PM.Codi=new function(){var t=[[{m:152,s:36},{m:162,s:46},{m:174,s:58},{m:186,s:70},{m:206,s:90},{m:0,s:0}],[{m:121,s:29},{m:130,s:38},{m:140,s:48},{m:148,s:56},{m:164,s:72},{m:0,s:0}],[{m:131,s:31},{m:142,s:42},{m:152,s:52},{m:162,s:62},{m:180,s:80},{m:0,s:0}],[{m:118,s:28},{m:126,s:51},{m:135,s:63},{m:144,s:75},{m:159,s:96},{m:0,s:0}],[{m:92,s:22},{m:98,s:28},{m:106,s:36},{m:112,s:42},{m:124,s:54},{m:0,s:0}],[{m:105,s:30},{m:117,s:43},{m:128,s:53},{m:138,s:64},{m:150,s:76},{m:0,s:0}],[{m:102,s:29},{m:113,s:41},{m:126,s:51},{m:134,s:61},{m:148,s:73},{m:0,s:0}]],e=[[{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:65},{m:90,s:88},{m:0,s:0}],[{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:71,s:69},{m:0,s:0}],[{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:69,s:67},{m:0,s:0}],[{m:23,s:22},{m:30,s:29},{m:38,s:36},{m:45,s:44},{m:52,s:50},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],o=[[{m:28,s:26},{m:40,s:38},{m:53,s:50},{m:65,s:63},{m:78,s:75},{m:0,s:0}],[{m:21,s:19},{m:30,s:29},{m:40,s:38},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:21,s:20},{m:31,s:30},{m:41,s:39},{m:51,s:49},{m:61,s:59},{m:0,s:0}],[{m:22,s:20},{m:31,s:29},{m:40,s:39},{m:50,s:48},{m:59,s:58},{m:0,s:0}],[{m:16,s:14},{m:23,s:22},{m:30,s:36},{m:38,s:36},{m:45,s:44},{m:0,s:0}],[{m:29,s:27},{m:38,s:37},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}],[{m:28,s:26},{m:38,s:36},{m:48,s:47},{m:58,s:57},{m:70,s:69},{m:0,s:0}]],r=[[0,0,0],[112,118,0],[121,128,0],[108,114,0],[84,89,0],[88,94,0],[87,92,0]],i=[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[11,17,20,26,0],[8,12,16,20,0],[0,0,0,0,0],[0,0,0,0,0]],a=[28,22,24,22,17,17,17],s=[20,15,16,15,12,12,12],n=[0,0,0,5,5,5,5],h=[0,22,24,22,17,17,17],l=[0,0,0,15,12,0,0],c=[{dx:18,dy:9},{dx:14,dy:7},{dx:14,dy:7},{dx:14,dy:7},{dx:10,dy:5},{dx:10,dy:5},{dx:10,dy:5}],p=[{x:489,y:566,w:78,h:40},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],d=[{x:519,y:577,w:84,h:42},{x:381,y:595,w:66,h:33},{x:558,y:443,w:66,h:33},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:547,y:446,w:62,h:26},{x:502,y:582,w:100,h:41}],_=[{x:0,y:0,w:0,h:0},{x:373,y:585,w:63,h:32},{x:569,y:472,w:69,h:34},{x:510,y:584,w:76,h:31},{x:390,y:601,w:60,h:24},{x:577,y:477,w:63,h:26},{x:499,y:588,w:97,h:39}],u=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0},{x:522,y:581,w:79,h:32},{x:395,y:599,w:62,h:25},{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}];this.GetProductSizeIndex=function(t){var e=t.toLowerCase(),o=-1;switch(e){case"6x6":o=PM.SIZE6X6;break;case"6x8":case"a5h":o=PM.SIZE6X8;break;case"8x6":case"a5w":o=PM.SIZE8X6;break;case"8x8":o=PM.SIZE8X8;break;case"8x11":case"a4h":o=PM.SIZE8X11;break;case"11x8":case"a4w":o=PM.SIZE11X8;break;case"10x10":o=PM.SIZE10X10}return o},this.GetPageBlockIndex=function(t,e,o){if("layflat"==t){if(21>=o)return 0;if(31>=o)return 1;if(41>=o)return 2;if(51>=o)return 3;if(61>=o)return 4}else if("design"==t)if("soft"==e){if(45>=o)return 0;if(65>=o)return 1;if(83>=o)return 2;if(101>=o)return 3}else{if(61>=o)return 0;if(81>=o)return 1}return-1},this.GetPhotobookGuideInfo=function(f,g,P,y,m,M){var v=this.GetPageBlockIndex(g,y,M),C=0,w=0,E=PM.Util.ProductSize2SizeId(P),k=c[E].dx,x=c[E].dy,R=null,I=0>=f;if("layflat"==g)if("soft"==y){var O="yes"==m||"y"==m;C=O?e[E][v].m:o[E][v].m,w=O?e[E][v].s:o[E][v].s,I&&(k=s[E],x=k),R=d[E]}else"hard"==y?(C=t[E][v].m,w=t[E][v].s,I&&(k=a[E],x=k),R=p[E]):"acrylic"==y?(C=0,I&&(k=n[E],x=k),R={x:0,y:0,w:0,h:0}):(C=0,I&&(k=x=0),R={x:0,y:0,w:0,h:0});else"soft"==y?(C=i[E][v],I&&(k=l[E],x=k),R=u[E]):"hard"==y||"pad"==y?(C=r[E][v],I&&(k=h[E],x=k),R=_[E]):(C=0,I&&(k=x=0),R={x:0,y:0,w:0,h:0});return{cut_w:k,cut_h:x,middle_w:C,spine_w:w,barcode_rect:R}};var f={category:"탁상달력",coordinates:[{product_name:"보타닉가든",product_code:["139078","255040"],front_year:{x:1096,y:178,w:77,h:40,font_size:29,font_color:"#454545",align:"right",font_name:"Times New Roman"},front_days:{x:510,y:325,w:693,h:563,font_size:27,font_color:"#454545",align:"center",font_name:"Times New Roman"},back_year:{x:220,y:846,w:44,h:20,font_size:19,font_color:"#454545",align:"left",font_name:"Times New Roman"},back_days:{x:170,y:868,w:1020,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"Times New Roman"},holiday_color:"#af3c00"},{product_name:"별헤는밤",product_code:["139080","255039"],front_year:{x:540,y:177,w:70,h:24,font_size:30,font_color:"#ffffff",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#ffffff",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:868,w:1008,h:16,font_size:20,font_color:"#ffffff",align:"left",font_name:"OratorStd Medium"},holiday_color:"#f4b900"},{product_name:"디노어드벤처",product_code:["139081","255042"],front_year:{x:540,y:167,w:70,h:24,font_size:32,font_color:"#303030",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#303030",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#303030",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#303030",align:"left",font_name:"OratorStd Medium"},holiday_color:"#e6001d"},{product_name:"퓨어퍼시픽",product_code:["139082","255043"],front_year:{x:526,y:187,w:85,h:41,font_size:29,font_color:"#454545",align:"center",font_name:"Times New Roman"},front_days:{x:510,y:325,w:693,h:563,font_size:27,font_color:"#454545",align:"center",font_name:"Times New Roman"},back_year:{x:224,y:846,w:44,h:20,font_size:19,font_color:"#454545",align:"left",font_name:"Times New Roman"},back_days:{x:170,y:868,w:1008,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"Times New Roman"},holiday_color:"#d90000"},{product_name:"어반보타닉",product_code:["139083","255044"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#464546",align:"center",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"심플캘리",product_code:["139074","255035"],front_year:{x:577,y:100,w:126,h:50,font_size:26,font_color:"#000000",align:"center",font_name:"Avenir LT Std 35 Light"},front_days:{x:99,y:361,w:1085,h:562,font_size:27,font_color:"#000000",align:"center",font_name:"Avenir LT Std 35 Light"},back_year:{},back_days:{},holiday_color:"#e6001d"},{product_name:"주땜므",product_code:["139020","255014"],front_year:{x:540,y:217,w:70,h:24,font_size:32,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},holiday_color:"#b68d3e"},{product_name:"달그림자",product_code:["139076","255037"],front_year:{x:577,y:100,w:126,h:50,font_size:26,font_color:"#282e2c",align:"center",font_name:"산돌PIS 달토끼여행"},front_days:{x:103,y:356,w:1071,h:562,font_size:26,font_color:"#282e2c",align:"left",font_name:"Avenir LT Std 35 Light"},back_year:{},back_days:{},holiday_color:"#e6001d"},{product_name:"나의유럽여행",product_code:["139077","255038"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#464546",align:"center",font_name:"Avenir LT Std 35 Light"},back_year:{},back_days:{},holiday_color:"#e6001d"},{product_name:"파스텔심플",product_code:["139067","255029"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#464546",align:"center",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#464546",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"내츄럴베이지",product_code:["139068","255030"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},holiday_color:"#b68d3e"},{product_name:"심플라이프",product_code:["139070","255031"],front_year:{x:208,y:150,w:80,h:30,font_size:28,font_color:"#ffffff",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:100,y:303,w:1080,h:585,font_size:27,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"로맨틱",product_code:["139071","255032"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#454545",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"OratorStd Medium"},holiday_color:"#b68d3e"},{product_name:"비밀편지",product_code:["139072","255033"],front_year:{x:540,y:177,w:70,h:24,font_size:31,font_color:"#ffffff",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:25,font_color:"#473d2f",align:"center",font_name:"OratorStd Medium"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#473d2f",align:"left",font_name:"OratorStd Medium"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#473d2f",align:"left",font_name:"OratorStd Medium"},holiday_color:"#e6001d"},{product_name:"스윗데코",product_code:["139073","255034"],front_year:{x:192,y:154,w:66,h:30,font_size:24,font_color:"#727171",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:8,y:322,w:1263,h:634,font_size:20,font_color:"#727171",align:"left",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#727171",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#727171",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#eb6101"},{product_name:"포토갤러리",product_code:["139020","255014"],front_year:{x:222,y:155,w:80,h:30,font_size:29,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:100,y:303,w:1080,h:585,font_size:29,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"노블화이트",product_code:["139019","255015"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#454545",align:"center",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#828688",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#828688",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"컬러센스",product_code:["139018","255016"],front_year:{x:222,y:155,w:80,h:30,font_size:29,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},front_days:{x:100,y:303,w:1080,h:585,font_size:29,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_year:{x:218,y:846,w:44,h:20,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},back_days:{x:170,y:871,w:1008,h:16,font_size:20,font_color:"#454545",align:"left",font_name:"Avenir LT Std 35 Light"},holiday_color:"#e6001d"},{product_name:"심플모노",product_code:["139055","255020"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#60523b",align:"left",font_name:"OratorStd Medium"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},back_year:{x:1140,y:280,w:56,h:18,font_size:24,font_color:"#60523b",align:"right",font_name:"OratorStd Medium"},back_days:{x:888,y:352,w:315,h:270,font_size:24,font_color:"#60523b",align:"center",font_name:"OratorStd Medium"},holiday_color:"#b68d3f"},{product_name:"모던시크",product_code:["139054","255019"],front_year:{x:540,y:177,w:70,h:24,font_size:32,font_color:"#717171",align:"left",font_name:"ITCAvantGardeStd-XLtCn"},front_days:{x:510,y:325,w:693,h:563,font_size:30,font_color:"#717171",align:"center",font_name:"ITCAvantGardeStd-XLtCn"},back_year:{x:1140,y:280,w:56,h:18,font_size:24,font_color:"#717171",align:"right",font_name:"ITCAvantGardeStd-XLtCn"},back_days:{x:888,y:352,w:315,h:270,font_size:24,font_color:"#717171",align:"center",font_name:"ITCAvantGardeStd-XLtCn"},holiday_color:"#e73358"}]};
this.LoadCalendarInfo=function(){},this.LoadCalendarHolidayInfo=function(){},this.GetCalendarGuideInfo=function(){return{cut_w:10,cut_h:10}},this.GetCalendarPrintInfo=function(t){for(var e=f.coordinates,o=0;o<e.length;o++)if(t==e[o].product_code[0]||t==e[o].product_code[1])return e[o];return null}},PM.Core.Layer=function(){this.gid="",this.require=!1,this.movelock=!1,this.resizelock=!1,this.zorderlock=!1,this.removelock=!1,this.xpos=0,this.ypos=0,this.width=0,this.height=0,this.radian=0},PM.Core.Layer.prototype.CopyProperty=function(t){return t.gid=this.gid,t.require=this.require,t.movelock=this.movelock,t.resizelock=this.resizelock,t.removelock=this.removelock,t.xpos=this.xpos,t.ypos=this.ypos,t.width=this.width,t.height=this.height,t.radian=this.radian,t},PM.Core.Layer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian}},PM.Core.Layer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian},PM.Core.Layer.prototype.IsEqualMoveInfo=function(t){return this.xpos==t.xpos&&this.ypos==t.ypos&&this.width==t.width&&this.height==t.height&&this.radian==t.radian},PM.Core.Layer.prototype.PrepareDC=function(t,e,o){t.save(),t.translate(e+this.xpos,o+this.ypos),this.radian&&(t.translate(this.width/2,this.height/2),t.rotate(this.radian),t.translate(-this.width/2,-this.height/2))},PM.Core.Layer.prototype.ReleaseDC=function(t){t.restore()},PM.Core.Layer.prototype.GetType=function(){return this.type},PM.Core.Layer.prototype.GetRect=function(){return{l:this.xpos,t:this.ypos,w:this.width,h:this.height}},PM.Core.Layer.prototype.GetCenterPos=function(){return{x:this.xpos+this.width/2,y:this.ypos+this.height/2}},PM.Core.Layer.prototype.NonRotatedPoint=function(t,e,o,r){var i=-this.radian;return this.GetRotatePoint(i,t,e,o,r)},PM.Core.Layer.prototype.GetRotatePoint=function(t,e,o,r,i){var a={x:r,y:i};return t&&(a.x=(r-e)*Math.cos(t)-(i-o)*Math.sin(t)+e,a.y=(r-e)*Math.sin(t)+(i-o)*Math.cos(t)+o),a},PM.Core.Layer.prototype.GetRotateInnerPoints=function(t,e){var o=[];return o.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos)),o.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos)),o.push(this.GetRotatePoint(this.radian,t,e,this.xpos,this.ypos+this.height)),o.push(this.GetRotatePoint(this.radian,t,e,this.xpos+this.width,this.ypos+this.height)),o},PM.Core.Layer.prototype.Points2OutRect=function(t){if(4!=t.length)return{l:0,t:0,w:0,h:0};var e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),o=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),r=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),i=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y));return{l:e,t:o,w:r-e,h:i-o}},PM.Core.Layer.prototype.GetOutRect=function(){var t=this.xpos+this.width/2,e=this.ypos+this.height/2,o=this.GetRotateInnerPoints(t,e),r=this.Points2OutRect(o);return r},PM.Core.Layer.prototype.DrawExtra=function(t,e){PM.DEBUG&&(PM.Editor.Framework.IsPreviewMode()||(t.font="12px Nanum Gothic",t.fillStyle="#ff0000",t.textAlign="center",t.textBaseline="middle",t.fillText(e,10,10,30)))},PM.Core.Layer.prototype.DrawHighlight=function(t,e,o){this.PrepareDC(t,e,o),PM.Util.DrawRect(t,0,0,this.width,this.height,1.5,"yellow",null),this.ReleaseDC(t)},PM.Core.Layer.prototype.DrawController=function(t,e,o,r){this.PrepareDC(t,e,o);var i=PM.Editor.Framework.IsShiftState(),a=1,s=r?PM.COLOR_DRAGGER_FOCUS_STROKE:PM.COLOR_DRAGGER_NORMAL_STROKE;if(PM.Util.DrawDashRect(t,0,0,this.width,this.height,a,s,null),!r){var n=0,h=0,l=PM.CONFIG.CONTROLLER_RADIUS,c=PM.COLOR_DRAGGER_NORMAL_FILL;if(!this.movelock&&!i){var p=this.resizelock?0:-l;PM.Util.DrawDashLine(t,this.width/2,-30+l,this.width/2,p,1,s)}n=this.width/2,h=-30,this.movelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width/2,h=0,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=this.height/2,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width/2,h=this.height,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=this.height/2,this.resizelock||i||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=0,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=this.width,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c),n=0,h=this.height,this.resizelock||PM.Util.DrawCircle(t,n,h,l,a,s,c)}this.ReleaseDC(t)},PM.Core.Layer.prototype.HitTest=function(t,e,o){var r=this.xpos+this.width/2,i=this.ypos+this.height/2,a=this.NonRotatedPoint(r,i,e,o),s=this.GetRect();return PM.Util.PtInRect(s,a.x,a.y)?this:null},PM.Core.Layer.prototype.HitTestController=function(t,e,o){var r=PM.Editor.Framework.IsShiftState(),i=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(i,a,e,o),n=this.GetRect(),h=PM.CONFIG.CONTROLLER_RADIUS;return i=n.l+this.width/2,a=n.t-30,this.movelock||r||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width/2,a=n.t+0,this.resizelock||r||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width,a=n.t+this.height/2,this.resizelock||r||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+this.width/2,a=n.t+this.height,this.resizelock||r||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+0,a=n.t+this.height/2,this.resizelock||r||!PM.Util.PtInCircle(i,a,h,s.x,s.y)?(i=n.l+0,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_LT:(i=n.l+this.width,a=n.t+0,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_RT:(i=n.l+this.width,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_RB:(i=n.l+0,a=n.t+this.height,!this.resizelock&&PM.Util.PtInCircle(i,a,h,s.x,s.y)?PM.HIT.RESIZE_LB:PM.Util.PtInRect(n,s.x,s.y)?PM.HIT.MOVE:PM.HIT.NONE)))):PM.HIT.RESIZE_L):PM.HIT.RESIZE_B):PM.HIT.RESIZE_R):PM.HIT.RESIZE_T):PM.HIT.ROTATE},PM.Core.Layer.prototype.Move=function(t,e,o,r){if(!this.movelock){var i=o-t,a=r-e;this.xpos+=i,this.ypos+=a}},PM.Core.Layer.prototype.ResizeToFixedRate=function(t,e,o,r,i){var a=0,s=this.width,n=this.height;Math.abs(e)>Math.abs(o)?(n=s*i/r,a=this.height-n,this.height=n,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_RT)&&(this.ypos+=a)):(s=n*r/i,a=this.width-s,this.width=s,(t==PM.HIT.RESIZE_LT||t==PM.HIT.RESIZE_LB)&&(this.xpos+=a))},PM.Core.Layer.prototype.Resize=function(t,e,o,r,i){if(!this.resizelock){var a=PM.Editor.Framework.IsShiftState(),s=this.xpos+this.width/2,n=this.ypos+this.height/2,h=this.NonRotatedPoint(s,n,e,o),l=this.NonRotatedPoint(s,n,r,i),c=this.width,p=this.height,d=l.x-h.x,_=l.y-h.y;switch(t){case PM.HIT.RESIZE_T:this.height-_>=30&&(this.ypos+=_,this.height-=_);break;case PM.HIT.RESIZE_B:this.height+_>=30&&(this.height+=_);break;case PM.HIT.RESIZE_L:this.width-d>=30&&(this.xpos+=d,this.width-=d);break;case PM.HIT.RESIZE_R:this.width+d>=30&&(this.width+=d);break;case PM.HIT.RESIZE_LT:this.width-d>=30&&this.height-_>=30&&(this.xpos+=d,this.width-=d,this.ypos+=_,this.height-=_,a&&this.ResizeToFixedRate(t,d,_,c,p));break;case PM.HIT.RESIZE_RT:this.width+d>=30&&this.height-_>=30&&(this.width+=d,this.ypos+=_,this.height-=_,a&&this.ResizeToFixedRate(t,d,_,c,p));break;case PM.HIT.RESIZE_RB:this.width+d>=30&&this.height+_>=30&&(this.width+=d,this.height+=_,a&&this.ResizeToFixedRate(t,d,_,c,p));break;case PM.HIT.RESIZE_LB:this.width-d>=30&&this.height+_>=30&&(this.xpos+=d,this.width-=d,this.height+=_,a&&this.ResizeToFixedRate(t,d,_,c,p))}this.RecalcXY(s,n)}},PM.Core.Layer.prototype.RecalcXY=function(t,e){if(this.radian){var o=this.GetRotateInnerPoints(t,e),r=this.Points2OutRect(o),i=r.l+r.w/2,a=r.t+r.h/2,s=this.NonRotatedPoint(i,a,o[0].x,o[0].y);this.xpos=s.x,this.ypos=s.y}},PM.Core.Layer.prototype.Rotate=function(t,e,o,r){if(!this.movelock){var i=this.xpos+this.width/2,a=this.ypos+this.height/2;t-=i,o-=i,e=a-e,r=a-r;var s=Math.atan2(t,e),n=Math.atan2(o,r);0>s&&(s=2*Math.PI+s),0>n&&(n=2*Math.PI+n),this.radian+=n-s,this.radian<0&&(this.radian+=2*Math.PI),this.radian>2*Math.PI&&(this.radian-=2*Math.PI)}},PM.Core.Layer.prototype.RotateAngle=function(t){if(this.movelock)return!1;if(90!=t&&-90!=t)return!1;var e=PM.Util.ToAngle(this.radian);0>e&&(e+=360),e>=360&&(e-=360),t>0?90>e?e=0:180>e?e=90:270>e?e=180:360>e&&(e=270):e=e>0&&90>=e?90:e>90&&180>=e?180:e>180&&270>=e?270:360;var o=e+t;return 0>o&&(o+=360),o>=360&&(o-=360),this.radian=PM.Util.ToRadian(o),!0},PM.Core.Layer.prototype.Parse=function(t){var e=this;e.gid=t.attr("gid").toLowerCase(),e.require="true"===t.attr("require"),e.movelock="true"===t.attr("movelock"),e.resizelock="true"===t.attr("resizelock"),e.zorderlock="true"===t.attr("zorderlock"),e.removelock="true"===t.attr("removelock"),$layer_rect=t.find("rect"),e.xpos=parseFloat($layer_rect.attr("x")),e.ypos=parseFloat($layer_rect.attr("y")),e.width=parseFloat($layer_rect.attr("width")),e.height=parseFloat($layer_rect.attr("height"));var o=parseFloat($layer_rect.attr("angle"));if(isNaN(o)&&(o=0),0>o&&(o+=360),o>360&&(o-=360),"spine"!=e.gid&&0!=o){var r=e.xpos,i=e.ypos,a=PM.Util.ToRadian(o),s=[];s.push(e.GetRotatePoint(a,r,i,e.xpos,e.ypos)),s.push(e.GetRotatePoint(a,r,i,e.xpos+e.width,e.ypos)),s.push(e.GetRotatePoint(a,r,i,e.xpos,e.ypos+e.height)),s.push(e.GetRotatePoint(a,r,i,e.xpos+e.width,e.ypos+e.height));var n=e.Points2OutRect(s),h=n.l+n.w/2,l=n.t+n.h/2;e.xpos=h-e.width/2,e.ypos=l-e.height/2,e.radian=a}else e.radian=PM.Util.ToRadian(o);e.radian<0&&(e.radian+=2*Math.PI),e.radian>2*Math.PI&&(e.radian-=2*Math.PI),e.movelock=e.resizelock=e.zorderlock=e.removelock="spine"==e.gid?!0:!1},PM.Core.Layer.prototype.LoadJson=function(t){return this.gid=t.gid,this.require=t.require,this.movelock=t.movelock,this.resizelock=t.resizelock,this.zorderlock=t.zorderlock,this.removelock=t.removelock,this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,!0},PM.Core.Layer.prototype.SaveJson=function(){var t="\n";t+='        "gid": "'+this.gid+'"',t+=', "require": '+this.require,t+=', "movelock": '+this.movelock,t+=', "resizelock": '+this.resizelock,t+=', "zorderlock": '+this.zorderlock,t+=', "removelock": '+this.removelock,t+=', "xpos": '+this.xpos,t+=', "ypos": '+this.ypos,t+=', "width": '+this.width,t+=', "height": '+this.height,t+=', "radian": '+this.radian;var e=this.GetOutRect();return t+=', "out_x": '+e.l,t+=', "out_y": '+e.t,t+=', "out_w": '+e.w,t+=', "out_h": '+e.h},PM.Core.IconLayer=function(){PM.Core.Layer.call(this),this.alpha=255,this.icon="",this.icon_image=null},PM.Core.IconLayer.prototype=new PM.Core.Layer,PM.Core.IconLayer.prototype.GetType=function(){return PM.TYPE.ICON},PM.Core.IconLayer.prototype.GetDesc=function(){return"스티커"},PM.Core.IconLayer.prototype.Load=function(){var t=$.Deferred(),e=this,o=e.icon,r=PM.Util.LoadImage(o);return r.done(function(o){e.icon_image=o,(e.width<=0||e.height<=0)&&(e.width=e.icon_image.width,e.height=e.icon_image.height),t.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.IconLayer.Load: "+o),t.reject()}),t.promise()},PM.Core.IconLayer.prototype.Draw=function(t,e,o,r){this.PrepareDC(t,e,o),null!=this.icon_image&&(t.globalAlpha=this.alpha/255,t.drawImage(this.icon_image,0,0,this.width,this.height),t.globalAlpha=1),this.DrawExtra(t,r),this.ReleaseDC(t)},PM.Core.IconLayer.prototype.GetDrawItemList=function(){return"\n[icon] "+this.icon},PM.Core.IconLayer.prototype.HitTest=function(t,e,o){return PM.Core.Layer.prototype.HitTest.call(this,t,e,o)?this:null},PM.Core.IconLayer.prototype.SetAlpha=function(t,e,o){if(this.alpha=e,o){var r=PM.Editor.Framework.GetPairNumber(),i=PM.Editor.Framework.GetSelectedPageIndex(),a=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(PM.RECORD_ICON_OPACITY,r,{page_pos:i,layer_pos:a,data:t},{page_pos:i,layer_pos:a,data:e},"스티커 투명도")}},PM.Core.IconLayer.prototype.GetAlpha=function(){return this.alpha},PM.Core.IconLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.alpha=parseInt(t.attr("alpha")),isNaN(this.alpha)&&(this.alpha=255),$layer_file=t.find("file");var e=$layer_file.text();e&&e.length>0&&(this.icon=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e))},PM.Core.IconLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.alpha=t.alpha,this.icon=t.icon;var o=this,r=this.Load();return r.done(function(){e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.IconLayer.LoadJson: "+o.icon),e.reject()}),e.promise()},PM.Core.IconLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.ICON,t+='\n        , "alpha": '+this.alpha,t+='\n        , "icon": "'+this.icon+'"',t+="\n        }"},PM.Core.ImageLayer=function(){PM.Core.Layer.call(this),this.diagram="",this.diagram_image=null,this.special="",this.special_image=null,this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,this.is_low=!1},PM.Core.ImageLayer.prototype=new PM.Core.Layer,PM.Core.ImageLayer.prototype.GetType=function(){return PM.TYPE.IMAGE},PM.Core.ImageLayer.prototype.GetDesc=function(){return"사진틀"},PM.Core.ImageLayer.prototype.GetMoveInfo=function(){return{xpos:this.xpos,ypos:this.ypos,width:this.width,height:this.height,radian:this.radian,extra:this.GetCropInfo()}},PM.Core.ImageLayer.prototype.SetMoveInfo=function(t){this.xpos=t.xpos,this.ypos=t.ypos,this.width=t.width,this.height=t.height,this.radian=t.radian,this.SetCropInfo(t.extra)},PM.Core.ImageLayer.prototype.GetCropInfo=function(){return{crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetCropInfo=function(t){this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h},PM.Core.ImageLayer.prototype.IsEqualCropInfo=function(t){return this.crop_x==t.crop_x&&this.crop_y==t.crop_y&&this.crop_w==t.crop_w&&this.crop_h==t.crop_h},PM.Core.ImageLayer.prototype.RecordState=function(t,e,o,r){var i=PM.Editor.Framework.GetPairNumber(),a=PM.Editor.Framework.GetSelectedPageIndex(),s=PM.Editor.Framework.GetSelectedLayerIndex();PM.Editor.Framework.RecordOperation(t,i,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:o},r)},PM.Core.ImageLayer.prototype.GetPhotoState=function(){return{photo:this.photo,photo_org:this.photo_org,original_w:this.original_w,original_h:this.original_h,photo_angle:this.photo_angle,flip_x:this.flip_x,flip_y:this.flip_y,crop_x:this.crop_x,crop_y:this.crop_y,crop_w:this.crop_w,crop_h:this.crop_h}},PM.Core.ImageLayer.prototype.SetPhotoState=function(t){this.photo=t.photo,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var e=$.Deferred(),o=this.Load();return o.done(function(){e.resolve()}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.SetPhotoState: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SetSharedImageInfo=function(t){"leather"==this.gid&&"leather"==t.gid&&(this.width=t.width,this.height=t.height,this.radian=t.radian,this.photo=t.photo,this.photo_image=t.photo_image,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h,this.is_low=t.is_low)},PM.Core.ImageLayer.prototype.GetSpecialFromDiagram=function(t){if(t.indexOf("_special_")>=0){var e=t.replace(".png","_cut.png");return e}return""},PM.Core.ImageLayer.prototype.Load=function(){var t=$.Deferred(),e=this,o=PM.Util.LoadImage(e.diagram);o.done(function(t){e.diagram_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(diagram): "+e.diagram)}),e.special=this.GetSpecialFromDiagram(e.diagram);var r=PM.Util.LoadImage(e.special);r.done(function(t){e.special_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0)}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(special): "+e.special)});var i=PM.Util.LoadImage(e.photo);return i.done(function(t){if(e.flip_x||e.flip_y){var o=0;e.Flip(t,e.flip_x,e.flip_y,o,function(t){e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):e.photo_image=t})}else e.photo_angle?e.RotatePhotoRightAngle(t,e.photo_angle,function(t){e.photo_image=t}):(e.photo_image=t,(e.width<=0||e.height<=0)&&(e.width=t?t.width:0,e.height=t?t.height:0))}),i.fail(function(){console.log("* Fail:PM.Core.ImageLayer.Load(photo): "+e.photo)}),$.when(o,i).then(function(){(e.crop_w<=0||e.crop_h<=0)&&e.FitPhoto(!1),t.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.Load Failure "),t.reject()}),t.promise()},PM.Core.ImageLayer.prototype.AddDiagram=function(t){var e=$.Deferred(),o=this,r=PM.Util.LoadImage(t);r.done(function(e){o.diagram=t,o.diagram_image=e}),r.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(diagram): "+o.diagram)});var i=this.GetSpecialFromDiagram(t),a=PM.Util.LoadImage(i);return a.done(function(t){o.special=i,o.special_image=t}),a.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddDiagram(special): "+o.special)}),$.when(r,a).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.ImageLayer.AddDiagram Failure "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.DeleteDiagram=function(){this.diagram="",this.diagram_image=null,this.special="",this.special_image=null},PM.Core.ImageLayer.prototype.AddPhoto=function(t,e,o,r,i){if(!i&&this.photo.length>0)return{added:!1,promise:null};var a=$.Deferred(),s=this,n=PM.Util.LoadImage(t);return s.photo=t,n.done(function(t){s.photo_image=t,s.photo_org=e,s.original_w=parseInt(o),s.original_h=parseInt(r),s.photo_angle=0,s.flip_x=!1,s.flip_y=!1,s.FitPhoto(!1),a.resolve(),"leather"==s.gid&&PM.Editor.Framework.SetSharedImageInfo(s)}),n.fail(function(){console.log("* Fail:PM.Core.ImageLayer.AddPhoto(photo): "+s.photo),a.reject()}),{added:!0,promise:a.promise()}},PM.Core.ImageLayer.prototype.DeletePhoto=function(){if(!(this.photo.length<=0)){var t=[],e=[],o={type:this.GetType(),value:this.GetPhotoState()};t.push(o),this.DeletePhotoProp();var r={type:this.GetType(),value:this.GetPhotoState()};e.push(r),this.RecordState(PM.RECORD_PHOTO_CHANGE,t,e,"사진 삭제")}},PM.Core.ImageLayer.prototype.DeletePhotoProp=function(){if(this.photo.length<=0)return!1;var t=this.photo;return this.photo="",this.photo_image=null,this.photo_org="",this.original_w=0,this.original_h=0,this.photo_angle=0,this.flip_x=!1,this.flip_y=!1,this.crop_x=0,this.crop_y=0,this.crop_w=0,this.crop_h=0,t.length>0&&"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),!0},PM.Core.ImageLayer.prototype.ValidatePhotoBoundary=function(){this.photo_image&&(this.crop_x<0&&(this.crop_x=0),this.crop_y<0&&(this.crop_y=0),this.crop_x+this.crop_w>this.photo_image.width&&(this.crop_x=this.photo_image.width-this.crop_w),this.crop_y+this.crop_h>this.photo_image.height&&(this.crop_y=this.photo_image.height-this.crop_h))},PM.Core.ImageLayer.prototype.MoveCrop=function(t,e,o,r){if(this.photo_image){var i=this.xpos+this.width/2,a=this.ypos+this.height/2,s=this.NonRotatedPoint(i,a,t,e),n=this.NonRotatedPoint(i,a,o,r),h=n.x-s.x,l=n.y-s.y;this.crop_x-=h,this.crop_y-=l,this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this)}},PM.Core.ImageLayer.prototype.FitPhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),o=PM.Util.GetScaledRect(this.width,this.height,this.photo_image.width,this.photo_image.height,!1);this.crop_x=o.l,this.crop_y=o.t,this.crop_w=o.w,this.crop_h=o.h,"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var r=this.GetCropInfo();t&&this.RecordState(PM.RECORD_PHOTO_CROP,e,r,"사진 화면맞춤")}},PM.Core.ImageLayer.prototype.ScalePhoto=function(t){if(this.photo_image){var e=this.GetCropInfo(),o=this.crop_w*t,r=this.crop_h*t;if(this.crop_w-o>this.photo_image.width||this.crop_h-r>this.photo_image.height){var i=this.crop_x,a=this.crop_y;this.FitPhoto(!1),this.crop_x=i,this.crop_y=a}else this.crop_x+=o/2,this.crop_y+=r/2,this.crop_w-=o,this.crop_h-=r;this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution();var s=this.GetCropInfo();this.RecordState(PM.RECORD_PHOTO_CROP,e,s,t>0?"사진 확대":"사진 축소")}},PM.Core.ImageLayer.prototype.Resize=function(t,e,o,r,i){var a=this.width,s=this.height;if(PM.Core.Layer.prototype.Resize.call(this,t,e,o,r,i),this.photo_image){var n=this.width-a,h=this.height-s,l=n/a,c=h/s;if(this.crop_w+=this.crop_w*l,this.crop_h+=this.crop_h*c,this.crop_w>this.photo_image.width||this.crop_h>this.photo_image.height){var p=this.crop_x,d=this.crop_y;this.FitPhoto(!1),this.crop_x=p,this.crop_y=d}this.ValidatePhotoBoundary(),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this),this.is_low=this.IsLowResolution()}},PM.Core.ImageLayer.prototype.RotatePhoto=function(t){if(this.photo_image&&(90==t||-90==t)){var e=this;this.RotatePhotoRightAngle(this.photo_image,t,function(o){var r=[],i=[],a={type:e.GetType(),value:e.GetPhotoState()};r.push(a),e.photo_image=o,e.photo_angle+=t,e.photo_angle<0&&(e.photo_angle+=360),e.photo_angle>=360&&(e.photo_angle-=360),e.FitPhoto(!1),"leather"==e.gid&&PM.Editor.Framework.SetSharedImageInfo(e);var s={type:e.GetType(),value:e.GetPhotoState()};i.push(s),e.RecordState(PM.RECORD_PHOTO_CHANGE,r,i,"사진 회전")})}},PM.Core.ImageLayer.prototype.RotatePhotoRightAngle=function(t,e,o){var r=$.Deferred();if(!t)return r.resolve();var i=document.createElement("canvas"),a=i.getContext("2d");90==e||-90==e||270==e?(i.width=t.height,i.height=t.width):(i.width=t.width,i.height=t.height),a.translate(i.width/2,i.height/2),a.rotate(e*Math.PI/180),a.translate(-i.width/2,-i.height/2);var s=i.width/2-t.width/2,n=i.height/2-t.height/2;a.drawImage(t,s,n);var h=this,l=PM.Util.CanvasToImage(i),c=PM.Util.LoadImage(l);return c.done(function(t){o(t),r.resolve(),"leather"==h.gid&&PM.Editor.Framework.SetSharedImageInfo(h)}),c.fail(function(){console.log("* Fail:PM.Core.ImageLayer.RotatePhoto: "+e),r.reject()}),r.promise()},PM.Core.ImageLayer.prototype.FlipPhoto=function(t,e){if(this.photo_image){var o=this;this.Flip(this.photo_image,t,e,this.photo_angle,function(r){var i=[],a=[],s={type:o.GetType(),value:o.GetPhotoState()};i.push(s),o.photo_image=r,t&&(o.flip_x=!o.flip_x),e&&(o.flip_y=!o.flip_y),"leather"==this.gid&&PM.Editor.Framework.SetSharedImageInfo(this);var n={type:o.GetType(),value:o.GetPhotoState()};a.push(n),o.RecordState(PM.RECORD_PHOTO_CHANGE,i,a,"사진 플립")})}},PM.Core.ImageLayer.prototype.Flip=function(t,e,o,r,i){var a=$.Deferred();if(!t)return a.resolve();var s=document.createElement("canvas"),n=s.getContext("2d");if(s.width=t.width,s.height=t.height,90==r||-90==r||270==r){var h=e;e=o,o=h}var l=0,c=0,p=1,d=1;e&&(l=s.width,p=-1),o&&(c=s.height,d=-1),n.translate(l,c),n.scale(p,d),n.drawImage(t,0,0);var _=this,u=PM.Util.CanvasToImage(s),f=PM.Util.LoadImage(u);return f.done(function(t){i(t),a.resolve(),"leather"==_.gid&&PM.Editor.Framework.SetSharedImageInfo(_)}),f.fail(function(){console.log("* Fail:PM.Core.ImageLayer.FlipPhoto"),a.reject()}),a.promise()},PM.Core.ImageLayer.prototype.DrawController=function(t,e,o,r){if(PM.Core.Layer.prototype.DrawController.call(this,t,e,o,r),this.photo_image&&!PM.Editor.Framework.IsShiftState()){this.PrepareDC(t,e,o);var i=1,a=PM.COLOR_DRAGGER_NORMAL_STROKE,s=PM.COLOR_DRAGGER_NORMAL_FILL,n=PM.CONFIG.CROP_RADIUS,h=this.width/2,l=this.height/2;PM.Util.DrawCircle(t,h,l,n,i,a,s),this.ReleaseDC(t)}},PM.Core.ImageLayer.prototype.Draw=function(t,e,o,r){if(this.PrepareDC(t,e,o),t.beginPath(),t.rect(0,0,this.width,this.height),t.clip(),this.diagram_image){var i=document.createElement("canvas"),a=i.getContext("2d");if(i.width=this.width,i.height=this.height,a.drawImage(this.diagram_image,0,0,this.width,this.height),this.photo_image)a.globalCompositeOperation="source-atop",a.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height),this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(i,0,0,this.width,this.height);else if(PM.Editor.Framework.IsPreviewMode())this.special_image&&t.drawImage(this.special_image,0,0,this.width,this.height);else{var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);a.globalCompositeOperation="source-atop",a.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}this.special_image&&a.drawImage(this.special_image,0,0,this.width,this.height),t.drawImage(i,0,0,this.width,this.height)}}else if(this.photo_image)t.drawImage(this.photo_image,this.crop_x,this.crop_y,this.crop_w,this.crop_h,0,0,this.width,this.height);else if(!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_empty_image;if(s){var n=PM.Util.GetScaledRect(this.width,this.height,s.width,s.height,!1);t.drawImage(s,n.l,n.t,n.w,n.h,0,0,this.width,this.height)}else PM.Util.DrawRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,PM.COLOR_LAYER_FILL)}if(this.is_low&&this.photo_image&&!PM.Editor.Framework.IsPreviewMode()){var s=PM.Editor.Framework.photo_warning_image;s&&t.drawImage(s,this.width-s.width,0,s.width,s.height)}if(this.DrawExtra(t,r),PM.DEBUG&&!PM.Editor.Framework.IsPreviewMode()){t.font="20px Nanum Gothic",t.fillStyle="#5555ff",t.strokeStyle="#ff0000",t.textAlign="center",t.textBaseline="middle";var h="("+this.original_w+"x"+this.original_h+")";t.fillText(h,this.width/2,20,this.width),t.strokeText(h,this.width/2,20,this.width)}this.ReleaseDC(t)},PM.Core.ImageLayer.prototype.GetDrawItemList=function(){return"\n[mask] "+this.diagram+", [photo] "+this.photo},PM.Core.ImageLayer.prototype.HitTestController=function(t,e,o){var r=PM.Core.Layer.prototype.HitTestController.call(this,t,e,o);if(r==PM.HIT.MOVE&&this.photo_image&&!PM.Editor.Framework.IsShiftState()){var i=PM.CONFIG.CROP_RADIUS,a=this.xpos+this.width/2,s=this.ypos+this.height/2,n=this.NonRotatedPoint(a,s,e,o);if(PM.Util.PtInCircle(a,s,i,n.x,n.y))return PM.HIT.MOVE_CROP}return r},PM.Core.ImageLayer.prototype.HitTest=function(t,e,o){return PM.Core.Layer.prototype.HitTest.call(this,t,e,o)?this:null},PM.Core.ImageLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),$layer_effect=t.find("effect");var e=$layer_effect.attr("diagramfilename");e&&e.length>0?this.diagram=PM.Util.GetFullPathName(PM.URL.STICKER_FILE,e):(e=$layer_effect.attr("rotateflip"),e&&"roundmask"==e&&(this.diagram=PM.CONFIG.ROUNDMASK_IMAGE))},PM.Core.ImageLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.diagram=t.diagram,this.diagram_image=null,this.photo=t.photo,this.photo_image=null,this.photo_org=t.photo_org,this.original_w=t.original_w,this.original_h=t.original_h,this.photo_angle=t.photo_angle,this.flip_x=t.flip_x,this.flip_y=t.flip_y,this.crop_x=t.crop_x,this.crop_y=t.crop_y,this.crop_w=t.crop_w,this.crop_h=t.crop_h;var o=this.Load();return o.done(function(){e.resolve()}),o.fail(function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: "),e.reject()}),e.promise()},PM.Core.ImageLayer.prototype.SaveJson=function(){var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.IMAGE,t+='\n        , "diagram": "'+this.diagram+'"',t+='\n        , "photo_org": "'+this.photo_org+'"',t+='\n        , "original_w": '+this.original_w,t+='\n        , "original_h": '+this.original_h,t+='\n        , "photo": "'+this.photo+'"',t+='\n        , "photo_angle": '+this.photo_angle,t+='\n        , "photo_width": '+(this.photo_image?this.photo_image.width:0),t+='\n        , "photo_height": '+(this.photo_image?this.photo_image.height:0),t+='\n        , "flip_x": '+this.flip_x,t+='\n        , "flip_y": '+this.flip_y,t+='\n        , "crop_x": '+this.crop_x,t+='\n        , "crop_y": '+this.crop_y,t+='\n        , "crop_w": '+this.crop_w,t+='\n        , "crop_h": '+this.crop_h,t+="\n        }"},PM.Core.ImageLayer.prototype.IsLowResolution=function(){var t=PM.Editor.Framework.GetProduct().product_size,e=PM.Editor.Framework.GetCurrentPairSize(),o=PM.Util.ProductSize2InchSize(t),r=o.w*PM.CONFIG.PHOTO_MIN_DPI*2*o.h*PM.CONFIG.PHOTO_MIN_DPI,i=this.width*this.height/(e.w*e.h),a=r*i,s=this.photo_image.width*this.photo_image.height,n=this.original_w*this.original_h,h=n/s,l=this.crop_w*this.crop_h*h;return a>l},PM.Core.ImageLayer.prototype.Test=function(t,e,o,r){if(null!=t&&(0!=e||0!=o||0!=r)){var i=this,a=new PM.Lib.SeqManager;(o||r)&&a.Add(function(e){i.Flip(t,o,r,0,function(o){t=o,console.log("flip"),e.deferred.resolve()})}),e&&a.Add(function(o){i.RotatePhotoRightAngle(t,e,function(e){t=e,console.log("rotate"),o.deferred.resolve()})}),a.Run(function(){i.photo_image=t,i.photo_angle=e,i.flip_x=o,i.flip_y=r,i.FitPhoto(!1),console.log("end...")},function(){console.log("* Fail:PM.Core.ImageLayer.LoadJson: ")})}},PM.Core.TextLayer=function(){PM.Core.Layer.call(this),this.halign="center",this.valign="middle",this.caption="",this.textdata="",this.fontname="",this.fontsize=14,this.italic=!1,this.bold=!1,this.color="",this.bkcolor="",this.chargap=0,this.linegap=0,this.tbox=new PM.Ctrl.TextBox},PM.Core.TextLayer.prototype=new PM.Core.Layer,PM.Core.TextLayer.prototype.GetType=function(){return PM.TYPE.TEXT},PM.Core.TextLayer.prototype.GetDesc=function(){return"글상자"},PM.Core.TextLayer.prototype.InitTBox=function(t){t.tbox.setfontdefault(t.fontname,t.fontsize,t.color,t.bold,t.italic),t.tbox.setparadefault(t.halign,0,t.linegap),t.tbox.setimemode(!0),t.tbox.setvalign(t.valign,PM.RECORD_OFF),"spine"==t.gid&&(t.tbox.setsingleline(!0),t.tbox.setvalign("middle",PM.RECORD_OFF),t.tbox.setspine(!0)),t.tbox.SetSize(t.width,t.height),t.tbox.SetMinHeight(t.height),t.textdata.length>0&&t.tbox.IsEmptyDoc()&&t.tbox.fromString(t.textdata)},PM.Core.TextLayer.prototype.Load=function(){var t=$.Deferred();return(this.width<=0||this.height<=0)&&(this.width=200,this.height=40),this.InitTBox(this),t.resolve(),t.promise()},PM.Core.TextLayer.prototype.ResizeFromTBoxCallback=function(t,e){if(!this.resizelock&&this.tbox){var o=this.xpos+this.width/2,r=this.ypos+this.height/2;this.height=e>=30?e:30,this.RecalcXY(o,r),this.tbox.SetSize(this.width,this.height)}},PM.Core.TextLayer.prototype.Resize=function(t,e,o,r,i){PM.Core.Layer.prototype.Resize.call(this,t,e,o,r,i),this.tbox.SetSize(this.width,this.height),this.tbox.SetMinHeight(this.height)},PM.Core.TextLayer.prototype.RecalcTBoxSize=function(t){this.tbox&&(this.tbox.edit_w=this.width,this.tbox.updateall(t))},PM.Core.TextLayer.prototype.AdjustSize=function(){this.height<this.tbox.getheight()&&(this.height=this.tbox.getheight(),this.tbox.SetSize(this.width,this.height))},PM.Core.TextLayer.prototype.SelectAll=function(){this.tbox&&this.tbox.selectAll()},PM.Core.TextLayer.prototype.GetEditableTextBox=function(){return this.tbox?this.tbox:null},PM.Core.TextLayer.prototype.IsFocusTextBox=function(){return this.tbox&&this.tbox.isfocus()?!0:!1},PM.Core.TextLayer.prototype.ResetFocus=function(){this.tbox&&(this.textdata=this.tbox.toString(),this.tbox.killfocus())},PM.Core.TextLayer.prototype.Undo=function(t){return this.tbox?this.tbox.undo_action(t):!1},PM.Core.TextLayer.prototype.Redo=function(t){return this.tbox?this.tbox.redo_action(t):!1},PM.Core.TextLayer.prototype.KeyDown=function(t){return this.tbox.KeyDown(t)},PM.Core.TextLayer.prototype.KeyPress=function(t){return this.tbox.KeyPress(t)},PM.Core.TextLayer.prototype.NormalizePoint=function(t,e){t-=this.xpos,e-=this.ypos;var o=this.width/2,r=this.height/2;return this.NonRotatedPoint(o,r,t,e)},PM.Core.TextLayer.prototype.MouseDown=function(t,e,o,r){var i=this.NormalizePoint(o,r);this.tbox.MouseDown(t,e,i.x,i.y)
},PM.Core.TextLayer.prototype.MouseMove=function(t,e,o){var r=this.NormalizePoint(e,o);this.tbox.MouseMove(t,r.x,r.y)},PM.Core.TextLayer.prototype.MouseUp=function(t,e,o){var r=this.NormalizePoint(e,o);this.tbox.MouseUp(t,r.x,r.y)},PM.Core.TextLayer.prototype.Draw=function(t,e,o,r){if(!PM.Editor.Framework.IsPreviewMode()||!this.tbox.IsEmptyDoc()){if(this.PrepareDC(t,e,o),t.canvas.id==PM.Core.MAIN_CANVAS_ID)if(this.textdata.length<=0&&!this.tbox.isfocus()){PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null);var i="";i=this.bold?"bold ":"",i+=this.italic?"italic ":"",i+=this.fontsize+"pt ",i+=PM.Util.GetWebFont(this.fontname),t.font=i,t.fillStyle=this.color,t.textAlign="center",t.textBaseline="middle",t.fillText(this.caption,this.width/2,this.height/2,this.width)}else PM.Editor.Framework.IsPreviewMode()||PM.Util.DrawDashRect(t,0,0,this.width,this.height,.5,PM.COLOR_LAYER_STROKE,null),this.tbox.Draw(t);else this.tbox.Draw(t);this.DrawExtra(t,r),this.ReleaseDC(t)}},PM.Core.TextLayer.prototype.GetDrawItemList=function(){return""},PM.Core.TextLayer.prototype.HitTestController=function(t,e,o){var r=PM.Core.Layer.prototype.HitTestController.call(this,t,e,o);return this.tbox.isfocus()&&(r=r==PM.HIT.MOVE?PM.HIT.EDIT_TEXT:PM.HIT.NONE),r},PM.Core.TextLayer.prototype.HitTest=function(t,e,o){return PM.Core.Layer.prototype.HitTest.call(this,t,e,o)?this:null},PM.Core.TextLayer.prototype.Parse=function(t){PM.Core.Layer.prototype.Parse.call(this,t),this.halign=t.attr("halign"),this.valign=t.attr("valign"),this.caption=t.find("caption").text(),this.textdata=t.find("text").text(),this.textdata.length>0?this.textdata.indexOf(PM.TBOX_COMMENT_DEFAULT)>=0?(this.caption=this.textdata,this.textdata=""):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata):(this.caption=PM.TBOX_COMMENT_DEFAULT,this.textdata=""),$layer_font=t.find("fontinfo");var e=$layer_font.attr("fontname");e=PM.Util.GetWebFont(e),PM.Util.LoadWebFont(e,function(){}),this.fontname=e,this.fontsize=parseInt($layer_font.attr("fontsize")),this.italic="true"===$layer_font.attr("italic"),this.bold="true"===$layer_font.attr("bold"),this.color=PM.Util.String2HexColor($layer_font.attr("color")),this.bkcolor=PM.Util.String2HexColor($layer_font.attr("bkcolor")),this.chargap=parseFloat($layer_font.attr("chargap")),this.linegap=parseFloat($layer_font.attr("linegap")),this.fontsize=Math.floor(6*this.fontsize/8),this.bkcolor="",this.chargap=0,this.linegap=0},PM.Core.TextLayer.prototype.LoadJson=function(t){var e=$.Deferred();PM.Core.Layer.prototype.LoadJson.call(this,t),this.halign=t.halign,this.valign=t.valign,this.caption=t.caption,this.textdata=t.textdata;var o=PM.Util.GetWebFont(t.fontname);return PM.Util.LoadWebFont(o,function(){console.log("[load-json] webfont loaded... "+o+" "+Date.now())}),this.fontname=o,this.fontsize=t.fontsize,this.italic=t.italic,this.bold=t.bold,this.color=t.color,this.bkcolor=t.bkcolor,this.chargap=t.chargap,this.linegap=t.linegap,this.tbox=new PM.Ctrl.TextBox,this.InitTBox(this),this.tbox.LoadJson(t.tbox_info),e.resolve(),e.promise()},PM.Core.TextLayer.prototype.LoadJsonAtPos=function(t,e,o){var r=JSON.parse(o);this.LoadJson(r),this.xpos=t,this.ypos=e},PM.Core.TextLayer.prototype.SaveJson=function(){this.textdata=this.tbox.toString();var t="\n        {";return t+=PM.Core.Layer.prototype.SaveJson.call(this),t+='\n        , "type": '+PM.TYPE.TEXT,t+='\n        , "halign": "'+this.halign+'"',t+='\n        , "valign": "'+this.valign+'"',t+='\n        , "caption": "'+this.caption+'"',t+='\n        , "textdata": "'+this.textdata+'"',t+='\n        , "fontname": "'+this.fontname+'"',t+='\n        , "fontsize": '+this.fontsize,t+='\n        , "italic": '+this.italic,t+='\n        , "bold": '+this.bold,t+='\n        , "color": "'+this.color+'"',t+='\n        , "bkcolor": "'+this.bkcolor+'"',t+='\n        , "chargap": '+this.chargap,t+='\n        , "linegap": '+this.linegap,t+='\n        , "tbox_info": \n',t+=this.tbox.SaveJsonEx(),t+="\n        }"},PM.Core.Layout=function(){this.style="normal",this.kind="",this.type="",this.imgcnt=0,this.link="",this.thumb=""},PM.Core.Layout.prototype.copy=function(){var t=new PM.Core.Layout;return t.style=this.style,t.kind=this.kind,t.type=this.type,t.imgcnt=this.imgcnt,t.link=this.link,t.thumb=this.thumb,t},PM.Core.Skin=function(){this.kind="",this.type="",this.link="",this.thumb="",this.storecode=""},PM.Core.Skin.prototype.copy=function(){var t=new PM.Core.Skin;return t.kind=this.kind,t.type=this.type,t.link=this.link,t.thumb=this.thumb,t.storecode=this.storecode,t},PM.Core.Cover=function(){this.back_page=new PM.Core.Page,this.middle_page=new PM.Core.Page,this.front_page=new PM.Core.Page},PM.Core.Cover.prototype.Load=function(){var t=$.Deferred(),e=this.back_page?this.back_page.Load():$.Deferred().resolve(),o=this.middle_page?this.middle_page.Load():$.Deferred().resolve(),r=this.front_page?this.front_page.Load():$.Deferred().resolve();return $.when(e,o,r).then(function(){t.resolve()},function(){t.reject()}),t.promise()},PM.Core.Cover.prototype.GetSpineWidth=function(){if(this.middle_page)for(var t=0;t<this.middle_page.layer_array.length;t++){var e=this.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.height}return 0},PM.Core.Cover.prototype.SetSpineWidth=function(t){if(this.middle_page)for(var e=0;e<this.middle_page.layer_array.length;e++){var o=this.middle_page.layer_array[e];o.GetType()==PM.TYPE.TEXT&&(t>0&&(o.height=t,o.tbox.SetSize(o.width,o.height)),o.xpos=this.middle_page.width/2-o.width/2,o.ypos=this.middle_page.height/2-o.height/2)}},PM.Core.Cover.prototype.LoadJson=function(t){return t.back_page&&void 0!=t.back_page&&this.back_page.LoadJson(t.back_page),t.middle_page&&void 0!=t.middle_page?this.middle_page.LoadJson(t.middle_page):this.middle_page=null,t.front_page&&void 0!=t.front_page?this.front_page.LoadJson(t.front_page):this.front_page=null,!0},PM.Core.Cover.prototype.SaveJson=function(){var t="\n   { ";return this.back_page&&(t+='\n   "back_page": ',t+=this.back_page.SaveJson(),this.middle_page&&(t+='\n,  "middle_page": ',t+=this.middle_page.SaveJson()),this.front_page&&(t+='\n,  "front_page": ',t+=this.front_page.SaveJson())),t+="\n   }"},PM.Core.Cover.prototype.CheckComplete=function(){if(this.back_page){if(!this.back_page.CheckComplete())return!1;if(this.middle_page&&!this.middle_page.CheckComplete())return!1;if(this.front_page&&!this.front_page.CheckComplete())return!1}return!0},PM.Core.Page=function(){this.layout_kind="",this.layout_type="",this.layout_link="",this.layout_style="normal",this.skin_kind="",this.skin_type="",this.skin_link="",this.skin_storecode="",this.is_layer_lock=!1,this.width=0,this.height=0,this.color="",this.layer_array=[],this.skin_image=null,this.work_pos={}},PM.Core.Page.prototype.SetLayoutInfo=function(t){t&&(this.layout_kind=t.kind,this.layout_type=t.type,this.layout_link=t.link,this.layout_style=t.style)},PM.Core.Page.prototype.SetSkinInfo=function(t){t&&(this.skin_kind=t.kind,this.skin_type=t.type,this.skin_link=t.link,this.skin_storecode=t.storecode)},PM.Core.Page.prototype.CopyProperty=function(){var t=new PM.Core.Page;return t.layout_kind=this.layout_kind,t.layout_type=this.layout_type,t.layout_link=this.layout_link,t.layout_style=this.layout_style,t.skin_kind=this.skin_kind,t.skin_type=this.skin_type,t.skin_link=this.skin_link,t.skin_storecode=this.skin_storecode,t.width=this.width,t.height=this.height,t.color=this.color,t.layer_array=[],t.skin_image=this.skin_image,t.work_pos.x=this.work_pos.x,t.work_pos.y=this.work_pos.y,t},PM.Core.Page.prototype.GetDefaultDummyLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h_bg.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"w_bg.xml":PM.URL.LAYOUT_FILE+"s_bg.xml"},PM.Core.Page.prototype.GetDefaultPageLink=function(t){var e="";return e="vertsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"h01f001.xml":"horzsquare"==t.layout_kind?PM.URL.LAYOUT_FILE+"W01f001.xml":PM.URL.LAYOUT_FILE+"s_01f097.xml"},PM.Core.Page.prototype.CreateDefaultPage=function(){var t=this.CopyProperty();t.layout_link=this.GetDefaultPageLink(t);var e=new PM.Core.ImageLayer;return t.layer_array.push(e),e.xpos=0,e.ypos=0,e.width=t.width,e.height=t.height,t},PM.Core.Page.prototype.Load=function(){var t=this,e=$.Deferred(),o=t.skin_link.length<=0,r=PM.Util.LoadXml(t.layout_link),i=PM.Util.LoadImage(t.skin_link);return r.done(function(e){t.Parse(e)}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(layout_xml): "+t.layout_link)}),i.done(function(e){t.skin_image=e}),i.fail(function(){console.log("* Fail:PM.Core.Page.Load(skin_image): "+t.skin_link)}),$.when(r,i).then(function(){var r=t.LoadLayers(t);r.done(function(){if(PM.PRODUCT.CALENDAR==PM.Editor.Framework.GetProduct().GetType()&&o&&t.skin_link.length>0){var r=PM.Util.LoadImage(t.skin_link);r.done(function(o){t.skin_image=o,e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(skin_image-> 2th try): "+t.skin_link)})}else e.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.Page.Load(LoadLayers) ")})},function(){console.log("-----------> PM.Core.Page.Load Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.LoadLayers=function(t){for(var e=$.Deferred(),o=[],r=0;r<t.layer_array.length;r++){var i=t.layer_array[r];o.push(i.Load())}return $.when.apply($,o).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadLayers Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.IsLayerLock=function(){return this.is_layer_lock},PM.Core.Page.prototype.SetLayersLockInfo=function(t){this.is_layer_lock=t;for(var e=0;e<this.layer_array.length;e++){var o=this.layer_array[e];o.movelock=t,o.resizelock=t,o.zorderlock=t,o.removelock=t,o.GetType()==PM.TYPE.TEXT&&o.tbox&&(o.resizelock?(o.tbox.setautoresize(!1),o.tbox.SetSize(o.width,o.height),o.tbox.SetMinHeight(o.height)):o.tbox.setautoresize(!0))}},PM.Core.Page.prototype.SetSharedImageInfo=function(t){for(var e=0;e<this.layer_array.length;e++){var o=this.layer_array[e];if(o&&o!=t&&o.GetType()==PM.TYPE.IMAGE&&"leather"==o.gid){o.SetSharedImageInfo(t);break}}},PM.Core.Page.prototype.ChangeColor=function(t){this.color=t,this.skin_link="",this.skin_storecode="",this.skin_image=null;var e=$.Deferred();return e.resolve()},PM.Core.Page.prototype.ChangeSkin=function(t){var e=this,o=$.Deferred(),r=PM.Util.LoadImage(t);return r.done(function(r){e.skin_link=t,e.skin_image=r,o.resolve()}),r.fail(function(){console.log("* Fail:PM.Core.Page.ChangeSkin(skin_image): "+t),o.reject()}),o.promise()},PM.Core.Page.prototype.ChangeLayout=function(t,e,o){var r=this,i=$.Deferred(),a=PM.Util.LoadXml(t);return a.done(function(a){r.layout_link=t;var s=$(a).find("foreground").find("rect");if(null!=s){var n=r.width/r.height,h=parseInt(s.attr("width"))/parseInt(s.attr("height"));if(n-h==0){var l=null==e?r.GetUserImageList():e,c=null==o?r.color:o;r.Parse(a);var p=r.LoadLayers(r);p.done(function(){r.color=c;var t=r.AddPhotos(l,0).promise;t.done(function(){i.resolve()}),t.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers>AddPhotos) ")})}),p.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(LoadLayers) "),i.reject()})}else i.reject()}}),a.fail(function(){console.log("* Fail:PM.Core.Page.ChangeLayout(layout_xml): "+t),i.reject()}),i.promise()},PM.Core.Page.prototype.GetLayerIndex=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e])return e;return-1},PM.Core.Page.prototype.AddLayerOrderly=function(t){var e=0,o=this.layer_array.length;if(t.GetType()==PM.TYPE.IMAGE){for(;o>e&&this.layer_array[e].GetType()==PM.TYPE.IMAGE;)e++;this.layer_array.splice(e,0,t)}else if(t.GetType()==PM.TYPE.ICON){for(;o>e&&(this.layer_array[e].GetType()==PM.TYPE.IMAGE||this.layer_array[e].GetType()==PM.TYPE.ICON);)e++;this.layer_array.splice(e,0,t)}else this.layer_array.push(t)},PM.Core.Page.prototype.AddNewLayer=function(t,e,o,r){var i=this,a=$.Deferred(),s=o.Load();return s.done(function(){i.AddLayerOrderly(o);var s=o.width,n=o.height;!r&&s>i.width/4&&(s=i.width/4,n=s*o.height/o.width),o.width=s,o.height=n,o.xpos=t-i.work_pos.x-o.width/2,o.ypos=e-i.work_pos.y-o.height/2,a.resolve()}),s.fail(function(){console.log("* Fail:PM.Core.Page.AddNewLayer "),a.reject()}),a.promise()},PM.Core.Page.prototype.AddLayerAndLoad=function(t){this.AddLayerOrderly(t),t.Load()},PM.Core.Page.prototype.AddLayer=function(t){this.AddLayerOrderly(t)},PM.Core.Page.prototype.RemoveLayer=function(t){for(var e=0;e<this.layer_array.length;e++)if(t==this.layer_array[e]){this.layer_array.splice(e,1);break}},PM.Core.Page.prototype.RemoveEmptyLayers=function(){for(var t=[],e=this.layer_array.length-1;e>=0;e--){var o=this.layer_array[e];if(o.GetType()==PM.TYPE.IMAGE&&o.photo.length<=0){var r={page_pos:-1,layer_pos:e,data:o};t.push(r),this.layer_array.splice(e,1)}}return t},PM.Core.Page.prototype.SwapLayer=function(t,e,o){if(0>e||e>=t.length)return-1;if(0>o||o>=t.length)return-1;if(t[e].GetType()!=t[o].GetType())return-1;var r=t[e];return t[e]=t[o],t[o]=r,o},PM.Core.Page.prototype.RotateLayer=function(t,e){return t?t.RotateAngle(e):!1},PM.Core.Page.prototype.UpLayer=function(t){for(var e=-1,o=0;o<this.layer_array.length;o++)if(t==this.layer_array[o]){e=this.SwapLayer(this.layer_array,o,o+1);break}return e},PM.Core.Page.prototype.DownLayer=function(t){for(var e=-1,o=0;o<this.layer_array.length;o++)if(t==this.layer_array[o]){e=this.SwapLayer(this.layer_array,o,o-1);break}return e},PM.Core.Page.prototype.ResetFocus=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];e.GetType()==PM.TYPE.TEXT&&e.ResetFocus()}},PM.Core.Page.prototype.AddPhotos=function(t,e){var o=e,r=[],i=[],a=$.Deferred();if(o>=0&&o<t.length)for(var s=0;s<this.layer_array.length;s++)try{var n=t[o],h=JSON.parse(n),l=this.layer_array[s];if(l&&l.GetType()==PM.TYPE.IMAGE){var c="",p="",d=0,_=0;void 0==h.url_domain?(c=h.edit_link,p=h.org_link,d=h.original_width,_=h.original_height):(c=h.url_domain+h.url_path+h.url_edit,p=h.url_domain+h.url_path+h.url_file,d=h.img_width,_=h.img_height);var u=!1,f=l.AddPhoto(c,p,d,_,u);f.added&&(o++,r.push({page_pos:-1,layer_pos:s,json:n}),i.push(f.promise))}}catch(g){o++,console.error(g)}finally{if(o>=t.length){o=-1;break}}else o=-1;return i.length>0?$.when.apply($,i).then(function(){a.resolve()},function(){a.reject()}):a.resolve(),{next_idx:o,result_photos:r,promise:a.promise()}},PM.Core.Page.prototype.DeletePhotos=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var o=this.layer_array[e];if(o&&o.GetType()==PM.TYPE.IMAGE){var r={page_pos:-1,layer_pos:e,info:o.GetPhotoState()};o.DeletePhotoProp()&&t.push(r)}}return t},PM.Core.Page.prototype.GetUserImageList=function(){for(var t=[],e=0;e<this.layer_array.length;e++){var o=this.layer_array[e];if(o&&o.GetType()==PM.TYPE.IMAGE&&o.photo.length>0&&o.photo_org.length>0){var r="{";r+='"edit_link": "'+o.photo+'"',r+=', "org_link": "'+o.photo_org+'"',r+=', "original_width": '+o.original_w,r+=', "original_height": '+o.original_h,r+="}",t.push(r)}}return t},PM.Core.Page.prototype.GetImageLayerCount=function(){for(var t=0,e=0;e<this.layer_array.length;e++){var o=this.layer_array[e];o&&o.GetType()==PM.TYPE.IMAGE&&t++}return t},PM.Core.Page.prototype.GetWorkRect=function(){var t="layflat"==this.layout_style?2*this.width:this.width;return{l:this.work_pos.x,t:this.work_pos.y,w:t,h:this.height}},PM.Core.Page.prototype.HitTestLayers=function(t,e,o){e-=this.work_pos.x,o-=this.work_pos.y;for(var r=this.layer_array.length-1;r>=0;r--){var i=this.layer_array[r].HitTest(t,e,o);if(i)return i}return null},PM.Core.Page.prototype.DrawBackground=function(t,e,o){if(t.save(),this.color&&this.color.length>0&&(t.fillStyle=this.color,t.fillRect(e,o,this.width,this.height)),null!=this.skin_image){var r=this.width/this.height,i=this.skin_image.width/this.skin_image.height;if(r-i==0)t.drawImage(this.skin_image,e,o,this.width,this.height);else{var a=PM.Util.GetScaledRect(this.width,this.height,this.skin_image.width,this.skin_image.height,!1);t.drawImage(this.skin_image,a.l,a.t,a.w,a.h,e,o,this.width,this.height)}}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.work_pos.x=e,this.work_pos.y=o),t.restore()},PM.Core.Page.prototype.DrawLayers=function(t,e,o,r){t.save();for(var i=0;i<this.layer_array.length;i++){var a=this.layer_array[i];(r==PM.TYPE.UNKNOWN||r==a.GetType())&&a.Draw(t,e,o,i)}t.restore()},PM.Core.Page.prototype.DrawBorder=function(t,e,o){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.strokeStyle=PM.COLOR_PAGE_BORDER,t.strokeRect(e,o,this.width,this.height),t.restore())},PM.Core.Page.prototype.DrawProlog=function(t,e,o){PM.Editor.Framework.IsPreviewMode()||(t.save(),t.font=PM.CONFIG.PROLOG_FONT,t.fillStyle=PM.CONFIG.PROLOG_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(PM.CONFIG.PROLOG_TEXT,e,o),t.restore())},PM.Core.Page.prototype.GetDrawItemList=function(){var t="\n[skin] "+this.skin_link,e=[];e.push(t);for(var o=0;o<this.layer_array.length;o++)e.push(this.layer_array[o].GetDrawItemList());return e},PM.Core.Page.prototype.Parse=function(t){var e=this;e.layer_array=[];var o=$(t).find("foreground").find("rect");if(null==o)return!1;if(e.width=parseInt(o.attr("width")),e.height=parseInt(o.attr("height")),e.skin_link.length<=0){var r=$(t).find("foreground").find("file"),i=r.text();i.length>0&&(e.skin_link=PM.Util.GetFullPathName(PM.URL.SKIN_FILE,i))}var a=$(t).find("pagefileargb");e.color=PM.Util.ToHexColor(a.attr("r"),a.attr("g"),a.attr("b"));var s=$(t).find("layer").find("maskimage");s.find("maskrect").each(function(){var t=new PM.Core.ImageLayer;e.AddLayerOrderly(t),t.type=0,t.Parse($(this))}),$(t).find("iconinfo").each(function(){var t=new PM.Core.IconLayer;e.AddLayerOrderly(t),t.type=1,t.Parse($(this))}),$(t).find("textinfo").each(function(){var t=new PM.Core.TextLayer;e.AddLayerOrderly(t),t.type=2,t.Parse($(this))})},PM.Core.Page.prototype.LoadJson=function(t){var e=$.Deferred(),o=[];this.layout_kind=t.layout_kind,this.layout_type=t.layout_type,this.layout_link=t.layout_link,this.layout_style=t.layout_style,this.skin_kind=t.skin_kind,this.skin_type=t.skin_type,this.skin_link=t.skin_link,this.skin_storecode=t.skin_storecode,this.width=t.width,this.height=t.height,this.color=t.color,this.layer_array=[];for(var r in t.layer_array){var i=null;switch(t.layer_array[r].type){case PM.TYPE.ICON:i=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:i=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:i=new PM.Core.TextLayer}i&&(this.layer_array.push(i),o.push(i.LoadJson(t.layer_array[r])))}var a=this,s=PM.Util.LoadImage(a.skin_link);return s.done(function(t){a.skin_image=t}),s.fail(function(){console.log("* Fail:PM.Core.Page.LoadJson(skin_image): "+a.skin_link)}),o.push(s),$.when.apply($,o).then(function(){e.resolve()},function(){console.log("-----------> PM.Core.Page.LoadJson Failure "),e.reject()}),e.promise()},PM.Core.Page.prototype.SaveJson=function(){var t="\n    {";t+='\n    "layout_kind": "'+this.layout_kind+'"',t+='\n    , "layout_type": "'+this.layout_type+'"',t+='\n    , "layout_link": "'+this.layout_link+'"',t+='\n    , "layout_style": "'+this.layout_style+'"',t+='\n    , "skin_kind": "'+this.skin_kind+'"',t+='\n    , "skin_type": "'+this.skin_type+'"',t+='\n    , "skin_link": "'+this.skin_link+'"',t+='\n    , "skin_storecode": "'+this.skin_storecode+'"',t+='\n    , "width": '+this.width,t+='\n    , "height": '+this.height,t+='\n    , "color": "'+this.color+'"',t+='\n    , "layer_array": [';for(var e=0;e<this.layer_array.length;e++)t+=this.layer_array[e].SaveJson(),e<this.layer_array.length-1&&(t+="\n    ,");return t+="\n    ]",t+="\n    }"},PM.Core.Page.prototype.CheckComplete=function(){for(var t=0;t<this.layer_array.length;t++){var e=this.layer_array[t];if(e&&e.GetType()==PM.TYPE.IMAGE&&e.photo.length<=0)return!1}return!0},PM.Core.ProductBase=function(){this.base_type=PM.PRODUCT.UNKNOWN,this.user_id="",this.session_id="",this.add_param="",this.price=0,this.basket_name="",this.order_code="",this.product_code="",this.product_key="",this.product_name="",this.cover=null,this.prolog=null,this.page_array=[],this.epilog=null,this.is_complete=!1,this.dragger=null,this.work_pos={x:0,y:0},this.clipboard_memory="",this.keep_photos=null,this.move_state=null},PM.Core.ProductBase.prototype.GetType=function(){return this.base_type},PM.Core.ProductBase.prototype.PreProcess=function(){console.assert(!1,"PreProcess")},PM.Core.ProductBase.prototype.Load=function(){console.assert(!1,"Load")},PM.Core.ProductBase.prototype.AddPhotosPerPage=function(t){var e=[];if(this.cover&&this.cover.back_page&&!PM.Editor.Framework.IsHoleLeatherCoverProduct()){var o=0,r=this.cover.back_page.AddPhotos(t[0],o);if(e.push(r.promise),this.cover.middle_page){var o=0,r=this.cover.middle_page.AddPhotos(t[1],o);e.push(r.promise)}if(this.cover.front_page){var o=0,r=this.cover.front_page.AddPhotos(t[2],o);e.push(r.promise)}}if(this.prolog,this.page_array.length>0)for(var i=3,a=0;a<this.page_array.length;a++){var o=0,r=this.page_array[a].AddPhotos(t[i++],o);if(e.push(r.promise),i>=t.length)break}this.epilog;var s=this;$.when.apply($,e).then(function(){s.AddPhotosComplete(),s.keep_photos=null},function(){s.AddPhotosFailure()})},PM.Core.ProductBase.prototype.ConcatArrayAndAddInfo=function(t,e,o){if(e.length<=0)return t;for(var r=0;r<e.length;r++)e[r].page_pos=o;return t.concat(e)},PM.Core.ProductBase.prototype.AddPhotos=function(t){var e=0,o=[],r=[];if(this.cover&&this.cover.back_page&&!PM.Editor.Framework.IsHoleLeatherCoverProduct()){var i=this.cover.back_page.AddPhotos(t,e);if(e=i.next_idx,r.push(i.promise),o=this.ConcatArrayAndAddInfo(o,i.result_photos,PM.PAGE.COVER_BACK),e>=0&&this.cover.middle_page){var i=this.cover.middle_page.AddPhotos(t,e);e=i.next_idx,r.push(i.promise),o=this.ConcatArrayAndAddInfo(o,i.result_photos,PM.PAGE.COVER_MIDDLE)}if(e>=0&&this.cover.front_page){var i=this.cover.front_page.AddPhotos(t,e);e=i.next_idx,r.push(i.promise),o=this.ConcatArrayAndAddInfo(o,i.result_photos,PM.PAGE.COVER_FRONT)}}if(e>=0&&this.prolog){var i=this.prolog.AddPhotos(t,e);e=i.next_idx,r.push(i.promise),o=this.ConcatArrayAndAddInfo(o,i.result_photos,PM.PAGE.PROLOG)}if(e>=0&&this.page_array.length>0)for(var a=0;a<this.page_array.length;a++){var i=this.page_array[a].AddPhotos(t,e);if(e=i.next_idx,r.push(i.promise),o=this.ConcatArrayAndAddInfo(o,i.result_photos,a),0>e)break}if(e>=0&&this.epilog,o.length>0){var s=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_ADDALL,s,null,{page_pos:-1,layer_pos:-1,data:o},"일괄사진넣기")}var n=this;$.when.apply($,r).then(function(){n.AddPhotosComplete(),n.keep_photos=null},function(){n.AddPhotosFailure()})},PM.Core.ProductBase.prototype.AddPhotosComplete=function(){console.log("AddPhotos Complete................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},PM.Core.ProductBase.prototype.AddPhotosFailure=function(){console.log("AddPhotos Failure.................................................."),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(-1,"failure")},PM.Core.ProductBase.prototype.DeletePhotos=function(){var t=[];if(this.cover&&this.cover.back_page){var e=this.cover.back_page.DeletePhotos();if(t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_BACK),this.cover.middle_page){var e=this.cover.middle_page.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_MIDDLE)}if(this.cover.front_page){var e=this.cover.front_page.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.COVER_FRONT)}}if(this.prolog){var e=this.prolog.DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,PM.PAGE.PROLOG)}if(this.page_array.length>0)for(var o=0;o<this.page_array.length;o++){var e=this.page_array[o].DeletePhotos();t=this.ConcatArrayAndAddInfo(t,e,o)}if(this.epilog,t.length>0){var r=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_DELALL,r,{page_pos:-1,layer_pos:-1,data:t},null,"일괄사진제거")}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Core.ProductBase.prototype.GetUserImageList=function(){var t=[];if(this.cover){var e=this.cover.back_page?this.cover.back_page.GetUserImageList():[],o=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],r=this.cover.front_page?this.cover.front_page.GetUserImageList():[];t=t.concat(e,o,r)}this.prolog;for(var i=0;i<this.page_array.length;i++)t=t.concat(this.page_array[i].GetUserImageList());return t},PM.Core.ProductBase.prototype.GetUserImageListPerPage=function(){var t=[];this.cover&&(t[0]=this.cover.back_page?this.cover.back_page.GetUserImageList():[],t[1]=this.cover.middle_page?this.cover.middle_page.GetUserImageList():[],t[2]=this.cover.front_page?this.cover.front_page.GetUserImageList():[]),this.prolog;for(var e=3,o=0;o<this.page_array.length;o++)t[e++]=this.page_array[o].GetUserImageList();return t},PM.Core.ProductBase.prototype.DeleteEmptyLayers=function(t){var e=[],o=[];if(t>=0){var r=this.Pair2PageIndex(t);if(r>PM.PAGE.ERROR)switch(r){case PM.PAGE.COVER:this.cover&&this.cover.back_page&&(PM.Editor.Framework.IsHoleLeatherCoverProduct()||(o=this.cover.back_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_BACK),this.cover.middle_page&&(o=this.cover.middle_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_MIDDLE)),this.cover.front_page&&(o=this.cover.front_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_FRONT))));break;case PM.PAGE.PROLOG:o=this.page_array[0].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,0);break;default:o=this.page_array[r].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,r),this.PageCountInPair()>1&&this.page_array[r+1]&&(o=this.page_array[r+1].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,r+1))}}else{this.cover&&this.cover.back_page&&(PM.Editor.Framework.IsHoleLeatherCoverProduct()||(o=this.cover.back_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_BACK),this.cover.middle_page&&(o=this.cover.middle_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_MIDDLE)),this.cover.front_page&&(o=this.cover.front_page.RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,PM.PAGE.COVER_FRONT))));for(var i=0;i<this.page_array.length;i++)o=this.page_array[i].RemoveEmptyLayers(),e=this.ConcatArrayAndAddInfo(e,o,i)}e.length>0&&(t=PM.Editor.Framework.GetPairNumber(),PM.Editor.Framework.RecordOperation(PM.RECORD_EMPTYLAYERS_DELETE,t,{page_pos:-1,layer_pos:-1,data:e},null,"빈레이어 삭제("+e.length+")"),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success"))},PM.Core.ProductBase.prototype.DeleteLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),o=this.GetPageIndex(t),r=t.GetLayerIndex(e),i=[],a=[],s=PM.RECORD_LAYER_DELETE,n={type:e.GetType(),value:$.extend(!0,{},e)};if(i.push(n),this.dragger.DeleteLayer()){var h=PM.Editor.Framework.GetPairNumber();PM.Editor.Framework.RecordOperation(s,h,{page_pos:o,layer_pos:r,data:i},{page_pos:o,layer_pos:r,data:a},e.GetDesc()+" 삭제")}},PM.Core.ProductBase.prototype.RotateLayer=function(t){var e=this.dragger.GetSelectedPage(),o=this.dragger.GetSelectedLayer(),r=this.GetPageIndex(e),i=e.GetLayerIndex(o),a=o.GetMoveInfo();if(this.dragger.RotateLayer(t)){PM.Editor.Framework.CheckBoundary();var s=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,s,{page_pos:r,layer_pos:i,data:a},{page_pos:r,layer_pos:i,data:o.GetMoveInfo()},"레이어 90도 단위 회전"),!0}return!1},PM.Core.ProductBase.prototype.UpLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),o=this.GetPageIndex(t),r=t.GetLayerIndex(e),i=this.dragger.UpLayer();if(i>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:o,layer_pos:r,data:null},{page_pos:o,layer_pos:i,data:null},"레이어 앞으로 이동"),!0}return!1},PM.Core.ProductBase.prototype.DownLayer=function(){var t=this.dragger.GetSelectedPage(),e=this.dragger.GetSelectedLayer(),o=this.GetPageIndex(t),r=t.GetLayerIndex(e),i=this.dragger.DownLayer();if(i>=0){var a=PM.Editor.Framework.GetPairNumber();return PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_ZORDER,a,{page_pos:o,layer_pos:r,data:null},{page_pos:o,layer_pos:i,data:null},"레이어 뒤로 이동"),!0}return!1},PM.Core.ProductBase.prototype.Copy=function(){var t=this.dragger.GetSelectedLayer();return t?"spine"==t.gid?(PM.Editor.Framework.ShowMessageBar("복사할 수 없습니다."),!1):(this.clipboard_memory=t.SaveJson(),this.clipboard_memory.length>0):!1},PM.Core.ProductBase.prototype.Cut=function(){var t=this.dragger.GetSelectedLayer();return t?(this.clipboard_memory=t.SaveJson(),this.DeleteLayer(),this.clipboard_memory.length>0):!1},PM.Core.ProductBase.prototype.Paste=function(t){if(this.clipboard_memory.length<=0)return!1;var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return!1;var o=this.dragger.GetSelectedPage();if(!o||o==this.prolog||this.cover&&o==this.cover.middle_page)switch(e){case PM.PAGE.COVER:o=this.cover.back_page;break;case PM.PAGE.PROLOG:o=this.page_array[0];break;default:o=this.page_array[e]}if(o&&!o.IsLayerLock()){var r=null,i=JSON.parse(this.clipboard_memory);switch(i.type){case PM.TYPE.ICON:r=new PM.Core.IconLayer;break;case PM.TYPE.IMAGE:r=new PM.Core.ImageLayer;break;case PM.TYPE.TEXT:r=new PM.Core.TextLayer}if(r){r.LoadJson(i),r.movelock=r.resizelock=r.zorderlock=r.removelock=!1;var a=o.work_pos.x+r.xpos+r.width/2+20,s=o.work_pos.y+r.ypos+r.height/2+20,n=this,h=o.AddNewLayer(a,s,r,!0);return h.done(function(){n.SetSelectLayer(o,r),PM.Editor.Framework.CheckBoundary();var e=[],i=[],a=n.GetPageIndex(o),s=o.GetLayerIndex(r),h={type:r.GetType(),value:$.extend(!0,{},r)};i.push(h),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_INSERT,t,{page_pos:a,layer_pos:s,data:e},{page_pos:a,layer_pos:s,data:i},r.GetDesc()+" 붙여넣기")}),!0}}return!1},PM.Core.ProductBase.prototype.MakeMoveLayerCallback=function(t){var e=this.dragger.GetSelectedLayer(),o=this.dragger.GetSelectedLayerRect();return null!=o&&(o=PM.Util.L2PRect(o,t)),{layer:e,rect:o}},PM.Core.ProductBase.prototype.ResizeFromTBoxCallbackProcess=function(t){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)},PM.Core.ProductBase.prototype.MovedCallbackProcess=function(t){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){var e=this.MakeMoveLayerCallback(t);PM.Editor.Framework.moveLayerCallback&&PM.Editor.Framework.moveLayerCallback(e.layer,e.rect)}},PM.Core.ProductBase.prototype.CheckComplete=function(){if(this.is_complete=!1,this.cover&&!this.cover.CheckComplete())return!1;for(var t=0;t<this.page_array.length;t++)if(!this.page_array[t].CheckComplete())return!1;return this.is_complete=!0,!0},PM.Core.ProductBase.prototype.GetTotalPageCount=function(){return this.ExtraCount()+this.page_array.length},PM.Core.ProductBase.prototype.GetInnerPageCount=function(){return this.page_array.length},PM.Core.ProductBase.prototype.GetPageIndex=function(t){if(t){for(var e=0;e<this.page_array.length;e++){var o=this.page_array[e];if(o==t)return e}if(t==this.cover.back_page)return PM.PAGE.COVER_BACK;if(t==this.cover.middle_page)return PM.PAGE.COVER_MIDDLE;if(t==this.cover.front_page)return PM.PAGE.COVER_FRONT;if(t==this.prolog)return PM.PAGE.PROLOG;if(t==this.epilog)return PM.PAGE.EPILOG}return PM.PAGE.ERROR},PM.Core.ProductBase.prototype.GetSelectedLayer=function(){return this.dragger.GetSelectedLayer()},PM.Core.ProductBase.prototype.GetSelectedPage=function(){return this.dragger.GetSelectedPage()},PM.Core.ProductBase.prototype.GetSelectedPageIndex=function(){var t=this.dragger.GetSelectedPage();return t?this.GetPageIndex(t):PM.PAGE.ERROR},PM.Core.ProductBase.prototype.ClearSelect=function(){this.dragger.SetSelect(null,null,-1,-1)},PM.Core.ProductBase.prototype.SetSelectLayer=function(t,e){if(e){var o=PM.Editor.Framework.GetPairNumber();
this.ResetFocus(o),this.dragger.SetSelect(t,e,-1,-1),this.dragger.drag_mode=PM.HIT.NONE}else this.ClearSelect()},PM.Core.ProductBase.prototype.GetWorkRect=function(t){var e=this.GetPairSize(t);return{l:this.work_pos.x,t:this.work_pos.y,w:e.w,h:e.h}},PM.Core.ProductBase.prototype.GetFitScaleFactor=function(t,e){var o=this.GetPairSize(1);return o.w=Math.max(o.w,this.GetPairSize(0).w),PM.Util.GetScale(t,e,o.w,o.h,!0)},PM.Core.ProductBase.prototype.GetDropData=function(t){var e="";return 0==t.indexOf("color")?e="color":0==t.indexOf("skin")?e="skin":0==t.indexOf("layout")?e="layout":0==t.indexOf("icon")?e="icon":0==t.indexOf("frame")?e="frame":0==t.indexOf("text")?e="text":0==t.indexOf("photo")&&(e="photo"),{id:e,value:t.substring(e.length)}},PM.Core.ProductBase.prototype.ResetFocus=function(){console.assert(!1,"ResetFocus")},PM.Core.ProductBase.prototype.PageCountInPair=function(){console.assert(!1,"PageCountInPair")},PM.Core.ProductBase.prototype.PairCount=function(){console.assert(!1,"PairCount")},PM.Core.ProductBase.prototype.Pair2PageIndex=function(){console.assert(!1,"Pair2PageIndex")},PM.Core.ProductBase.prototype.GetPairSize=function(){console.assert(!1,"GetPairSize")},PM.Core.ProductBase.prototype.GetPairText=function(){console.assert(!1,"GetPairText")},PM.Core.ProductBase.prototype.ExtraCount=function(){console.assert(!1,"ExtraCount")},PM.Core.ProductBase.prototype.KeyDown=function(t){return this.dragger.KeyDown(t)},PM.Core.ProductBase.prototype.KeyPress=function(t){return this.dragger.KeyPress(t)},PM.Core.ProductBase.prototype.ContextMenu=function(t,e,o,r,i,a){var s=PM.Util.L2PPoint({x:r,y:i},a);PM.Editor.Framework.contextMenuCallback&&PM.Editor.Framework.contextMenuCallback(s.x,s.y)},PM.Core.ProductBase.prototype.Point2Page=function(t,e,o){var r=this.Pair2PageIndex(t);if(r<=PM.PAGE.ERROR)return null;var i=null;switch(r){case PM.PAGE.COVER:this.cover&&(this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),e,o)?i=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),e,o)?i=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),e,o)&&(i=this.cover.front_page));break;case PM.PAGE.PROLOG:this.prolog&&this.page_array[0]&&(PM.Util.PtInRect(this.prolog.GetWorkRect(),e,o)?i=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),e,o)&&(i=this.page_array[0]));break;default:if(this.page_array[r]&&(PM.Util.PtInRect(this.page_array[r].GetWorkRect(),e,o)&&(i=this.page_array[r]),i))break;if(this.PageCountInPair()>1&&this.page_array[r+1]&&(PM.Util.PtInRect(this.page_array[r+1].GetWorkRect(),e,o)&&(i=this.page_array[r+1]),i))break}return i},PM.Core.ProductBase.prototype.DblClick=function(t,e,o,r,i){this.Select(t,e,o,r,i),this.dragger.DblClick(t,e,r,i),this.Up(t,e,o,r,i)},PM.Core.ProductBase.prototype.Select=function(t,e,o,r,i,a){this.move_state=null;var s=this.dragger.HitTest(e,r,i);if(s==PM.HIT.NONE){var n=this.HitTest(e,o,r,i);this.dragger.SetSelect(n.page,n.layer,r,i),n.page||n.layer||this.ClearSelect()}else this.dragger.Down(t,e,r,i);var h=this.dragger.GetSelectedPage(),l=this.dragger.GetSelectedLayer(),c=this.dragger.GetSelectedLayerRect();if(null!=l){if(l.GetType()==PM.TYPE.TEXT){var p=l.GetEditableTextBox();p&&p.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)}this.dragger.IsMove()||this.dragger.IsRotate()||this.dragger.IsResize()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetMoveInfo()}:this.dragger.IsMoveCrop()?this.move_state={page_pos:this.GetPageIndex(h),layer_pos:h.GetLayerIndex(l),move_info:l.GetCropInfo()}:this.dragger.IsEditText()}null!=c&&(c=PM.Util.L2PRect(c,a)),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(l,c)},PM.Core.ProductBase.prototype.Move=function(t,e,o,r,i,a){var s=PM.HIT.NONE,n=!0;if(this.dragger.IsMove()){var h=this.HitTest(e,o,r,i),l=h.page?h.page:this.dragger.GetSelectedPage(),c=h.layer?h.layer:this.dragger.GetSelectedLayer();if(l&&c){var p=l.GetWorkRect(),d=c.GetCenterPos(),_=this.Point2Page(o,p.l+d.x,p.t+d.y);_==this.prolog&&(_=null),this.dragger.Move(t,_,r,i),s=PM.HIT.MOVE}}else if(this.dragger.IsResize()){var l=this.dragger.GetSelectedPage(),c=this.dragger.GetSelectedLayer();if(l&&c){var p=l.GetWorkRect(),d=c.GetCenterPos(),_=this.Point2Page(o,p.l+d.x,p.t+d.y);_==this.prolog&&(_=null),_&&(l=_)}s=this.dragger.Resize(l,r,i)}else if(this.dragger.IsRotate())s=this.dragger.Rotate(r,i);else if(this.dragger.IsMoveCrop())s=this.dragger.MoveCrop(r,i);else if(this.dragger.IsEditText())s=this.dragger.EditText(t,r,i);else{if(this.dragger.IsSelect()&&(s=this.dragger.HitTest(e,r,i)),s==PM.HIT.NONE){var h=this.HitTest(e,o,r,i);s=h.layer?PM.HIT.MOVE:PM.HIT.NONE}n=!1}return this.MovedCallbackProcess(a),{hit_type:s,modified:n}},PM.Core.ProductBase.prototype.Up=function(t,e,o,r,i,a){if(this.dragger.IsMove()||this.dragger.IsResize()||this.dragger.IsRotate()){if(PM.Editor.Framework.CheckBoundary(),null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);if(n.GetType()==PM.TYPE.TEXT&&this.dragger.IsResize()&&(n.ResizeFromTBoxCallback(n.width,n.tbox.edit_h),PM.Editor.Framework.CheckBoundary()),this.move_state.page_pos!=h||this.move_state.layer_pos!=l||!n.IsEqualMoveInfo(this.move_state.move_info)){var c="?";this.dragger.IsMove()?c=" 위치 변경":this.dragger.IsResize()?c=" 크기 변경":this.dragger.IsRotate()&&(c=" 회전"),PM.Editor.Framework.RecordOperation(PM.RECORD_LAYER_MOVE,o,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetMoveInfo()},n.GetDesc()+c)}}}else if(this.dragger.IsMoveCrop()){if(null!=this.move_state){var s=this.dragger.GetSelectedPage(),n=this.dragger.GetSelectedLayer(),h=this.GetPageIndex(s),l=s.GetLayerIndex(n);this.move_state.page_pos==h&&this.move_state.layer_pos==l&&n.IsEqualCropInfo(this.move_state.move_info)||PM.Editor.Framework.RecordOperation(PM.RECORD_PHOTO_CROP,o,{page_pos:this.move_state.page_pos,layer_pos:this.move_state.layer_pos,data:this.move_state.move_info},{page_pos:h,layer_pos:l,data:n.GetCropInfo()},"사진 크롭")}}else this.dragger.IsEditText();this.MovedCallbackProcess(a),this.dragger.Up(t,r,i),this.move_state=null},PM.Core.ProductBase.prototype.HitTest=function(t,e,o,r){var i=this.Pair2PageIndex(e);if(i<=PM.PAGE.ERROR)return{page:null,layer:null};var a=null,s=null;switch(i){case PM.PAGE.COVER:if(this.cover){if(this.cover.back_page&&(s=this.cover.back_page.HitTestLayers(t,o,r),a=s?this.cover.back_page:null,s))break;if(this.cover.middle_page&&(s=this.cover.middle_page.HitTestLayers(t,o,r),a=s?this.cover.middle_page:null,s))break;if(this.cover.front_page&&(s=this.cover.front_page.HitTestLayers(t,o,r),a=s?this.cover.front_page:null,s))break;this.cover.back_page&&PM.Util.PtInRect(this.cover.back_page.GetWorkRect(),o,r)?a=this.cover.back_page:this.cover.middle_page&&PM.Util.PtInRect(this.cover.middle_page.GetWorkRect(),o,r)?a=this.cover.middle_page:this.cover.front_page&&PM.Util.PtInRect(this.cover.front_page.GetWorkRect(),o,r)&&(a=this.cover.front_page)}break;case PM.PAGE.PROLOG:if(this.prolog&&this.page_array[0]){if(s=this.prolog.HitTestLayers(t,o,r),a=s?this.prolog:null,s)break;if(s=this.page_array[0].HitTestLayers(t,o,r),a=s?this.page_array[0]:null,s)break;PM.Util.PtInRect(this.prolog.GetWorkRect(),o,r)?a=this.prolog:PM.Util.PtInRect(this.page_array[0].GetWorkRect(),o,r)&&(a=this.page_array[0])}break;default:if(this.page_array[i]){if(s=this.page_array[i].HitTestLayers(t,o,r),a=s?this.page_array[i]:null,s)break;if(PM.Util.PtInRect(this.page_array[i].GetWorkRect(),o,r)&&(a=this.page_array[i]),a)break}if(this.PageCountInPair()>1&&this.page_array[i+1]){if(s=this.page_array[i+1].HitTestLayers(t,o,r),a=s?this.page_array[i+1]:null,s)break;if(PM.Util.PtInRect(this.page_array[i+1].GetWorkRect(),o,r)&&(a=this.page_array[i+1]),a)break}}return{page:a,layer:s}},PM.Core.ProductBase.prototype.CheckBoundary=function(t){var e=this.dragger.GetSelectedPage(),o=this.dragger.GetSelectedLayer();if(e&&o&&"spine"!=o.gid){var r=this.GetCutInfo(t),i=r.cut_w+5,a=r.cut_h+5,s=e.GetWorkRect(),n=o.GetCenterPos(),h=o.GetOutRect();PM.Editor.Framework.GetGridMode()&&(h.l=Math.floor(h.l/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,h.t=Math.floor(h.t/PM.CONFIG.GRID_SPACE)*PM.CONFIG.GRID_SPACE,n.x=h.l+h.w/2,n.y=h.t+h.h/2,o.xpos=n.x-o.width/2,o.ypos=n.y-o.height/2);var l=this.Point2Page(t,s.l+n.x,s.t+n.y);if(l==this.prolog&&(l=null),l||(n.x<i?n.x=i:n.x>s.w-i&&(n.x=s.w-i),n.y<a?n.y=a:n.y>s.h-a&&(n.y=s.h-a),o.xpos=n.x-o.width/2,o.ypos=n.y-o.height/2),o.GetType()==PM.TYPE.TEXT){h.l<i?h.l=i:h.l+h.w>s.w-i&&(h.l=h.w>s.w-2*i?i:s.w-h.w-i),h.t<a?h.t=a:h.t+h.h>s.h-a&&(h.t=h.h>s.h-2*a?a:s.h-h.h-a);var c=h.l+h.w/2,p=h.t+h.h/2;o.xpos=c-o.width/2,o.ypos=p-o.height/2}if(o.GetType()==PM.TYPE.TEXT&&"layflat"==e.layout_style){var d=s.w/2;if(d>h.l&&d<h.l+h.w){var _=d-h.l,u=h.l+h.w-d;h.l=_>u?d-h.w-i:d+i;var c=h.l+h.w/2,p=h.t+h.h/2;o.xpos=c-o.width/2,o.ypos=p-o.height/2,h.w>s.w/2-2*i&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE)}}o.GetType()==PM.TYPE.TEXT&&(h.w>s.w-2*i||h.h>s.h-2*a)&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_SIZE),this.cover&&0==t?this.cover.middle_page&&o.GetType()==PM.TYPE.IMAGE&&(l==this.cover.back_page?h.l+h.w>s.w&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA):l==this.cover.front_page&&h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_SPINE_AREA)):!this.prolog||null!=l&&l!=this.page_array[0]||h.l<0&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_PROLOG_AREA)}},PM.Core.ProductBase.prototype.GetCutInfo=function(){console.assert(!1,"GetCutInfo")},PM.Core.ProductBase.prototype.DragOver=function(){console.assert(!1,"DragOver")},PM.Core.ProductBase.prototype.Drop=function(){console.assert(!1,"Drop")},PM.Core.ProductBase.prototype.DropDefault=function(){console.assert(!1,"DropDefault")},PM.Core.ProductBase.prototype.MakePreviewImages=function(){console.assert(!1,"MakePreviewImages")},PM.Core.ProductBase.prototype.ChangeAll=function(t,e,o){var r=[],i=[],a=[];switch(e){case"color":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];n&&(r.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeColor(o)))}break;case"skin":for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n){var h=JSON.parse(o);h.kind==n.skin_kind&&h.type==n.skin_type&&(r.push({skin_link:n.skin_link,color:n.color}),a.push(n.ChangeSkin(PM.URL.SKIN_FILE+h.link)))}}break;case"layout":var h=JSON.parse(o);if("page"==h.type)for(var s=0;s<this.page_array.length;s++){var n=this.page_array[s];if(n&&!n.IsLayerLock()&&h.kind==n.layout_kind&&h.type==n.layout_type){var l=n.SaveJson();r.push(l),a.push(n.ChangeLayout(PM.URL.LAYOUT_FILE+h.link,null,null))}}}if(r.length<=0)return void PM.Editor.Framework.ShowMessageBar("실행할 수 없습니다.");this.ClearSelect();var c=this;return $.when.apply($,a).then(function(){var o=PM.RECORD_UNKNOWN,a="";switch(e){case"color":o=PM.RECORD_PAGE_BKCOLOR,a="배경색 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];n&&i.push({skin_link:n.skin_link,color:n.color})}break;case"skin":o=PM.RECORD_PAGE_BKIMAGE,a="배경스킨 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];n&&i.push({skin_link:n.skin_link,color:n.color})}break;case"layout":o=PM.RECORD_PAGE_LAYOUT,a="레이아웃 전체일괄적용";for(var s=0;s<c.page_array.length;s++){var n=c.page_array[s];if(n){n.layout_style="normal";var h=n.SaveJson();i.push(h)}}}PM.Editor.Framework.RecordOperation(o,t,{page_pos:0,layer_pos:-1,data:r},{page_pos:0,layer_pos:-1,data:i},a),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all",e)},function(){PM.Editor.Framework.ShowMessageBar(desc+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")}),a.length>0},PM.Core.ProductBase.prototype.DrawPair=function(){console.assert(!1,"DrawPair")},PM.Core.ProductBase.prototype.LoadJson=function(){console.assert(!1,"LoadJson")},PM.Core.ProductBase.prototype.SaveJson=function(){console.assert(!1,"SaveJson")},PM.Core.ProductPhotobook=function(){PM.Core.ProductBase.call(this),this.product_size="",this.product_type="",this.cover_type="",this.surface_type="",this.price_page=0,this.min_page=0,this.max_page=0,this.theme_depth1="",this.theme_depth2="",this.theme_name="",this.style_id="",this.cover_layout_id="",this.cover_skin_id="",this.page_layout_id="",this.page_skin_id="",this.base_type=PM.PRODUCT.PHOTOBOOK,this.dragger=new PM.Ctrl.Dragger},PM.Core.ProductPhotobook.prototype=new PM.Core.ProductBase,PM.Core.ProductPhotobook.prototype.PreProcess=function(t){var e=t.cover?t.cover.back_page:null,o=t.page_array[0];"leather"==t.cover_type?"design"==t.product_type?(e.SetLayersLockInfo(!0),o.SetLayersLockInfo(!0)):"layflat"==t.product_type&&e.SetLayersLockInfo(!0):"napura"==t.cover_type&&e.SetLayersLockInfo(!0)},PM.Core.ProductPhotobook.prototype.IsHoleLeatherCoverProduct=function(){return"design"==this.product_type&&"leather"==this.cover_type},PM.Core.ProductPhotobook.prototype.SetSharedImageInfo=function(t){this.IsHoleLeatherCoverProduct()&&(this.cover&&this.cover.back_page&&this.cover.back_page.SetSharedImageInfo(t),this.page_array[0]&&this.page_array[0].SetSharedImageInfo(t))},PM.Core.ProductPhotobook.prototype.Load=function(t){PM.Editor.Framework.Ready(PM.CONFIG.BOOT_LOADING);var e=PM.URL.PHOTOBOOK_THEME+"depth1="+this.theme_depth1+"&depth2="+this.theme_depth2+"&productOption1="+this.product_key+"&addParam="+this.add_param;this.product_size=this.product_size.toLowerCase(),this.product_type=this.product_type.toLowerCase(),this.cover_type=this.cover_type.toLowerCase(),this.surface_type=this.surface_type.toLowerCase(),this.keep_photos=t;var o=this,r=PM.Util.LoadXml(e);r.done(function(t){o.Parse(t),o.LoadPages(o)}),r.fail(function(t,o){alert("* Fail PM.Core.ProductPhotobook.Load: "+o+":"+e)})},PM.Core.ProductPhotobook.prototype.LoadPages=function(t){var e=[];t.cover&&e.push(t.cover.Load()),t.prolog&&e.push(t.prolog.Load());for(var o=0;o<t.page_array.length;o++)e.push(t.page_array[o].Load());$.when.apply($,e).then(function(){t.PreProcess(t),t.LoadComplete(),null!=t.keep_photos&&t.AddPhotosPerPage(t.keep_photos),"layflat"!=t.product_type||"no"!=t.surface_type&&"n"!=t.surface_type||t.ResetSpine();for(var e="#ffffff",o=0;o<t.page_array.length;o++){var r=t.page_array[o];r.skin_link.length<=0&&r.color.length<=0&&(r.color=e),e=r.color}},function(){t.LoadFailure()})},PM.Core.ProductPhotobook.prototype.LoadComplete=function(){console.log("Load Complete................................................."),console.log(navigator.userAgent),this.cover&&(this.dragger.middle_page=this.cover.middle_page),this.page_array.length>=this.min_page?(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_SUCCESS),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(0,"success")):(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-2,"insufficient pages"))},PM.Core.ProductPhotobook.prototype.LoadFailure=function(){console.log("Load Failure.................................................."),PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"load failed")},PM.Core.ProductPhotobook.prototype.IsAvailableSpine=function(){return this.cover&&this.cover.middle_page},PM.Core.ProductPhotobook.prototype.IsEmptySpine=function(){if(this.cover&&this.cover.middle_page)for(var t=0;t<this.cover.middle_page.layer_array.length;t++){var e=this.cover.middle_page.layer_array[t];if(e.GetType()==PM.TYPE.TEXT)return e.tbox.IsEmptyDoc()}return!1},PM.Core.ProductPhotobook.prototype.ResetSpine=function(){if(this.cover&&this.cover.middle_page){var t=PM.Codi.GetPhotobookGuideInfo(0,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount());if(void 0!=t.middle_w&&t.middle_w>0){var e=this.cover.middle_page.width,o=t.middle_w;e!=o&&(PM.Editor.Framework.ShowMessageBar("커버의 책등(세네카) 크기가 변경되었습니다. 커버의 편집 내용을 다시 확인해 주십시오."),this.cover.middle_page.width=o,this.SetSpineWidth(t.spine_w))}}},PM.Core.ProductPhotobook.prototype.GetSpineWidth=function(){return this.cover?this.cover.GetSpineWidth():0},PM.Core.ProductPhotobook.prototype.SetSpineWidth=function(t){this.cover&&this.cover.SetSpineWidth(t)},PM.Core.ProductPhotobook.prototype.GetPoolInfo=function(){return{cover_layout_id:this.cover_layout_id,cover_skin_id:this.cover_skin_id,page_layout_id:this.page_layout_id,page_skin_id:this.page_skin_id}},PM.Core.ProductPhotobook.prototype.SwapPages=function(t,e){var o=this.PairCount();if(t>=o||e>=o)return!1;var r=this.Pair2PageIndex(t),i=this.Pair2PageIndex(e);if(0>r||0>i)return!1;var a=this.page_array[r],s=this.page_array[r+1];return this.page_array[r]=this.page_array[i],this.page_array[r+1]=this.page_array[i+1],this.page_array[i]=a,this.page_array[i+1]=s,!0},PM.Core.ProductPhotobook.prototype.ReorderPages=function(t,e){if(!e||e.length<=0)return!1;if(this.PairCount()!=e.length)return!1;var o=[],r=[],i=0;null!=this.cover&&i++,null!=this.prolog&&(i++,o.push(this.page_array[0]),r.push(0));for(var a=i;a<e.length;a++){var s=this.Pair2PageIndex(e[a]);o.push(this.page_array[s]),o.push(this.page_array[s+1]),r.push(s),r.push(s+1)}return this.page_array=o,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success"),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_REORDER,t,null,{page_pos:-1,layer_pos:-1,data:r},"페이지 순서 변경"),!0},PM.Core.ProductPhotobook.prototype.AddPages=function(t,e){var o=this.GetInnerPageCount();if(o>=this.max_page)return PM.ADDPAGE_LIMIT_ERROR;o+2*e>this.max_page&&(e=(this.max_page-o)/2);var r=!1;0>t&&(r=!0,t=this.PairCount()-1);for(var i=this.Pair2PageIndex(t);0>i;){if(t++,t>=this.PairCount())return PM.ADDPAGE_FAIL;i=this.Pair2PageIndex(t)}for(var a=this.page_array[i].CreateDefaultPage(),s=this.page_array[i+1].CreateDefaultPage(),n=r?i+2:i,h=[],l=0;e>l;l++)h.splice(0,0,a,s),a=a.CreateDefaultPage(),s=s.CreateDefaultPage();if(h.length>0){for(var l=0;l<h.length;l++)this.page_array.splice(n,0,h[l]);this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_INSERT,t,null,{page_pos:n,layer_pos:-1,data:h},"페이지 추가")}return t},PM.Core.ProductPhotobook.prototype.DeletePages=function(t,e){var o=this.GetInnerPageCount();if(o<=this.min_page)return PM.DELPAGE_LIMIT_ERROR;o-2*e<this.min_page&&(e=(o-this.min_page)/2);var r=!1;0>t&&(r=!0,t=this.PairCount()-e);var i=this.Pair2PageIndex(t);if(0>i)return PM.DELPAGE_FAIL;var a=this.page_array.slice(i,i+2*e);return this.page_array.splice(i,2*e),this.ResetSpine(),PM.Editor.Framework.RecordOperation(PM.RECORD_PAGE_DELETE,t,{page_pos:i,layer_pos:-1,data:a},null,"페이지 삭제"),PM.DELPAGE_SUCCESS},PM.Core.ProductPhotobook.prototype.ResetFocus=function(t){var e=this.Pair2PageIndex(t);if(!(e<=PM.PAGE.ERROR))switch(e){case PM.PAGE.COVER:this.cover.back_page&&this.cover.back_page.ResetFocus(),this.cover.middle_page&&this.cover.middle_page.ResetFocus(),this.cover.front_page&&this.cover.front_page.ResetFocus();break;case PM.PAGE.PROLOG:this.page_array[0].ResetFocus();break;default:this.page_array[e].ResetFocus(),this.page_array[e+1].ResetFocus()}},PM.Core.ProductPhotobook.prototype.ExtraCount=function(){var t=0;return null!=this.cover&&(t+=2),null!=this.prolog&&(t+=1),null!=this.epilog&&(t+=1),t},PM.Core.ProductPhotobook.prototype.PageCountInPair=function(){return 2},PM.Core.ProductPhotobook.prototype.PairCount=function(){var t=this.GetTotalPageCount();return Math.ceil(t/2)},PM.Core.ProductPhotobook.prototype.Pair2PageIndex=function(t){if(0>t||t>=this.PairCount())return PM.PAGE.ERROR;var e=PM.PAGE.ERROR;return this.cover&&(e=0==t?PM.PAGE.COVER:this.prolog?1==t?PM.PAGE.PROLOG:2*t-3:2*t-2),e},PM.Core.ProductPhotobook.prototype.GetPairSize=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return{w:0,h:0};switch(e){case PM.PAGE.COVER:return this.GetCoverSize();case PM.PAGE.PROLOG:return this.GetPagesSize(PM.PAGE.PROLOG,0);default:return this.GetPagesSize(e,e+1)}return{w:0,h:0}},PM.Core.ProductPhotobook.prototype.GetPairText=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return"";switch(e){case PM.PAGE.ERROR:return"error";case PM.PAGE.COVER:return"cover";case PM.PAGE.PROLOG:return"1p";case PM.PAGE.EPILOG:return"epilog";default:return""+(e+1)+" | "+(e+2)}return""},PM.Core.ProductPhotobook.prototype.GetCoverSize=function(){var t=0;return this.cover.back_page&&(t+=this.cover.back_page.width),this.cover.middle_page&&(t+=this.cover.middle_page.width),this.cover.front_page&&(t+=this.cover.front_page.width),{w:t,h:this.cover.back_page.height}},PM.Core.ProductPhotobook.prototype.GetPages=function(t,e){return{lpage:t==PM.PAGE.PROLOG?this.prolog:this.page_array[t],rpage:e==PM.PAGE.EPILOG?this.epilog:this.page_array[e]}},PM.Core.ProductPhotobook.prototype.GetPagesSize=function(t,e){var o=this.GetPages(t,e);return{w:o.lpage.width+o.rpage.width,h:o.lpage.height}},PM.Core.ProductPhotobook.prototype.CheckDrop=function(t,e,o,r){if("skin"==o){if(t&&!t.IsLayerLock()){var i=JSON.parse(r);return i.kind==t.skin_kind&&i.type==t.skin_type}}else if("layout"==o&&t&&!t.IsLayerLock()){if(this.IsAvailableSpine()&&t==this.cover.middle_page)return!1;var i=JSON.parse(r),a=!1;return"cover"==i.type&&"cover"==t.layout_type?a=!0:"page"==i.type&&"page"==t.layout_type?a=!0:"layflat"==this.product_type&&"page_spread"==i.type&&"page"==t.layout_type&&(a=!0),i.kind==t.layout_kind&&a}return null!=t&&t!=this.prolog},PM.Core.ProductPhotobook.prototype.DropItem=function(t,e,o,r,i,a,s){var n="",h=null,l=null,c=[],p=[],d=PM.RECORD_UNKNOWN;switch(a){case"color":if(n="배경색 변경",e&&!e.IsLayerLock()){d=PM.RECORD_PAGE_BKCOLOR;var _={skin_link:e.skin_link,color:e.color};c.push(_),h=e.ChangeColor(s)}break;case"skin":if(n="배경스킨 변경",e&&!e.IsLayerLock()){var u=JSON.parse(s);if(u.kind==e.skin_kind&&u.type==e.skin_type){d=PM.RECORD_PAGE_BKIMAGE;var _={skin_link:e.skin_link,color:e.color};c.push(_),h=e.ChangeSkin(PM.URL.SKIN_FILE+u.link)}}break;case"layout":if(n="레이아웃 변경",e&&!e.IsLayerLock()){if(this.cover&&e==this.cover.middle_page)break;var u=JSON.parse(s);if(u.kind==e.layout_kind){d=PM.RECORD_PAGE_LAYOUT;var _=e.SaveJson();if("cover"==u.type&&"cover"==e.layout_type)c.push(_),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null);else if("page"==u.type&&"page"==e.layout_type)if("layflat"==e.layout_style){var f=this.GetPageIndex(e);if(f>0&&f<this.page_array.length-1){c.push(_);var g=this.page_array[f+1].SaveJson();c.push(g),this.page_array[f+1]=null,this.page_array[f+1]=e.CreateDefaultPage(),this.page_array[f+1].layout_style=e.layout_style="normal",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null)}}else c.push(_),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null);else if("layflat"==this.product_type&&"page_spread"==u.type&&"page"==e.layout_type)if("layflat"==e.layout_style)c.push(_),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null);else{var f=this.GetPageIndex(e);if(f>0&&(this.page_array[f-1].work_pos.x<e.work_pos.x&&(f--,e=this.page_array[f]),f<this.page_array.length-1)){var _=e.SaveJson();c.push(old_info1);var g=this.page_array[f+1].SaveJson();c.push(g);var P=e.GetDefaultDummyLink(e);this.page_array[f+1].layout_link=P,this.page_array[f+1].layout_style="dummy",this.page_array[f+1].layer_array=[],e.layout_style="layflat",h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null)}}}}break;case"text":n="글상자 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.TextLayer,h=e.AddNewLayer(r,i,l,!1),l.LoadJsonAtPos(l.xpos,l.ypos,s));break;case"icon":n="스티커 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.IconLayer,l.icon=s,h=e.AddNewLayer(r,i,l,!1));break;case"frame":if(n="사진틀 추가",e&&!e.IsLayerLock())if(o&&o.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_FRAME_CHANGE;var _={type:o.GetType(),value:o.diagram};c.push(_),s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0?(h=o.AddDiagram(s),n="사진틀 변경"):(o.DeleteDiagram(),h=$.Deferred().resolve(),n="사진틀 제거")}else e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX&&s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.diagram=s,h=e.AddNewLayer(r,i,l,!1));break;case"photo":if(n="사진 추가",e)if(o&&o.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_PHOTO_CHANGE;var _={type:o.GetType(),value:o.GetPhotoState()};c.push(_);var u=JSON.parse(s),y=u.url_domain+u.url_path+u.url_edit,m=u.url_domain+u.url_path+u.url_file,M=o.AddPhoto(y,m,u.img_width,u.img_height,!0);M.added&&(h=M.promise),n="사진 변경"}else if(e.IsLayerLock());else if(e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX){var u=JSON.parse(s),y=u.url_domain+u.url_path+u.url_edit,m=u.url_domain+u.url_path+u.url_file;d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.photo=y,l.photo_org=m,l.original_w=u.img_width,l.original_h=u.img_height,h=e.AddNewLayer(r,i,l,!1)}}if(this.SetSelectLayer(e,l),PM.Editor.Framework.CheckBoundary(),h){var v=this;h.done(function(){var r=v.GetPageIndex(e),i=-1;switch(a){case"color":p.push({skin_link:e.skin_link,color:s});break;case"skin":p.push({skin_link:PM.URL.SKIN_FILE+u.link,color:e.color});break;case"layout":var h=e.SaveJson();if(p.push(h),c.length>1){var _=v.page_array[r+1].SaveJson();p.push(_)}break;case"text":case"icon":case"frame":case"photo":if(d==PM.RECORD_LAYER_INSERT){i=e.GetLayerIndex(l);var f={type:l.GetType(),value:$.extend(!0,{},l)};p.push(f)}else if(d==PM.RECORD_FRAME_CHANGE){i=e.GetLayerIndex(o);var f={type:o.GetType(),value:o.diagram};p.push(f)}else if(d==PM.RECORD_PHOTO_CHANGE){i=e.GetLayerIndex(o);var f={type:o.GetType(),value:o.GetPhotoState()};p.push(f)}}d>PM.RECORD_UNKNOWN&&PM.Editor.Framework.RecordOperation(d,t,{page_pos:r,layer_pos:i,data:c},{page_pos:r,layer_pos:i,data:p},n),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback(a,s)}),h.fail(function(){PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")})}else PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")},PM.Core.ProductPhotobook.prototype.DragOver=function(t,e,o,r,i){var a=this.HitTest(e,o,r,i),s=this.GetDropData(t.dataTransfer.getData("text"));return this.CheckDrop(a.page,a.layer,s.id,s.value)},PM.Core.ProductPhotobook.prototype.Drop=function(t,e,o,r,i){t.preventDefault();var a=this.HitTest(e,o,r,i);if(a.page){var s=a.page,n=a.layer,h=this.GetDropData(t.dataTransfer.getData("text"));if(("skin"==h.id||"color"==h.id)&&"layflat"==s.layout_style){var l=s.GetWorkRect();if(l.l+=l.w/2,PM.Util.PtInRect(l,r,i)){var c=this.Pair2PageIndex(o);if(c<=PM.PAGE.ERROR)return;s=this.page_array[c+1]}}this.DropItem(o,s,n,r,i,h.id,h.value)}},PM.Core.ProductPhotobook.prototype.DropDefault=function(t,e,o){var r=this.Pair2PageIndex(t);if(!(r<=PM.PAGE.ERROR)){var i=this.dragger.GetSelectedPage(),a=this.dragger.GetSelectedLayer();if(!i)switch(r){case PM.PAGE.COVER:i=this.cover.back_page;break;case PM.PAGE.PROLOG:i=this.page_array[0];break;default:i=this.page_array[r]}if(i&&this.CheckDrop(i,a,e,o)){var s=i.work_pos.x+i.width/2,n=i.work_pos.y+i.height/2;this.DropItem(t,i,a,s,n,e,o)}}},PM.Core.ProductPhotobook.prototype.GetCutInfo=function(t){var e=PM.Codi.GetPhotobookGuideInfo(t,this.product_type,this.product_size,this.cover_type,this.surface_type,this.GetInnerPageCount());return{cut_w:e.cut_w,cut_h:e.cut_h}},PM.Core.ProductPhotobook.prototype.MakePreviewImages=function(t){for(var e=document.createElement("canvas"),o=e.getContext("2d"),r=0,i=[],a=0;a<this.PairCount();a++){var s=this.GetPairSize(a),n=0==a&&(null==this.cover.middle_page||null==this.cover.front_page);t||n?(e.width=s.w,e.height=s.h,this.DrawPair(o,a,s.w,s.h),i[r++]=PM.Util.CanvasToImage(e)):(e.width=s.w/2,e.height=s.h,PM.PAGE.PROLOG!=this.Pair2PageIndex(a)&&(this.DrawPair(o,a,s.w,s.h),i[r++]=PM.Util.CanvasToImage(e)),o.translate(-e.width,0),this.DrawPair(o,a,s.w,s.h),i[r++]=PM.Util.CanvasToImage(e),o.translate(e.width,0))}return i},PM.Core.ProductPhotobook.prototype.DrawCover=function(t,e,o){var r=this.GetCoverSize(),i=PM.Util.GetCenterPos(e,o,r.w,r.h);this.cover.back_page&&this.cover.back_page.DrawBackground(t,i.x,i.y),this.cover.middle_page&&this.cover.middle_page.DrawBackground(t,i.x+this.cover.back_page.width,i.y),this.cover.front_page&&this.cover.front_page.DrawBackground(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.IMAGE),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.IMAGE),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.IMAGE),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.ICON),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.ICON),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.ICON),this.cover.back_page&&this.cover.back_page.DrawLayers(t,i.x,i.y,PM.TYPE.TEXT),this.cover.middle_page&&this.cover.middle_page.DrawLayers(t,i.x+this.cover.back_page.width,i.y,PM.TYPE.TEXT),this.cover.front_page&&this.cover.front_page.DrawLayers(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y,PM.TYPE.TEXT),this.cover.back_page&&this.cover.back_page.DrawBorder(t,i.x,i.y),this.cover.middle_page&&this.cover.middle_page.DrawBorder(t,i.x+this.cover.back_page.width,i.y),this.cover.front_page&&this.cover.front_page.DrawBorder(t,i.x+this.cover.back_page.width+this.cover.middle_page.width,i.y),PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=i)},PM.Core.ProductPhotobook.prototype.DrawPages=function(t,e,o,r,i){var a=this.GetPagesSize(r,i),s=PM.Util.GetCenterPos(e,o,a.w,a.h),n=this.GetPages(r,i);if(n.rpage.DrawBackground(t,s.x+n.lpage.width,s.y),n.lpage.DrawBackground(t,s.x,s.y),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.IMAGE),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.IMAGE),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.ICON),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.ICON),n.lpage.DrawLayers(t,s.x,s.y,PM.TYPE.TEXT),n.rpage.DrawLayers(t,s.x+n.lpage.width,s.y,PM.TYPE.TEXT),n.lpage.DrawBorder(t,s.x,s.y),n.rpage.DrawBorder(t,s.x+n.lpage.width,s.y),-1==r&&this.prolog&&this.prolog==n.lpage&&this.prolog.DrawProlog(t,s.x+n.lpage.width/2,s.y+n.lpage.height/2),"layflat"!=this.product_type&&PM.Editor.Framework.page_gradation_image&&!PM.Editor.Framework.IsPreviewMode()){var h=s.x+n.lpage.width-PM.Editor.Framework.page_gradation_image.width/2,l=s.y,c=PM.Editor.Framework.page_gradation_image.width,p=a.h;t.drawImage(PM.Editor.Framework.page_gradation_image,h,l,c,p)}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=s)},PM.Core.ProductPhotobook.prototype.DrawPair=function(t,e,o,r){var i=this.Pair2PageIndex(e);if(!(i<=PM.PAGE.ERROR))switch(i){case PM.PAGE.COVER:this.DrawCover(t,o,r);break;case PM.PAGE.PROLOG:this.DrawPages(t,o,r,PM.PAGE.PROLOG,0);break;default:this.DrawPages(t,o,r,i,i+1)}},PM.Core.ProductPhotobook.prototype.Parse=function(t){var e=this,o=$(t).find("photo").find("theme").find("theme");return o.attr("id")!=e.product_key?!1:o.find("theme").attr("themename")!=e.theme_depth1?!1:o.find("theme").find("theme").attr("id")!=e.theme_depth2?!1:(o=o.find("theme").find("theme"),void o.find("theme").each(function(){if("styles"==$(this).attr("type")&&(e.style_id=$(this).attr("id")),"pages"==$(this).attr("type")){var t=null,o=null,r=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.page_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.page_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")?o=e.ParseItems($(this)):"prolog"==$(this).attr("type")&&(r=e.ParseItems($(this)))
}),r&&r.length>0){var i=r[0];i.type="prolog";var a=new PM.Core.Page;a.SetLayoutInfo(i),a.SetSkinInfo(new PM.Core.Skin),e.prolog=a}if(t.length>0&&o.length>0)for(var s=0,n=0,h=0;h<e.min_page;h++){s>=t.length&&(s=0),n>=o.length&&(n=0);var i=t[s++],l=o[n++],c=new PM.Core.Page;c.SetLayoutInfo(i),c.SetSkinInfo(l),e.page_array.push(c)}}if("cover"==$(this).attr("type")){var t=null,o=null;if($(this).find("theme").each(function(){"pool_layout"==$(this).attr("type")?e.cover_layout_id=$(this).attr("id"):"pool_skin"==$(this).attr("type")?e.cover_skin_id=$(this).attr("id"):"layout"==$(this).attr("type")?t=e.ParseItems($(this)):"skin"==$(this).attr("type")&&(o=e.ParseItems($(this)))}),1==t.length&&1==o.length){var p=t[0],d=o[0],_=new PM.Core.Cover;_.back_page.SetLayoutInfo(p),_.back_page.SetSkinInfo(d),_.middle_page=null,_.front_page=null,e.cover=_}else if(t.length>=3&&o.length>=3){var p=t[0],u=t[1],f=t[2],d=o[0],g=o[1],P=o[2],_=new PM.Core.Cover;_.back_page.SetLayoutInfo(p),_.back_page.SetSkinInfo(d),_.middle_page.SetLayoutInfo(u),_.middle_page.SetSkinInfo(g),_.front_page.SetLayoutInfo(f),_.front_page.SetSkinInfo(P),e.cover=_}}}))},PM.Core.ProductPhotobook.prototype.ParseItems=function(t){var e=this,o=t.attr("type"),r=[];return t.find("skinthumb").each(function(){var t="normal",i=$(this).attr("type"),a=$(this).attr("kind"),s=$(this).attr("imgcnt"),n=$(this).attr("link"),h=($(this).text(),$(this).attr("storecode"));if("layflat"==e.product_type){var l=$(this).attr("spreadimgcnt");l&&l.length>0&&(s=$(this).attr("spreadimgcnt"));var c=$(this).attr("spreadlink");c&&c.length>0&&(n=$(this).attr("spreadlink"),t="s_bg.xml"==c||"w_bg.xml"==c||"h_bg.xml"==c?"dummy":"layflat")}if("layout"==o||"prolog"==o){var p=new PM.Core.Layout;p.style=t,p.type=i,p.kind=a,p.imgcnt=s,p.link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n),p.thumb="",r.push(p)}else if("skin"==o){var p=new PM.Core.Skin;p.type=i,p.kind=a,p.link=PM.Util.GetFullPathName(PM.URL.SKIN_FILE,n),p.thumb="",p.storecode=h,r.push(p)}}),r},PM.Core.ProductPhotobook.prototype.LoadJson=function(t){void 0!=t.base_type&&console.assert(this.base_type==t.base_type,"mismatch product base_type"),this.user_id=t.user_id,this.session_id=t.session_id,this.add_param=t.add_param,this.price=t.price,this.basket_name=t.basket_name,this.order_code=t.order_code,this.product_code=t.product_code,this.product_key=t.product_key,this.product_name=t.product_name,this.product_size=t.product_size,this.product_type=t.product_type,this.cover_type=t.cover_type,this.surface_type=t.surface_type,this.price_page=t.price_page,this.min_page=t.min_page,this.max_page=t.max_page,this.theme_depth1=t.theme_depth1,this.theme_depth2=t.theme_depth2,this.theme_name=t.theme_name,this.style_id=t.style_id,this.cover_layout_id=t.cover_layout_id,this.cover_skin_id=t.cover_skin_id,this.page_layout_id=t.page_layout_id,this.page_skin_id=t.page_skin_id,this.is_complete=t.is_complete;var e=[];this.cover=null,t.cover&&(this.cover=new PM.Core.Cover,e.push(this.cover.LoadJson(t.cover))),this.prolog=null,t.prolog&&(this.prolog=new PM.Core.Page,e.push(this.prolog.LoadJson(t.prolog)));for(var o in t.page_array){var r=new PM.Core.Page;this.page_array.push(r),e.push(r.LoadJson(t.page_array[o]))}var i=this;$.when.apply($,e).then(function(){i.PreProcess(i),i.LoadComplete()},function(){i.LoadFailure()})},PM.Core.ProductPhotobook.prototype.SaveJson=function(){var t="{";navigator&&navigator.userAgent&&(t+='\n  "user_agent": "'+navigator.userAgent+'"'),t+='\n, "base_type": '+this.base_type,t+='\n, "user_id": "'+this.user_id+'"',t+='\n, "session_id": "'+this.session_id+'"',t+='\n, "add_param": "'+this.add_param+'"',t+='\n, "price": '+this.price,t+='\n, "basket_name": "'+this.basket_name+'"',t+='\n, "order_code": "'+this.order_code+'"',t+='\n, "product_code": "'+this.product_code+'"',t+='\n, "product_key": "'+this.product_key+'"',t+='\n, "product_name": "'+this.product_name+'"',t+='\n, "product_size": "'+this.product_size+'"',t+='\n, "product_type": "'+this.product_type+'"',t+='\n, "cover_type": "'+this.cover_type+'"',t+='\n, "surface_type": "'+this.surface_type+'"',t+='\n, "price_page": '+this.price_page,t+='\n, "min_page": '+this.min_page,t+='\n, "max_page": '+this.max_page,t+='\n, "inner_page_count": '+this.page_array.length,t+='\n, "theme_depth1": "'+this.theme_depth1+'"',t+='\n, "theme_depth2": "'+this.theme_depth2+'"',t+='\n, "theme_name": "'+this.theme_name+'"',t+='\n, "style_id": "'+this.style_id+'"',t+='\n, "cover_layout_id": "'+this.cover_layout_id+'"',t+='\n, "cover_skin_id": "'+this.cover_skin_id+'"',t+='\n, "page_layout_id": "'+this.page_layout_id+'"',t+='\n, "page_skin_id": "'+this.page_skin_id+'"',t+='\n, "is_complete": '+this.is_complete,this.cover?(t+='\n, "cover": ',t+=this.cover.SaveJson()):t+='\n, "cover": null',this.prolog?(t+='\n, "prolog": ',t+=this.prolog.SaveJson()):t+='\n, "prolog": null',t+='\n, "page_array": [';for(var e=0;e<this.page_array.length;e++)t+=this.page_array[e].SaveJson(),e<this.page_array.length-1&&(t+="\n,");return t+="\n]",t+="\n}"},PM.Core.ProductCalendar=function(){PM.Core.ProductBase.call(this),this.start_year=0,this.start_month=0,this.month_count=0,this.calendar_info=null,this.memorial_days=[{date:"20170101",type:"holiday",title:"신정",data:""},{date:"20170118",type:"holiday",title:"설날",data:""},{date:"20170214",type:"special",title:"발렌타인데이",data:""},{date:"20170301",type:"holiday",title:"삼일절",data:""},{date:"20170314",type:"special",title:"화이트데이",data:""},{date:"20170401",type:"special",title:"만우절",data:""},{date:"20170405",type:"special",title:"식목일",data:""},{date:"20170413",type:"special",title:"준우 생일",data:""},{date:"20170414",type:"special",title:"블랙데이",data:""},{date:"20170501",type:"special",title:"근로자의날",data:""},{date:"20170503",type:"holiday",title:"석가탄신일",data:""},{date:"20170505",type:"holiday",title:"어린이날",data:""},{date:"20170506",type:"special",title:"결혼기념일",data:""},{date:"20170508",type:"special",title:"어버이날",data:""},{date:"20170515",type:"special",title:"스승의날",data:""},{date:"20170606",type:"holiday",title:"현충일",data:""},{date:"20170714",type:"special",title:"제헌절",data:""},{date:"20170815",type:"holiday",title:"광복절",data:""},{date:"20171003",type:"holiday",title:"개천철",data:""},{date:"20171004",type:"holiday",title:"추석",data:""},{date:"20171005",type:"holiday",title:"",data:""},{date:"20171009",type:"holiday",title:"한글날",data:""},{date:"20171220",type:"holiday",title:"19대 대통령선거",data:""},{date:"20180101",type:"holiday",title:"신정",data:""},{date:"20180214",type:"special",title:"발렌타인데이",data:""},{date:"20180215",type:"holiday",title:"",data:""},{date:"20180216",type:"holiday",title:"설날",data:""},{date:"20180217",type:"holiday",title:"",data:""}],this.base_type=PM.PRODUCT.CALENDAR,this.dragger=new PM.Ctrl.Dragger},PM.Core.ProductCalendar.prototype=new PM.Core.ProductBase,PM.Core.ProductCalendar.prototype.PreProcess=function(){},PM.Core.ProductCalendar.prototype.Load=function(t){PM.Editor.Framework.Ready(PM.CONFIG.BOOT_LOADING);var e=PM.URL.CALENDAR_THEME+"productcode="+this.product_code;this.keep_photos=t,this.calendar_info=PM.Codi.GetCalendarPrintInfo(this.product_code);var o=this,r=PM.Util.LoadJson(e);r.done(function(t){o.Parse(t),o.LoadPages(o),console.log(t)}),r.fail(function(t,o){alert("* Fail PM.Core.ProductCalendar.Load: "+o+":"+e)})},PM.Core.ProductCalendar.prototype.LoadPages=function(t){var e=[];t.cover&&e.push(t.cover.Load()),t.prolog&&e.push(t.prolog.Load()),t.epilog&&e.push(t.epilog.Load());for(var o=0;o<t.page_array.length;o++)e.push(t.page_array[o].Load());$.when.apply($,e).then(function(){t.PreProcess(t),t.LoadComplete(),null!=t.keep_photos&&t.AddPhotosPerPage(t.keep_photos);for(var e="#ffffff",o=0;o<t.page_array.length;o++){var r=t.page_array[o];r.skin_link.length<=0&&r.color.length<=0&&(r.color=e),e=r.color}PM.Util.LoadWebFont(t.calendar_info.front_year.font_name,function(){}),PM.Util.LoadWebFont(t.calendar_info.front_days.font_name,function(){}),PM.Util.LoadWebFont(t.calendar_info.back_year.font_name,function(){}),PM.Util.LoadWebFont(t.calendar_info.back_days.font_name,function(){})},function(){t.LoadFailure()})},PM.Core.ProductCalendar.prototype.LoadComplete=function(){console.log("Load Complete................................................."),console.log(navigator.userAgent),PM.Util.PrintCalendar(this.start_year,this.start_month,this.month_count),this.page_array.length>0?(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_SUCCESS),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(0,"success")):(PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-2,"insufficient pages"))},PM.Core.ProductCalendar.prototype.LoadFailure=function(){console.log("Load Failure.................................................."),PM.Editor.Framework.Ready(PM.CONFIG.BOOT_FAILURE),PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"load failed")},PM.Core.ProductCalendar.prototype.ResetFocus=function(t){var e=this.Pair2PageIndex(t);if(!(e<=PM.PAGE.ERROR))switch(e){case PM.PAGE.COVER:this.cover.back_page&&this.cover.back_page.ResetFocus();break;case PM.PAGE.PROLOG:this.prolog.ResetFocus();break;case PM.PAGE.EPILOG:this.epilog.ResetFocus();break;default:this.page_array[e].ResetFocus()}},PM.Core.ProductCalendar.prototype.ExtraCount=function(){var t=0;return null!=this.cover&&(t+=1),null!=this.prolog&&(t+=1),null!=this.epilog&&(t+=1),t},PM.Core.ProductCalendar.prototype.PageCountInPair=function(){return 1},PM.Core.ProductCalendar.prototype.PairCount=function(){var t=this.GetTotalPageCount();return t},PM.Core.ProductCalendar.prototype.Pair2PageIndex=function(t){if(0>t||t>=this.PairCount())return PM.PAGE.ERROR;var e=PM.PAGE.ERROR;return this.cover&&(e=0==t?PM.PAGE.COVER:1==t?this.prolog?PM.PAGE.PROLOG:0:this.epilog&&t>=this.PairCount()-1?PM.PAGE.EPILOG:this.prolog?t-2:t-1),e},PM.Core.ProductCalendar.prototype.GetPairSize=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return{w:0,h:0};switch(e){case PM.PAGE.COVER:return{w:this.cover.back_page.width,h:this.cover.back_page.height};case PM.PAGE.PROLOG:return{w:this.prolog.width,h:this.prolog.height};case PM.PAGE.EPILOG:return{w:this.epilog.width,h:this.epilog.height};default:return{w:this.page_array[e].width,h:this.page_array[e].height}}return{w:0,h:0}},PM.Core.ProductCalendar.prototype.GetPairText=function(t){var e=this.Pair2PageIndex(t);if(e<=PM.PAGE.ERROR)return"";switch(e){case PM.PAGE.COVER:return"cover";case PM.PAGE.PROLOG:return"prolog";case PM.PAGE.EPILOG:return"epilog";default:var o=this.page_array[e],r=PM.Util.ParseCalendarFilename(o.layout_link),i=""+r.year+"년 "+r.month+"월, "+(r.is_front?"앞":"뒤");return i}return""},PM.Core.ProductCalendar.prototype.CheckDrop=function(t,e,o,r){if("skin"==o){if(t&&!t.IsLayerLock()){var i=JSON.parse(r);return i.type==t.skin_type}}else if("layout"==o&&t&&!t.IsLayerLock()){var i=JSON.parse(r);return i.type==t.skin_type}return null!=t},PM.Core.ProductCalendar.prototype.DropItem=function(t,e,o,r,i,a,s){var n="",h=null,l=null,c=[],p=[],d=PM.RECORD_UNKNOWN;switch(a){case"color":if(n="배경색 변경",e&&!e.IsLayerLock()){d=PM.RECORD_PAGE_BKCOLOR;var _={skin_link:e.skin_link,color:e.color};c.push(_),h=e.ChangeColor(s)}break;case"skin":if(n="배경스킨 변경",e&&!e.IsLayerLock()){var u=JSON.parse(s);if(u.type==e.skin_type){d=PM.RECORD_PAGE_BKIMAGE;var _={skin_link:e.skin_link,color:e.color};c.push(_),h=e.ChangeSkin(PM.URL.SKIN_FILE+u.link)}}break;case"layout":if(n="레이아웃 변경",e&&!e.IsLayerLock()){var u=JSON.parse(s);if(u.kind==e.layout_kind){d=PM.RECORD_PAGE_LAYOUT;var _=e.SaveJson();u.type==e.layout_type&&(c.push(_),h=e.ChangeLayout(PM.URL.LAYOUT_FILE+u.link,null,null))}}break;case"text":n="글상자 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.TextLayer,h=e.AddNewLayer(r,i,l,!1),l.LoadJsonAtPos(l.xpos,l.ypos,s));break;case"icon":n="스티커 추가",e&&!e.IsLayerLock()&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.IconLayer,l.icon=s,h=e.AddNewLayer(r,i,l,!1));break;case"frame":if(n="사진틀 추가",e&&!e.IsLayerLock())if(o&&o.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_FRAME_CHANGE;var _={type:o.GetType(),value:o.diagram};c.push(_),s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0?(h=o.AddDiagram(s),n="사진틀 변경"):(o.DeleteDiagram(),h=$.Deferred().resolve(),n="사진틀 제거")}else e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX&&s&&s.toLowerCase().indexOf(PM.CONFIG.FRAME_EMPTY_IMAGE)<0&&(d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.diagram=s,h=e.AddNewLayer(r,i,l,!1));break;case"photo":if(n="사진 추가",e)if(o&&o.GetType()==PM.TYPE.IMAGE){d=PM.RECORD_PHOTO_CHANGE;var _={type:o.GetType(),value:o.GetPhotoState()};c.push(_);var u=JSON.parse(s),f=u.url_domain+u.url_path+u.url_edit,g=u.url_domain+u.url_path+u.url_file,P=o.AddPhoto(f,g,u.img_width,u.img_height,!0);P.added&&(h=P.promise),n="사진 변경"}else if(e.IsLayerLock());else if(e.GetImageLayerCount()<PM.CONFIG.PHOTO_MAX){var u=JSON.parse(s),f=u.url_domain+u.url_path+u.url_edit,g=u.url_domain+u.url_path+u.url_file;d=PM.RECORD_LAYER_INSERT,l=new PM.Core.ImageLayer,l.photo=f,l.photo_org=g,l.original_w=u.img_width,l.original_h=u.img_height,h=e.AddNewLayer(r,i,l,!1)}}if(this.SetSelectLayer(e,l),PM.Editor.Framework.CheckBoundary(),h){var y=this;h.done(function(){var r=y.GetPageIndex(e),i=-1;switch(a){case"color":p.push({skin_link:e.skin_link,color:s});break;case"skin":p.push({skin_link:PM.URL.SKIN_FILE+u.link,color:e.color});break;case"layout":var h=e.SaveJson();p.push(h);break;case"text":case"icon":case"frame":case"photo":if(d==PM.RECORD_LAYER_INSERT){i=e.GetLayerIndex(l);var _={type:l.GetType(),value:$.extend(!0,{},l)};p.push(_)}else if(d==PM.RECORD_FRAME_CHANGE){i=e.GetLayerIndex(o);var _={type:o.GetType(),value:o.diagram};p.push(_)}else if(d==PM.RECORD_PHOTO_CHANGE){i=e.GetLayerIndex(o);var _={type:o.GetType(),value:o.GetPhotoState()};p.push(_)}}d>PM.RECORD_UNKNOWN&&PM.Editor.Framework.RecordOperation(d,t,{page_pos:r,layer_pos:i,data:c},{page_pos:r,layer_pos:i,data:p},n),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback(a,s)}),h.fail(function(){PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")})}else PM.Editor.Framework.ShowMessageBar(n+" 실패"),PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("","")},PM.Core.ProductCalendar.prototype.DragOver=function(t,e,o,r,i){var a=this.HitTest(e,o,r,i),s=this.GetDropData(t.dataTransfer.getData("text"));return this.CheckDrop(a.page,a.layer,s.id,s.value)},PM.Core.ProductCalendar.prototype.Drop=function(t,e,o,r,i){t.preventDefault();var a=this.HitTest(e,o,r,i);if(a.page){var s=a.page,n=a.layer,h=this.GetDropData(t.dataTransfer.getData("text"));this.DropItem(o,s,n,r,i,h.id,h.value)}},PM.Core.ProductCalendar.prototype.DropDefault=function(t,e,o){var r=this.Pair2PageIndex(t);if(!(r<=PM.PAGE.ERROR)){var i=this.dragger.GetSelectedPage(),a=this.dragger.GetSelectedLayer();if(!i)switch(r){case PM.PAGE.COVER:i=this.cover.back_page;break;case PM.PAGE.PROLOG:i=this.prolog;break;case PM.PAGE.EPILOG:i=this.epilog;break;default:i=this.page_array[r]}if(i&&this.CheckDrop(i,a,e,o)){var s=i.work_pos.x+i.width/2,n=i.work_pos.y+i.height/2;this.DropItem(t,i,a,s,n,e,o)}}},PM.Core.ProductCalendar.prototype.GetCutInfo=function(t){var e=PM.Codi.GetCalendarGuideInfo(t);return{cut_w:e.cut_w,cut_h:e.cut_h}},PM.Core.ProductCalendar.prototype.MakePreviewImages=function(t){for(var e=document.createElement("canvas"),o=e.getContext("2d"),r=0,i=[],a=0;a<this.PairCount();a++){var s=this.GetPairSize(a);e.width=s.w,e.height=s.h,this.DrawPair(o,a,s.w,s.h),i[r++]=PM.Util.CanvasToImage(e)}return i},PM.Core.ProductCalendar.prototype.GetCurrentYearMonth=function(t){var e=null,o=this.Pair2PageIndex(t);switch(o){case PM.PAGE.ERROR:case PM.PAGE.COVER:case PM.PAGE.PROLOG:case PM.PAGE.EPILOG:return null;default:e=this.page_array[o]}return PM.Util.ParseCalendarFilename(e.layout_link)},PM.Core.ProductCalendar.prototype.SetStartYearMonth=function(){},PM.Core.ProductCalendar.prototype.GetDupleDays=function(t,e){var o=e-(35-t);0>o&&(o=0),console.assert(2>=o,"over_days is not valid.");for(var r=[],i=0;o>i;i++)r.push(e-7-i);return r},PM.Core.ProductCalendar.prototype.IsDupleDay=function(t,e){return e.length>0&&e[0]==t||e.length>1&&e[1]==t},PM.Core.ProductCalendar.prototype.GetCellArray=function(t,e,o){for(var r=[],i=o.x,a=o.y,s=o.w/7,n=o.h/5,h=this.GetDupleDays(t,e),l=-t;l<e-h.length;l++){var c=(l+t)%7==0;if(c&&l>-t&&(i=o.x,a+=n),l>=0){var p=""+(l+1),d=o.font_size,_=Math.ceil(96*d/72)+5,u=n-_-5;this.IsDupleDay(l+1,h)&&(p=""+(l+1)+"/"+(l+1+7),d=parseInt(.8*o.font_size)),r.push({title:{text:p,align:"middle",color:c?this.calendar_info.holiday_color:o.font_color,size:d,rect:{x:i,y:a,w:s,h:_}},body:{color:"#f0f0f0",rect:{x:i+2,y:a+_,w:s-4,h:u}}})}i+=s}return r},PM.Core.ProductCalendar.prototype.DrawNumber=function(t,e,o,r,i,a,s,n,h,l){var c=e,p=o;t.font=""+l+"pt "+s.font_name,t.fillStyle=h,t.textAlign=s.align,t.textBaseline=n,"center"==s.align?c+=r/2:"right"==s.align&&(c+=r),"middle"==n?p+=i/2:"bottom"==n&&(p+=i),t.fillText(a,c,p,r)},PM.Core.ProductCalendar.prototype.DrawDaysCellType=function(t,e,o,r,i,a){for(var s=this.GetCellArray(r,i,a),n=0;n<s.length;n++){var h=s[n].title;this.DrawNumber(t,e+h.rect.x,o+h.rect.y,h.rect.w,h.rect.h,h.text,a,h.align,h.color,h.size);var l=s[n].body;PM.Util.DrawRect(t,e+l.rect.x,o+l.rect.y,l.rect.w,l.rect.h,1,l.color,null)}},PM.Core.ProductCalendar.prototype.DrawDaysLineType=function(t,e,o,r,i,a){for(var s=a.w/i,n=0;i>n;n++){var h=(n+r)%7==0,l=h?this.calendar_info.holiday_color:a.font_color,c=""+(n+1);this.DrawNumber(t,e+a.x,o+a.y,s,a.h,c,a,"middle",l,a.font_size),e+=s}},PM.Core.ProductCalendar.prototype.DrawPages=function(t,e,o,r){t.save();var i=PM.Util.ParseCalendarFilename(e.layout_link);if(this.calendar_info&&i){var a=PM.Util.MakeMonth(i.year,i.month),s=null,n=null;i.is_front?(s=this.calendar_info.front_year,this.DrawNumber(t,o+s.x,r+s.y,s.w,s.h,i.year,s,"middle",s.font_color,s.font_size),n=this.calendar_info.front_days,this.DrawDaysCellType(t,o,r,a.week,a.days,n)):(s=this.calendar_info.back_year,this.DrawNumber(t,o+s.x,r+s.y,s.w,s.h,i.year,s,"middle",s.font_color,s.font_size),n=this.calendar_info.back_days,this.DrawDaysLineType(t,o,r,a.week,a.days,n)),PM.DEBUG&&s&&n&&(t.strokeStyle="#ff0000",t.strokeRect(o+s.x,r+s.y,s.w,s.h),t.strokeRect(o+n.x,r+n.y,n.w,n.h))}t.restore()},PM.Core.ProductCalendar.prototype.DrawPair=function(t,e,o,r){var i=this.Pair2PageIndex(e);if(!(i<=PM.PAGE.ERROR)){var a=null;switch(i){case PM.PAGE.COVER:a=this.cover.back_page;break;case PM.PAGE.PROLOG:a=this.prolog;break;case PM.PAGE.EPILOG:a=this.epilog;break;default:a=this.page_array[i]}if(a){var s=this.GetPairSize(e),n=PM.Util.GetCenterPos(o,r,s.w,s.h);a.DrawBackground(t,n.x,n.y),i>=0&&i!=PM.PAGE.EPILOG&&this.DrawPages(t,a,n.x,n.y),a.DrawLayers(t,n.x,n.y,PM.TYPE.IMAGE),a.DrawLayers(t,n.x,n.y,PM.TYPE.ICON),a.DrawLayers(t,n.x,n.y,PM.TYPE.TEXT),a.DrawBorder(t,n.x,n.y)}PM.Core.MAIN_CANVAS_ID==t.canvas.id&&(this.dragger.Draw(t),this.work_pos=n)}},PM.Core.ProductCalendar.prototype.Parse=function(t){var e=this;if(t&&t.skins){var o=e.start_year,r=e.start_month+e.month_count-1;r>12&&(o+=Math.floor(r/12),r%=12);for(var i=100*e.start_year+e.start_month,a=100*o+r,s=0;s<t.skins.length;s++){var n=t.skins[s];if(n)if("cover"==n.type){var h=new PM.Core.Cover;h.back_page.layout_type="cover",h.back_page.layout_link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n.link),h.middle_page=null,h.front_page=null,e.cover=h}else if("prolog"==n.type){var l=new PM.Core.Page;l.layout_type="prolog",l.layout_link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n.link),e.prolog=l}else if("epilog"==n.type){var c=new PM.Core.Page;c.layout_type="epilog",c.layout_link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n.link),e.epilog=c}else if("page"==n.type){var p=PM.Util.ParseCalendarFilename(n.link),d=100*p.year+p.month;if(d>=i&&a>=d){var _=new PM.Core.Page;_.layout_type="page",_.layout_link=PM.Util.GetFullPathName(PM.URL.LAYOUT_FILE,n.link),e.page_array.push(_)}}else console.assert(!1,"unknown page type")}}},PM.Ctrl.Dragger=function(){this.drag_mode=PM.HIT.NONE,this.move={x:-1,y:-1},this.sel_page=null,this.sel_layer=null,this.is_editmode=!1,this.middle_page=null},PM.Ctrl.Dragger.prototype.IsMove=function(){return this.drag_mode==PM.HIT.MOVE},PM.Ctrl.Dragger.prototype.IsMoveCrop=function(){return this.drag_mode==PM.HIT.MOVE_CROP},PM.Ctrl.Dragger.prototype.IsEditText=function(){return this.drag_mode==PM.HIT.EDIT_TEXT},PM.Ctrl.Dragger.prototype.IsResize=function(){return this.drag_mode>=PM.HIT.RESIZE_T&&this.drag_mode<=PM.HIT.RESIZE_LB},PM.Ctrl.Dragger.prototype.IsRotate=function(){return this.drag_mode==PM.HIT.ROTATE},PM.Ctrl.Dragger.prototype.IsSelect=function(){return null!=this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedPage=function(){return this.sel_page},PM.Ctrl.Dragger.prototype.GetSelectedLayer=function(){return this.sel_layer},PM.Ctrl.Dragger.prototype.GetSelectedLayerRect=function(){if(!this.sel_layer)return null;if(!this.sel_page)return null;var t=this.sel_page.GetWorkRect(),e=this.sel_layer.GetRect(),o=e.l+e.w/2,r=e.t+e.h/2,i=this.sel_layer.GetRotateInnerPoints(o,r),a=this.sel_layer.Points2OutRect(i);return{l:t.l+a.l,t:t.t+a.t,w:a.w,h:a.h}},PM.Ctrl.Dragger.prototype.DeleteLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.removelock?!1:(this.sel_page.RemoveLayer(this.sel_layer),this.sel_layer=null,!0):!1},PM.Ctrl.Dragger.prototype.RotateLayer=function(t){return this.sel_layer&&this.sel_page?this.sel_layer.movelock?!1:this.sel_page.RotateLayer(this.sel_layer,t):!1},PM.Ctrl.Dragger.prototype.UpLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.UpLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.DownLayer=function(){return this.sel_layer&&this.sel_page?this.sel_layer.zorderlock?-1:this.sel_page.DownLayer(this.sel_layer):-1},PM.Ctrl.Dragger.prototype.KeyDown=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyDown(t):!1},PM.Ctrl.Dragger.prototype.KeyPress=function(t){return this.sel_layer&&this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT?this.sel_layer.KeyPress(t):!1},PM.Ctrl.Dragger.prototype.SetSelect=function(t,e,o,r){this.is_editmode=e&&e==this.sel_layer&&this.is_editmode,this.sel_page=t,this.sel_layer=e,this.drag_mode=e?PM.HIT.MOVE:PM.HIT.NONE,this.move.x=o,this.move.y=r},PM.Ctrl.Dragger.prototype.ResetSelectedPage=function(t,e,o){if(this.sel_layer&&this.sel_page&&(this.sel_layer.GetType()!=PM.TYPE.TEXT||t!=this.middle_page)&&t){var r=this.sel_layer,i=this.sel_page,a=t;a.AddLayer(r),i.RemoveLayer(r);var s=i.GetWorkRect(),n=e-s.l-r.xpos,h=o-s.t-r.ypos,l=a.GetWorkRect();r.xpos=e-l.l-n,r.ypos=o-l.t-h,this.sel_page=a,this.sel_layer=r}},PM.Ctrl.Dragger.prototype.DblClick=function(t,e,o,r){this.sel_layer&&(this.is_editmode=this.drag_mode==PM.HIT.MOVE||this.drag_mode==PM.HIT.EDIT_TEXT,this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,o,r),this.drag_mode=PM.HIT.EDIT_TEXT))},PM.Ctrl.Dragger.prototype.Down=function(t,e,o,r){if(this.sel_layer&&this.sel_page){this.move.x=o,this.move.y=r;var i=this.sel_page.GetWorkRect();this.drag_mode=this.sel_layer.HitTestController(e,o-i.l,r-i.t),this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT&&(this.sel_layer.MouseDown(t,e,o-i.l,r-i.t),this.drag_mode=PM.HIT.EDIT_TEXT)}},PM.Ctrl.Dragger.prototype.Move=function(t,e,o,r){if(this.sel_layer&&this.sel_page&&this.IsMove()&&!this.sel_layer.movelock){e&&e!=this.sel_page&&this.ResetSelectedPage(e,o,r);var i=this.move.x,a=this.move.y;this.move.x=o,this.move.y=r,this.sel_layer.Move(i,a,this.move.x,this.move.y)}},PM.Ctrl.Dragger.prototype.Up=function(t,e,o){if(this.sel_layer&&this.sel_page){if(this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT){var r=this.sel_page.GetWorkRect();this.sel_layer.MouseUp(t,e-r.l,o-r.t)}this.is_editmode||this.sel_layer.GetType()!=PM.TYPE.TEXT||(this.sel_layer.SelectAll(),this.IsResize()&&this.sel_layer.AdjustSize()),this.drag_mode=PM.HIT.NONE}},PM.Ctrl.Dragger.prototype.EditText=function(t,e,o){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsEditText())return PM.HIT.NONE;if(!this.is_editmode)return PM.HIT.NONE;var r=this.sel_page.GetWorkRect();return this.sel_layer.MouseMove(t,e-r.l,o-r.t),this.drag_mode},PM.Ctrl.Dragger.prototype.MoveCrop=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsMoveCrop())return PM.HIT.NONE;var o=this.move.x,r=this.move.y;return this.move.x=t,this.move.y=e,this.sel_layer.MoveCrop(o,r,this.move.x,this.move.y),this.drag_mode},PM.Ctrl.Dragger.prototype.Resize=function(t,e,o){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsResize())return PM.HIT.NONE;t&&t!=this.sel_page&&this.ResetSelectedPage(t,e,o);var r=this.move.x,i=this.move.y;this.move.x=e,this.move.y=o;var a=this.sel_page.GetWorkRect();return this.sel_layer.Resize(this.drag_mode,r-a.l,i-a.t,this.move.x-a.l,this.move.y-a.t),this.drag_mode},PM.Ctrl.Dragger.prototype.Rotate=function(t,e){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;if(!this.IsRotate())return PM.HIT.NONE;var o=this.move.x,r=this.move.y;this.move.x=t,this.move.y=e;var i=this.sel_page.GetWorkRect();return this.sel_layer.Rotate(o-i.l,r-i.t,this.move.x-i.l,this.move.y-i.t),this.drag_mode},PM.Ctrl.Dragger.prototype.HitTest=function(t,e,o){if(!this.sel_layer)return PM.HIT.NONE;if(!this.sel_page)return PM.HIT.NONE;var r=this.sel_page.GetWorkRect(),i=this.sel_layer.HitTestController(t,e-r.l,o-r.t);return i},PM.Ctrl.Dragger.prototype.Draw=function(t){if(this.sel_page&&!PM.Editor.Framework.IsPreviewMode()){var e=this.sel_page.GetWorkRect();if(PM.Util.DrawRect(t,e.l,e.t,e.w,e.h,5,PM.COLOR_PAGE_FOCUS_STROKE,null),this.sel_layer){var o=this.is_editmode&&this.sel_layer.GetType()==PM.TYPE.TEXT;this.sel_layer.DrawController(t,e.l,e.t,o)}}},PM.Ctrl.Message=function(){this.is_show=!1,this.text="^^",this.timer_id=-1},PM.Ctrl.Message.prototype.Show=function(t){this.Hide(),this.is_show=!0,this.text=t;var e=PM.CONFIG.MESSAGEBAR_TIMEOUT;t.length>parseInt(e/100)&&(e=100*t.length);var o=this;this.timer_id=setTimeout(function(){o.is_show=!1,o.text=""},e)},PM.Ctrl.Message.prototype.Hide=function(){this.is_show=!1,this.text="",-1!=this.timer_id&&clearTimeout(this.timer_id)},PM.Ctrl.Message.prototype.Draw=function(t,e,o,r,i){this.is_show&&(t.save(),t.fillStyle=PM.CONFIG.MESSAGEBAR_BACKCOLOR,t.fillRect(e,o,r,i),t.font=PM.CONFIG.MESSAGEBAR_FONT,t.fillStyle=PM.CONFIG.MESSAGEBAR_TEXTCOLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(this.text,e+r/2,o+i/2),t.restore())},PM.Ctrl.TextBox=function(){this.doc_pos=new xpos(0,0),this.caret=new xcaret,this.dox=new xdoc,this.ime=new xime,this.valign=0,this.edit_w=0,this.edit_h=0,this.min_h=0,this.ctx=null,this.is_singleline=!1,this.is_autoresize=!0,this.is_editable=!0,this.is_spine=!1,this.is_drag=!1,this.undo_stack=[],this.redo_stack=[],this.clipboard_memory=""},PM.Ctrl.TextBox.prototype.callback_update_state=function(){PM.Editor.Framework.updateTextStateCallback&&PM.Editor.Framework.updateTextStateCallback()},PM.Ctrl.TextBox.prototype.callback_update_size=function(t,e){PM.Editor.Framework.updateTextBoundsCallback&&PM.Editor.Framework.updateTextBoundsCallback(t,e)},PM.Ctrl.TextBox.prototype.LoadJson=function(t){this.undo_stack=[],this.redo_stack=[];var e=t;null!=e&&(this.dox.loaddata(e),this.doc_pos.init(),this.movecaretpos(this.doc_pos.getmove()))},PM.Ctrl.TextBox.prototype.SaveJson=function(){return this.dox.toJSON()},PM.Ctrl.TextBox.prototype.SaveJsonEx=function(){var t=0,e=this.getdocy();return this.dox.toJSONEx(t,e)},PM.Ctrl.TextBox.prototype.IsEmptyDoc=function(){return this.dox.getlength()<=0},PM.Ctrl.TextBox.prototype.SetSize=function(t,e){this.edit_w=t,this.edit_h=e,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.SetMinHeight=function(t){this.min_h=t,this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.adjustsize=function(t){if(!this.is_singleline&&this.is_autoresize){var e=Math.floor(this.dox.getdocheight()),o=Math.floor(this.edit_h);if(e>this.edit_h)o=e;else if(e<this.edit_h){var r=this.min_h;o=r>e?r:e}o>0&&o!=this.edit_h&&(this.edit_h=o,t&&this.callback_update_size(this.edit_w,this.edit_h))}},PM.Ctrl.TextBox.prototype.Draw=function(t){t&&(t.save(),this.align(t,!0),this.draw(t),this.ctx=t,t.restore())},PM.Ctrl.TextBox.prototype.align=function(t,e){this.dox.aligndoc(t,this.edit_w,e),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(!0)},PM.Ctrl.TextBox.prototype.draw=function(t){t.beginPath(),t.rect(0,-4,this.edit_w,this.edit_h+4),t.clip(),this.isOverflowText()&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(t.fillStyle=PM.COLOR_TBOX_WARNING_FILL,t.fillRect(0,0,this.edit_w,this.edit_h));var e=0,o=this.getdocy(),r=this.doc_pos.getblock();this.dox.display(t,e,o,this.edit_h,r.left,r.right,this.isfocus()),this.is_editable&&t.canvas.id==PM.Core.MAIN_CANVAS_ID&&!PM.Editor.Framework.IsPreviewMode()&&this.caret.display(t,e,o)},PM.Ctrl.TextBox.prototype.getdocy=function(){var t=0;switch(this.valign){case 0:t=0;break;case 1:t=this.edit_h/2-this.getdocheight()/2;break;case 2:t=this.edit_h-this.getdocheight()}return t},PM.Ctrl.TextBox.prototype.MouseDown=function(t,e,o,r){var t=window.event||t;this.setfocus(),r-=this.getdocy();var i=new xpoint(o,r),a=this.movecaretpoint(i,!0);a>=0&&(t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.is_drag=!0)},PM.Ctrl.TextBox.prototype.MouseMove=function(t,e,o){if(this.is_drag){var t=window.event||t;o-=this.getdocy();var r=new xpoint(e,o),i=this.movecaretpoint(r,!0);i>=0&&this.doc_pos.setmove(i)}},PM.Ctrl.TextBox.prototype.MouseUp=function(t){this.is_drag=!1,t.target.id==PM.Core.MAIN_CANVAS_ID&&this.callback_update_state()},PM.Ctrl.TextBox.prototype.KeyDown=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;switch(e){case 112:t.preventDefault(),this.dox.dump();break;case 113:check_bbox=!check_bbox;break;case 114:this.pastetext("朴大熙㉿ ■ ♥ ☆ ◆ ⊙");break;case 21:case 229:t.preventDefault(),this.setimemode(!this.ime.is_activate());break;case 32:t.preventDefault(),t.shiftKey?this.setimemode(!this.ime.is_activate()):this.keyprocess(e);break;case 10:case 13:this.is_singleline||(t.preventDefault(),this.completecompose(),this.insertchars(X.ENTERKEY,1,X.RECORD_INS));break;case 220:break;case 90:t.ctrlKey&&(t.preventDefault(),this.completecompose(),t.shiftKey?PM.Editor.Framework.Redo():PM.Editor.Framework.Undo());break;case 89:t.ctrlKey&&(t.preventDefault(),this.completecompose(),PM.Editor.Framework.Redo());break;case 67:case 88:case 86:t.ctrlKey&&(t.preventDefault(),this.completecompose(),67==e?this.copy():88==e?(this.copy(),this.deletechars(0,X.RECORD_DEL)):86==e&&this.paste(""));break;case 48:case 107:case 109:case 187:case 189:t.ctrlKey&&this.completecompose();break;case 8:if(t.preventDefault(),this.ime.is_composite()){var o=this.ime.composite(-1);if(o.comp_update>=0){this.deletechars(-1,X.RECORD_OFF);var r=String.fromCharCode(o.comp_update);this.insertchars(r,1,X.RECORD_REPL)}else this.deletechars(-1,X.RECORD_DEL)}else this.deletechars(-1,X.RECORD_DEL);break;case 46:t.preventDefault(),this.ime.is_composite()?this.completecompose():this.deletechars(1,X.RECORD_DEL);break;case 65:t.ctrlKey&&(t.preventDefault(),this.completecompose(),this.select(0,this.dox.getlength()),this.callback_update_state());break;case 33:case 36:t.preventDefault(),this.completecompose(),this.movehome(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 34:case 35:t.preventDefault(),this.completecompose(),this.moveend(this.doc_pos.getmove(),t.shiftKey),this.callback_update_state();break;case 37:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveleft(0):this.doc_pos.moveleft(0),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();break;case 39:t.preventDefault(),this.completecompose(),t.shiftKey?this.doc_pos.blockmoveright(this.dox.getlength()):this.doc_pos.moveright(this.dox.getlength()),this.movecaretpos(this.doc_pos.getmove()),this.callback_update_state();
break;case 38:t.preventDefault(),this.completecompose();var i=new xpoint(0,0);i.x=this.caret.getbase_x(),i.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(i,!1,-1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state();break;case 40:t.preventDefault(),this.completecompose();var i=new xpoint(0,0);i.x=this.caret.getbase_x(),i.y=this.caret.rect.t+this.caret.rect.height()/2;var a=this.movelinecaretpoint(i,!1,1);t.shiftKey?this.doc_pos.setmove(a):this.doc_pos.setpos(a),this.callback_update_state()}return!0},PM.Ctrl.TextBox.prototype.KeyPress=function(t){if(!this.isfocus())return!1;var e=t.which||t.keyCode;return this.keyprocess(e),!0},PM.Ctrl.TextBox.prototype.keyprocess=function(t){if((!this.is_singleline||13!=t)&&92!=t){if(PM.Editor.Framework.IsMacintosh()&&t>255)return PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_IME),void PM.Editor.Framework.SetIMEState();if(this.ime.is_activate()){var e=this.ime.is_composite(),o=this.ime.composite(t);if(o.comp_update>=0){if(e&&this.deletechars(-1,X.RECORD_OFF),o.comp_end>=0){var r=String.fromCharCode(o.comp_end);this.insertchars(r,1,X.RECORD_REPL)}if(o.comp_update>=0){var r=String.fromCharCode(o.comp_update);X.RECORD_type=X.RECORD_REPL,(!e||o.comp_end>=0)&&(X.RECORD_type=X.RECORD_INS),this.insertchars(r,1,X.RECORD_type)}}else{this.completecompose();var r=String.fromCharCode(t);this.insertchars(r,1,X.RECORD_INS)}}else{var r=String.fromCharCode(t);this.insertchars(r,1,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.completecompose=function(){this.ime.is_composite()&&(this.ime.flush(),this.movecaretpos(this.doc_pos.getmove()+1))},PM.Ctrl.TextBox.prototype.record_op=function(t,e,o,r){this.redo_stack=[];var i=null,a="";switch(t){case X.RECORD_INS:i=new xop(t,e,null,r),a="문자 입력";break;case X.RECORD_DEL:i=new xop(t,e,o,null),a="문자 삭제";break;case X.RECORD_REPL:this.undo_stack.pop(),PM.Editor.Framework.GetUndoStack().pop(),i=new xop(t,e,null,r),a="문자 입력.";break;case X.RECORD_ATTR:i=new xop(t,e,o,r),a="글꼴 속성 변경";break;case X.RECORD_PARA:i=new xop(t,e,o,r),a="단락 속성 변경";break;case X.RECORD_VALIGN:i=new xop(t,e,o,r),a="세로 정렬"}if(null!=i){var s=PM.Editor.Framework.GetSelectedLayer();if(s&&s.GetType()==PM.TYPE.TEXT){var n=PM.Editor.Framework.GetPairNumber(),h=PM.Editor.Framework.GetSelectedPageIndex(),l=PM.Editor.Framework.GetSelectedLayerIndex(),c={text_data:i,layer_data:s.GetMoveInfo()};this.ctx&&(this.align(this.ctx,!0),PM.Editor.Framework.ResizeFromTBox(s,this.edit_w,this.edit_h));var p={text_data:i,layer_data:s.GetMoveInfo()};PM.Editor.Framework.RecordOperation(PM.RECORD_TEXT_CHANGE,n,{page_pos:h,layer_pos:l,data:c},{page_pos:h,layer_pos:l,data:p},a)}}this.isOverflowText()&&PM.Editor.Framework.ShowMessageBar(PM.CONFIG.MESSAGE_CHECK_TEXT_LEN)},PM.Ctrl.TextBox.prototype.isOverflowText=function(){if(this.is_singleline&&this.dox.getlength()>0){var t=this.dox.getalignedwidth();if(t>0&&t>this.edit_w)return!0;if(this.getdocheight()>this.edit_h)return!0}return!1},PM.Ctrl.TextBox.prototype.insertdoc=function(t,e){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var o=this.doc_pos.getmove(),r=o+t.strings.length;if(this.dox.insertdoc(o,t),this.doc_pos.setpos(r),e!=X.RECORD_OFF){var i=new xpos(o,o),a=t;this.record_op(e,i,null,a)}}},PM.Ctrl.TextBox.prototype.insertchars=function(t,e,o){if(this.is_editable){this.doc_pos.isblock()&&this.deletechars(0,X.RECORD_DEL);var r=this.doc_pos.getmove(),i=r+e;if(this.dox.insertchars(r,t,e),this.doc_pos.setpos(i),o!=X.RECORD_OFF){var a=new xpos(r,r),s=this.dox.getblockdoc(r,i-1);this.record_op(o,a,null,s)}}},PM.Ctrl.TextBox.prototype.deletechars=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var o=this.doc_pos.getblock();if(o.left>=0&&o.right>=0){if(e!=X.RECORD_OFF){var r=new xpos(o.left,o.left),i=this.dox.getblockdoc(o.left,o.right);this.record_op(e,r,i,null)}this.doc_pos.setpos(o.left),this.dox.deletechars(o.left,o.right-o.left+1)}}else{if(0>t){if(!this.doc_pos.moveleft(0))return;t=1}var a=this.doc_pos.getmove();if(e!=X.RECORD_OFF){var r=new xpos(a,a),i=this.dox.getblockdoc(a,a+t-1);this.record_op(e,r,i,null)}this.dox.deletechars(a,t),this.doc_pos.setpos(a)}},PM.Ctrl.TextBox.prototype.select=function(t,e){if(!(0>t||t>=e)){this.doc_pos.setpos(t),this.doc_pos.setmove(e);var o=this.dox.pos2caretrect(e,!1);this.caret.setrect(o),this.caret.setbase_x(o.l)}},PM.Ctrl.TextBox.prototype.movehome=function(t,e){var o=this.dox.pos2linepos(t,0);e?this.doc_pos.setmove(o):this.doc_pos.setpos(o);var r=this.dox.pos2caretrect(o,!1);this.caret.setrect(r),this.caret.setbase_x(r.l)},PM.Ctrl.TextBox.prototype.moveend=function(t,e){var o=this.dox.pos2linepos(t,1);e?this.doc_pos.setmove(o):this.doc_pos.setpos(o);var r=this.dox.pos2caretrect(o,!1);this.caret.setrect(r),this.caret.setbase_x(r.l)},PM.Ctrl.TextBox.prototype.movecaretpos=function(t){this.ime.is_composite()&&--t,0>t&&(t=0),t>this.dox.getlength()&&(t=this.dox.getlength());var e=this.dox.pos2caretrect(t,this.ime.is_composite());this.caret.setrect(e),this.caret.setbase_x(e.l)},PM.Ctrl.TextBox.prototype.movecaretpoint=function(t,e){var o=this.dox.point2caretrect(t,0);return this.caret.setrect(o.rect),e&&this.caret.setbase_x(o.rect.l),o.pos},PM.Ctrl.TextBox.prototype.movelinecaretpoint=function(t,e,o){var r=this.dox.point2caretrect(t,o);return this.caret.setrect(r.rect),e&&this.caret.setbase_x(r.rect.l),r.pos},PM.Ctrl.TextBox.prototype.copydox=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock(),e=this.dox.getblockdoc(t.left,t.right);return null!=e?e.toJSON():""},PM.Ctrl.TextBox.prototype.pastedox=function(t){if(this.is_editable){var e=JSON.parse(t);if(null!=e){var o=new xdoc;o.loaddata(e),this.insertdoc(o,X.RECORD_INS)}}},PM.Ctrl.TextBox.prototype.setfontprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var o=this.doc_pos.getblock(),r=this.dox.getblockdoc(o.left,o.right);this.dox.setblockattrstate(o.left,o.right,t,e);var i=new xpos(o.left,o.right),a=this.dox.getblockdoc(o.left,o.right);this.record_op(X.RECORD_ATTR,i,r,a)}else{var i=this.doc_pos.getmove();this.dox.setattrstate(i,t,e)}},PM.Ctrl.TextBox.prototype.setparaprop=function(t,e){if(this.is_editable)if(this.doc_pos.isblock()){var o=this.doc_pos.getblock(),r=this.dox.getselparas(o.left,o.right);this.dox.setblockparastate(o.left,o.right,t,e);var i=new xpos(o.left,o.right),a=this.dox.getselparas(o.left,o.right);this.record_op(X.RECORD_PARA,i,r,a)}else{var s=this.doc_pos.getmove(),r=this.dox.getselparas(s,-1);this.dox.setparastate(s,t,e);var i=new xpos(s,-1),a=this.dox.getselparas(s,-1);this.record_op(X.RECORD_PARA,i,r,a)}},PM.Ctrl.TextBox.prototype.dump_undoredo=function(){console.log(".>> tbox stack log");for(var t=null,e=0;2>e;e++){0==e?(console.log("undo_stack"),t=this.undo_stack):(console.log("redo_stack"),t=this.redo_stack);for(var o=0;o<t.length;o++){var r="";switch(t[o].type){case X.RECORD_INS:r="insert ";break;case X.RECORD_DEL:r="delete ";break;case X.RECORD_REPL:r="replace";break;case X.RECORD_ATTR:r="attr   ";break;case X.RECORD_PARA:r="para   "}r+="["+t[o].pos.getpivot()+","+t[o].pos.getmove()+"]",t[o].ins&&(r+=" (ins)",r+=t[o].ins.strings),t[o].del&&(r+=" (del)",r+=t[o].del.strings),console.log(r)}}},PM.Ctrl.TextBox.prototype.setfontdefault=function(t,e,o,r,i){var a=new xattr;a.facename=t,a.point=parseInt(e),a.textcolor=o,a.bold=r,a.italic=i,this.dox.setdefault(a,null)},PM.Ctrl.TextBox.prototype.setparadefault=function(t,e,o){var r=new xpara;switch(t){case"left":r.align=0;break;case"right":r.align=1;break;case"center":r.align=2;break;case"scattering":r.align=3;break;case"justify":r.align=4}r.paragap=e,r.linegap=o,this.dox.setdefault(null,r)},PM.Ctrl.TextBox.prototype.getfontstate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockattrstate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getattrstate(e)}return null==t.attr||null==t.filter?null:{fontface:t.filter.facename?t.attr.facename:"",fontpoint:t.filter.point?t.attr.point:0,fillcolor:t.filter.textcolor?t.attr.textcolor:"",isstroke:t.filter.strokecolor&&""!=t.attr.strokecolor?!0:!1,isbold:t.filter.bold?t.attr.bold:!1,isitalic:t.filter.italic?t.attr.italic:!1,isunderline:t.filter.underline?t.attr.underline:!1,charw:t.filter.charw?t.attr.charw:0}},PM.Ctrl.TextBox.prototype.getparastate=function(){var t=null;if(this.doc_pos.isblock()){var e=this.doc_pos.getblock();t=this.dox.getblockparastate(e.left,e.right)}else{var e=this.doc_pos.getmove();t=this.dox.getparastate(e)}if(null==t.para||null==t.filter)return null;var o=t.filter.linegap?t.para.linegap:"",r=t.filter.paragap?t.para.paragap:"",i="";if(t.filter.align)switch(t.para.align){case 0:i="left";break;case 1:i="right";break;case 2:i="center";break;case 3:i="scattering";break;case 4:i="justify"}return{lineh:o,parah:r,align:i}},PM.Ctrl.TextBox.prototype.setfontname=function(t){var e=this;PM.Util.LoadWebFont(t,function(){var o=new xattr,r=new xattr_filter(!1);o.facename=t,r.facename=!0,e.setfontprop(o,r)})},PM.Ctrl.TextBox.prototype.setfontsize=function(t){var e=new xattr,o=new xattr_filter(!1);e.point=t,o.point=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontcolor=function(t){var e=new xattr,o=new xattr_filter(!1);e.textcolor=t,o.textcolor=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontstroke=function(t){var e=new xattr,o=new xattr_filter(!1);e.strokecolor=t?"#ff7f00":"",o.strokecolor=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontbold=function(t){var e=new xattr,o=new xattr_filter(!1);e.bold=t,o.bold=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontitalic=function(t){var e=new xattr,o=new xattr_filter(!1);e.italic=t,o.italic=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontunderline=function(t){var e=new xattr,o=new xattr_filter(!1);e.underline=t,o.underline=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setfontwidth=function(t){var e=new xattr,o=new xattr_filter(!1);e.charw=t,o.charw=!0,this.setfontprop(e,o)},PM.Ctrl.TextBox.prototype.setalign=function(t){var e=new xpara,o=new xpara_filter(!1);switch(t){case"left":e.align=0;break;case"right":e.align=1;break;case"center":e.align=2;break;case"scattering":e.align=3;break;case"justify":e.align=4}o.align=!0,this.setparaprop(e,o)},PM.Ctrl.TextBox.prototype.setvalign=function(t,e){var o=PM.Editor.Framework.GetSelectedLayer();if(o&&o.gid&&"spine"==o.gid)return PM.Editor.Framework.ShowMessageBar("책등은 가운데 정렬만 지원합니다."),!1;var r=this.valign;switch(t){case"top":this.valign=0;break;case"middle":this.valign=1;break;case"bottom":this.valign=2}var i=this.valign;return e&&this.record_op(X.RECORD_VALIGN,0,r,i),!0},PM.Ctrl.TextBox.prototype.getvalign=function(){var t="";switch(this.valign){case 0:t="top";break;case 1:t="middle";break;case 2:t="bottom"}return t},PM.Ctrl.TextBox.prototype.setlineh=function(t){var e=new xpara,o=new xpara_filter(!1);e.linegap=t,o.linegap=!0,this.setparaprop(e,o)},PM.Ctrl.TextBox.prototype.setparah=function(t){var e=new xpara,o=new xpara_filter(!1);e.paragap=t,o.paragap=!0,this.setparaprop(e,o)},PM.Ctrl.TextBox.prototype.fromString=function(t){this.undo_stack=[],this.redo_stack=[];var t=t.replace(/\r\n/gi,X.ENTERKEY);t=t.replace(/\n/gi,X.ENTERKEY),t=t.replace(/\r/gi,X.ENTERKEY),this.select(0,this.dox.getlength()),this.insertchars(t,t.length,X.RECORD_OFF)},PM.Ctrl.TextBox.prototype.toString=function(){return this.dox.toString()},PM.Ctrl.TextBox.prototype.toSVG=function(){return this.dox.toSVG()},PM.Ctrl.TextBox.prototype.setimemode=function(t){this.completecompose(),this.ime.activate(t),this.movecaretpos(this.doc_pos.getmove())},PM.Ctrl.TextBox.prototype.copytext=function(){if(!this.doc_pos.isblock())return"";var t=this.doc_pos.getblock();return this.dox.getblocktext(t.left,t.right)},PM.Ctrl.TextBox.prototype.pastetext=function(t){this.insertchars(t,t.length,X.RECORD_INS)},PM.Ctrl.TextBox.prototype.copy=function(){return this.clipboard_memory=this.copydox(),this.clipboard_memory},PM.Ctrl.TextBox.prototype.paste=function(t){""==t&&(t=this.clipboard_memory),this.clipboard_memory.length>0&&this.pastedox(this.clipboard_memory)},PM.Ctrl.TextBox.prototype.undo=function(){if(!this.is_editable)return!1;if(this.undo_stack.length<=0)return!1;var t=this.undo_stack.pop();return null!=t&&(this.undo_action(t),this.redo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.redo=function(){if(!this.is_editable)return!1;if(this.redo_stack.length<=0)return!1;var t=this.redo_stack.pop();return null!=t&&(this.redo_action(t),this.undo_stack.push(t)),!0},PM.Ctrl.TextBox.prototype.undo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.ins.strings.length,X.RECORD_OFF),this.insertdoc(t.del,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.del);break;case X.RECORD_VALIGN:this.valign=t.del}return!0},PM.Ctrl.TextBox.prototype.redo_action=function(t){if(!t)return!1;switch(t.type){case X.RECORD_INS:case X.RECORD_REPL:this.doc_pos.setpos(t.pos.getpivot()),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_DEL:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF);break;case X.RECORD_ATTR:this.doc_pos.setpos(t.pos.getpivot()),this.deletechars(t.del.strings.length,X.RECORD_OFF),this.insertdoc(t.ins,X.RECORD_OFF);break;case X.RECORD_PARA:this.doc_pos.setpos(t.pos.getpivot()),this.dox.setselparas(t.pos.getpivot(),t.pos.getmove(),t.ins);break;case X.RECORD_VALIGN:this.valign=t.ins}return!0},PM.Ctrl.TextBox.prototype.setsingleline=function(t){this.is_singleline=t,this.dox.is_singleline=t},PM.Ctrl.TextBox.prototype.isspine=function(){return this.is_spine},PM.Ctrl.TextBox.prototype.setspine=function(t){this.is_spine=t},PM.Ctrl.TextBox.prototype.getautoresize=function(){return this.is_autoresize},PM.Ctrl.TextBox.prototype.setautoresize=function(t){this.is_autoresize=t},PM.Ctrl.TextBox.prototype.seteditable=function(t){this.is_editable=t},PM.Ctrl.TextBox.prototype.getwidth=function(){return this.edit_w},PM.Ctrl.TextBox.prototype.getheight=function(){return this.edit_h},PM.Ctrl.TextBox.prototype.getdocwidth=function(){return this.dox.getdocwidth()},PM.Ctrl.TextBox.prototype.getdocheight=function(){return this.dox.getdocheight()},PM.Ctrl.TextBox.prototype.isfocus=function(){return this.caret.is_show()},PM.Ctrl.TextBox.prototype.setfocus=function(){this.caret.show(!0)},PM.Ctrl.TextBox.prototype.killfocus=function(){this.completecompose(),this.caret.show(!1)},PM.Ctrl.TextBox.prototype.selectAll=function(){this.select(0,this.dox.getlength()),this.callback_update_state()},PM.Ctrl.TextBox.prototype.updateall=function(t){if(null!=this.ctx){var e=this.ctx;this.dox.aligndoc(e,this.edit_w,!0),this.movecaretpos(this.doc_pos.getmove()),this.adjustsize(t),this.draw(e)}},PM.Editor.Framework=new function(){var t=this,e=!1,o=!1,r=PM.CONFIG.BOOT_LOADING,i="",a=new PM.Ctrl.Message,s=null,n=null,h=null,l=null,c=0,p=1,d=!1,_=!1,u=PM.CONFIG.GRID_SPACE,f=PM.CONFIG.GRID_COLOR,g=[],P=[],y=[];this.Init=function(e){switch(PM.Util.LoadWebFont(PM.CONFIG.FONT_DEFAULT,function(){}),i=document.title,document.title=i+"."+PM.Core.Version,PM.Core.MAIN_CANVAS_ID=e.canvasTarget.id,n=e.canvasTarget,h=n.getContext("2d"),n.width=2e3,n.height=2e3,n.ondragover=this.OnDragOver,n.ondrop=this.OnDrop,n.addEventListener("contextmenu",this.OnContextMenu,!1),n.addEventListener("dblclick",this.OnDoubleClick,!1),n.addEventListener("mousedown",this.OnMouseDown,!1),n.addEventListener("mousemove",this.OnMouseMove,!1),document.addEventListener("mouseup",this.OnMouseUp,!1),document.addEventListener("keydown",this.OnKeyDown,!1),document.addEventListener("keypress",this.OnKeyPress,!1),document.addEventListener("keyup",this.OnKeyUp,!1),window.addEventListener("resize",this.OnResize,!0),document.body.addEventListener("online",this.OnUpdateConnection,!1),document.body.addEventListener("offline",this.OnUpdateConnection,!1),$(window).on("beforeunload",function(){}),window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3)}}(),window.requestAnimationFrame(this.OnMainLoop),l=e.productInfo,l.GetType()){case PM.PRODUCT.PHOTOBOOK:PM.URL.LAYOUT_FILE=PM.URL.PHOTOBOOK_LAYOUT,PM.URL.SKIN_FILE=PM.URL.PHOTOBOOK_SKIN;break;case PM.PRODUCT.CALENDAR:PM.URL.LAYOUT_FILE=PM.URL.CALENDAR_LAYOUT,PM.URL.SKIN_FILE=PM.URL.CALENDAR_SKIN;break;default:console.assert(!1,"unknown product_type.")}l.Load(null),this.SetModified(!1),P=[],y=[],this.loadCompleteCallback=e.loadCompleteCallback,this.addPhotosCompleteCallback=e.addPhotosCompleteCallback,this.deletePhotosCompleteCallback=e.deletePhotosCompleteCallback,this.updateTextStateCallback=e.updateTextStateCallback,this.selectLayerCallback=e.selectLayerCallback,this.moveLayerCallback=e.moveLayerCallback,this.contextMenuCallback=e.contextMenuCallback,this.movePageCallback=e.movePageCallback,this.dropTargetCallback=e.dropTargetCallback,this.updateTextBoundsCallback=function(e,o){var r=t.GetSelectedLayer();r&&r.GetType()==PM.TYPE.TEXT&&t.ResizeFromTBox(r,e,o)},s=e.infoTarget;var o=PM.Util.LoadImage(PM.CONFIG.COVER_BARCODE_IMAGE);o.done(function(e){t.cover_barcode_image=e}),o.fail(function(){t.cover_barcode_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.COVER_BARCODE_IMAGE)});var r=PM.Util.LoadImage(PM.CONFIG.PAGE_GRADATION_IMAGE);r.done(function(e){t.page_gradation_image=e}),r.fail(function(){t.page_gradation_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PAGE_GRADATION_IMAGE)});var a=PM.Util.LoadImage(PM.CONFIG.PHOTO_EMPTY_IMAGE);a.done(function(e){t.photo_empty_image=e}),a.fail(function(){t.photo_empty_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_EMPTY_IMAGE)});var c=PM.Util.LoadImage(PM.CONFIG.PHOTO_WARNING_IMAGE);c.done(function(e){t.photo_warning_image=e}),c.fail(function(){t.photo_warning_image=null,console.log("* Fail:PM.Editor.Framework.Init: "+PM.CONFIG.PHOTO_WARNING_IMAGE)})},this.Ready=function(t){r=t,r==PM.CONFIG.BOOT_SUCCESS&&(this.RecalcCanvasSize(),e=PM.Util.IsMacintosh())},this.IsShiftState=function(){return o},this.IsMacintosh=function(){return e},this.SetIMEState=function(){n.style.imeMode="disable"},this.GetParentElementSize=function(){var t={w:1e3,h:600};if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var e=n.parentElement.getBoundingClientRect();t.w=e.width,t.h=e.height}return t},this.RecalcCanvasSize=function(){if(l){var t=PM.Util.P2LSize(this.GetParentElementSize(),p),e=this.GetPairSize(c),o={w:e.w+PM.CONFIG.CANVAS_MARGIN_W,h:e.h+PM.CONFIG.CANVAS_MARGIN_H},r=Math.max(o.w,t.w),i=Math.max(o.h,t.h);n.width=r*p-20,n.height=i*p-20}},this.ResizeFromTBox=function(t,e,o){l&&(l.dragger.IsResize()||t.ResizeFromTBoxCallback(e,o),l.ResizeFromTBoxCallbackProcess(p),l.CheckBoundary(c))},this.CheckBoundary=function(){l&&l.CheckBoundary(c)},this.ShowMessageBar=function(t){a.Show(t)},this.HideMessageBar=function(){a.Hide()},this.GetProduct=function(){return l},this.LoadProduct=function(t){var e=null;try{e=JSON.parse(t)}catch(o){e=null,console.error(o)}if(e){var r=null;void 0==e.base_type?r=new PM.Core.ProductPhotobook:e.base_type==PM.PRODUCT.PHOTOBOOK?r=new PM.Core.ProductPhotobook:e.base_type==PM.PRODUCT.CALENDAR?r=new PM.Core.ProductCalendar:console.assert(!1,"unknown product base_type.."),r.LoadJson(e),l=null,l=r,this.SetModified(!1),P=[],y=[]}else PM.Editor.Framework.loadCompleteCallback&&PM.Editor.Framework.loadCompleteCallback(-1,"Parse failed")},this.SaveProduct=function(){return l?(this.SetModified(!1),l.SaveJson()):""},this.ClearProduct=function(){l=null,c=0,p=1,this.SetModified(!1)},this.LoadTheme=function(t,e,o){var r=new PM.Core.ProductPhotobook;r.user_id=l.user_id,r.session_id=l.session_id,r.add_param=l.add_param,r.price=l.price,r.product_code=l.product_code,r.product_key=l.product_key,r.product_name=l.product_name,r.product_size=l.product_size,r.product_type=l.product_type,r.cover_type=l.cover_type,r.surface_type=l.surface_type,r.theme_depth1=t,r.theme_depth2=e,r.theme_name=o,r.price_page=l.price_page,r.min_page=l.min_page,r.max_page=l.max_page;var i=l.GetUserImageListPerPage();this.ClearProduct(),l=r,l.Load(i),this.SetModified(!1),P=[],y=[]},this.IsComplete=function(){return l?l.CheckComplete():!1},this.IsModified=function(){return this.is_modified},this.SetModified=function(t){this.is_modified=t,document.title=i+"."+PM.Core.Version+(this.is_modified?"*":"")},this.SetPreviewMode=function(t){d=t},this.IsPreviewMode=function(){return d},this.GetPoolInfo=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.GetPoolInfo():null},this.IsEmptySpine=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.IsEmptySpine():!1},this.IsHoleLeatherCoverProduct=function(){return l&&l.GetType()==PM.PRODUCT.PHOTOBOOK?l.IsHoleLeatherCoverProduct():!1},this.SetSharedImageInfo=function(t){l&&l.GetType()==PM.PRODUCT.PHOTOBOOK&&l.IsHoleLeatherCoverProduct()&&l.SetSharedImageInfo(t)},this.MakePreviewImages=function(t){if(!l)return null;var e=null,o=d;d=!0;try{e=l.MakePreviewImages(t)}catch(r){e=null,console.error(r)}finally{d=!1,d=o}return e},this.ConnectPageThumbnail=function(t,e){if(l&&t){g[e]=t;var o=t,r=t.getContext("2d"),i=l.GetFitScaleFactor(o.width-5,o.height-5);o&&r&&this.Draw(r,o,i,e)}},this.SetCurrentThumbnail=function(){l&&this.ModifyCurrentThumbnail(c)},this.ModifyCurrentThumbnail=function(t){this.DrawThumbnail(t),this.IsHoleLeatherCoverProduct()&&(0==t?this.DrawThumbnail(1):1==t&&this.DrawThumbnail(0))},this.DrawThumbnail=function(t){if(!(0>t||t>=g.length)&&null!=g[t]&&void 0!=g[t]){var e=g[t],o=e.getContext("2d"),r=l.GetFitScaleFactor(e.width-5,e.height-5);this.Draw(o,e,r,t)}},this.MovePair=function(t){return l?(pair_count=l.PairCount(),0>t?t=0:t>=pair_count&&(t=pair_count-1),c=t,this.RecalcCanvasSize(),l.ClearSelect(),this.Draw(h,n,p,c),this.movePageCallback&&this.movePageCallback(c),c):0},this.SwapPair=function(t,e){return!1},this.ReorderPair=function(t){return l?d?!1:(this.SetModified(!0),l.ReorderPages(c,t)):!1},this.AddPair=function(t,e){return l?d?PM.ADDPAGE_FAIL:(this.SetModified(!0),"current"==t?l.AddPages(c,parseInt(e)):"last"==t?l.AddPages(-1,parseInt(e)):PM.ADDPAGE_FAIL):PM.ADDPAGE_FAIL},this.DeletePair=function(t,e){if(!l)return PM.DELPAGE_FAIL;if(d)return PM.DELPAGE_FAIL;this.SetModified(!0);var o=PM.DELPAGE_FAIL;return"current"==t?o=l.DeletePages(c,parseInt(e)):"last"==t&&(o=l.DeletePages(-1,parseInt(e))),this.MovePair(c),o},this.GetInnerPageCount=function(){return l?l.GetInnerPageCount():0},this.GetPairText=function(t){return l?l.GetPairText(t):""},this.GetPairNumber=function(){return c},this.GetPairCount=function(){return l?l.PairCount():0},this.GetPairSize=function(t){return l?l.GetPairSize(t):{w:0,h:0}},this.GetCurrentPairSize=function(){return l?l.GetPairSize(c):{w:0,h:0}},this.GetPageNumber=function(t){return l?l.Pair2PageIndex(t):PM.PAGE.ERROR},this.DeleteEmptyLayers=function(t){l&&(d||(l.ClearSelect(),this.SetModified(!0),l.DeleteEmptyLayers(t)))},this.DeleteLayer=function(){l&&(d||(this.SetModified(!0),l.DeleteLayer()))},this.RotateLayer=function(t){return l?d?!1:(this.SetModified(!0),l.RotateLayer(t)):!1},this.UpLayer=function(){return l?d?!1:(this.SetModified(!0),l.UpLayer()):!1},this.DownLayer=function(){return l?d?!1:(this.SetModified(!0),l.DownLayer()):!1},this.AddPhotos=function(t){l&&(d||(this.SetModified(!0),l.AddPhotos(t)))},this.DeletePhotos=function(){l&&(d||(this.SetModified(!0),l.DeletePhotos()))},this.GetUserImageList=function(){return l?l.GetUserImageList():""},this.GetUserImageListText=function(){if(!l)return"";for(var t="",e=l.GetUserImageList(),o=0;o<e.length;o++){var r=JSON.parse(e[o]);t+=r.org_link,t+="\n"}return t},this.GetSelectedLayer=function(){return l?d?null:l.GetSelectedLayer():null},this.GetSelectedLayerIndex=function(){if(!l)return null;if(d)return null;var t=this.GetSelectedPage();if(t){var e=l.GetSelectedLayer();return t.GetLayerIndex(e)}return-1},this.GetSelectedPage=function(){return l?d?null:l.GetSelectedPage():null},this.GetSelectedPageIndex=function(){return l?d?null:l.GetSelectedPageIndex():null},this.GetEditableTextBox=function(){if(!l)return null;if(d)return null;var t=l.GetSelectedLayer();return t&&t.GetType()==PM.TYPE.TEXT?t.GetEditableTextBox():null},this.IsFocusTextBox=function(){if(!l)return null;if(d)return null;var t=l.GetSelectedLayer();return t&&t.GetType()==PM.TYPE.TEXT?t.IsFocusTextBox():!1},this.FitScale=function(){if(!l)return 1;var t=this.GetParentElementSize();return n.width=t.w,n.height=t.h,p=l.GetFitScaleFactor(n.width-PM.CONFIG.CANVAS_MARGIN_W,n.height-PM.CONFIG.CANVAS_MARGIN_H),this.Draw(h,n,p,c),p},this.SetScale=function(t){return l?(t<PM.CONFIG.SCALE_MIN?t=PM.CONFIG.SCALE_MIN:t>PM.CONFIG.SCALE_MAX&&(t=PM.CONFIG.SCALE_MAX),p=t,this.RecalcCanvasSize(),this.Draw(h,n,p,c),t):1},this.GetScale=function(){return p},this.GetGridMode=function(){return _},this.SetGridMode=function(t){d||(_=t)},this.GetGridOption=function(){return{space:u,color:f}},this.SetGridOption=function(t){u=t.space,f=t.color},this.Draw=function(t,e,o,i){t.clearRect(0,0,e.width,e.height),t.save(),t.scale(o,o);var s={w:e.width,h:e.height};if(s=PM.Util.P2LSize(s,o),l&&r==PM.CONFIG.BOOT_SUCCESS&&(l.DrawPair(t,i,s.w,s.h),e==n&&(this.DrawBarcode(t,i),d||(this.DrawGuideline(t,i),_&&this.DrawGrid(t,i),this.DebugInfo(t)))),t.restore(),e==n&&!d){if(n.parentElement&&"DIV"==n.parentElement.nodeName.toUpperCase()){var h=n.parentElement.scrollLeft,c=n.parentElement.scrollTop,p=n.parentElement.getBoundingClientRect().width,u=PM.CONFIG.MESSAGEBAR_HEIGHT;a.Draw(t,h,c,p,u)}if(r!=PM.CONFIG.BOOT_SUCCESS){var f=r==PM.CONFIG.BOOT_FAILURE?PM.CONFIG.BOOT_FAILURE_MSG:PM.CONFIG.BOOT_LOADING_MSG,h=n.parentElement.scrollLeft,c=n.parentElement.scrollTop,g=n.parentElement.getBoundingClientRect();this.DrawBootMessage(t,h,c,g.width,g.height,f)}}},this.DrawBarcode=function(t,e){if(l&&l.GetType()==PM.PRODUCT.PHOTOBOOK){t.save();var o=0>=e;if(o&&this.cover_barcode_image){var r=l.GetWorkRect(e),i=r.l,a=r.t,s=PM.Codi.GetPhotobookGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());t.drawImage(this.cover_barcode_image,i+s.barcode_rect.x,a+s.barcode_rect.y,s.barcode_rect.w,s.barcode_rect.h)}t.restore()}},this.DrawGuideline=function(t,e){if(l&&l.GetType()==PM.PRODUCT.PHOTOBOOK){t.save();var o=l.GetWorkRect(e),r=o.l,i=o.l+o.w,a=o.t,s=o.t+o.h,n=0>=e,h=l.GetSpineWidth(),c=PM.Codi.GetPhotobookGuideInfo(e,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount()),p=PM.CONFIG.GUIDE_EXTRA;if(t.strokeStyle=PM.CONFIG.GUIDE_COLOR,t.fillStyle=PM.CONFIG.GUIDE_TEXT_COLOR,t.lineWidth=PM.CONFIG.GUIDE_LINEW,t.beginPath(),t.moveTo(r-p,a+c.cut_h),t.lineTo(i+p,a+c.cut_h),t.moveTo(r-p,s-c.cut_h),t.lineTo(i+p,s-c.cut_h),t.moveTo(r+c.cut_w,a-p),t.lineTo(r+c.cut_w,s+p),t.moveTo(i-c.cut_w,a-p),t.lineTo(i-c.cut_w,s+p),t.font=PM.CONFIG.GUIDE_FONT,n)if(l.IsAvailableSpine()){var d=r+o.w/2-c.middle_w/2,_=d+c.middle_w,u=r+o.w/2-h/2,f=u+h,g="";PM.DEBUG&&l.cover.middle_page&&(g=":"+c.middle_w+"=="+l.cover.middle_page.width+"("+h+")"),t.moveTo(d,a-p),t.lineTo(d,s+p),t.moveTo(_,a-p),t.lineTo(_,s+p),t.moveTo(u,a-p),t.lineTo(u,s+p),t.moveTo(f,a-p),t.lineTo(f,s+p),t.textAlign="center",t.textBaseline="bottom",t.fillText("책등"+g,r+o.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("뒷면->",u,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-앞면",f,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="hanging",t.fillText("<-인쇄영역",r,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="hanging",t.fillText("인쇄영역->",i,s+PM.CONFIG.GUIDE_TEXT_MARGIN),t.fillText("(인쇄영역까지 사진을 넣어주셔야 여백없이 제작됩니다)",i,s+PM.CONFIG.GUIDE_FONT_H+2*PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-접히는면",r+c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->",i-c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}else l.IsHoleLeatherCoverProduct()&&(t.textAlign="center",t.textBaseline="bottom",t.fillText(PM.CONFIG.GUIDE_LEATHERCOVER_TEXT,r+o.w/2,a-PM.CONFIG.GUIDE_TEXT_MARGIN));else{var P=r+o.w/2;t.moveTo(P,a-p),t.lineTo(P,s+p),t.textAlign="right",t.textBaseline="bottom",t.fillText("접히는면->   ",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("   <-접히는면",P,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="left",t.textBaseline="bottom",t.fillText("<-잘리는면",r+c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN),t.textAlign="right",t.textBaseline="bottom",t.fillText("잘리는면->",i-c.cut_w,a-PM.CONFIG.GUIDE_TEXT_MARGIN)}t.stroke(),t.restore()}},this.DrawGrid=function(t,e){t.save();var o=l.GetWorkRect(e),r=o.l,i=o.l+o.w,a=o.t,s=o.t+o.h,n=u;t.strokeStyle=f,t.lineWidth=PM.CONFIG.GRID_LINEW,t.beginPath();for(var h=r;i>=h;h+=n)t.moveTo(h,a),t.lineTo(h,s);for(var h=a;s>=h;h+=n)t.moveTo(r,h),t.lineTo(i,h);t.stroke(),t.restore()},this.DrawBootMessage=function(t,e,o,r,i,a){t.save(),t.font=PM.CONFIG.BOOT_FONT,t.fillStyle=PM.CONFIG.BOOT_COLOR,t.textAlign="center",t.textBaseline="middle",t.fillText(a,e+r/2,o+i/2),t.restore()},this.DebugString=function(){return""},this.DebugInfo=function(){if(!PM.DEBUG)return"";if(!l)return"";if(l.GetType()!=PM.PRODUCT.PHOTOBOOK)return"";if(s){var t="";t+="["+l.product_code,t+=" "+l.product_size,t+=" "+l.product_type,t+=" "+l.cover_type,t+=" "+l.surface_type,t+=" "+l.theme_depth1,t+=" "+l.theme_depth2,t+="] ";var e=PM.Codi.GetPhotobookGuideInfo(c,l.product_type,l.product_size,l.cover_type,l.surface_type,l.GetInnerPageCount());t+="[",t+=" 책등폭:"+e.middle_w,t+=" 재단선:"+e.cut_w+" "+e.cut_h,t+=" ] ",s.html(t)}},this.DropDefault=function(t,e){l&&(d||(l.ResetFocus(c),l.DropDefault(c,t,e),this.SetModified(!0)))},this.ChangeAll=function(t,e){if(!l)return!1;if(d)return!1;l.ResetFocus(c);var o=l.ChangeAll(c,t,e);return o?(this.SetModified(!0),!0):!1},this.Copy=function(){return l?d?!1:this.IsCopyAvailable()?l.Copy(c):(console.log("Copy is not available."),!1):!1},this.Cut=function(){return l?d?!1:this.IsCutAvailable()?(this.SetModified(!0),l.Cut(c)):(console.log("Cut is not available."),!1):!1},this.Paste=function(){return l?d?!1:this.IsPasteAvailable()?(this.SetModified(!0),l.Paste(c)):(console.log("Paste is not available."),!1):!1},this.IsCopyAvailable=function(){if(!l)return!1;if(d)return!1;if(this.IsFocusTextBox())return!1;var t=l.GetSelectedLayer();return t&&"spine"!=t.gid},this.IsCutAvailable=function(){return this.IsCopyAvailable()},this.IsPasteAvailable=function(){return l?d?!1:this.IsFocusTextBox()?!1:l.clipboard_memory.length>0:!1},this.RecordOperation=function(t,e,o,r,i){var a=new PM.Record(t,e,o,r,i);null!=a&&(y=[],P.push(a))},this.DumpRecord=function(){if(PM.DEBUG){console.log("\n[undo stack...................]");for(var t=0;t<P.length;t++)console.log(t+". "+P[t].desc);console.log("\n[redo stack...................]");for(var t=0;t<y.length;t++)console.log(t+". "+y[t].desc);console.log("\n")}},this.Undo=function(){this.IsUndoAvailable()||console.log("Undo is not available.");var t=P.pop();t&&(l.ResetFocus(c),t.UndoAction(),y.push(t),l.ResetFocus(c),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.Redo=function(){this.IsRedoAvailable()||console.log("Redo is not available.");var t=y.pop();t&&(l.ResetFocus(c),t.RedoAction(),P.push(t),l.ResetFocus(c),this.DumpRecord(),l.ClearSelect(),PM.Editor.Framework.selectLayerCallback&&PM.Editor.Framework.selectLayerCallback(null,null))},this.GetUndoStack=function(){return P},this.GetUndoDesc=function(){if(P.length>0){var t=P[P.length-1];
if(t&&t.desc)return t.desc}return""},this.GetRedoDesc=function(){if(P.length>0){var t=y[y.length-1];if(t&&t.desc)return t.desc}return""},this.IsUndoAvailable=function(){return P.length>0},this.IsRedoAvailable=function(){return y.length>0},this.WindowToCanvas=function(t){var t=window.event||t,e=n.getBoundingClientRect();return{x:t.clientX-e.left*(n.width/e.width),y:t.clientY-e.top*(n.height/e.height)}},this.OnMainLoop=function(){t.OnIdle(),window.requestAnimationFrame(t.OnMainLoop)};var m=0;this.OnIdle=function(){t.Draw(h,n,p,c);var e=+new Date;e-m>1e3&&(t.ModifyCurrentThumbnail(c),m=e)},this.OnUpdateConnection=function(){var e=navigator.onLine?PM.CONFIG.MESSAGE_ONLINE:PM.CONFIG.MESSAGE_OFFLINE;t.ShowMessageBar(e)},this.OnKeyDown=function(e){if(l&&!d)if(l.KeyDown(e))t.SetModified(!0);else{o=e.shiftKey;var r=e.which||e.keyCode;switch(r){case 90:e.ctrlKey&&(e.shiftKey?t.Redo():t.Undo());break;case 89:e.ctrlKey&&t.Redo()}}},this.OnKeyPress=function(e){l&&(d||l.KeyPress(e)&&t.SetModified(!0))},this.OnKeyUp=function(){o=!1},this.OnDoubleClick=function(e){if(l&&!d){l.ResetFocus(c);var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);if(l.DblClick(e,h,c,o.x,o.y),2==p&&_&&e.shiftKey){var r=l.GetWorkRect(c);o.x<r.l&&o.x>r.l-20&&(PM.DEBUG=!PM.DEBUG)}}},this.OnMouseDown=function(e){if(l&&!d&&3!=e.which){l.ResetFocus(c);var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Select(e,h,c,o.x,o.y,p)}},this.OnMouseMove=function(e){if(l&&!d){var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p),r=l.Move(e,h,c,o.x,o.y,p);switch(r.hit_type){case PM.HIT.MOVE:e.target.style.cursor="move";break;case PM.HIT.RESIZE_T:e.target.style.cursor="n-resize";break;case PM.HIT.RESIZE_R:e.target.style.cursor="e-resize";break;case PM.HIT.RESIZE_B:e.target.style.cursor="s-resize";break;case PM.HIT.RESIZE_L:e.target.style.cursor="w-resize";break;case PM.HIT.RESIZE_LT:e.target.style.cursor="nw-resize";break;case PM.HIT.RESIZE_RT:e.target.style.cursor="ne-resize";break;case PM.HIT.RESIZE_RB:e.target.style.cursor="se-resize";break;case PM.HIT.RESIZE_LB:e.target.style.cursor="sw-resize";break;case PM.HIT.ROTATE:e.target.style.cursor="pointer";break;case PM.HIT.MOVE_CROP:e.target.style.cursor="pointer";break;case PM.HIT.EDIT_TEXT:e.target.style.cursor="text";break;default:e.target.style.cursor="default"}r.modified&&t.SetModified(!0)}},this.OnMouseUp=function(e){if(l&&!d){var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Up(e,h,c,o.x,o.y,p),e.target.style.cursor="default"}},this.OnContextMenu=function(e){if(!d){e.preventDefault();var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.ContextMenu(e,h,c,o.x,o.y,p)}},this.OnResize=function(){t.RecalcCanvasSize()},this.OnDragOver=function(e){if(l&&!d){var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.DragOver(e,h,c,o.x,o.y)&&e.preventDefault()}},this.OnDrop=function(e){if(l&&!d){l.ResetFocus(c);var o=PM.Util.P2LPoint(t.WindowToCanvas(e),p);l.Drop(e,h,c,o.x,o.y),t.SetModified(!0)}}},PM.Lib.AjaxItem=function(){this.status="ready",this.params=null,this.xhr=null,this.result={},this.success=null,this.error=null,this.abort=null},PM.Lib.AjaxItem.prototype.Init=function(t,e,o,r){this.params=t,this.success=e,this.error=o,this.abort=r},PM.Lib.AjaxItem.prototype.Send=function(){if(null!=this.params){this.params.timeout=3e4;var t=this;this.status="waiting",this.xhr=$.ajax(this.params),this.xhr.done(function(e,o,r){t.status="success",t.result={data:e,textStatus:o,jqXHR:r}}),this.xhr.fail(function(e,o,r){t.status="fail",t.result={jqXHR:e,textStatus:o,errorThrown:r}})}},PM.Lib.AjaxItem.CommitSuccess=function(){null!=this.success&&this.success(this.result.data,this.result.textStatus,this.result.jqXHR)},PM.Lib.AjaxItem.CommitError=function(){null!=this.error&&this.error(this.result.jqXHR,this.result.textStatus,this.result.errorThrown)},PM.Lib.AjaxItem.CommitAbort=function(){null!=this.xhr&&this.xhr.abort(),null!=this.abort&&this.abort()},PM.Lib.AjaxManager=new function(){this.request_array=[],this.Add=function(t,e,o,r){var i=new PM.Lib.AjaxItem;i.Init(t,e,o,r),this.request_array.push(i)},this.Download=function(){for(var t in this.request_array)this.request_array[t].Send()}},PM.Lib.SeqItem=function(){this.deferred=$.Deferred(),this.func=null},PM.Lib.SeqManager=function(){this.seq_array=[],this.result={}},PM.Lib.SeqManager.prototype.Add=function(t){var e=new PM.Lib.SeqItem;e.func=t,this.seq_array.push(e)},PM.Lib.SeqManager.prototype.Connect=function(t,e){$.when(e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.ConnectArray=function(t,e){$.when.apply($,e).then(function(){t.resolve()},function(){t.reject()})},PM.Lib.SeqManager.prototype.Run=function(t,e){for(var o=this,r=0;r<o.seq_array.length;r++){var i=function(r,i){$.when(r.deferred).then(function(){void 0==i?t(o.result):(o.result.deferred=i.deferred,i.func(o.result))},function(){e(o.result)})};i(o.seq_array[r],o.seq_array[r+1])}o.seq_array.length>0?(o.result.deferred=o.seq_array[0].deferred,o.seq_array[0].func(o.result)):t(o.result)},PM.Record=function(t,e,o,r,i){this.type=t,this.pair_pos=e,this.old_info=o,this.new_info=r,this.desc=i},PM.Record.prototype.GetPageFromIndex=function(t){var e=null;if(t>=0)e=PM.Editor.Framework.GetProduct().page_array[t];else switch(t){case PM.PAGE.COVER_FRONT:e=PM.Editor.Framework.GetProduct().cover.front_page;break;case PM.PAGE.COVER_MIDDLE:e=PM.Editor.Framework.GetProduct().cover.middle_page;break;case PM.PAGE.COVER_BACK:e=PM.Editor.Framework.GetProduct().cover.back_page}return e},PM.Record.prototype.ChangeBackground=function(t,e){for(var o=[],r=0;r<e.length;r++){var i=e[r],a=this.GetPageFromIndex(t+r);a&&o.push(i.skin_link.length>0?a.ChangeSkin(i.skin_link):a.ChangeColor(i.color))}$.when.apply($,o).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.ChangeLayout=function(t,e){for(var o=[],r=0;r<e.length;r++){var i=e[r],a=this.GetPageFromIndex(t+r);if(a){var s=JSON.parse(i);o.push(a.LoadJson(s))}}$.when.apply($,o).then(function(){e.length>2&&PM.Editor.Framework.dropTargetCallback&&PM.Editor.Framework.dropTargetCallback("all","")},function(){})},PM.Record.prototype.InsertLayer=function(t,e,o){var r=this.GetPageFromIndex(t);r&&r.layer_array.splice(e,0,o)},PM.Record.prototype.DeleteLayer=function(t,e){var o=null,r=this.GetPageFromIndex(t);return r&&(o=r.layer_array[e],r.layer_array.splice(e,1)),o},PM.Record.prototype.MoveLayer=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var o=e.layer_array[t.layer_pos];o&&(o.SetMoveInfo(t.data),o.GetType()==PM.TYPE.TEXT&&o.RecalcTBoxSize(!0))}},PM.Record.prototype.SwapLayer=function(t,e,o){var r=this.GetPageFromIndex(t);if(r){var i=r.layer_array[e];r.layer_array[e]=r.layer_array[o],r.layer_array[o]=i}},PM.Record.prototype.ReorderLayer=function(t,e,o){var r=this.GetPageFromIndex(t);if(r){var i=r.layer_array[o];r.layer_array.splice(o,1),r.layer_array.splice(e,0,i)}},PM.Record.prototype.ChangeFrame=function(t){var e=t.data;if(e.length>0){var o=this.GetPageFromIndex(t.page_pos);if(o){var r=o.layer_array[t.layer_pos];if(r.GetType()==PM.TYPE.IMAGE){var i=e[0];i.value.length>0?r.AddDiagram(i.value):r.DeleteDiagram()}}}},PM.Record.prototype.ChangePhoto=function(t){var e=t.data;if(e.length>0){var o=this.GetPageFromIndex(t.page_pos);if(o){var r=o.layer_array[t.layer_pos];if(r.GetType()==PM.TYPE.IMAGE){var i=e[0];r.SetPhotoState(i.value)}}}},PM.Record.prototype.CropPhoto=function(t){var e=this.GetPageFromIndex(t.page_pos);if(e){var o=e.layer_array[t.layer_pos];o&&o.SetCropInfo(t.data)}},PM.Record.prototype.AddAllPhotos=function(t,e){for(var o=[],r=t.data,i=0;i<r.length;i++){var a=this.GetPageFromIndex(r[i].page_pos);if(a){var s=a.layer_array[r[i].layer_pos];if(s&&s.GetType()==PM.TYPE.IMAGE)if(e){var n=JSON.parse(r[i].json),h=n.url_domain+n.url_path+n.url_edit,l=n.url_domain+n.url_path+n.url_file,c=n.img_width,p=n.img_height,d=!1,_=s.AddPhoto(h,l,c,p,d);_.added&&o.push(_.promise)}else{var u=s.SetPhotoState(r[i].info);o.push(u)}}}$.when.apply($,o).then(function(){PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success")},function(){})},PM.Record.prototype.DeleteAllPhotos=function(t){for(var e=t.data,o=0;o<e.length;o++){var r=this.GetPageFromIndex(e[o].page_pos);if(r){var i=r.layer_array[e[o].layer_pos];i&&i.GetType()==PM.TYPE.IMAGE&&i.DeletePhotoProp()}}PM.Editor.Framework.deletePhotosCompleteCallback&&PM.Editor.Framework.deletePhotosCompleteCallback(0,"")},PM.Record.prototype.UndoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:var e=PM.Editor.Framework.GetProduct(),o=this.new_info.data;e.page_array.splice(this.new_info.page_pos,o.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:for(var e=PM.Editor.Framework.GetProduct(),o=this.old_info.data,r=o.length-1;r>=0;r--)e.page_array.splice(this.old_info.page_pos,0,o[r]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),o=this.new_info.data,i=[],r=0;r<o.length;r++){var a=o[r];i[a]=e.page_array[r]}e.page_array=i,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.old_info.page_pos,this.old_info.data);break;case PM.RECORD_LAYER_INSERT:this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);break;case PM.RECORD_LAYER_DELETE:var o=this.old_info.data;if(o.length>0){var s=o[0];this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,s.value)}break;case PM.RECORD_EMPTYLAYERS_DELETE:for(var o=this.old_info.data,r=o.length-1;r>=0;r--){var s=o[r];this.InsertLayer(s.page_pos,s.layer_pos,s.data)}PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.new_info.page_pos,this.new_info.layer_pos);n&&this.InsertLayer(this.old_info.page_pos,this.old_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);this.MoveLayer(this.old_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.old_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.old_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.old_info);break;case PM.RECORD_PHOTO_ADDALL:this.DeleteAllPhotos(this.new_info);break;case PM.RECORD_PHOTO_DELALL:this.AddAllPhotos(this.old_info,!1);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.old_info.data,this.old_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.old_info.page_pos);if(h){var l=h.layer_array[this.old_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Undo(this.old_info.data.text_data),l.SetMoveInfo(this.old_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Record.prototype.RedoAction=function(){var t=!0;switch(this.type){case PM.RECORD_PAGE_INSERT:for(var e=PM.Editor.Framework.GetProduct(),o=this.new_info.data,r=o.length-1;r>=0;r--)e.page_array.splice(this.new_info.page_pos,0,o[r]);e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_DELETE:var e=PM.Editor.Framework.GetProduct(),o=this.old_info.data;e.page_array.splice(this.old_info.page_pos,o.length),e.ResetSpine(),PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_REORDER:for(var e=PM.Editor.Framework.GetProduct(),o=this.new_info.data,i=[],r=0;r<o.length;r++){var a=o[r];i.push(e.page_array[a])}e.page_array=i,PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_PAGE_BKCOLOR:case PM.RECORD_PAGE_BKIMAGE:this.ChangeBackground(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_PAGE_LAYOUT:this.ChangeLayout(this.new_info.page_pos,this.new_info.data);break;case PM.RECORD_LAYER_INSERT:var o=this.new_info.data;if(o.length>0){var s=o[0];this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,s.value)}break;case PM.RECORD_LAYER_DELETE:this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);break;case PM.RECORD_EMPTYLAYERS_DELETE:for(var o=this.old_info.data,r=0;r<o.length;r++){var s=o[r];this.DeleteLayer(s.page_pos,s.layer_pos,s.data)}PM.Editor.Framework.addPhotosCompleteCallback&&PM.Editor.Framework.addPhotosCompleteCallback(0,"success");break;case PM.RECORD_LAYER_MOVE:if(this.old_info.page_pos!=this.new_info.page_pos){var n=this.DeleteLayer(this.old_info.page_pos,this.old_info.layer_pos);n&&this.InsertLayer(this.new_info.page_pos,this.new_info.layer_pos,n)}else this.old_info.layer_pos!=this.new_info.layer_pos&&this.ReorderLayer(this.new_info.page_pos,this.new_info.layer_pos,this.old_info.layer_pos);this.MoveLayer(this.new_info);break;case PM.RECORD_LAYER_ZORDER:this.SwapLayer(this.old_info.page_pos,this.old_info.layer_pos,this.new_info.layer_pos);break;case PM.RECORD_FRAME_CHANGE:this.ChangeFrame(this.new_info);break;case PM.RECORD_PHOTO_CHANGE:this.ChangePhoto(this.new_info);break;case PM.RECORD_PHOTO_CROP:this.CropPhoto(this.new_info);break;case PM.RECORD_PHOTO_ADDALL:this.AddAllPhotos(this.new_info,!0);break;case PM.RECORD_PHOTO_DELALL:this.DeleteAllPhotos(this.old_info);break;case PM.RECORD_ICON_OPACITY:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.ICON&&l.SetAlpha(this.new_info.data,this.new_info.data,!1)}break;case PM.RECORD_TEXT_CHANGE:var h=this.GetPageFromIndex(this.new_info.page_pos);if(h){var l=h.layer_array[this.new_info.layer_pos];l&&l.GetType()==PM.TYPE.TEXT&&(l.Redo(this.new_info.data.text_data),l.SetMoveInfo(this.new_info.data.layer_data))}}return PM.Editor.Framework.MovePair(this.pair_pos),t},PM.Util=new function(){this.P2LPoint=function(t,e){return t.x/=e,t.y/=e,t},this.P2LSize=function(t,e){return t.w/=e,t.h/=e,t},this.P2LRect=function(t,e){return t.l/=e,t.t/=e,t.w/=e,t.h/=e,t},this.L2PPoint=function(t,e){return t.x*=e,t.y*=e,t},this.L2PSize=function(t,e){return t.w*=e,t.h*=e,t},this.L2PRect=function(t,e){return t.l*=e,t.t*=e,t.w*=e,t.h*=e,t},this.PtInRect=function(t,e,o){return e>=t.l&&e<=t.l+t.w&&o>=t.t&&o<=t.t+t.h?!0:!1},this.PtInCircle=function(t,e,o,r,i){var a={l:t-o,t:e-o,w:2*o,h:2*o};return this.PtInRect(a,r,i)},this.ToRadian=function(t){return t*Math.PI/180},this.ToAngle=function(t){return 180*t/Math.PI},this.DrawLine=function(t,e,o,r,i,a,s){t.beginPath(),t.lineWidth=a,t.strokeStyle=s,t.moveTo(e,o),t.lineTo(r,i),t.stroke(),t.closePath()},this.DrawRect=function(t,e,o,r,i,a,s,n){t.lineWidth=a,t.strokeStyle=s,t.strokeRect(e,o,r,i),n&&(t.fillStyle=n,t.fillRect(e,o,r,i))},this.DrawCircle=function(t,e,o,r,i,a,s){t.beginPath(),t.lineWidth=i,t.strokeStyle=a,s&&(t.fillStyle=s),t.arc(e,o,r,0,2*Math.PI,!1),t.stroke(),s&&t.fill(),t.closePath()},this.DrawDashLine=function(t,e,o,r,i,a,s){var n=t.getLineDash();t.setLineDash([4,4]),this.DrawLine(t,e,o,r,i,a,s),t.setLineDash(n)},this.DrawDashRect=function(t,e,o,r,i,a,s,n){var h=t.getLineDash();t.setLineDash([4,4]),this.DrawRect(t,e,o,r,i,a,s,n),t.setLineDash(h)},this.GetFullPathName=function(t,e){return e.indexOf("colorempty.png")>=0?"":t+e},this.ToHexColor=function(t,e,o){if(!t||!e||!o)return"";var r=parseInt(t,10).toString(16),i=parseInt(e,10).toString(16),a=parseInt(o,10).toString(16);return r=1==r.length?"0"+r:r,i=1==i.length?"0"+i:i,a=1==a.length?"0"+a:a,"#"+r+i+a},this.String2HexColor=function(t){var e=t.split(",");return e.length<4?"#000000":this.ToHexColor(e[1],e[2],e[3])},this.GetWebFont=function(t){for(var e in PM.CONFIG.FONT_POOL)if(t==PM.CONFIG.FONT_POOL[e])return t;return PM.CONFIG.FONT_DEFAULT},this.LoadWebFont=function(t,e){t=this.GetWebFont(t);var o=PM.CONFIG.FONT_PATH[t];o.length<=0||WebFont.load({timeout:6e3,custom:{families:[t],urls:[o]},loading:function(){},inactive:function(){console.error("webfont inactive!!!! "+t+" "+Date.now()),PM.Editor.Framework.ShowMessageBar("웹폰트를 로드할 수 없습니다.")},active:e})},this.LoadXml=function(t){return this.LoadAsync(t,"xml")},this.LoadJson=function(t){return this.LoadAsync(t,"json")},this.LoadAsync=function(t,e){var o=$.Deferred();return $.ajax({type:"get",dataType:e,timeout:2e4,url:t,success:function(t,e,r){o.resolve(t,e,r)},error:function(t,e,r){o.reject(t,e,r)}}),o.promise()},this.LoadImage=function(t){var e=$.Deferred(function(e){if(null==t||t.length<=0)e.resolve(null);else{var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){e.resolve(o)},o.onerror=function(){e.reject()},o.src=t,(o.complete||void 0===o.complete)&&(o.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",o.src=t)}});return e.promise()},this.CanvasToImage=function(t){var e=null;try{e=t.toDataURL("image/jpeg",1)}catch(o){e=null,console.error(o)}return e},this.GetCenterPos=function(t,e,o,r){var i=0,a=0;return t>=o&&(i=t/2-o/2),e>=r&&(a=e/2-r/2),{x:i,y:a}},this.GetScale=function(t,e,o,r,i){var a=t/o,s=e/r,n=i?Math.min(a,s):Math.max(a,s);return n},this.GetScaledRect=function(t,e,o,r,i){var a=this.GetScale(t,e,o,r,i),s=o*a,n=r*a,h=(t-s)/2,l=(e-n)/2,c={l:-h/a,t:-l/a,w:t/a,h:e/a};return c.l<0&&(c.l=0),c.t<0&&(c.t=0),c.l+c.w>o&&(c.w=o-c.l),c.t+c.h>r&&(c.h=r-c.t),c},this.IsMacintosh=function(){var t=navigator.userAgent;return t.indexOf("Macintosh")>=0||t.indexOf("Mac OS")>=0?!0:!1},this.ProductSize2SizeId=function(t){var e=t,o=-1;switch(e){case"6x6":o=PM.SIZE6X6;break;case"6x8":case"a5h":o=PM.SIZE6X8;break;case"8x6":case"a5w":o=PM.SIZE8X6;break;case"8x8":o=PM.SIZE8X8;break;case"8x11":case"a4h":o=PM.SIZE8X11;break;case"11x8":case"a4w":o=PM.SIZE11X8;break;case"10x10":o=PM.SIZE10X10}return o},this.ProductSize2InchSize=function(t){var e={w:0,h:0},o=this.ProductSize2SizeId(t);switch(o){case PM.SIZE6X6:e.w=6,e.h=6;break;case PM.SIZE6X8:e.w=6,e.h=8;break;case PM.SIZE8X6:e.w=8,e.h=6;break;case PM.SIZE8X8:e.w=8,e.h=8;break;case PM.SIZE8X11:e.w=8,e.h=11;break;case PM.SIZE11X8:e.w=11,e.h=8;break;case PM.SIZE10X10:e.w=10,e.h=10}return e};var t=0;this.CalcFps=function(){var e=new Date,o=1e3/(e-t);return t=e,o},this.IsValidURL=function(t){return t&&t.length>0&&(t=t.toLowerCase(),t.indexOf("http://")>=0||t.indexOf("https://")>=0)?!0:!1},this.replaceEscapeChar=function(t){var e=t;return e=e.replace(/"/gi,'\\"')},this.ParseCalendarFilename=function(t){var e=0,o=0,r=!1;if(t.length>10){var i=t.substr(t.length-10,10),a=i.split("."),s=a[0].split("-");2==s.length&&4==s[0].length&&1==s[1].length&&(e=2e3+parseInt(s[0].substr(0,2)),o=parseInt(s[0].substr(2,2)),r="a"==s[1])}return{year:e,month:o,is_front:r}},this.GetMonthArray=function(t){var e=t%4==0&&(t%100!=0||t%400==0),o=[0,31,28,31,30,31,30,31,31,30,31,30,31];return e&&(o[2]=29),o},this.MakeMonth=function(t,e){for(var o=this.GetMonthArray(t),r=365*(t-1)+Math.floor((t-1)/4)-Math.floor((t-1)/100)+Math.floor((t-1)/400),i=1;e>i;i++)r+=o[i];r+=1;var a=r%7;return{week:a,days:o[e]}},this.PrintCalendar=function(t,e,o){if(PM.DEBUG)for(var r=0;o>r;r++){console.log("\n          "+t+" "+e),console.log("SUN MON TUE WED THU FRI SAT");for(var i="",a=PM.Util.MakeMonth(t,e),s=-a.week;s<a.days;s++){if((s+a.week)%7==0&&i.length>0&&(console.log(i),i=""),0>s)i+="   ";else{var n=s+1,h=10>n?"  ":" ";i+=h+n}i+=" "}console.log(i),e++,e>12&&(e=1,t++)}}},X={},X.ENTERKEY="¶",X.COLOR_CARET="rgba(255, 0, 0, 0.5)",X.COLOR_ULINE="rgba(0, 0, 0, 1)",X.COLOR_BLOCK="rgba(0, 0, 255, 0.5)",X.COLOR_BLOCK_KILLFOCUS="rgba(0, 0, 255, 0.0)",X.RECORD_OFF=0,X.RECORD_INS=1,X.RECORD_DEL=2,X.RECORD_REPL=3,X.RECORD_ATTR=4,X.RECORD_PARA=5,X.RECORD_VALIGN=6,X.MARGIN_H=5;var check_bbox=!1,xpoint=function(t,e){this.x=t,this.y=e};xpoint.prototype={clone:function(){var t=new xpoint;return t.x=this.x,t.y=this.y,t}};var xrect=function(t,e,o,r){this.l=t,this.t=e,this.r=o,this.b=r};xrect.prototype={clone:function(){var t=new xrect;return t.l=this.l,t.t=this.t,t.r=this.r,t.b=this.b,t},width:function(){return this.r-this.l},height:function(){return this.b-this.t}};var xattr_filter=function(t){this.bold=t,this.italic=t,this.underline=t,this.point=t,this.facename=t,this.charw=t,this.textcolor=t,this.strokecolor=t,this.shadowcolor=t},xattr=function(){this.bold=!1,this.italic=!1,this.underline=!1,this.point=12,this.facename="",this.charw=100,this.textcolor="#000000",this.strokecolor="",this.shadowcolor="",this.ascent=0,this.descent=0};xattr.prototype={clone:function(){var t=new xattr;return t.bold=this.bold,t.italic=this.italic,t.underline=this.underline,t.point=this.point,t.facename=this.facename,t.charw=this.charw,t.textcolor=this.textcolor,t.strokecolor=this.strokecolor,t.shadowcolor=this.shadowcolor,t.ascent=this.ascent,t.descent=this.descent,t},loaddata:function(t){this.bold=t.bold,this.italic=t.italic,this.underline=t.underline,this.point=t.point,this.facename=t.facename,this.charw=t.charw,this.textcolor=t.textcolor,this.strokecolor=t.strokecolor,this.shadowcolor=t.shadowcolor;var e=this.facename;PM.Util.LoadWebFont(e,function(){console.log("[xdoc-load] webfont loaded... "+e+" "+Date.now())});var o=getbaselineinfo(this.facename,this.point);this.ascent=o.ascent,this.descent=o.descent},toJSON:function(){var t="  {";return t+='"bold":'+this.bold,t+=', "italic":'+this.italic,t+=', "underline":'+this.underline,t+=', "point":'+this.point,t+=', "facename":"'+this.facename+'"',t+=', "charw":"'+this.charw+'"',t+=', "textcolor":"'+this.textcolor+'"',t+=', "strokecolor":"'+this.strokecolor+'"',t+=', "shadowcolor":"'+this.shadowcolor+'"',t+="}"},set_prop:function(t,e){if(e.bold&&(this.bold=t.bold),e.italic&&(this.italic=t.italic),e.underline&&(this.underline=t.underline),e.point&&(this.point=t.point),e.facename&&(this.facename=t.facename),e.charw&&(this.charw=t.charw),e.textcolor&&(this.textcolor=t.textcolor),e.strokecolor&&(this.strokecolor=t.strokecolor),e.shadowcolor&&(this.shadowcolor=t.shadowcolor),e.point||e.facename){var o=getbaselineinfo(this.facename,this.point);this.ascent=o.ascent,this.descent=o.descent}},is_equal:function(t){return this.bold!=t.bold?!1:this.italic!=t.italic?!1:this.underline!=t.underline?!1:this.point!=t.point?!1:this.facename!=t.facename?!1:this.charw!=t.charw?!1:this.textcolor!=t.textcolor?!1:this.strokecolor!=t.strokecolor?!1:this.shadowcolor!=t.shadowcolor?!1:!0}};var xattr_pool=function(){this.array={}};xattr_pool.prototype.clone=function(){var t=new xattr_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xattr_pool.prototype.add_nodup=function(t){var e=-1;for(var o in this.array)if(this.array[o].is_equal(t)){e=o,t=null;break}if(0>e){var r=getbaselineinfo(t.facename,t.point);t.ascent=r.ascent,t.descent=r.descent,e=get_key(this.array),this.array[e]=t}return e},xattr_pool.prototype.toJSON=function(){var t=0,e=0;for(var o in this.array)e++;var r='"attr_pool": {\n';for(var i in this.array)r+='"'+i+'":',r+=this.array[i].toJSON(),e-1>t&&(r+=","),r+="\n",t++;return r+="}"},xattr_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var o=parseInt(e);this.array[o]=new xattr,this.array[o].loaddata(t[e])}};var xpara_filter=function(t){this.align=t,this.linegap=t,this.paragap=t},xpara=function(){this.align=4,this.linegap=5,this.paragap=0};xpara.prototype={clone:function(){var t=new xpara;return t.align=this.align,t.linegap=this.linegap,t.paragap=this.paragap,t},loaddata:function(t){this.align=t.align,this.linegap=t.linegap,this.paragap=t.paragap},toJSON:function(){var t="  {";return t+='"align":'+this.align,t+=', "linegap":'+this.linegap,t+=', "paragap":'+this.paragap,t+=" }"},set_prop:function(t,e){e.align&&(this.align=t.align),e.linegap&&(this.linegap=t.linegap),e.paragap&&(this.paragap=t.paragap)},is_equal:function(t){return this.align!=t.align?!1:this.linegap!=t.linegap?!1:this.paragap!=t.paragap?!1:!0}};var xpara_pool=function(){this.array={}};xpara_pool.prototype.clone=function(){var t=new xpara_pool;for(var e in this.array)t.array[e]=this.array[e].clone();return t},xpara_pool.prototype.add_nodup=function(t){var e=-1;for(var o in this.array)if(this.array[o].is_equal(t)){e=o,t=null;break}return 0>e&&(e=get_key(this.array),this.array[e]=t),e},xpara_pool.prototype.toJSON=function(){var t=0,e=0;for(var o in this.array)e++;var r='"para_pool": {\n';for(var i in this.array)r+='"'+i+'":',r+=this.array[i].toJSON(),e-1>t&&(r+=","),r+="\n",t++;return r+="}"},xpara_pool.prototype.loaddata=function(t){this.array={};for(var e in t){var o=parseInt(e);this.array[o]=new xpara,this.array[o].loaddata(t[e])}};var xcodeinfo=function(){this.code="",this.width=0,this.ascent=0,this.descent=0,this.x=0,this.y=0,this.step_w=0};xcodeinfo.prototype={clone:function(){var t=new xcodeinfo;return t.code=this.code,t.width=this.width,t.ascent=this.ascent,t.descent=this.descent,t.x=this.x,t.y=this.y,t.step_w=this.step_w,t}};var xline=function(){this.begin=0,this.end=0,this.total_w=0,this.remain_w=0,this.max_ascent=0,this.max_descent=0,this.gap=0,this.is_lastline,this.ci_array=null},xlines=function(){this.array=new Array};xlines.prototype={pos2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0;e<this.array.length;e++){var o=this.array[e];if(t>=o.begin&&t<=o.end)return e}return-1},point2lineindex:function(t){if(this.array.length<=0)return-1;for(var e=0,o=0;o<this.array.length;o++){var r=this.array[o],i=r.max_ascent+r.max_descent+r.gap;if(e+i>t)return o;e+=i}return this.array.length-1},gettotalheight:function(){for(var t=0,e=0;e<this.array.length;e++){var o=this.array[e],r=o.max_ascent+o.max_descent+o.gap;t+=r}return t},getlinerect:function(t,e){if(this.array.length<=0)return new xrect(0,0,0,0);if(0>t)return new xrect(0,0,0,0);if(t>=this.array.length)return new xrect(0,0,0,0);for(var o=0,r=new xrect(0,0,0,0),i=0;i<this.array.length;i++){var a=this.array[i];if(r.r=r.l+(a.total_w-a.remain_w),r.b=r.t+(a.max_ascent+a.max_descent+a.gap),o=a.gap,i==t)break;r.t=r.b}return e||(r.b-=o),r}};var xsel_state=function(){this.inspos=-1,this.attrid=-1};xsel_state.prototype={reset:function(){this.inspos=-1,this.attrid=-1},clone:function(){var t=new xsel_state;return t.inspos=this.inspos,t.attrid=this.attrid,t},setstate:function(t,e){this.inspos=t,this.attrid=e},getinspos:function(){return this.inspos},getattrid:function(){return this.attrid}};var xpos=function(t,e){this.pivot=t,this.move=e};xpos.prototype={init:function(){this.pivot=0,this.move=0},clone:function(){var t=new xpos(0,0);return t.pivot=this.pivot,t.move=this.move,t},isblock:function(){return this.pivot<0||this.move<0?!1:this.pivot!=this.move},setpos:function(t){this.pivot=t,this.move=t},getpivot:function(){return this.pivot},getmove:function(){return this.move},setpivot:function(t){this.pivot=t},setmove:function(t){this.move=t},setleft:function(){var t=this.pivot<=this.move?this.pivot:this.move;this.pivot=this.move=t},setright:function(){var t=this.pivot>this.move?this.pivot:this.move;this.pivot=this.move=t},moveleft:function(t){if(this.isblock())this.setleft();else{if(this.pivot<=t)return!1;this.pivot--,this.move=this.pivot}return!0},moveright:function(t){if(this.isblock())this.setright();else{if(this.pivot>=t)return!1;this.pivot++,this.move=this.pivot}return!0},blockmoveleft:function(t){return this.move<=t?!1:(this.move--,!0)},blockmoveright:function(t){return this.move>=t?!1:(this.move++,!0)},getblock:function(){if(this.isblock()){var t=this.pivot<=this.move?this.pivot:this.move,e=this.pivot>this.move?this.pivot:this.move;return{left:t,right:e-1}}return{left:-1,right:-1}},setblock:function(t,e){return 0>t||0>e?!1:(this.pivot=t,this.move=e,this.pivot<this.move)}};var xcaret=function(){this.visible=!1,this.base_x=0,this.rect=new xrect(0,0,0,0)};xcaret.prototype={is_show:function(){return this.visible},show:function(t){this.visible=t},getbase_x:function(){return this.base_x},setbase_x:function(t){this.base_x=t},getrect:function(){return this.rect.clone()},setrect:function(t){this.rect=null,this.rect=t.clone()},display:function(t,e,o){0!=this.visible&&(t.save(),t.fillStyle=X.COLOR_CARET,t.fillRect(this.rect.l+e,this.rect.t+o,this.rect.width(),this.rect.height()),t.restore())}};var xop=function(t,e,o,r){this.type=t,this.pos=e,this.del=o,this.ins=r},xdoc=function(){this.is_singleline=!1,this.strings=[],this.offsets=[],this.attr_pool=new xattr_pool,this.para_pool=new xpara_pool,this.lines=new xlines,this.sel_state=new xsel_state,this.strings.push(X.ENTERKEY),this.offsets.push(0),this.attr_pool.array[0]=new xattr,this.para_pool.array[0]=new xpara};xdoc.prototype={clone:function(){var t=new xdoc;return t.strings=this.strings.slice(0),t.offsets=this.offsets.slice(0),t.attr_pool=this.attr_pool.clone(),t.para_pool=this.para_pool.clone(),t},setdefault:function(t,e){null!=t&&(this.attr_pool.array[0]=t),null!=e&&(this.para_pool.array[0]=e)},delete_unused:function(){var t={},e={};for(var o in this.attr_pool.array)t[o]=0;for(var o in this.para_pool.array)e[o]=0;for(var o=0;o<this.offsets.length;o++){var r=this.offsets[o];this.strings[o]==X.ENTERKEY?e[r]=1:t[r]=1}t[0]=e[0]=1;for(var o in this.attr_pool.array)0==t[o]&&delete this.attr_pool.array[o];for(var o in this.para_pool.array)0==e[o]&&delete this.para_pool.array[o]},loaddata:function(t){this.strings=t.strings,this.offsets=t.offsets,this.attr_pool.loaddata(t.attr_pool),this.para_pool.loaddata(t.para_pool)},toString:function(){for(var t="",e=0;e<this.strings.length-1;e++)t+=this.strings[e];return t=PM.Util.replaceEscapeChar(t)},toJSON:function(){var t="{\n";t+='"strings": [\n';for(var e=0;e<this.strings.length;e++){var o=PM.Util.replaceEscapeChar(this.strings[e]);t+='"'+o+'"',e<this.strings.length-1&&(t+=",")}t+="],\n",t+='"offsets": [\n';for(var e=0;e<this.offsets.length;e++)t+=this.offsets[e],e<this.offsets.length-1&&(t+=",");return t+="],\n",t+=this.attr_pool.toJSON()+",\n",t+=this.para_pool.toJSON()+"\n",t+="}\n"},toJSONEx:function(t,e){var o="{\n";o+='"strings": [\n';for(var r=0;r<this.strings.length;r++){var i=PM.Util.replaceEscapeChar(this.strings[r]);o+='"'+i+'"',r<this.strings.length-1&&(o+=",")}o+="],\n",o+='"offsets": [\n';for(var r=0;r<this.offsets.length;r++)o+=this.offsets[r],r<this.offsets.length-1&&(o+=",");return o+="],\n",o+=this.attr_pool.toJSON()+",\n",o+=this.para_pool.toJSON()+"\n",o+=",\n"+this.toCoordinatesJSON(t,e)+"\n",o+="}\n"},toCoordinatesJSON:function(t,e){for(var o='"coordinates": [\n',r=e+X.MARGIN_H,i=0;i<this.lines.array.length;){for(var a=this.lines.array[i++],s=a.begin;s<=a.end;){var n=a.ci_array[s-a.begin],h=n.x,l=r+n.y,c=n.width,p=n.ascent+n.descent,d=n.ascent;o+="{ ",o+='"x": '+h.toFixed(2)+", ",o+='"y": '+l.toFixed(2)+", ",o+='"w": '+c.toFixed(2)+", ",o+='"h": '+p.toFixed(2)+", ",o+='"ascent": '+d.toFixed(2),o+="}",s++,s<this.strings.length&&(o+=","),o+="\n"}var _=a.max_ascent+a.max_descent+a.gap;r+=_}return o+="]"},toSVG:function(){this.delete_unused();var t='<?xml version="1.0" encoding="utf-8"?>\n';t+='<svg xmlns="http://www.w3.org/2000/svg" ',t+='width="'+canvas.width+'px" height="'+canvas.height+'px">\n';for(var e=0;e<this.lines.array.length;)for(var o=this.lines.array[e++],r=o.begin;r<=o.end;){var i=o.ci_array[r-o.begin],a=this.strings[r];if(a!=X.ENTERKEY){t+="<text ";var s=this.getattr(r);t+='x="'+i.x+'" ',t+='y="'+(i.y+i.ascent+i.descent)+'" ',t+='style="',t+="font-family:"+s.facename+";",t+="font-size:"+s.point+"pt;",t+="fill:"+s.textcolor+";",t+=""!=s.strokecolor?"stroke:"+s.strokecolor+";":"",t+=s.bold?"font-weight:bold;":"",t+=s.italic?"font-style:italic;":"",t+='"',t+=">",t+=a,t+="</text>\n"
}r++}return t+="</svg>\n"},getlength:function(){return this.strings.length-1},getdocheight:function(){return this.lines.gettotalheight()+2*X.MARGIN_H},getdocwidth:function(){if(0<this.lines.array.length){var t=this.lines.array[0];return t.total_w}return 0},getalignedwidth:function(){if(this.lines.array.length>0){var t=this.lines.array[0];return t.total_w-t.remain_w}return 0},insertchars:function(t,e,o){if(0>t||t>=this.strings.length)return!1;if(e[0]==X.ENTERKEY&&1==o){var r=this.getpara(t-1),i=null!=r?r.clone():new xpara,a=get_key(this.para_pool.array);this.para_pool.array[a]=i,this.strings.splice(t,0,X.ENTERKEY),this.offsets.splice(t,0,a)}else{var s=0;s=t==this.sel_state.getinspos()?this.sel_state.getattrid():this.getattrid(t-1);for(var n=t,h=0;o>h;h++)this.strings.splice(n,0,e[h]),this.offsets.splice(n,0,s),n++}return t!=this.sel_state.getinspos()&&this.sel_state.reset(),!0},insertdoc:function(t,e){if(0>t||t>=this.strings.length)return!1;var o=e.clone(),r={};for(var i in o.attr_pool.array)r[i]=this.attr_pool.add_nodup(o.attr_pool.array[i]);var a={};for(var i in o.para_pool.array){var s=get_key(this.para_pool.array);this.para_pool.array[s]=o.para_pool.array[i],a[i]=s}for(var i=0;i<o.offsets.length;i++){var n=o.offsets[i];o.offsets[i]=o.strings[i]==X.ENTERKEY?a[n]:r[n]}for(var h=t,i=0;i<o.strings.length;i++)this.strings.splice(h,0,o.strings[i]),this.offsets.splice(h,0,o.offsets[i]),h++;this.delete_unused()},deletechars:function(t,e){return 0>t||t+e>this.getlength()?!1:(this.strings.splice(t,e),this.offsets.splice(t,e),t!=this.sel_state.getinspos()&&this.sel_state.reset(),e>2&&this.delete_unused(),!0)},getblockdoc:function(t,e){if(t>=0&&e>=t&&e<this.strings.length-1){var o=new xdoc;o.strings=this.strings.slice(t,e+1),o.offsets=this.offsets.slice(t,e+1);for(var r=t;e+1>r;r++){var i=this.offsets[r];this.strings[r]==X.ENTERKEY?o.para_pool.array[i]=this.para_pool.array[i].clone():o.attr_pool.array[i]=this.attr_pool.array[i].clone()}return o}return null},getblocktext:function(t,e){return t>=0&&e>t&&e<this.strings.length?this.strings.slice(t,e+1).join(""):""},getattrid:function(t){for(;t>=0;){var e=this.strings[t];if(e!=X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getparaid:function(t){for(;t>=0;){var e=this.strings[t];if(e==X.ENTERKEY)break;t--}return 0>t?0:this.offsets[t]},getattr:function(t){var e=this.getattrid(t);return this.attr_pool.array.hasOwnProperty(e)?this.attr_pool.array[e]:null},getpara:function(t){var e=this.getparaid(t);return this.para_pool.array.hasOwnProperty(e)?this.para_pool.array[e]:null},getattrstate:function(t){if(t>=0&&t<this.strings.length){var e=this.getattr(t-1);if(e){var o=e.clone(),r=new xattr_filter(!0);return{attr:o,filter:r}}}return{attr:null,filter:null}},getparastate:function(t){if(t>=0&&t<this.strings.length){var e=this.getpara(t-1);if(e){var o=e.clone(),r=new xpara_filter(!0);return{para:o,filter:r}}}return{para:null,filter:null}},getblockattrstate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var o=this.getattr(t);if(o){for(var r=o.clone(),i=new xattr_filter(!0),a=t+1;e>=a;a++){var s=this.getattr(a);o.bold!=s.bold&&(i.bold=!1),o.italic!=s.italic&&(i.italic=!1),o.point!=s.point&&(i.point=!1),o.facename!=s.facename&&(i.facename=!1),o.charw!=s.charw&&(i.charw=!1),o.textcolor!=s.textcolor&&(i.textcolor=!1),o.strokecolor!=s.strokecolor&&(i.strokecolor=!1),o.shadowcolor!=s.shadowcolor&&(i.shadowcolor=!1)}return{attr:r,filter:i}}}return{attr:null,filter:null}},getblockparastate:function(t,e){if(t>=0&&e>=t&&e<this.strings.length){var o=this.getpara(t);if(o){for(var r=o.clone(),i=new xpara_filter(!0),a=t+1;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.getpara(a);o.align!=n.align&&(i.align=!1),o.linegap!=n.linegap&&(i.linegap=!1),o.paragap!=n.paragap&&(i.paragap=!1)}}return{para:r,filter:i}}}return{para:null,filter:null}},setattrstate:function(t,e,o){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var r=null;if(o){var i=this.getattr(t-1);i&&(r=i.clone(),r.set_prop(e,o))}else r=e.clone();var a=this.attr_pool.add_nodup(r);return this.sel_state.setstate(t,a),!0},setparastate:function(t,e,o){if(0>t||t>this.strings.length)return!1;if(null==e)return!1;var r=this.getpara(t-1);return r?(r.set_prop(e,o),!0):!1},setblockattrstate:function(t,e,o,r){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==o)return!1;if(r)for(var i=new Array,a=new Array,s=t;e>=s;s++){var n=this.strings[s];if(n!=X.ENTERKEY){for(var h=this.offsets[s],l=!1,c=0;c<i.length;c++)if(h==a[c]){var p=a[c];this.offsets[s]=p,l=!0;break}if(!l){var d=this.attr_pool.array[h],_=d.clone();_.set_prop(o,r);var p=this.attr_pool.add_nodup(_);this.offsets[s]=p,i.push(h),a.push(p)}}}else for(var _=o.clone(),u=this.attr_pool.add_nodup(_),s=t;e>=s;s++){var n=this.strings[s];n!=X.ENTERKEY&&(this.offsets[s]=u)}return!0},setblockparastate:function(t,e,o,r){if(0>t||t>e||e>=this.strings.length-1)return!1;if(null==o)return!1;if(this.setparastate(t,o,r)){for(var i=t;e>=i;i++){var a=this.strings[i];if(a==X.ENTERKEY){var s=this.offsets[i];if(this.para_pool.array.hasOwnProperty(s)){var n=this.para_pool.array[s];n.set_prop(o,r)}}}return!0}return!1},getselparas:function(t,e){if(!(0>t)){var o=[],r=this.getpara(t-1);if(r){o.push(r.clone());for(var i=t;e>=i;i++)if(this.strings[i]==X.ENTERKEY){var a=this.offsets[i];this.para_pool.array.hasOwnProperty(a)&&(r=this.para_pool.array[a],r&&o.push(r.clone()))}return o}return null}},setselparas:function(t,e,o){if(!(0>t)){var r=new xpara_filter(!0);if(this.setparastate(t,o[0],r))for(var i=1,a=t;e>=a;a++){var s=this.strings[a];if(s==X.ENTERKEY){var n=this.offsets[a];if(this.para_pool.array.hasOwnProperty(n)){var h=this.para_pool.array[n];h.set_prop(o[i],r)}i++}}}},is_dbcs:function(t){var e=t.charCodeAt();return e>=4352&&4607>=e?!0:e>=12592&&12687>=e?!0:e>=44032&&55203>=e?!0:!1},preparedc:function(t,e){if(this.attr_pool.array.hasOwnProperty(e)){var o=this.attr_pool.array[e];if(o){var r=o.bold?"bold ":"";r+=o.italic?"italic ":"",t.font=r+o.point+"pt '"+o.facename+"'",t.fillStyle=o.textcolor,t.strokeStyle=o.strokecolor,""!=o.strokecolor&&(t.lineWidth=1),t.shadowColor=o.shadowcolor,""!=o.shadowcolor&&(t.shadowOffsetX=3,t.shadowOffsetY=2),t.textAlign="left",t.textBaseline="alphabetic"}}},getcodeinfo:function(t,e,o,r,i){var a=this.getattrid(e);this.prev_attr_id!=a&&(this.preparedc(t,a,this.is_dbcs(o)),this.prev_attr_id=a);var s=this.getattr(e);if(s){var n=t.measureText(o);if(r.code=o,r.width=n.width*s.charw/100,!i||s.ascent<=0||s.descent<=0){var h=getbaselineinfo(s.facename,s.point);s.ascent=h.ascent,s.descent=h.descent}r.ascent=s.ascent,r.descent=s.descent,r.x=0,r.y=0,o==X.ENTERKEY&&(r.width=0)}},aligndoc:function(t,e,o){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0,this.lines=null,this.lines=new xlines;for(var r=0;;){var i=this.alignline(t,e,r,o);if(i>=this.strings.length)break;r=i}for(var a=0,s=0,n=0;n<this.lines.array.length;){{var h=this.lines.array[n++];h.max_ascent+h.max_descent+h.gap}this.alignlinexy(a,s,h)}return n+1}},alignline:function(t,e,o,r){var i=new xline;i.begin=o,i.end=o,i.total_w=e,i.remain_w=e,i.max_ascent=0,i.max_descent=0,i.gap=0,i.is_lastline=!1,i.ci_array=new Array;var a=this.getpara(o);a&&(i.gap=a.linegap);for(var s=o,n=o,h=0,l=0,c=!1;s<this.strings.length;){var p=this.strings[s],d=new xcodeinfo;if(this.getcodeinfo(t,s,p,d,r),i.ci_array.push(d),i.max_ascent<d.ascent&&(i.max_ascent=d.ascent),i.max_descent<d.descent&&(i.max_descent=d.descent),h+=d.width," "==p?(n=s,l+=h,h=0):1==c&&(n=s-1,l+=h-d.width,h=d.width),p==X.ENTERKEY||s>=this.strings.length-1){n=s,i.is_lastline=!0,a&&(i.gap+=a.paragap);break}if(!this.is_singleline&&l+h>e){if(s==o){l=e,n=s;break}n==o&&(l=h-d.width,n=s-1);for(var _=s;_>n;)i.ci_array.pop(),_--;break}s++,c=!1;var u=this.strings[s];this.is_dbcs(p)&&this.is_dbcs(u)&&(c=!0),this.is_dbcs(p)!=this.is_dbcs(u)&&(c=!0)}for(var _=n+1;_<this.strings.length&&" "==this.strings[_];){var f=d.clone();i.ci_array.push(f),_++}return n=_-1,i.end=n,this.lines.array.push(i),n+1},alignlinexy:function(t,e,o){if(!(o.begin>o.end)){var r=this.getpara(o.begin);if(null!=r){for(var i=o.ci_array.length-1;" "==o.ci_array[i].code;)i--;for(var a=0,s=0,n=0;i>=n;n++)" "==o.ci_array[n].code&&a++,s+=o.ci_array[n].width;o.remain_w=o.total_w-s;var h=0,l=0,c=t,p=e,d=p+o.max_ascent;switch(r.align){case 0:break;case 1:c=t+o.remain_w;break;case 2:c=t+o.remain_w/2;break;case 3:if(o.ci_array.length<=1)c=t+o.remain_w/2;else{var _=o.ci_array.length-1;1==o.is_lastline&&_--,h=o.remain_w/_}case 4:a>0&&(l=o.remain_w/a)}for(var n=0;i>=n;n++){var u=o.ci_array[n];switch(u.x=c,u.y=d-u.ascent,r.align){case 0:case 1:case 2:u.step_w=u.width,c+=u.step_w;break;case 3:u.step_w=u.width+h,c+=u.step_w;break;case 4:u.step_w=u.width," "!=u.code||o.is_lastline||(u.step_w+=l),c+=u.step_w}}for(var n=i+1;n<o.ci_array.length;n++){var u=o.ci_array[n];u.x=c,u.y=d-u.ascent}}}},display:function(t,e,o,r,i,a,s){if(!(this.strings.length<=0)){this.preparedc(t,0,!0),this.prev_attr_id=0;for(var n=o,h=n+r,l=e,c=X.MARGIN_H+o,p=0;p<this.lines.array.length;){var d=this.lines.array[p++],_=d.max_ascent+d.max_descent+d.gap;if(c+_>0&&this.displayline(t,l,c,d,i,a,s),c+=_,c>h)break}}},displayline:function(t,e,o,r,i,a,s){if(!(r.begin>r.end)){for(var n=-1,h=-1,l=-1,c=r.begin;c<=r.end;){var p=r.ci_array[c-r.begin];c==i&&(h=p.x),c==a&&(l=p.x+p.step_w);var d=this.strings[c];if(d!=X.ENTERKEY){var _=this.getattrid(c);if(this.prev_attr_id!=_&&(this.preparedc(t,_,this.is_dbcs(d)),this.prev_attr_id=_),t.fillText(d,p.x,o+p.y+p.ascent,p.width),""!=this.attr_pool.array[_].strokecolor&&t.strokeText(d,p.x,o+p.y+p.ascent,p.width),this.attr_pool.array[_].underline&&0>n&&(n=p.x),n>=0){var u=-1;this.attr_pool.array[_].underline?(c>=r.end||r.is_lastline&&this.strings[c+1]==X.ENTERKEY)&&(u=p.x+p.width):u=p.x,u>=0&&(t.save(),t.strokeStyle=X.COLOR_ULINE,t.beginPath(),t.moveTo(n,o+r.max_ascent+r.max_descent),t.lineTo(u,o+r.max_ascent+r.max_descent),t.stroke(),n=-1,t.restore())}1==check_bbox&&(t.beginPath(),t.rect(p.x,o+p.y,p.width,p.ascent+p.descent),t.moveTo(p.x,o+p.y+p.ascent),t.lineTo(p.x+p.width,o+p.y+p.ascent),t.stroke())}c++}t.canvas.id==PM.Core.MAIN_CANVAS_ID&&(r.begin>=i&&r.begin<=a||r.end>=i&&r.begin<=a)&&(0>h&&(h=e),0>l&&(l=r.total_w),t.save(),t.fillStyle=s?X.COLOR_BLOCK:X.COLOR_BLOCK_KILLFOCUS,t.fillRect(h,o,l-h,r.max_ascent+r.max_descent+r.gap),t.restore())}},pos2linepos:function(t,e){var o=this.lines.pos2lineindex(t);if(o>=0){var r=this.lines.array[o];if(t>=r.begin&&t<=r.end)return 0==e?r.begin:r.end}return 0},pos2caretrect:function(t,e){var o=this.lines.pos2lineindex(t);if(0>o)return new xrect(0,0,0,0);var r=this.lines.array[o];t<r.begin&&(t=r.begin),t>r.end&&(t=r.end);var i=r.ci_array[t-r.begin].x,a=r.ci_array[t-r.begin].width,s=this.lines.getlinerect(o,!1);return s.l=i,s.r=e?i+a:s.l+1,s.t+=X.MARGIN_H,s.b+=X.MARGIN_H,s},point2caretrect:function(t,e){var o=-1,r=(new xrect(0,0,0,0),this.lines.point2lineindex(t.y));r+=e,0>r&&(r=0),r>=this.lines.array.length&&(r=this.lines.array.length-1);for(var i=this.lines.array[r],a=null,s=i.begin;s<=i.end&&(o=s,a=i.ci_array[s-i.begin],!(t.x<=a.x+a.width/2));s++);var n=this.lines.getlinerect(r,!1);return n.l=a.x,n.r=a.x+1,n.t+=X.MARGIN_H,n.b+=X.MARGIN_H,{rect:n,pos:o}},dump:function(){for(var t="",e=0;e<this.strings.length;e++)t+=this.strings[e]+",";for(var o="",e=0;e<this.offsets.length;e++)o+=this.offsets[e]+",";console.log("strings:\n"+t),console.log("offsets:\n"+o);for(var e in this.attr_pool.array){var r=this.attr_pool.array[e];console.log("attr_pool key:"+e+" value:"+r.facename+","+r.point+","+r.bold+","+r.italic)}for(var e in this.para_pool.array){var i=this.para_pool.array[e];console.log("para_pool key:"+e+" value:"+i.align+","+i.linegap+","+i.paragap)}console.log("<-- end of dump.\n")}};var xime=function(){this.cho_han=[12593,12594,12596,12599,12600,12601,12609,12610,12611,12613,12614,12615,12616,12617,12618,12619,12620,12621,12622],this.cho_eng=[114,82,115,101,69,102,97,113,81,116,84,100,119,87,99,122,120,118,103],this.jung_han=[12623,12624,12625,12626,12627,12628,12629,12630,12631,12632,12633,12634,12635,12636,12637,12638,12639,12640,12641,12642,12643],this.jung_eng=[107,111,105,79,106,112,117,80,104,0,0,0,121,110,0,0,0,98,109,0,108],this.jong_han=[0,12593,12594,12595,12596,12597,12598,12599,12601,12602,12603,12604,12605,12606,12607,12608,12609,12610,12612,12613,12614,12615,12616,12618,12619,12620,12621,12622],this.jong_eng=[0,114,82,0,115,0,0,101,102,0,0,0,0,0,0,0,97,113,0,116,84,100,119,99,122,120,118,103],this.cho_jong=[1,2,4,7,0,8,16,17,0,19,20,21,22,0,23,24,25,26,27],this.state=0,this.queue=[],this.last_comp=0,this.is_act=!1};xime.prototype={activate:function(t){this.is_act=t,this.state=0,this.queue=[],this.last_comp=-1},flush:function(){var t=this.last_comp;return this.state=0,this.queue=[],this.last_comp=-1,t},is_activate:function(){return this.is_act},is_composite:function(){return this.is_act&&this.last_comp>=0?!0:!1},composite:function(t){var e=this.cho_eng.indexOf(t),o=this.jung_eng.indexOf(t);if(t>=0&&0>e&&0>o)return this.state=0,{comp_end:this.last_comp,comp_update:-1};var r=-1,i=-1;switch(this.state){case 0:e>=0?(this.state=1,r=this.cho_han[e],this.queue.push(e)):(this.state=2,r=this.jung_han[o],this.queue.push(o));break;case 1:if(0>t)this.flush();else if(e>=0){var a=this.comp_conx(this.queue[this.queue.length-1],e);a>=0?(this.state=3,r=this.jong_han[a],this.queue.pop(),this.queue.push(a)):(this.state=1,i=this.cho_han[this.queue.shift()],r=this.cho_han[e],this.queue.push(e))}else this.state=4,r=44032+588*this.queue[0]+28*o+0,this.queue.push(o);break;case 2:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),r=this.jung_han[this.queue[0]],this.state=2}else this.flush()}else if(e>=0)this.state=1,i=this.jung_han[this.queue.shift()],r=this.cho_han[e],this.queue.push(e);else{var a=this.comp_vowx(this.queue[this.queue.length-1],o);a>=0?(this.state=2,r=this.jung_han[a],this.queue.pop(),this.queue.push(a)):(this.state=2,i=this.jung_han[this.queue.shift()],r=this.jung_han[o],this.queue.push(o))}break;case 3:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(a.prev),r=this.cho_han[this.queue[0]],this.state=1}else if(e>=0)this.state=1,r=this.jong_han[this.queue.shift()],this.queue.push(e);else{this.state=4;var a=this.div_conx(this.queue.pop());i=this.cho_han[a.prev],r=44032+588*a.next+28*o+0,this.queue.push(a.next),this.queue.push(o)}break;case 4:if(0>t){var s=this.queue.pop();if(this.is_vowx(s)){var a=this.div_vowx(s);this.queue.push(a.prev),r=44032+588*this.queue[0]+28*this.queue[1],this.state=4}else r=this.cho_han[this.queue[0]],this.state=1}else if(e>=0){var n=this.jong_eng.indexOf(t);if(0>n){this.state=1;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0,r=this.cho_han[e],this.queue.push(e)}else this.state=5,r=44032+588*this.queue[0]+28*this.queue[1]+n,this.queue.push(n)}else{var a=this.comp_vowx(this.queue[this.queue.length-1],o);if(a>=0)this.state=4,r=44032+588*this.queue[0]+28*a+0,this.queue.pop(),this.queue.push(a);else{this.state=2;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0,r=this.jung_han[o],this.queue.push(o)}}break;case 5:if(0>t)this.queue.pop(),r=44032+588*this.queue[0]+28*this.queue[1],this.state=4;else if(e>=0){var a=this.comp_conx(this.jong2cho(this.queue[this.queue.length-1]),e);if(a>=0)this.state=6,r=44032+588*this.queue[0]+28*this.queue[1]+a,this.queue.pop(),this.queue.push(a);else{this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();i=44032+588*h+28*l+n,r=this.cho_han[e],this.queue.push(e)}}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift();i=44032+588*h+28*l+0;var n=this.queue.shift(),a=this.jong2cho(n);r=44032+588*a+28*o+0,this.queue.push(a),this.queue.push(o)}break;case 6:if(0>t){var a=this.div_conx(this.queue.pop());this.queue.push(this.cho2jong(a.prev)),r=44032+588*this.queue[0]+28*this.queue[1]+this.queue[2],this.state=5}else if(e>=0){this.state=1;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift();i=44032+588*h+28*l+n,r=this.cho_han[e],this.queue.push(e)}else{this.state=4;var h=this.queue.shift(),l=this.queue.shift(),n=this.queue.shift(),a=this.div_conx(n);i=44032+588*h+28*l+this.cho2jong(a.prev),r=44032+588*a.next+28*o+0,this.queue.push(a.next),this.queue.push(o)}}return this.last_comp=r,{comp_end:i,comp_update:r}},cho2jong:function(t){return this.cho_jong[t]},jong2cho:function(t){return this.cho_jong.indexOf(t)},comp_conx:function(t,e){switch(t){case 0:if(9==e)return 3;break;case 2:if(12==e)return 5;if(18==e)return 6;break;case 5:if(0==e)return 9;if(6==e)return 10;if(7==e)return 11;if(9==e)return 12;if(16==e)return 13;if(17==e)return 14;if(18==e)return 15;break;case 7:if(9==e)return 18}return-1},comp_vowx:function(t,e){switch(t){case 8:if(0==e)return 9;if(1==e)return 10;if(20==e)return 11;break;case 13:if(4==e)return 14;if(5==e)return 15;if(20==e)return 16;break;case 18:if(20==e)return 19}return-1},is_vowx:function(t){return 9==t||10==t||11==t||14==t||15==t||16==t||19==t?!0:!1},div_conx:function(t){switch(t){case 3:return{prev:0,next:9};case 5:return{prev:2,next:12};case 6:return{prev:2,next:18};case 9:return{prev:5,next:0};case 10:return{prev:5,next:6};case 11:return{prev:5,next:7};case 12:return{prev:5,next:9};case 13:return{prev:5,next:16};case 14:return{prev:5,next:17};case 15:return{prev:5,next:18};case 18:return{prev:7,next:9}}return{prev:-1,next:-1}},div_vowx:function(t){switch(t){case 9:return{prev:8,next:0};case 10:return{prev:8,next:1};case 11:return{prev:8,next:20};case 14:return{prev:13,next:4};case 15:return{prev:13,next:5};case 16:return{prev:13,next:20};case 19:return{prev:18,next:20}}return{prev:-1,next:-1}}};